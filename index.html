<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ny-å‰ç«¯è½®æ¤… - SillyTavernçŠ¶æ€æ ç”Ÿæˆå™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="ny-themes.css">
    <link rel="stylesheet" href="ny-ui.css">
    <link rel="stylesheet" href="ny-ui-fonts.css">
    <link rel="stylesheet" href="ny-ui-effects.css">
</head>
<body>
 
    <div class="generator-container">
        <div class="controls-panel">
            <h1>Ny-å‰ç«¯è½®æ¤…</h1>
            <p class="subtitle">SillyTavernçŠ¶æ€æ ç”Ÿæˆå™¨</p>
 
            <div id="global-style-mount"></div>
            <script src="js/sections/section.global.style.js"></script>
            <script>
              try { if (window.Ny && Ny.Sections && Ny.Sections.renderGlobalStyle) Ny.Sections.renderGlobalStyle(); } catch (_e) {}
            </script>
 
            <div id="customization-mount"></div>
<script src="js/sections/section.customization.parts.js"></script>
<script src="js/sections/section.customization.js"></script>
<script>
  try { if (window.Ny && Ny.Sections && Ny.Sections.renderCustomization) Ny.Sections.renderCustomization(); } catch (_e) {}
</script>
<script src="js/sections/section.items.parts.js"></script>
<script src="js/sections/section.items.js"></script>
<script>
  try { if (window.Ny && Ny.Sections && Ny.Sections.renderItems) Ny.Sections.renderItems(); } catch (_e) {}
</script>
<div class="control-section collapsible" id="section-2">
                <h3>3. çŠ¶æ€é¡¹ç›® <span class="toggle-icon">â–¾</span></h3>
                <div class="section-body">
                <div class="form-group-box" data-title="é…è‰²ä¸è¿›åº¦æ¡æ ·å¼"><div class="form-box-title">é…è‰²ä¸è¿›åº¦æ¡æ ·å¼</div>
                <div class="control-group">
                    <label>ç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²</label>
                    <div class="compact-colors-grid">
                        <div class="color-cell">
                            <label for="section2-label-color-input">æ ‡ç­¾é¢œè‰²</label>
                            <div class="color-row">
                                <input type="color" id="section2-label-color-input" value="#6a717c">
                                <input type="text" id="section2-label-color-code-input" placeholder="#RRGGBB æˆ– CSSé¢œè‰²" value="#6a717c">
                            </div>
                        </div>
                        <div class="color-cell">
                            <label for="section2-value-color-input">å€¼é¢œè‰²</label>
                            <div class="color-row">
                                <input type="color" id="section2-value-color-input" value="#97aec8">
                                <input type="text" id="section2-value-color-code-input" placeholder="#RRGGBB æˆ– CSSé¢œè‰²" value="#97aec8">
                            </div>
                        </div>
                        <div class="color-cell">
                            <label for="section2-bar-color-input">æ»‘æ¡é¢œè‰²</label>
                            <div class="color-row">
                                <input type="color" id="section2-bar-color-input" value="#6a717c">
                                <input type="text" id="section2-bar-color-code-input" placeholder="#RRGGBB æˆ– CSSé¢œè‰²" value="#6a717c">
                            </div>
                        </div>
                        <div class="color-cell">
                            <label for="section2-divider-color-input">åˆ†å‰²çº¿é¢œè‰²</label>
                            <div class="color-row">
                                <input type="color" id="section2-divider-color-input" value="#6a717c">
                                <input type="text" id="section2-divider-color-code-input" placeholder="#RRGGBB æˆ– CSSé¢œè‰²" value="#6a717c">
                            </div>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">ä»…ä½œç”¨äºç¬¬ä¸‰éƒ¨åˆ†çš„é¡¹ç›®ï¼ˆåˆ†å‰²çº¿ã€æ ‡ç­¾ã€æ»‘æ¡ï¼‰ï¼Œä¸å½±å“æ ‡é¢˜ä¸æ¨¡æ¿å…¨å±€é…è‰²ã€‚</p>
                </div>

                <div class="control-group">
                    <label>è¿›åº¦æ¡æ ·å¼</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label for="bar-style-select">æ ·å¼</label>
                            <select id="bar-style-select">
                                <option value="normal">æ ‡å‡†</option>
                                <option value="glow">è§å…‰</option>
                                <option value="striped">æ–œçº¹</option>
                                <option value="glass">ç»ç’ƒå…‰æ³½</option>
                            </select>
                        </div>
                        <div>
                            <label for="bar-animation-select">åŠ¨ç”»</label>
                            <select id="bar-animation-select">
                                <option value="none">æ— </option>
                                <option value="grow">é€æ¸å¢é•¿åˆ°å›ºå®šæ•°å€¼</option>
                            </select>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">é€‰æ‹©å…¨å±€è¿›åº¦æ¡é£æ ¼ä¸åŠ¨ç”»ï¼Œå¯ä¸ä¸Šæ–¹é¢œè‰²è”åŠ¨ã€‚</p>
                </div>

                <div class="control-group">
                    <label for="percent-display-select">ç™¾åˆ†æ¯”æ˜¾ç¤º</label>
                    <select id="percent-display-select">
                        <option value="center">ä¸­å¿ƒè¦†ç›–</option>
                        <option value="badge">å³ä¾§å¾½ç« </option>
                        <option value="tooltip">ä¸Šæ–¹æ°”æ³¡</option>
                        <option value="follow">æœ«ç«¯è·Ÿéš</option>
                        <option value="toast">ä¸‹æ–¹åå¸</option>
                    </select>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">ç‚¹å‡»è¿›åº¦æ¡æ˜¾ç¤º/éšè—ç™¾åˆ†æ¯”ï¼Œå¯åˆ‡æ¢æ˜¾ç¤ºé£æ ¼ã€‚</p>
                </div>
                </div>

                <!-- æ–°å¢ï¼šé¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰ -->
                <div class="form-group-box" data-title="é¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±">
                  <div class="form-box-title">é¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±</div>

                  <div class="control-group">
                    <label style="display:flex;align-items:center;gap:8px;">
                      <input type="checkbox" id="item-bg-shadow-per-item-toggle">
                      å…è®¸æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹è®¾ç½®èƒŒæ™¯ä¸é˜´å½±
                    </label>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      å¼€å¯åï¼Œå¯åœ¨â€œé¡¹ç›®ç¼–è¾‘â€ä¸­ä¸ºå•ä¸ªé¡¹ç›®è®¾ç½®èƒŒæ™¯ä¸é˜´å½±ï¼Œå±€éƒ¨è®¾ç½®å°†ä¼˜å…ˆäºä¸‹æ–¹å…¨å±€è®¾ç½®ã€‚
                    </p>
                  </div>

                  <div class="control-group">
                    <label for="item-card-bg-mode-select">èƒŒæ™¯æ¨¡å¼ï¼ˆå…¨å±€ï¼‰</label>
                    <select id="item-card-bg-mode-select">
                      <option value="theme">è·Ÿéšæ¨¡æ¿</option>
                      <option value="none">æ— èƒŒæ™¯ï¼ˆé€æ˜ï¼‰</option>
                      <option value="color">çº¯è‰²</option>
                      <option value="gradient">æ¸å˜</option>
                      <option value="image">å›¾ç‰‡</option>
                      <option value="url">è‡ªå®šä¹‰URLèƒŒæ™¯</option>
                    </select>
                  </div>

                  <!-- çº¯è‰²ï¼ˆå…¨å±€ï¼‰ -->
                  <div class="control-group" id="item-card-bg-color-group" style="display:none;">
                    <label for="item-card-bg-color-input">çº¯è‰²èƒŒæ™¯</label>
                    <input type="color" id="item-card-bg-color-input" value="#111215">
                    <input type="text" id="item-card-bg-color-code-input" placeholder="#RRGGBB æˆ– CSSé¢œè‰²" value="#111215" style="margin-top:6px;">
                  </div>

                  <!-- æ¸å˜ï¼ˆå…¨å±€ï¼‰ -->
                  <div class="control-group" id="item-card-bg-gradient-group" style="display:none;">
                    <label>æ¸å˜èƒŒæ™¯</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                      <div>
                        <label for="item-card-grad-start-color-input">èµ·è‰²</label>
                        <input type="color" id="item-card-grad-start-color-input" value="#6a717c">
                        <input type="text" id="item-card-grad-start-code-input" placeholder="#RRGGBB æˆ– CSSé¢œè‰²" value="#6a717c" style="margin-top:6px;">
                      </div>
                      <div>
                        <label for="item-card-grad-end-color-input">ç»ˆè‰²</label>
                        <input type="color" id="item-card-grad-end-color-input" value="#97aec8">
                        <input type="text" id="item-card-grad-end-code-input" placeholder="#RRGGBB æˆ– CSSé¢œè‰²" value="#97aec8" style="margin-top:6px;">
                      </div>
                    </div>
                    <div class="range-row" style="margin-top:8px;">
                      <label>è§’åº¦(Â°)</label>
                      <input type="range" id="item-card-grad-angle-range" min="0" max="360" step="1" value="135">
                      <span class="value-pill"><span id="item-card-grad-angle-value">135</span>Â°</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      ç¤ºä¾‹ï¼šlinear-gradient(135deg, èµ·è‰², ç»ˆè‰²)
                    </p>
                  </div>

                  <!-- å›¾ç‰‡ï¼ˆå…¨å±€ï¼‰ -->
                  <div class="control-group" id="item-card-bg-image-group" style="display:none;">
                    <label for="item-card-bg-image-url">èƒŒæ™¯å›¾ç‰‡ URL</label>
                    <input type="url" id="item-card-bg-image-url" placeholder="https://example.com/card-bg.jpg">
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      èƒŒæ™¯é»˜è®¤ä½¿ç”¨ cover/center/no-repeatã€‚
                    </p>
                  </div>

                  <!-- è‡ªå®šä¹‰URLèƒŒæ™¯ï¼ˆå…¨å±€ï¼‰ -->
                  <div class="control-group" id="item-card-bg-url-group" style="display:none;">
                    <label for="item-card-bg-url-input">è‡ªå®šä¹‰ URL èƒŒæ™¯</label>
                    <input type="url" id="item-card-bg-url-input" placeholder="https://example.com/your-image.png">
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      ä¸â€œå›¾ç‰‡â€ä¸€è‡´ï¼Œä½¿ç”¨ cover/center/no-repeatï¼›è¯¥é¡¹ç”¨äºè¡¥å……â€œèƒŒæ™¯æ¨¡å¼â€æœªåŒ…å«çš„è‡ªå®šä¹‰ URL åœºæ™¯ã€‚
                    </p>
                  </div>

                  <!-- é˜´å½±ï¼ˆå…¨å±€ï¼‰ -->
                  <div class="control-group" id="item-card-shadow-group">
                    <label style="display:flex;align-items:center;gap:8px;">
                      <input type="checkbox" id="item-card-shadow-enable"> å¯ç”¨é˜´å½±ï¼ˆå…¨å±€ï¼‰
                    </label>
                    <div class="range-row" style="margin-top:6px;">
                      <label>å¼ºåº¦</label>
                      <input type="range" id="item-card-shadow-strength-range" min="0" max="1" step="0.05" value="0.30" disabled>
                      <span class="value-pill"><span id="item-card-shadow-strength-value">0.30</span></span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      å±€éƒ¨é¡¹ç›®ä¹Ÿå¯è®¾ç½®é˜´å½±ï¼›å½“å¼€å¯å±€éƒ¨è®¾ç½®æ—¶ï¼Œé¡¹ç›®å†…çš„é˜´å½±å°†è¦†ç›–æ­¤å¤„å…¨å±€è®¾ç½®ã€‚
                    </p>
                  </div>
                </div>
                <div class="form-group-box sm" data-title="é•¿æ–‡å­—è®¾ç½®ï¼ˆå…¨å±€ï¼‰" style="display:none;">
                <div class="form-box-title">é•¿æ–‡å­—è®¾ç½®ï¼ˆå…¨å±€ï¼‰</div>
                <div class="control-group" id="longtext-settings-group" style="display:none;"></div>
                </div>

                <div class="form-group-box" data-title="å€¼æ¡†ä¸æ•´ä½“åç§»"><div class="form-box-title">å€¼æ¡†ä¸æ•´ä½“åç§»</div>
                <!-- æ–°å¢ï¼šå€¼æ¡†å®½åº¦/ä½ç½® ä¸ é¡¹ç›®æ•´ä½“åç§»/é˜´å½±ï¼ˆä»…ä½œç”¨äºâ€œç¬¬ä¸‰éƒ¨åˆ† çŠ¶æ€é¡¹ç›®â€ï¼‰ -->
                <div class="control-group">
                  <label>å€¼æ¡†å®½åº¦ä¸ä½ç½®ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰</label>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div class="range-row">
                      <label>å®½åº¦(ç›¸å¯¹æœ€å¤§ %)</label>
                      <input type="range" id="value-box-width-pct-range" min="40" max="100" step="1" value="100">
                      <span class="value-pill"><span id="value-box-width-pct-value">100</span>%</span>
                    </div>
                    <div class="range-row">
                      <label>å€¼æ¡†æ°´å¹³åç§»(%)</label>
                      <input type="range" id="value-box-offset-pct-range" min="-40" max="40" step="1" value="0">
                      <span class="value-pill"><span id="value-box-offset-pct-value">0</span>%</span>
                    </div>
                  </div>
                </div>

                <!-- æ–°å¢ï¼šæ ‡ç­¾/å€¼æ¯”ä¾‹ï¼ˆé»˜è®¤ 3:7ï¼Œå¯è°ƒ 10%~50% æ ‡ç­¾å æ¯”ï¼‰ -->
                <div class="control-group">
                  <label>æ ‡ç­¾/å€¼æ¯”ä¾‹ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰</label>
                  <div class="range-row">
                    <label>æ ‡ç­¾å æ¯”(%)</label>
                    <input type="range" id="label-value-label-pct-range" min="10" max="50" step="1" value="30">
                    <span class="value-pill"><span id="label-value-label-pct-value">30</span>% / <span id="label-value-value-pct-value">70</span>%</span>
                  </div>
                  <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                    ä»…åœ¨â€œæ–‡å­—æ’åˆ—æ–¹å¼=å·¦å³æ’åˆ—ï¼ˆé»˜è®¤ï¼‰â€æ—¶ç”Ÿæ•ˆï¼›â€œä¸Šä¸‹å †å /åŒåˆ—â€ä¿æŒå„è‡ªå¸ƒå±€è®¾å®šã€‚
                  </p>
                </div>

                <div class="control-group">
                  <label>é¡¹ç›®æ•´ä½“åç§»ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰</label>
                  <div class="range-row">
                    <label>æ•´ä½“æ°´å¹³åç§»(%)</label>
                    <input type="range" id="item-offset-pct-range" min="-40" max="40" step="1" value="0">
                    <span class="value-pill"><span id="item-offset-pct-value">0</span>%</span>
                  </div>
                  <div class="range-row">
                    <label>æ•´ä½“å³ä¾§åç§»(%)</label>
                    <input type="range" id="item-offset-right-pct-range" min="-40" max="40" step="1" value="0">
                    <span class="value-pill"><span id="item-offset-right-pct-value">0</span>%</span>
                  </div>

                  <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">é»˜è®¤å®½åº¦ä¸ºæœ€å¤§å€¼ï¼›åç§»èŒƒå›´å—é™ï¼Œé¿å…è¶…å‡ºèƒŒæ™¯è¾¹ç•Œã€‚</p>
                </div>
                </div>

                <div class="form-group-box" data-title="çŠ¶æ€é¡¹ç›®å­—ä½“æ ·å¼"><div class="form-box-title">çŠ¶æ€é¡¹ç›®å­—ä½“æ ·å¼</div>
                <div class="control-group">
                    <label>é«˜çº§å­—ä½“æ ·å¼</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label for="global-label-font-select">æ ‡ç­¾å­—ä½“</label>
                            <select id="global-label-font-select">
                                <option value="Noto Sans SC, sans-serif">Noto Sans SCï¼ˆé»˜è®¤ï¼‰</option>
                                <option value="Inter, Noto Sans SC, sans-serif">Inter</option>
                                <option value="Georgia, Songti SC, serif">Georgia / å®‹ä½“</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                                <option value="'Times New Roman', Georgia, serif">Times New Roman</option>
                                <optgroup label="ğŸ“± åƒç´ ä½“">
                                    <option value="'BoutiqueBitmap9x9', monospace">ç²¾å“ç‚¹é˜µä½“9Ã—9</option>
                                </optgroup>
                                <optgroup label="âœ¨ è‹±æ–‡èŠ±ä½“">
                                    <option value="'Dancing Script', cursive">Dancing Scriptï¼ˆèˆåŠ¨èŠ±ä½“ï¼‰</option>
                                    <option value="'Pacifico', cursive">Pacificoï¼ˆæ¸©å’ŒèŠ±ä½“ï¼‰</option>
                                    <option value="'Great Vibes', cursive">Great Vibesï¼ˆä¼˜é›…èŠ±ä½“ï¼‰</option>
                                    <option value="'Allura', cursive">Alluraï¼ˆåä¸½èŠ±ä½“ï¼‰</option>
                                </optgroup>
                                <optgroup label="âœï¸ æ‰‹å†™ä½“">
                                    <option value="'Caveat', cursive">Caveatï¼ˆä¼‘é—²æ‰‹å†™ï¼‰</option>
                                    <option value="'Indie Flower', cursive">Indie Flowerï¼ˆç‹¬ç«‹æ‰‹å†™ï¼‰</option>
                                    <option value="'Shadows Into Light', cursive">Shadows Into Lightï¼ˆé˜´å½±æ‰‹å†™ï¼‰</option>
                                    <option value="'Permanent Marker', cursive">Permanent Markerï¼ˆé©¬å…‹ç¬”ï¼‰</option>
                                </optgroup>
                                <optgroup label="ğŸš€ ç§‘æŠ€æ„Ÿ">
                                    <option value="'Rajdhani', sans-serif">Rajdhaniï¼ˆç°ä»£ç§‘æŠ€ï¼‰</option>
                                    <option value="'Audiowide', cursive">Audiowideï¼ˆæ•°å­—ç§‘æŠ€ï¼‰</option>
                                    <option value="'Electrolize', sans-serif">Electrolizeï¼ˆç”µå­ç§‘æŠ€ï¼‰</option>
                                </optgroup>
                                <optgroup label="ğŸ¨ ä¸­æ–‡è‰ºæœ¯">
                                    <option value="'Ma Shan Zheng', cursive">é©¬å–„æ”¿æ¥·ä½“</option>
                                    <option value="'ZCOOL XiaoWei', serif">ç«™é…·å°è–‡LOGOä½“</option>
                                    <option value="'Long Cang', cursive">é¾™è—ä½“</option>
                                    <option value="'Zhi Mang Xing', cursive">å¿—è½è¡Œä½“</option>
                                </optgroup>
                                <optgroup label="ğŸ“– è¡¬çº¿ä½“">
                                    <option value="'Merriweather', serif">Merriweatherï¼ˆä¼˜é›…è¡¬çº¿ï¼‰</option>
                                    <option value="'Playfair Display', serif">Playfair Displayï¼ˆå±•ç¤ºè¡¬çº¿ï¼‰</option>
                                </optgroup>
                                <optgroup label="ğŸ”¤ æ— è¡¬çº¿æ‰©å±•">
                                    <option value="'Roboto', sans-serif">Robotoï¼ˆç°ä»£æ— è¡¬çº¿ï¼‰</option>
                                    <option value="'Montserrat', sans-serif">Montserratï¼ˆæ—¶å°šæ— è¡¬çº¿ï¼‰</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label for="global-value-font-select">å€¼å­—ä½“</label>
                            <select id="global-value-font-select">
                                <option value="Noto Sans SC, sans-serif">Noto Sans SCï¼ˆé»˜è®¤ï¼‰</option>
                                <option value="Inter, Noto Sans SC, sans-serif">Inter</option>
                                <option value="Georgia, Songti SC, serif">Georgia / å®‹ä½“</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                                <option value="'Times New Roman', Georgia, serif">Times New Roman</option>
                                <optgroup label="ğŸ“± åƒç´ ä½“">
                                    <option value="'BoutiqueBitmap9x9', monospace">ç²¾å“ç‚¹é˜µä½“9Ã—9</option>
                                </optgroup>
                                <optgroup label="âœ¨ è‹±æ–‡èŠ±ä½“">
                                    <option value="'Dancing Script', cursive">Dancing Scriptï¼ˆèˆåŠ¨èŠ±ä½“ï¼‰</option>
                                    <option value="'Pacifico', cursive">Pacificoï¼ˆæ¸©å’ŒèŠ±ä½“ï¼‰</option>
                                    <option value="'Great Vibes', cursive">Great Vibesï¼ˆä¼˜é›…èŠ±ä½“ï¼‰</option>
                                    <option value="'Allura', cursive">Alluraï¼ˆåä¸½èŠ±ä½“ï¼‰</option>
                                </optgroup>
                                <optgroup label="âœï¸ æ‰‹å†™ä½“">
                                    <option value="'Caveat', cursive">Caveatï¼ˆä¼‘é—²æ‰‹å†™ï¼‰</option>
                                    <option value="'Indie Flower', cursive">Indie Flowerï¼ˆç‹¬ç«‹æ‰‹å†™ï¼‰</option>
                                    <option value="'Shadows Into Light', cursive">Shadows Into Lightï¼ˆé˜´å½±æ‰‹å†™ï¼‰</option>
                                    <option value="'Permanent Marker', cursive">Permanent Markerï¼ˆé©¬å…‹ç¬”ï¼‰</option>
                                </optgroup>
                                <optgroup label="ğŸš€ ç§‘æŠ€æ„Ÿ">
                                    <option value="'Rajdhani', sans-serif">Rajdhaniï¼ˆç°ä»£ç§‘æŠ€ï¼‰</option>
                                    <option value="'Audiowide', cursive">Audiowideï¼ˆæ•°å­—ç§‘æŠ€ï¼‰</option>
                                    <option value="'Electrolize', sans-serif">Electrolizeï¼ˆç”µå­ç§‘æŠ€ï¼‰</option>
                                </optgroup>
                                <optgroup label="ğŸ¨ ä¸­æ–‡è‰ºæœ¯">
                                    <option value="'Ma Shan Zheng', cursive">é©¬å–„æ”¿æ¥·ä½“</option>
                                    <option value="'ZCOOL XiaoWei', serif">ç«™é…·å°è–‡LOGOä½“</option>
                                    <option value="'Long Cang', cursive">é¾™è—ä½“</option>
                                    <option value="'Zhi Mang Xing', cursive">å¿—è½è¡Œä½“</option>
                                </optgroup>
                                <optgroup label="ğŸ“– è¡¬çº¿ä½“">
                                    <option value="'Merriweather', serif">Merriweatherï¼ˆä¼˜é›…è¡¬çº¿ï¼‰</option>
                                    <option value="'Playfair Display', serif">Playfair Displayï¼ˆå±•ç¤ºè¡¬çº¿ï¼‰</option>
                                </optgroup>
                                <optgroup label="ğŸ”¤ æ— è¡¬çº¿æ‰©å±•">
                                    <option value="'Roboto', sans-serif">Robotoï¼ˆç°ä»£æ— è¡¬çº¿ï¼‰</option>
                                    <option value="'Montserrat', sans-serif">Montserratï¼ˆæ—¶å°šæ— è¡¬çº¿ï¼‰</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div class="range-row">
                            <label>æ ‡ç­¾å­—å·</label>
                            <input type="range" id="global-label-font-size-range" min="10" max="36" step="1" value="16">
                            <span class="value-pill"><span id="global-label-font-size-value">16</span>px</span>
                        </div>
                        <div class="range-row">
                            <label>å€¼å­—å·</label>
                            <input type="range" id="global-value-font-size-range" min="10" max="36" step="1" value="16">
                            <span class="value-pill"><span id="global-value-font-size-value">16</span>px</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div>
                            <label>æ ‡ç­¾æ ·å¼</label>
                            <div style="display:grid; gap:8px;">
                                <select id="global-label-weight-select">
                                    <option value="400">å¸¸è§„(400)</option>
                                    <option value="500">ä¸­ç­‰(500)</option>
                                    <option value="600">åŠç²—(600)</option>
                                    <option value="700">åŠ ç²—(700)</option>
                                </select>
                                <div style="display:flex; align-items:center; gap:6px; flex-wrap: nowrap; font-size:12px; white-space:nowrap; margin-top:6px; grid-row:2;">
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-label-italic-checkbox">å€¾æ–œ</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-label-uppercase-checkbox">å¤§å†™</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-label-reflect-checkbox">å€’å½±</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label>å€¼æ ·å¼</label>
                            <div style="display:grid; gap:8px;">
                                <select id="global-value-weight-select">
                                    <option value="400">å¸¸è§„(400)</option>
                                    <option value="500">ä¸­ç­‰(500)</option>
                                    <option value="600">åŠç²—(600)</option>
                                    <option value="700">åŠ ç²—(700)</option>
                                </select>
                                <div style="display:flex; align-items:center; gap:6px; flex-wrap: nowrap; font-size:12px; white-space:nowrap; margin-top:6px; grid-row:2;">
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-value-italic-checkbox">å€¾æ–œ</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-value-uppercase-checkbox">å¤§å†™</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-value-reflect-checkbox">å€’å½±</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <div class="form-group-box" data-title="é¡¹ç›®ç¼–è¾‘"><div class="form-box-title">é¡¹ç›®ç¼–è¾‘</div>
                <div id="items-container">
                    <div class="item-controls">
                        <div class="item-header"><span>åœ°ç‚¹ (æ–‡æœ¬)</span><button class="btn-delete">X</button></div>
                    </div>
                    <div class="item-controls">
                        <div class="item-header"><span>æƒ…ç»ª (è¿›åº¦æ¡)</span><button class="btn-delete">X</button></div>
                    </div>
                    <div class="item-controls">
                        <div class="item-header"><span>åˆ†å‰²çº¿</span><button class="btn-delete">X</button></div>
                    </div>
                </div>
                <div class="control-group" style="margin-top: 20px;">
                    <label for="add-item-select">æ·»åŠ æ–°é¡¹ç›®</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="add-item-select">
                            <option value="text">æ–‡æœ¬</option>
                            <option value="longtext">é•¿æ–‡å­—</option>
                            <option value="bar">è¿›åº¦æ¡/æ•°å€¼æ¡</option>
                            <option value="divider">åˆ†å‰²çº¿</option>
                        </select>
                        <button class="btn btn-primary" style="width: auto; flex-shrink: 0;">æ·»åŠ </button>
                    </div>
                </div>
                </div>
            </div>
            </div>
 
            <div class="control-section collapsible" id="section-3">
                <h3>3. è¾“å‡ºä»£ç  <span class="toggle-icon">â–¾</span></h3>
                <div class="section-body">
                <!-- å·²ç§»é™¤ï¼šå¯¼å‡ºæœ€å¤§å®½åº¦è®¾ç½®ï¼Œæ”¹ç”±â€œ2 æ¨¡æ¿ä¸ªæ€§åŒ– â†’ é¢„è§ˆæœ€å¤§å®½åº¦â€ç»Ÿä¸€æ§åˆ¶ -->

                <div class="control-group">
                    <label for="xml-wrapper-name">AI è¾“å‡ºåŒ…è£¹æ ‡ç­¾åï¼ˆè‡ªåŠ¨ä½¿ç”¨ä¸Šæ–¹â€œçŠ¶æ€æ æ ‡é¢˜â€ï¼Œä»…ç”¨äºæŸ¥çœ‹ï¼‰</label>
                    <input type="text" id="xml-wrapper-name" value="è§’è‰²çŠ¶æ€" placeholder="å°†ç”Ÿæˆ <çŠ¶æ€æ æ ‡é¢˜çŠ¶æ€æ >...</çŠ¶æ€æ æ ‡é¢˜çŠ¶æ€æ >" readonly>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                        è¾“å‡ºæ ¼å¼ç¤ºä¾‹ï¼š<åå­—çŠ¶æ€æ > åœ°ç‚¹ï¼š... æƒ…ç»ªï¼š... </åå­—çŠ¶æ€æ >ã€‚é»˜è®¤æ¥æºï¼šçŠ¶æ€æ æ ‡é¢˜ã€‚
                    </p>
                </div>
                <div class="control-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                        <label>AI è¾“å‡ºæ¨¡æ¿</label>
                        <button class="btn-copy" data-target="ai-template-inline">å¤åˆ¶</button>
                    </div>
                    <textarea id="ai-template-inline" class="code-area" rows="8" readonly></textarea>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">ç”¨äºæç¤º AI è¾“å‡º <åå­—çŠ¶æ€æ > ... </åå­—çŠ¶æ€æ > ç»“æ„çš„ç¤ºä¾‹æ¨¡æ¿ã€‚</p>
                </div>
                
                <!-- æ–°å¢ï¼šå®æ—¶çŠ¶æ€æ  HTMLï¼ˆä¸å³ä¾§é¢„è§ˆä¿æŒä¸€è‡´ï¼‰ -->
                <div class="control-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                        <label>çŠ¶æ€æ  HTMLï¼ˆå®æ—¶ç”Ÿæˆï¼‰</label>
                        <button class="btn-copy" data-target="statusbar-code-live">å¤åˆ¶</button>
                    </div>
                    <textarea id="statusbar-code-live" class="code-area" rows="24" readonly></textarea>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">æ­¤å¤„å®æ—¶å±•ç¤ºä¸å³ä¾§é¢„è§ˆä¸€è‡´çš„çŠ¶æ€æ  HTMLï¼Œå¼¹çª—æ‰“å¼€æ—¶å°†è‡ªåŠ¨åŒæ­¥ã€‚</p>
                </div>
                
                <div class="control-group">
                    <button id="btn-download-json" class="btn btn-primary" style="width: 100%;">ä¸‹è½½é…’é¦†æ­£åˆ™</button>
                </div>
            </div>
            </div>
 
        </div>
 
        <div class="preview-panel">
            <div id="live-preview-container"></div>
        </div>
 
        <div class="output-panel">
            <div class="generate-btn-container">
                <button id="device-toggle-btn" title="ä»…å½±å“å³ä¾§é¢„è§ˆï¼Œä¸æ”¹å˜å¯¼å‡ºä»£ç ">ğŸ“± æ‰‹æœºç«¯</button>
                <button id="generate-btn">âœ¨ ç”Ÿæˆä»£ç </button>
            </div>
            <div id="code-output" class="code-output" style="display:none;">
                <!-- å³ä¸‹è§’æ—§æ¨¡å—ä¿ç•™åœ¨DOMï¼Œæ­¤å¤„ä¸å†æ‰¿è½½â€œ3. è¾“å‡ºä»£ç â€ -->
                <div class="code-block">
                    <div class="code-block-header">è¾“å‡ºçŠ¶æ€æ ä»£ç ï¼ˆHTMLã€CSSã€JSï¼‰ <button class="btn-copy" data-target="statusbar-code">å¤åˆ¶</button></div>
                    <textarea id="statusbar-code" class="code-area" rows="28" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">æ­£åˆ™æ–¹æ¡ˆï¼ˆæŒ‰æ ‡ç­¾åŒ¹é…å€¼ï¼‰ <button class="btn-copy" data-target="regex-recipe">å¤åˆ¶</button></div>
                    <textarea id="regex-recipe" class="code-area" rows="14" readonly></textarea>
                </div>

                <!-- SillyTavern é›†æˆå››ä»¶å¥—è¾“å‡º -->
                <div class="code-block">
                    <div class="code-block-header">1) åŸå§‹ä»£ç ï¼ˆStandalone HTMLï¼Œç”¨äºå‚è€ƒ/å•ç‹¬é¢„è§ˆï¼‰ <button class="btn-copy" data-target="original-code">å¤åˆ¶</button></div>
                    <textarea id="original-code" class="code-area" rows="28" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">2) AI è¾“å‡ºæ¨¡æ¿ï¼ˆXML åŒ…è£¹ï¼Œè´´ç»™ AI ç”Ÿæˆï¼‰ <button class="btn-copy" data-target="ai-template">å¤åˆ¶</button></div>
                    <textarea id="ai-template" class="code-area" rows="10" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">3) findRegexï¼ˆæ•è· <åå­—çŠ¶æ€æ >...</åå­—çŠ¶æ€æ >ï¼‰
                      <div>
                        <button class="btn-copy" id="btn-copy-find-raw" data-clip="">å¤åˆ¶åŸç”Ÿ</button>
                        <button class="btn-copy" id="btn-copy-find-json" data-clip="">å¤åˆ¶JSON-safe</button>
                      </div>
                    </div>
                    <textarea id="find-regex" class="code-area" rows="3" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">4) replaceStringï¼ˆåŠ¡å¿…ä½¿ç”¨â€œå¤åˆ¶åŸç”Ÿâ€ï¼›å›´æ ç‰ˆä¸æ‰§è¡Œè„šæœ¬ï¼Œä»…ç”¨äºå±•ç¤ºï¼‰
                      <div>
                        <button class="btn-copy" id="btn-copy-rep-raw" data-clip="">å¤åˆ¶åŸç”Ÿ</button>
                        <button class="btn-copy" id="btn-copy-rep-fenced" data-clip="">å¤åˆ¶å›´æ ç‰ˆ</button>
                        <button class="btn-copy" id="btn-copy-rep-raw-json" data-clip="">å¤åˆ¶JSON-safe(åŸç”Ÿ)</button>
                        <button class="btn-copy" id="btn-copy-rep-fenced-json" data-clip="">å¤åˆ¶JSON-safe(å›´æ )</button>
                      </div>
                    </div>
                    <textarea id="replace-string" class="code-area" rows="28" readonly></textarea>
                </div>

                <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                    <button id="close-output" class="btn">å…³é—­</button>
                </div>
            </div>
            <!-- è¾“å‡ºä»£ç å¼¹çª—ï¼ˆæ‰¿è½½å·¦ä¾§â€œ3. è¾“å‡ºä»£ç â€ï¼‰ -->
            <div id="code-modal">
              <div class="modal-backdrop"></div>
              <div class="modal-dialog">
                <div class="modal-header">
                  <span>è¾“å‡ºä»£ç </span>
                  <button id="code-modal-close" class="btn">å…³é—­</button>
                </div>
                <div id="moved-section3-modal"></div>
              </div>
            </div>
        </div>
    </div>

 <script>
  (() => {
    // Disable overlapping inline event bindings; external Ny.UI/Ny.Export will handle generate/copy/modal/download.
    window.NY_DISABLE_INLINE = true;
    const themeOptions = document.querySelectorAll('.theme-option');
    const titleInput = document.getElementById('title-input');
    const previewContainer = document.getElementById('live-preview-container');

    const enterAnimSelect = document.getElementById('enter-animation-select');
    const loopAnimSelect = document.getElementById('loop-animation-select');
    const animSpeedRange = document.getElementById('animation-speed');
    const animIntensityRange = document.getElementById('animation-intensity');
    const speedValue = document.getElementById('speed-value');
    const intensityValue = document.getElementById('intensity-value');

    const itemsContainer = document.getElementById('items-container');
    const addItemSelect = document.getElementById('add-item-select');
    // â€œæ·»åŠ â€æŒ‰é’®ï¼šå–ä¸‹æ‹‰æ¡†åŒä¸€è¡Œçš„é‚£ä¸ªæŒ‰é’®ï¼ˆåŠ å®¹é”™ï¼‰
    let addItemBtn = null;
    try {
      addItemBtn = addItemSelect ? (addItemSelect.closest('div') ? addItemSelect.closest('div').querySelector('button') : null) : null;
    } catch (_e) {
      addItemBtn = null;
    }

    // æ—§ç‰ˆâ€œæ¢è¡Œâ€é€‰é¡¹å·²ç§»é™¤ï¼›ä¿ç•™å…¼å®¹å ä½
    function updateAddItemOptionVisibility() {
      // removed: row option no longer supported
      try {} catch (_e) {}
    }

    // ===== ç•Œé¢æ¨¡å¼ï¼ˆç™½å¤©/é»‘å¤œï¼‰åˆå§‹åŒ–ä¸åˆ‡æ¢ï¼Œä»…å½±å“é¡µé¢ UIï¼Œä¸æ”¹å˜ç”Ÿæˆé€»è¾‘ =====
    const uiModeSelect = document.getElementById('ui-mode-select');
    (function initUiMode(){
      try {
        // å¼ºåˆ¶é»˜è®¤æš—è‰²ï¼šé¦–æ¬¡åŠ è½½ä¸è¯»å–ç³»ç»Ÿåå¥½æˆ–å†å²åå¥½
        document.body.classList.remove('ui-light'); // æš—è‰²ä¸ºåŸºçº¿
        if (uiModeSelect) uiModeSelect.value = 'dark';
        // ä¸æ¸…ç†æœ¬åœ°å­˜å‚¨ï¼Œä»¥ä¾¿ç”¨æˆ·åç»­æ‰‹åŠ¨åˆ‡æ¢ä»å¯æŒä¹…åŒ–ï¼›ä½†æ¯æ¬¡åˆå§‹å‡ä¸ºæš—è‰²
      } catch (_e) {}
    })();
    if (uiModeSelect) {
      uiModeSelect.addEventListener('change', (e) => {
        const v = (e.target.value === 'light') ? 'light' : 'dark';
        if (v === 'light') document.body.classList.add('ui-light');
        else document.body.classList.remove('ui-light');
        try { localStorage.setItem('ny-ui-mode', v); } catch (_e) {}
      });
    }

    let currentTheme = 'theme-mystic-noir';
    let currentTitle = 'è§’è‰²çŠ¶æ€';
    let currentEnterAnimation = 'none';
    let currentLoopAnimation = 'none';
    let currentAnimation = 'none';
    let animSpeed = 1.0;
    let animIntensity = 0.70;
    // é¢„è§ˆå›ºå®šé«˜åº¦ï¼šå½“è°ƒæ•´å®½åº¦æ—¶é”å®šå½“å‰é«˜åº¦ï¼Œé¿å…éšå®½åº¦å˜åŒ–
    let fixedWrapperHeight = null;

    // ç»Ÿä¸€çŠ¶æ€ï¼šitems
    let items = [
      { id: genId(), type: 'text', label: 'åœ°ç‚¹', value: 'è¿·é›¾æ£®æ— Â· æ·±å¤„' },
      { id: genId(), type: 'bar',  label: 'æƒ…ç»ª', percent: 60 },
      { id: genId(), type: 'divider' },
      {
        id: genId(),
        type: 'longtext',
        label: 'è¯´æ˜',
        value: 'ç¬¬ä¸€æ®µæ–‡å­—ï¼Œè¿™æ˜¯æµ‹è¯•é¦–å­—ç¼©è¿›çš„ç¬¬ä¸€æ®µã€‚\nç¬¬äºŒæ®µæ–‡å­—ï¼Œæ¢è¡Œåä¹Ÿåº”è¯¥æœ‰é¦–å­—ç¼©è¿›ã€‚\nç¬¬ä¸‰æ®µæ–‡å­—ï¼Œç»§ç»­æµ‹è¯•å¤šæ®µè½çš„ç¼©è¿›æ•ˆæœã€‚',
        ltLineHeight: 1.6,
        ltEffect: 'none',
        ltSkipFirstLine: false,
        ltFirstIndentPx: 32,
        ltPadTopPx: 0,
        ltPadRightPx: 0,
        ltPadBottomPx: 0,
        ltPadLeftPx: 0,
        ltTwSpeedMs: 18,
        ltTwDelayMs: 0,
        ltTwCaret: true
      }
    ];

    // -----------------------
    // å·¥å…·
    // -----------------------
    function genId() {
      return 'it_' + Math.random().toString(36).slice(2, 9);
    }
    function esc(s = '') {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    // delegate to external Ny.Utils.clamp to avoid inline duplicate
    function clamp(n, min, max) {
      try {
        if (window.Ny && Ny.Utils && typeof Ny.Utils.clamp === 'function') {
          return Ny.Utils.clamp(n, min, max);
        }
      } catch (_e) {}
      return Math.max(min, Math.min(max, n));
    }
    // ç”±â€œçŠ¶æ€æ æ ‡é¢˜â€æ´¾ç”Ÿ AI åŒ…è£¹æ ‡ç­¾åå­—ï¼ˆå§”æ‰˜ Ny.Utils.toWrapperNameFromTitleï¼‰
    function toWrapperNameFromTitle(title) {
      try {
        if (window.Ny && Ny.Utils && typeof Ny.Utils.toWrapperNameFromTitle === 'function') {
          return Ny.Utils.toWrapperNameFromTitle(title);
        }
        const name = String(title || '').replace(/[^A-Za-z0-9\u4E00-\u9FFF_-]+/g, '').trim();
        return name || 'çŠ¶æ€';
      } catch (_e) {
        return 'çŠ¶æ€';
      }
    }
    const typeName = t => ({text:'æ–‡æœ¬', longtext:'é•¿æ–‡å­—', bar:'è¿›åº¦æ¡', divider:'åˆ†å‰²çº¿'}[t] || t);
    const snapshot = () => JSON.parse(JSON.stringify(items));

    // æ–°å¢ï¼šè¯Šæ–­è¾…åŠ©å‡½æ•°ï¼ˆé¿å…æœªå®šä¹‰æŠ¥é”™ï¼›ä»…ç”¨äºæ—¥å¿—ï¼‰
    function contrastRatio(c1, c2) {
      try {
        function hexToRgb(hex) {
          const h = String(hex || '').trim();
          if (!/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(h)) return [0, 0, 0];
          const s = h.slice(1);
          const full = s.length === 3 ? s.split('').map(ch => ch + ch).join('') : s;
          const r = parseInt(full.slice(0, 2), 16);
          const g = parseInt(full.slice(2, 4), 16);
          const b = parseInt(full.slice(4, 6), 16);
          return [r, g, b];
        }
        function srgbToLin(v) {
          v = v / 255;
          return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
        }
        function luminance(rgb) {
          const [r, g, b] = rgb;
          const R = srgbToLin(r), G = srgbToLin(g), B = srgbToLin(b);
          return 0.2126 * R + 0.7152 * G + 0.0722 * B;
        }
        const L1 = luminance(hexToRgb(c1));
        const L2 = luminance(hexToRgb(c2));
        const hi = Math.max(L1, L2), lo = Math.min(L1, L2);
        return (hi + 0.05) / (lo + 0.05);
      } catch (_e) {
        return 1;
      }
    }
    function computeCoherence(opts) {
      try {
        const { primaryColor, secondaryColor, letterSpacing = 0, lineHeight = 1.4, animationType = 'none' } = (opts || {});
        const cr = contrastRatio(primaryColor, secondaryColor);
        let score = 0.5 + Math.min(cr, 7) / 14; // åŸºäºå¯¹æ¯”åº¦çš„åŸºçº¿
        if (lineHeight >= 1.2 && lineHeight <= 1.8) score += 0.1;
        if (letterSpacing > 0.5) score -= 0.05;
        if (animationType !== 'none') score += 0.05;
        return Number(Math.max(0, Math.min(1, score)).toFixed(2));
      } catch (_e) {
        return 0.5;
      }
    }

    // -----------------------
    // é¢„è§ˆæ¸²æŸ“ï¼ˆä¸¥æ ¼ç”± items çŠ¶æ€é©±åŠ¨ï¼‰
    // -----------------------
    // removed: legacy getHeaderHTML() duplicate; use enhanced [getHeaderHTML2()](å‰ç«¯è½®æ¤…4.0.original.html:2163) below for parity

// removed: legacy buildItemsHTML(list) duplicate; using enhanced version below

    // removed: legacy renderPreview() duplicate; use enhanced [renderPreview()](å‰ç«¯è½®æ¤…4.0.original.html:3108) implementation with backgrounds, variables, FX, and per-item overrides

    // -----------------------
    // å·¦ä¾§ç¼–è¾‘é¢æ¿æ¸²æŸ“ï¼ˆç”± items çŠ¶æ€é©±åŠ¨ï¼‰
    // -----------------------
    function renderItemsEditor() {
      // è®°å½•å½“å‰å·²æŠ˜å çš„é¡¹ç›®ï¼ˆåœ¨é‡æ¸²æŸ“æ—¶ä¿æŒæŠ˜å çŠ¶æ€ï¼‰
      let prevCollapsedIds = new Set();
      try {
        prevCollapsedIds = new Set(
          Array.from(itemsContainer.querySelectorAll('.item-controls.collapsed'))
            .map(el => el.getAttribute('data-id'))
        );
      } catch (_e) {}

      itemsContainer.innerHTML = items.map((it, idx) => {
        const titleText = `${esc(it.label || typeName(it.type))} (${typeName(it.type)})`;
        const collapsedClass = prevCollapsedIds.has(it.id) ? ' collapsed' : '';
        return `
          <div class="item-controls collapsible${collapsedClass}" data-id="${it.id}">
            <div class="item-header">
              <span>${idx + 1}. ${titleText}</span>
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="item-actions">
                  <button class="btn" data-action="up" data-id="${it.id}" title="ä¸Šç§»"><i class="fa-solid fa-chevron-up"></i></button>
                  <button class="btn" data-action="down" data-id="${it.id}" title="ä¸‹ç§»"><i class="fa-solid fa-chevron-down"></i></button>
                  <button class="btn btn-delete" data-action="delete" data-id="${it.id}" title="åˆ é™¤"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <span class="item-collapse-toggle" title="æŠ˜å /å±•å¼€">â–¾</span>
              </div>
            </div>
            ${renderItemInputs(it)}
          </div>
        `;
      }).join('');
      
      // æ³¨å…¥ï¼šå±€éƒ¨å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±æ§åˆ¶ï¼ˆä»…å½“å¼€å¯â€œæ¯é¡¹ç›®ç‹¬ç«‹è®¾ç½®â€ï¼‰
      try {
        if (customization.itemCardPerItemEnabled) {
          const partsFn = (window.Ny && Ny.Sections && Ny.Sections.ItemsParts && typeof Ny.Sections.ItemsParts.perItemCardBox === 'function')
            ? Ny.Sections.ItemsParts.perItemCardBox
            : null;

          items.forEach(it => {
            const card = itemsContainer.querySelector(`.item-controls[data-id="${it.id}"]`);
            if (!card || card.querySelector('.per-item-card-box')) return;

            if (partsFn) {
              const html = partsFn(it, customization);
              if (html && typeof html === 'string') {
                // ç›´æ¥æ’å…¥ perItemCardBox è¿”å›çš„å®Œæ•´èŠ‚ç‚¹ï¼ˆå†…å« per-item-card-box ç±»ï¼‰
                card.insertAdjacentHTML('beforeend', html);
              }
            } else {
              // å®‰å…¨å›é€€ï¼šä»… URL + é˜´å½±
              const csEnabled = !!it.cardShadowEnable;
              const csStrength = isFinite(it.cardShadowStrength) ? it.cardShadowStrength : (customization.itemCardShadowStrength || 0.30);
              const urlVal = esc(it.cardUrl || '');
              const box = document.createElement('div');
              box.className = 'inline-subbox per-item-card-box';
              box.innerHTML = `
                <div class="form-box-title">å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±ï¼ˆå±€éƒ¨è¦†ç›–ï¼‰</div>
                <div class="control-group">
                  <label>è‡ªå®šä¹‰ URL èƒŒæ™¯ï¼ˆç•™ç©ºåˆ™è·Ÿéšå…¨å±€ï¼‰</label>
                  <input type="url" value="${urlVal}" data-field="cardUrl" data-id="${it.id}" placeholder="https://example.com/card.png">
                </div>
                <div class="control-group">
                  <label style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" ${csEnabled ? 'checked' : ''} data-field="cardShadowEnable" data-id="${it.id}">
                    é˜´å½±ï¼ˆå±€éƒ¨ï¼‰
                  </label>
                  <div class="range-row" style="margin-top:6px;">
                    <label>å¼ºåº¦</label>
                    <input type="range" min="0" max="1" step="0.05" value="${csStrength}" ${csEnabled ? '' : 'disabled'} data-field="cardShadowStrength" data-id="${it.id}">
                    <span class="value-pill"><span>${Number(csStrength).toFixed(2)}</span></span>
                  </div>
                </div>
              `;
              card.appendChild(box);
            }
          });
        } else {
          // æ¸…ç†å·²æ³¨å…¥çš„å±€éƒ¨æ§åˆ¶
          itemsContainer.querySelectorAll('.per-item-card-box').forEach(n => n.remove());
        }
      } catch (_e) {}
    }

    function renderItemInputs(it) {
      if (it.type === 'text') {
        const vbw = isFinite(it.vbWidthPct) ? clamp(parseInt(it.vbWidthPct, 10) || 100, 40, 100) : (customization.valueBoxWidthPct || 100);
        const vbo = isFinite(it.vbOffsetPct) ? clamp(parseInt(it.vbOffsetPct, 10) || 0, -40, 40) : (customization.valueBoxOffsetPct || 0);
        const iol = isFinite(it.itemOffsetPct) ? clamp(parseInt(it.itemOffsetPct, 10) || 0, -40, 40) : (customization.itemOffsetPct || 0);
        const ior = isFinite(it.itemOffsetRightPct) ? clamp(parseInt(it.itemOffsetRightPct, 10) || 0, -40, 40) : (customization.itemOffsetRightPct || 0);
        return `
          <div class="control-group">
            <label>æ ‡ç­¾</label>
            <input type="text" value="${esc(it.label || '')}" data-field="label" data-id="${it.id}">
          </div>
          <div class="control-group">
            <label>å€¼</label>
            <input type="text" value="${esc(it.value || '')}" data-field="value" data-id="${it.id}">
          </div>
          <div class="inline-subbox">
            <div class="form-box-title">å±€éƒ¨å€¼æ¡†ä¸åç§»</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="range-row">
                <label>å®½åº¦(ç›¸å¯¹æœ€å¤§ %)</label>
                <input type="range" min="40" max="100" step="1" value="${vbw}" data-field="vbWidthPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbw}</span>%</span>
              </div>
              <div class="range-row">
                <label>å€¼æ¡†æ°´å¹³åç§»(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${vbo}" data-field="vbOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbo}</span>%</span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;">
              <div class="range-row">
                <label>æ•´ä½“æ°´å¹³åç§»(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${iol}" data-field="itemOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${iol}</span>%</span>
              </div>
              <div class="range-row">
                <label>æ•´ä½“å³ä¾§åç§»(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${ior}" data-field="itemOffsetRightPct" data-id="${it.id}">
                <span class="value-pill"><span>${ior}</span>%</span>
              </div>
            </div>
          </div>
        `;
      }
      if (it.type === 'longtext') {
        const lh = (typeof it.ltLineHeight === 'number' ? it.ltLineHeight : 1.6);
        const eff = it.ltEffect || 'none';
        return `
          <div class="control-group">
            <label>æ ‡ç­¾</label>
            <input type="text" value="${esc(it.label || '')}" data-field="label" data-id="${it.id}">
          </div>
          <div class="control-group">
            <label>é•¿æ–‡å­—</label>
            <textarea rows="4" data-field="value" data-id="${it.id}" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-control);color:var(--text-primary);">${esc(it.value || '')}</textarea>
          </div>
          <div class="inline-subbox collapsible lt-typo-box">
            <div class="form-box-title" tabindex="0">æ’ç‰ˆä¸åŠ¨ç”»</div>
            <div class="control-group">
              <label>è¡Œé—´è·</label>
              <div class="range-row">
                <input type="range" min="1" max="3" step="0.05" value="${lh}" data-field="ltLineHeight" data-id="${it.id}">
                <span class="value-pill"><span>${(typeof lh === 'number' && lh.toFixed ? lh.toFixed(2) : lh)}</span></span>
              </div>
            </div>

            <div class="control-group">
              <label style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" ${it.ltSkipFirstLine ? 'checked' : ''} data-field="ltSkipFirstLine" data-id="${it.id}">
                ç©ºå‡ºé¦–è¡Œ
              </label>
              <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">å¯ç”¨åï¼Œåœ¨é¦–è¡Œé¢„ç•™ä¸€è¡Œé«˜åº¦ï¼Œä¸æ¸²æŸ“æ–‡å­—ã€‚</p>
            </div>

            <div class="control-group">
              <label>é¦–å­—ç¼©è¿›(px)</label>
              <input type="number" min="0" step="1" value="${isFinite(it.ltFirstIndentPx)?Number(it.ltFirstIndentPx):0}" data-field="ltFirstIndentPx" data-id="${it.id}" style="width:100px;">
            </div>

            <div class="control-group">
              <label>é•¿æ–‡å­—ä¸è¾¹æ¡†çš„è·ç¦»ï¼ˆå†…è¾¹è·ï¼Œpxï¼‰</label>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">ä¸Š</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadTopPx)?Number(it.ltPadTopPx):0}" data-field="ltPadTopPx" data-id="${it.id}" style="width:100%;">
                </div>
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">å³</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadRightPx)?Number(it.ltPadRightPx):0}" data-field="ltPadRightPx" data-id="${it.id}" style="width:100%;">
                </div>
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">ä¸‹</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadBottomPx)?Number(it.ltPadBottomPx):0}" data-field="ltPadBottomPx" data-id="${it.id}" style="width:100%;">
                </div>
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">å·¦</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadLeftPx)?Number(it.ltPadLeftPx):0}" data-field="ltPadLeftPx" data-id="${it.id}" style="width:100%;">
                </div>
              </div>
            </div>

            <div class="control-group">
              <label>åŠ¨ç”»ç‰¹æ•ˆ</label>
              <select data-field="ltEffect" data-id="${it.id}">
                <option value="none"${eff==='none'?' selected':''}>æ— </option>
                <option value="typewriter"${eff==='typewriter'?' selected':''}>æ‰“å­—æœº</option>
                <option value="fade"${eff==='fade'?' selected':''}>æ·¡å…¥</option>
                <option value="slide"${eff==='slide'?' selected':''}>ä¸Šæ»‘</option>
              </select>
            </div>

            <div class="control-group" data-role="lt-typewriter-options" style="${eff==='typewriter'?'':'display:none;'}">
              <label>æ‰“å­—æœºè®¾ç½®</label>
              <div class="range-row">
                <label>é€Ÿåº¦(æ¯«ç§’/å­—ç¬¦)</label>
                <input type="range" min="5" max="200" step="1" value="${isFinite(it.ltTwSpeedMs)?Number(it.ltTwSpeedMs):18}" data-field="ltTwSpeedMs" data-id="${it.id}">
                <span class="value-pill"><span>${isFinite(it.ltTwSpeedMs)?Number(it.ltTwSpeedMs):18}</span></span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
                <label style="min-width:100px;">å¼€å§‹å»¶è¿Ÿ(ms)</label>
                <input type="number" min="0" step="50" value="${isFinite(it.ltTwDelayMs)?Number(it.ltTwDelayMs):0}" data-field="ltTwDelayMs" data-id="${it.id}" style="width:120px;">
              </div>
              <div class="control-group" style="margin-top:6px;">
                <label style="display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" ${it.ltTwCaret !== false ? 'checked' : ''} data-field="ltTwCaret" data-id="${it.id}">
                  æ˜¾ç¤ºå…‰æ ‡é—ªçƒ
                </label>
              </div>
            </div>
          </div>
        `;
      }
      if (it.type === 'bar') {
        const p = clamp(parseInt(it.percent ?? 0, 10) || 0, 0, 100);
        const accent = esc(customization.section2BarColor || customization.primaryColor);
        const vbw = isFinite(it.vbWidthPct) ? clamp(parseInt(it.vbWidthPct, 10) || 100, 40, 100) : (customization.valueBoxWidthPct || 100);
        const vbo = isFinite(it.vbOffsetPct) ? clamp(parseInt(it.vbOffsetPct, 10) || 0, -40, 40) : (customization.valueBoxOffsetPct || 0);
        const iol = isFinite(it.itemOffsetPct) ? clamp(parseInt(it.itemOffsetPct, 10) || 0, -40, 40) : (customization.itemOffsetPct || 0);
        const ior = isFinite(it.itemOffsetRightPct) ? clamp(parseInt(it.itemOffsetRightPct, 10) || 0, -40, 40) : (customization.itemOffsetRightPct || 0);
        return `
          <div class="control-group">
            <label>æ ‡ç­¾</label>
            <input type="text" value="${esc(it.label || '')}" data-field="label" data-id="${it.id}">
          </div>
          <div class="control-group">
            <label>ç™¾åˆ†æ¯”</label>
            <div class="range-row">
              <input type="range" min="0" max="100" step="1" value="${p}" data-field="percent" data-id="${it.id}" style="accent-color:${accent}">
              <span class="value-pill"><span>${p}%</span></span>
            </div>
          </div>
          <div class="inline-subbox">
            <div class="form-box-title">å±€éƒ¨å€¼æ¡†ä¸åç§»</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="range-row">
                <label>å®½åº¦(ç›¸å¯¹æœ€å¤§ %)</label>
                <input type="range" min="40" max="100" step="1" value="${vbw}" data-field="vbWidthPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbw}</span>%</span>
              </div>
              <div class="range-row">
                <label>å€¼æ¡†æ°´å¹³åç§»(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${vbo}" data-field="vbOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbo}</span>%</span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;">
              <div class="range-row">
                <label>æ•´ä½“æ°´å¹³åç§»(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${iol}" data-field="itemOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${iol}</span>%</span>
              </div>
              <div class="range-row">
                <label>æ•´ä½“å³ä¾§åç§»(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${ior}" data-field="itemOffsetRightPct" data-id="${it.id}">
                <span class="value-pill"><span>${ior}</span>%</span>
              </div>
            </div>
          </div>
        `;
      }
      // divider / row æ— æ§ä»¶
      return '';
    }

    // -----------------------
    // åŠ¨ç”»
    // -----------------------
    function applyAnimation() {
      const wrapper = previewContainer.querySelector('.status-preview-wrapper');
      if (!wrapper) return;
      // åŸºæœ¬å˜é‡
      wrapper.style.setProperty('--anim-speed', `${animSpeed}s`);
      wrapper.style.setProperty('--anim-intensity', `${animIntensity}`);
      // å…‰æ™•å˜é‡ï¼ˆè·Ÿéšè‡ªå®šä¹‰æˆ–ä¸»/è¾…è‰²ï¼‰
      try {
        const a = (customization.glowColorA && customization.glowColorA.trim()) ? customization.glowColorA : (customization.primaryColor || '#85a6f8');
        const b = (customization.glowColorB && customization.glowColorB.trim()) ? customization.glowColorB : (customization.secondaryColor || '#95b3e8');
        const gs = (typeof customization.glowSpeed === 'number' ? customization.glowSpeed : 1.0);
        wrapper.style.setProperty('--glow-color-a', a);
        wrapper.style.setProperty('--glow-color-b', b);
        wrapper.style.setProperty('--glow-speed', `${gs}s`);
      } catch(_e){}
      // æ¸…ç†æ‰€æœ‰åŠ¨ç”»ç±»
      wrapper.classList.remove('anim-none','anim-fade-in','anim-slide-up','anim-pulse','anim-neon-glow','anim-shimmer','anim-tilt-3d','anim-breathe','anim-gloss');
      // æ˜ å°„ï¼šè¿›å…¥åŠ¨ç”»ä¸é•¿é©»åŠ¨ç”»
      const enterMap = { none:'', fade:'anim-fade-in', slide:'anim-slide-up' };
      const loopMap  = { none:'', pulse:'anim-pulse', neon:'anim-neon-glow', shimmer:'anim-shimmer', tilt3d:'anim-tilt-3d', breathe:'anim-breathe', gloss:'anim-gloss' };
      const enterCls = enterMap[currentEnterAnimation] || '';
      const loopCls  = loopMap[currentLoopAnimation]  || '';
      if (enterCls) wrapper.classList.add(enterCls);
      if (loopCls)  wrapper.classList.add(loopCls);
    }

    // -----------------------
    // äº‹ä»¶ç»‘å®š
    // -----------------------
    // ä¸»é¢˜åˆ‡æ¢
    themeOptions.forEach(option => {
      option.addEventListener('click', () => {
        const nextTheme = option.dataset.theme;
        if (!nextTheme || nextTheme === currentTheme) return;
        // è‹¥å½“å‰ä¸»é¢˜ä¸ªæ€§åŒ–ä¸é»˜è®¤å€¼ä¸ä¸€è‡´ï¼Œåˆ™æç¤º
        const modified = isCustomizationModified(currentTheme);
        if (modified) {
          const ok = window.confirm('åˆ‡æ¢æ¨¡æ¿å°†æ¸…ç©ºå½“å‰æ¨¡æ¿çš„é¢œè‰²ç­‰ä¸ªæ€§åŒ–è®¾ç½®ï¼Œå¹¶åº”ç”¨æ–°æ¨¡æ¿é»˜è®¤é…ç½®ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ');
          if (!ok) return;
        }
        themeOptions.forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
        currentTheme = nextTheme;
        // åº”ç”¨æ–°æ¨¡æ¿é»˜è®¤å€¼ï¼ˆé¢œè‰²/å­—ä½“/åœ†è§’/åˆ†å‰²çº¿/èƒŒæ™¯æ¨¡å¼ï¼‰
        applyThemeDefaults(currentTheme);
        updateAddItemOptionVisibility();
        renderPreview();
      });
    });

    // æ ‡é¢˜
    titleInput.addEventListener('input', (e) => {
      currentTitle = e.target.value;
      const w = document.getElementById('xml-wrapper-name');
      if (w) w.value = toWrapperNameFromTitle(currentTitle);
      renderPreview();
    });

    // åŠ¨ç”»
    if (enterAnimSelect) {
      enterAnimSelect.addEventListener('change', (e) => {
        currentEnterAnimation = e.target.value;
        // ç»Ÿä¸€åŠ¨ç”»æè¿°ï¼Œé¿å…æœªå®šä¹‰å˜é‡å¯¼è‡´ç‚¹å‡»å´©æºƒ
        currentAnimation = (currentEnterAnimation !== 'none' || currentLoopAnimation !== 'none')
          ? `${currentEnterAnimation}+${currentLoopAnimation}`
          : 'none';
        renderPreview();
      });
    }
    if (loopAnimSelect) {
      loopAnimSelect.addEventListener('change', (e) => {
        currentLoopAnimation = e.target.value;
        // ç»Ÿä¸€åŠ¨ç”»æè¿°ï¼Œé¿å…æœªå®šä¹‰å˜é‡å¯¼è‡´ç‚¹å‡»å´©æºƒ
        currentAnimation = (currentEnterAnimation !== 'none' || currentLoopAnimation !== 'none')
          ? `${currentEnterAnimation}+${currentLoopAnimation}`
          : 'none';
        renderPreview();
      });
    }
    animSpeedRange.addEventListener('input', (e) => {
      animSpeed = parseFloat(e.target.value);
      speedValue.textContent = animSpeed.toFixed(1);
      applyAnimation();
    });
    animIntensityRange.addEventListener('input', (e) => {
      animIntensity = parseFloat(e.target.value);
      intensityValue.textContent = animIntensity.toFixed(2);
      applyAnimation();
    });

    // æ·»åŠ é¡¹ç›®
    if (addItemBtn) {
      addItemBtn.addEventListener('click', () => {
        const t = addItemSelect ? addItemSelect.value : 'text';
        let newItem;
        if (t === 'text') {
          newItem = { id: genId(), type: 'text', label: 'æ ‡ç­¾', value: 'å€¼' };
        } else if (t === 'longtext') {
          newItem = {
            id: genId(),
            type: 'longtext',
            label: 'è¯´æ˜',
            value: 'åœ¨æ­¤å¡«å†™é•¿æ®µæ–‡å­—â€¦',
            ltLineHeight: 1.6,
            ltEffect: 'none',
            ltSkipFirstLine: false,
            ltFirstIndentPx: 0,
            ltPadTopPx: 0,
            ltPadRightPx: 0,
            ltPadBottomPx: 0,
            ltPadLeftPx: 0,
            ltTwSpeedMs: 18,
            ltTwDelayMs: 0,
            ltTwCaret: true
          };
        } else if (t === 'bar') {
          newItem = { id: genId(), type: 'bar', label: 'è¿›åº¦', percent: 50 };
        } else if (t === 'divider') {
          newItem = { id: genId(), type: 'divider' };
        } else {
          newItem = { id: genId(), type: 'text', label: 'æ ‡ç­¾', value: 'å€¼' };
        }
        items.push(newItem);
        renderItemsEditor();
        renderPreview();
        console.log('[ADD]', snapshot());
      });
    } else {
      console.warn('[ui] addItemBtn not found; skip binding');
    }

    // ç¼–è¾‘/åˆ é™¤/æ’åº ä¸ æŠ˜å ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
    itemsContainer.addEventListener('click', (e) => {
      // æŠ˜å /å±•å¼€ï¼šæœ€å³ä¾§å°ä¸‰è§’
      const tog = e.target.closest('.item-collapse-toggle');
      if (tog) {
        const card = tog.closest('.item-controls');
        if (card) card.classList.toggle('collapsed');
        return;
      }

      // å­ç»„æŠ˜å ï¼šç‚¹å‡»â€œæ’ç‰ˆä¸åŠ¨ç”»â€å­æ¡†æ ‡é¢˜æŠ˜å /å±•å¼€
      const subTitle = e.target.closest('.inline-subbox .form-box-title');
      if (subTitle) {
        const box = subTitle.closest('.inline-subbox');
        if (box && box.classList.contains('collapsible')) {
          box.classList.toggle('collapsed');
        }
        return;
      }

      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      const idx = items.findIndex(it => it.id === id);
      if (idx === -1) return;

      if (action === 'delete') {
        items.splice(idx, 1);
        renderItemsEditor();
        renderPreview();
        console.log('[DELETE]', id, snapshot());
      } else if (action === 'up') {
        if (idx > 0) {
          [items[idx - 1], items[idx]] = [items[idx], items[idx - 1]];
          renderItemsEditor();
          renderPreview();
          console.log('[MOVE_UP]', id, snapshot());
        }
      } else if (action === 'down') {
        if (idx < items.length - 1) {
          [items[idx], items[idx + 1]] = [items[idx + 1], items[idx]];
          renderItemsEditor();
          renderPreview();
          console.log('[MOVE_DOWN]', id, snapshot());
        }
      }
    });

    // é”®ç›˜å¯è®¿é—®æ€§ï¼šåœ¨å­æ¡†æ ‡é¢˜ä¸ŠæŒ‰ Enter/Space æŠ˜å /å±•å¼€
    itemsContainer.addEventListener('keydown', (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('form-box-title')) {
        const box = t.closest('.inline-subbox.collapsible');
        if (box && (e.key === 'Enter' || e.key === ' ')) {
          e.preventDefault();
          box.classList.toggle('collapsed');
        }
      }
    });

    itemsContainer.addEventListener('input', (e) => {
      const field = e.target.dataset.field;
      if (!field) return;
      const id = e.target.dataset.id;
      const item = items.find(it => it.id === id);
      if (!item) return;
     
      if (field === 'label') {
        item.label = e.target.value;
        // å³æ—¶åŒæ­¥æœ¬é¡¹æ ‡é¢˜ï¼Œé¿å…ç­‰å¾…æ•´è¡¨é‡ç»˜
        try {
          const card = e.target.closest('.item-controls');
          const hdr = card && card.querySelector('.item-header > span');
          const idx2 = items.findIndex(x => x && x.id === item.id);
          const tn = typeName(item.type);
          const tLabel = (item.label && item.label.trim()) ? item.label : tn;
          if (hdr) hdr.textContent = (idx2 >= 0 ? (idx2 + 1) + '. ' : '') + tLabel + ' (' + tn + ')';
        } catch(_e){}
      } else if (field === 'value') {
        item.value = e.target.value;
      } else if (field === 'percent') {
        item.percent = clamp(parseInt(e.target.value, 10) || 0, 0, 100);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = item.percent + '%';
      } else if (field === 'labelColor') {
        item.labelColor = e.target.value;
      } else if (field === 'valueColor') {
        item.valueColor = e.target.value;
      } else if (field === 'barColor') {
        item.barColor = e.target.value;
      } else if (field === 'ltLineHeight') {
        item.ltLineHeight = clamp(parseFloat(e.target.value) || 1.6, 1, 3);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = item.ltLineHeight.toFixed(2);
      } else if (field === 'ltEffect') {
        item.ltEffect = e.target.value;
      } else if (field === 'ltFirstIndentPx') {
        item.ltFirstIndentPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadTopPx') {
        item.ltPadTopPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadRightPx') {
        item.ltPadRightPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadBottomPx') {
        item.ltPadBottomPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadLeftPx') {
        item.ltPadLeftPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'vbWidthPct') {
        item.vbWidthPct = clamp(parseInt(e.target.value, 10) || 100, 40, 100);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.vbWidthPct);
      } else if (field === 'vbOffsetPct') {
        item.vbOffsetPct = clamp(parseInt(e.target.value, 10) || 0, -40, 40);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.vbOffsetPct);
      } else if (field === 'itemOffsetPct') {
        item.itemOffsetPct = clamp(parseInt(e.target.value, 10) || 0, -40, 40);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.itemOffsetPct);
      } else if (field === 'itemOffsetRightPct') {
        item.itemOffsetRightPct = clamp(parseInt(e.target.value, 10) || 0, -40, 40);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.itemOffsetRightPct);
      } else if (field === 'cardBgColor') {
        item.cardBgColor = e.target.value;
      } else if (field === 'cardBgColorCode') {
        item.cardBgColor = e.target.value;
        const v = e.target.value;
        const colorInp = e.target.closest('.control-group')?.querySelector('input[type="color"][data-field="cardBgColor"]');
        if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && colorInp) colorInp.value = v;
      } else if (field === 'cardGradStart') {
        item.cardGradStart = e.target.value;
      } else if (field === 'cardGradEnd') {
        item.cardGradEnd = e.target.value;
      } else if (field === 'cardGradAngle') {
        item.cardGradAngle = clamp(parseInt(e.target.value, 10) || 135, 0, 360);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.cardGradAngle);
      } else if (field === 'cardImageUrl') {
        item.cardImageUrl = e.target.value;
      } else if (field === 'cardUrl') {
        item.cardUrl = e.target.value;
      } else if (field === 'cardShadowStrength') {
        item.cardShadowStrength = clamp(parseFloat(e.target.value) || 0.30, 0, 1);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = Number(item.cardShadowStrength).toFixed(2);
      } else if (field === 'ltTwSpeedMs') {
        item.ltTwSpeedMs = clamp(parseInt(e.target.value, 10) || 18, 5, 200);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.ltTwSpeedMs);
      } else if (field === 'ltTwDelayMs') {
        item.ltTwDelayMs = Math.max(0, parseInt(e.target.value, 10) || 0);
      }
      renderPreview();
      console.log('[UPDATE]', { id, field, value: e.target.value }, snapshot());
    });
    
    // é¢å¤–ï¼šå±€éƒ¨å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±çš„é€‰æ‹©/å¼€å…³
    itemsContainer.addEventListener('change', (e) => {
      const field = e.target.dataset.field;
      if (!field) return;
      const id = e.target.dataset.id;
      const item = items.find(it => it.id === id);
      if (!item) return;
      if (field === 'ltSkipFirstLine') {
        item.ltSkipFirstLine = !!e.target.checked;
      } else if (field === 'cardShadowEnable') {
        item.cardShadowEnable = !!e.target.checked;
        // å¯ç”¨/ç¦ç”¨å¼ºåº¦æ»‘æ¡
        try {
          const range = e.target.closest('.control-group')?.querySelector('input[type="range"][data-field="cardShadowStrength"]');
          if (range) range.disabled = !item.cardShadowEnable;
        } catch (_e) {}
      } else if (field === 'cardBgMode') {
        item.cardBgMode = e.target.value || '';
        const root = e.target.closest('.inline-subbox') || e.target.closest('.item-controls');
        if (root) {
          const show = (q, vis) => { const el = root.querySelector(q); if (el) el.style.display = vis ? '' : 'none'; };
          show('[data-role="card-bg-color"]', item.cardBgMode === 'color');
          show('[data-role="card-bg-gradient"]', item.cardBgMode === 'gradient');
          show('[data-role="card-bg-image"]', item.cardBgMode === 'image');
          show('[data-role="card-bg-url"]', item.cardBgMode === 'url');
        }
      } else if (field === 'ltTwCaret') {
        item.ltTwCaret = !!e.target.checked;
      } else if (field === 'ltEffect') {
        item.ltEffect = e.target.value;
        const root = e.target.closest('.inline-subbox') || e.target.closest('.item-controls');
        if (root) {
          const box = root.querySelector('[data-role="lt-typewriter-options"]');
          if (box) box.style.display = (item.ltEffect === 'typewriter') ? '' : 'none';
        }
      }
      renderPreview();
      console.log('[UPDATE:change]', { id, field, value: e.target.value }, snapshot());
    });

// ===== æ¨¡æ¿ä¸ªæ€§åŒ–ï¼šçŠ¶æ€ä¸è”åŠ¨ï¼ˆèƒŒæ™¯ / å›¾æ ‡ / å­—ä½“ / é¢œè‰² / åœ†è§’ / å¸ƒå±€ï¼‰ =====
const fontFamilySelect = document.getElementById('font-family-select');
const primaryColorInput = document.getElementById('primary-color-input');
const secondaryColorInput = document.getElementById('secondary-color-input');
const primaryColorCodeInput = document.getElementById('primary-color-code-input');
const secondaryColorCodeInput = document.getElementById('secondary-color-code-input');
const borderRadiusRange = document.getElementById('border-radius-range');
const radiusValue = document.getElementById('radius-value');

const bgModeSelect = document.getElementById('bg-mode-select');
const bgColorInput = document.getElementById('bg-color-input');
const bgColorCodeInput = document.getElementById('bg-color-code-input');
const bgGradientStartColorInput = document.getElementById('bg-gradient-start-color-input');
const bgGradientStartCodeInput = document.getElementById('bg-gradient-start-code-input');
const bgGradientEndColorInput = document.getElementById('bg-gradient-end-color-input');
const bgGradientEndCodeInput = document.getElementById('bg-gradient-end-code-input');
const bgGradientStyleSelect = document.getElementById('bg-gradient-style-select');
const bgGradientAngleRange = document.getElementById('bg-gradient-angle-range');
const bgGradientAngleValue = document.getElementById('bg-gradient-angle-value');
const bgGradientDirectionSelect = document.getElementById('bg-gradient-direction-select');
const bgImageUrlInput = document.getElementById('bg-image-url');


const iconModeSelect = document.getElementById('icon-mode-select');
const iconBuiltinSelect = document.getElementById('icon-built-in-select');
const iconUrlInput = document.getElementById('icon-url-input');
const iconSizeRange = document.getElementById('icon-size-range');
const iconSizeValue = document.getElementById('icon-size-value');
const iconPositionSelect = document.getElementById('icon-position-select');

const layoutSelect = document.getElementById('layout-select');
const letterSpacingRange = document.getElementById('letter-spacing-range');
const letterSpacingValue = document.getElementById('letter-spacing-value');
const lineHeightRange = document.getElementById('line-height-range');
const lineHeightValue = document.getElementById('line-height-value');
const opacityRange = document.getElementById('opacity-range');
const opacityValue = document.getElementById('opacity-value');
const dividerStyleSelect = document.getElementById('divider-style-select');
const barStyleSelect = document.getElementById('bar-style-select');
const barAnimationSelect = document.getElementById('bar-animation-select');
const percentDisplaySelect = document.getElementById('percent-display-select');
const longtextLineHeightRange = document.getElementById('longtext-line-height-range');
const longtextLineHeightValue = document.getElementById('longtext-line-height-value');
const longtextEffectSelect = document.getElementById('longtext-effect-select');

/* åŒåˆ—è®¾ç½®æ§ä»¶ */
const twoColSettingsGroup = document.getElementById('two-col-settings');
const twoColLabelPctRange = document.getElementById('two-col-label-pct-range');
const twoColLabelPctValue = document.getElementById('two-col-label-pct-value');
const twoColGapRange = document.getElementById('two-col-gap-range');
const twoColGapValue = document.getElementById('two-col-gap-value');
/* å…‰æ™•è®¾ç½®æ§ä»¶ */
const glowColorAInput = document.getElementById('glow-color-a-input');
const glowColorACodeInput = document.getElementById('glow-color-a-code-input');
const glowColorBInput = document.getElementById('glow-color-b-input');
const glowColorBCodeInput = document.getElementById('glow-color-b-code-input');
const glowSpeedRange = document.getElementById('glow-speed-range');
const glowSpeedValue = document.getElementById('glow-speed-value');

// æ–°å¢ï¼šå€¼æ¡†å®½åº¦/ä½ç½® ä¸ é¡¹ç›®æ•´ä½“åç§»/é˜´å½±ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰
const valueBoxWidthPctRange = document.getElementById('value-box-width-pct-range');
const valueBoxWidthPctValue = document.getElementById('value-box-width-pct-value');
const valueBoxOffsetPctRange = document.getElementById('value-box-offset-pct-range');
const valueBoxOffsetPctValue = document.getElementById('value-box-offset-pct-value');

// æ–°å¢ï¼šæ ‡ç­¾/å€¼å æ¯”ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰
const labelValueLabelPctRange = document.getElementById('label-value-label-pct-range');
const labelValueLabelPctValue = document.getElementById('label-value-label-pct-value');
const labelValueValuePctValue = document.getElementById('label-value-value-pct-value');

const itemOffsetPctRange = document.getElementById('item-offset-pct-range');
const itemOffsetPctValue = document.getElementById('item-offset-pct-value');
const itemOffsetRightPctRange = document.getElementById('item-offset-right-pct-range');
const itemOffsetRightPctValue = document.getElementById('item-offset-right-pct-value');

// é¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±ï¼ˆå…¨å±€+å±€éƒ¨ï¼‰
const itemCardPerItemToggle = document.getElementById('item-bg-shadow-per-item-toggle');
const itemCardBgModeSelect = document.getElementById('item-card-bg-mode-select');
const itemCardBgColorInput = document.getElementById('item-card-bg-color-input');
const itemCardBgColorCodeInput = document.getElementById('item-card-bg-color-code-input');
const itemCardGradStartInput = document.getElementById('item-card-grad-start-color-input');
const itemCardGradStartCodeInput = document.getElementById('item-card-grad-start-code-input');
const itemCardGradEndInput = document.getElementById('item-card-grad-end-color-input');
const itemCardGradEndCodeInput = document.getElementById('item-card-grad-end-code-input');
const itemCardGradAngleRange = document.getElementById('item-card-grad-angle-range');
const itemCardGradAngleValue = document.getElementById('item-card-grad-angle-value');
const itemCardBgImageUrlInput = document.getElementById('item-card-bg-image-url');
const itemCardBgUrlInput = document.getElementById('item-card-bg-url-input');
const itemCardShadowEnableCheckbox = document.getElementById('item-card-shadow-enable');
const itemCardShadowStrengthRange = document.getElementById('item-card-shadow-strength-range');
const itemCardShadowStrengthValue = document.getElementById('item-card-shadow-strength-value');

const itemCardBgColorGroup = document.getElementById('item-card-bg-color-group');
const itemCardBgGradientGroup = document.getElementById('item-card-bg-gradient-group');
const itemCardBgImageGroup = document.getElementById('item-card-bg-image-group');
const itemCardBgUrlGroup = document.getElementById('item-card-bg-url-group');


// æ–°å¢ï¼šç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²æ§åˆ¶ï¼ˆä»…å½±å“â€œçŠ¶æ€é¡¹ç›®â€æ¸²æŸ“ï¼‰
const section2LabelColorInput = document.getElementById('section2-label-color-input');
const section2ValueColorInput = document.getElementById('section2-value-color-input');
const section2BarColorInput = document.getElementById('section2-bar-color-input');
const section2DividerColorInput = document.getElementById('section2-divider-color-input');
const section2LabelColorCodeInput = document.getElementById('section2-label-color-code-input');
const section2ValueColorCodeInput = document.getElementById('section2-value-color-code-input');
const section2BarColorCodeInput = document.getElementById('section2-bar-color-code-input');
const section2DividerColorCodeInput = document.getElementById('section2-divider-color-code-input');

// æ–°å¢ï¼šå…¨å±€æ ‡ç­¾/å€¼å­—ä½“ä¸æ ·å¼æ§åˆ¶
const globalLabelFontSelect = document.getElementById('global-label-font-select');
const globalValueFontSelect = document.getElementById('global-value-font-select');
const globalLabelWeightSelect = document.getElementById('global-label-weight-select');
const globalValueWeightSelect = document.getElementById('global-value-weight-select');
const globalLabelItalicCheckbox = document.getElementById('global-label-italic-checkbox');
const globalValueItalicCheckbox = document.getElementById('global-value-italic-checkbox');
const globalLabelUppercaseCheckbox = document.getElementById('global-label-uppercase-checkbox');
const globalValueUppercaseCheckbox = document.getElementById('global-value-uppercase-checkbox');
const globalLabelReflectCheckbox = document.getElementById('global-label-reflect-checkbox');
const globalValueReflectCheckbox = document.getElementById('global-value-reflect-checkbox');
const statusbarWidthRange = document.getElementById('statusbar-width-range');
const statusbarWidthValue = document.getElementById('statusbar-width-value');



// æ ‡é¢˜å­—å·ï¼ˆ1.5ä¸ªæ€§åŒ–ï¼‰
const titleEnabledCheckbox = document.getElementById('title-enabled-checkbox');
const titleFontSizeRange = document.getElementById('title-font-size-range');
const titleFontSizeValue = document.getElementById('title-font-size-value');

/* æ ‡é¢˜åŒºåŸŸè‡ªå®šä¹‰æ§ä»¶ */
const headerMinHeightRange = document.getElementById('header-min-height-range');
const headerMinHeightValue = document.getElementById('header-min-height-value');
const headerPaddingYRange = document.getElementById('header-padding-y-range');
const headerPaddingYValue = document.getElementById('header-padding-y-value');
const headerAlignSelect = document.getElementById('header-align-select');

const titleGapEnableCheckbox = document.getElementById('title-gap-enable');
const titleGapRange = document.getElementById('title-gap-range');
const titleGapValue = document.getElementById('title-gap-value');

const titleColorModeSelect = document.getElementById('title-color-mode-select');
const titleColorSolidGroup = document.getElementById('title-color-solid-group');
const titleColorSolidInput = document.getElementById('title-color-solid-input');
const titleColorSolidCodeInput = document.getElementById('title-color-solid-code-input');

const titleColorGradientGroup = document.getElementById('title-color-gradient-group');
const titleGradStartInput = document.getElementById('title-grad-start-input');
const titleGradStartCodeInput = document.getElementById('title-grad-start-code-input');
const titleGradEndInput = document.getElementById('title-grad-end-input');
const titleGradEndCodeInput = document.getElementById('title-grad-end-code-input');
const titleGradAngleRange = document.getElementById('title-grad-angle-range');
const titleGradAngleValue = document.getElementById('title-grad-angle-value');

const titleGlowEnableCheckbox = document.getElementById('title-glow-enable');
const titleGlowIntensityRange = document.getElementById('title-glow-intensity-range');
const titleGlowIntensityValue = document.getElementById('title-glow-intensity-value');

const titleShadowEnableCheckbox = document.getElementById('title-shadow-enable');
const titleShadowStrengthRange = document.getElementById('title-shadow-strength-range');
const titleShadowStrengthValue = document.getElementById('title-shadow-strength-value');

// æ ‡é¢˜é«˜çº§æ ·å¼æ§ä»¶
const titleWeightSelect = document.getElementById('title-weight-select');
const titleItalicCheckbox = document.getElementById('title-italic-checkbox');
const titleUppercaseCheckbox = document.getElementById('title-uppercase-checkbox');
const titleLetterSpacingRange = document.getElementById('title-letter-spacing-range');
const titleLetterSpacingValue = document.getElementById('title-letter-spacing-value');

// ä¸‹åˆ’çº¿
const titleUnderlineStyleSelect = document.getElementById('title-underline-style-select');
const titleUnderlineColorInput = document.getElementById('title-underline-color-input');
const titleUnderlineColorCodeInput = document.getElementById('title-underline-color-code-input');
const titleUnderlineThicknessRange = document.getElementById('title-underline-thickness-range');
const titleUnderlineThicknessValue = document.getElementById('title-underline-thickness-value');
const titleUnderlineOffsetRange = document.getElementById('title-underline-offset-range');
const titleUnderlineOffsetValue = document.getElementById('title-underline-offset-value');

// æ ‡é¢˜å¾½ç« èƒŒæ™¯
const titleBadgeEnableCheckbox = document.getElementById('title-badge-enable');
const titleBadgeColorInput = document.getElementById('title-badge-color-input');
const titleBadgeColorCodeInput = document.getElementById('title-badge-color-code-input');


// çŠ¶æ€é¡¹ç›®å­—å·ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰
const globalLabelFontSizeRange = document.getElementById('global-label-font-size-range');
const globalLabelFontSizeValue = document.getElementById('global-label-font-size-value');
const globalValueFontSizeRange = document.getElementById('global-value-font-size-range');
const globalValueFontSizeValue = document.getElementById('global-value-font-size-value');

/* æŠ˜å ä¸åŠ¨æ€æ˜¾éšï¼šèƒŒæ™¯ / å›¾æ ‡ æ§ä»¶åˆ†ç»„å¼•ç”¨ */
const iconModeGroup = document.getElementById('icon-mode-group');
const iconBuiltinGroup = document.getElementById('icon-built-in-group');
const iconUrlGroup = document.getElementById('icon-url-group');
const iconSizeGroup = document.getElementById('icon-size-group');
const iconPositionGroup = document.getElementById('icon-position-group');

const bgColorGroup = document.getElementById('bg-color-group');
const bgGradientGroup = document.getElementById('bg-gradient-group');
const bgImageGroup = document.getElementById('bg-image-group');
const bgLayersGroup = document.getElementById('bg-layers-group');
const bgComponentsGroup = document.getElementById('bg-components-group');
const bgLayersBox = document.getElementById('bg-layers-box');


/* å¤šå›¾å±‚/ç»„ä»¶æ§åˆ¶å¼•ç”¨ */
const btnAddColorLayer = document.getElementById('btn-add-color-layer');
const btnAddGradientLayer = document.getElementById('btn-add-gradient-layer');
const btnAddImageLayerUrl = document.getElementById('btn-add-image-layer-url');
const bgLayersList = document.getElementById('bg-layers-list');

const btnAddCompUrl = document.getElementById('btn-add-comp-url');
const bgCompDragToggle = document.getElementById('bg-comp-drag-toggle');
const bgComponentsList = document.getElementById('bg-components-list');

/* èƒŒæ™¯ç±»å‹æ˜¾éšï¼šä»…æ˜¾ç¤ºæ‰€é€‰ç±»å‹çš„è®¾ç½® */
function updateBgFieldsVisibility() {
  try {
    const mode = bgModeSelect?.value || 'theme';
    const show = (el, visible) => { if (el) el.style.display = visible ? '' : 'none'; };
    show(bgColorGroup, mode === 'color');
    show(bgGradientGroup, mode === 'gradient');
    show(bgImageGroup, mode === 'image');
    show(bgLayersBox, mode === 'layers');
    show(bgLayersGroup, mode === 'layers');
    show(bgComponentsGroup, mode === 'layers');
    if (mode === 'theme' || mode === 'none') {
      show(bgColorGroup, false);
      show(bgGradientGroup, false);
      show(bgImageGroup, false);
      show(bgLayersBox, false);
      show(bgLayersGroup, false);
      show(bgComponentsGroup, false);
    }
  } catch (err) { console.warn('[ui] updateBgFieldsVisibility error', err); }
}
function updateIconFieldsVisibility() {
  try {
    const mode = iconModeSelect?.value || 'none';
    const show = (el, visible) => { if (el) el.style.display = visible ? '' : 'none'; };
    if (mode === 'none') {
      show(iconBuiltinGroup, false);
      show(iconUrlGroup, false);
      show(iconSizeGroup, false);
      show(iconPositionGroup, false);
    } else if (mode === 'built-in') {
      show(iconBuiltinGroup, true);
      show(iconUrlGroup, false);
      show(iconSizeGroup, true);
      show(iconPositionGroup, true);
    } else {
      show(iconBuiltinGroup, false);
      show(iconUrlGroup, true);
      show(iconSizeGroup, true);
      show(iconPositionGroup, true);
    }
  } catch (err) { console.warn('[ui] updateIconFieldsVisibility error', err); }
}


/* åŒåˆ—è®¾ç½®æ˜¾éšï¼šä»…å½“å¸ƒå±€é€‰æ‹©â€œåŒåˆ—â€æ—¶æ˜¾ç¤ºè°ƒèŠ‚é¢æ¿ */
function updateTwoColumnFieldsVisibility() {
  try {
    const layout = layoutSelect?.value || 'label-left';
    if (twoColSettingsGroup) {
      twoColSettingsGroup.style.display = (layout === 'two-column') ? '' : 'none';
    }
  } catch (err) { console.warn('[ui] updateTwoColumnFieldsVisibility error', err); }
}

/* é¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±ï¼šå…¨å±€å­—æ®µæ˜¾éšè”åŠ¨ï¼ˆæ ¹æ®â€œèƒŒæ™¯æ¨¡å¼ï¼ˆå…¨å±€ï¼‰â€é€‰æ‹©æ˜¾ç¤ºå¯¹åº”é…ç½®å—ï¼‰ */
function updateItemCardBgFieldsVisibility() {
  try {
    const mode = itemCardBgModeSelect?.value || 'theme';
    const show = (el, vis) => { if (el) el.style.display = vis ? '' : 'none'; };
    show(itemCardBgColorGroup, mode === 'color');
    show(itemCardBgGradientGroup, mode === 'gradient');
    show(itemCardBgImageGroup, mode === 'image');
    show(itemCardBgUrlGroup, mode === 'url');
    if (mode === 'theme' || mode === 'none') {
      show(itemCardBgColorGroup, false);
      show(itemCardBgGradientGroup, false);
      show(itemCardBgImageGroup, false);
      show(itemCardBgUrlGroup, false);
    }
    if (itemCardShadowStrengthRange) {
      itemCardShadowStrengthRange.disabled = !(itemCardShadowEnableCheckbox?.checked);
    }
  } catch (err) { console.warn('[ui] updateItemCardBgFieldsVisibility error', err); }
}

/* æŠ˜å åŠŸèƒ½ï¼š1ã€1.5ã€2ã€3 éƒ¨åˆ†å‡å¯æŠ˜å  */
function setupCollapsibleSections() {
  try {
    document.querySelectorAll('.control-section.collapsible > h3').forEach(h3 => {
      const sec = h3.parentElement;
      h3.addEventListener('click', () => {
        sec.classList.toggle('collapsed');
      });
    });
  } catch (err) { console.warn('[ui] setupCollapsibleSections error', err); }
}

/* æ–°å¢ï¼šåŠ¨ç”»å åŠ æ§ä»¶ */
const starEnabledCheckbox = document.getElementById('star-enabled');
const starFrequencyRange = document.getElementById('star-frequency-range');
const starFrequencyValue = document.getElementById('star-frequency-value');
const starDensityRange = document.getElementById('star-density-range');
const starDensityValue = document.getElementById('star-density-value');
const starColorInput = document.getElementById('star-color-input');
const starColorCodeInput = document.getElementById('star-color-code-input');

const sparkleEnabledCheckbox = document.getElementById('sparkle-enabled');
const sparkleDirectionSelect = document.getElementById('sparkle-direction-select');
const sparkleFrequencyRange = document.getElementById('sparkle-frequency-range');
const sparkleFrequencyValue = document.getElementById('sparkle-frequency-value');
const sparkleDensityRange = document.getElementById('sparkle-density-range');
const sparkleDensityValue = document.getElementById('sparkle-density-value');
const sparkleColorInput = document.getElementById('sparkle-color-input');
const sparkleColorCodeInput = document.getElementById('sparkle-color-code-input');
const sparkleGlowCheckbox = document.getElementById('sparkle-glow-checkbox');

const petalEnabledCheckbox = document.getElementById('petal-enabled');
const petalFrequencyRange = document.getElementById('petal-frequency-range');
const petalFrequencyValue = document.getElementById('petal-frequency-value');
const petalDensityRange = document.getElementById('petal-density-range');
const petalDensityValue = document.getElementById('petal-density-value');
const petalIconModeSelect = document.getElementById('petal-icon-mode-select');
const petalIconBuiltinSelect = document.getElementById('petal-icon-built-in-select');
const petalIconUrlInput = document.getElementById('petal-icon-url-input');

// ä¸»é¢˜é»˜è®¤é…ç½®ï¼ˆæœ€ä½³é…è‰²ï¼‰
const themeDefaults = {
  'theme-mystic-noir':        { fontFamily: 'Georgia, Songti SC, serif',                                       primaryColor: '#c8cbd2', secondaryColor: '#d6d6d6', radius: 12, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 20 },
  'theme-cyber-grid':         { fontFamily: "'Courier New', Courier, monospace",                                primaryColor: '#FF6A3D', secondaryColor: '#9DAAF2', radius: 4,  dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-neon-night':         { fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",                  primaryColor: '#00f7ff', secondaryColor: '#ff00a6', radius: 14, dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-glassmorphism':      { fontFamily: 'Inter, Noto Sans SC, sans-serif',                                  primaryColor: '#6EE7F9', secondaryColor: '#A78BFA', radius: 16, dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-steampunk':          { fontFamily: "Cinzel, 'Noto Serif SC', 'Times New Roman', Georgia, 'Songti SC', serif", primaryColor: '#B08D57', secondaryColor: '#F1E6D0', radius: 12, dividerStyle: 'dashed',   bgMode: 'theme', titleFontSize: 22 },
  'theme-paper-journal':      { fontFamily: "'Noto Serif SC', 'Songti SC', Georgia, serif",                      primaryColor: '#B48A60', secondaryColor: '#2A2A2A', radius: 12, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 22 },
  'theme-pixel-retro':        { fontFamily: "'Courier New', Courier, monospace",                                 primaryColor: '#64FF64', secondaryColor: '#C8C8C8', radius: 6,  dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 18 },
  'theme-modern-minimal':     { fontFamily: "Inter, 'Noto Sans SC', sans-serif",                                 primaryColor: '#FFFFFF', secondaryColor: '#9FA6B2', radius: 12, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 20 },
  'theme-nature-aura':        { fontFamily: "'Noto Serif SC', 'Songti SC', Georgia, serif",                      primaryColor: '#64D58B', secondaryColor: '#A7D7C5', radius: 14, dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-ink-wash':           { fontFamily: "'Noto Serif SC', 'Songti SC', Georgia, serif",                      primaryColor: '#2A2A2A', secondaryColor: '#7A6248', radius: 14, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 22 }
};

// åˆå§‹ä¸ªæ€§åŒ–çŠ¶æ€ï¼ˆä»¥æ§ä»¶å€¼ä¸ºåŸºå‡†ï¼Œéšåå åŠ å½“å‰ä¸»é¢˜é»˜è®¤ï¼‰
let customization = {
  fontFamily: fontFamilySelect?.value || 'Noto Sans SC, sans-serif',
  primaryColor: primaryColorInput?.value || '#6a717c',
  secondaryColor: secondaryColorInput?.value || '#97aec8',
  radius: parseInt(borderRadiusRange?.value || '12', 10),
  bgMode: bgModeSelect?.value || 'theme',
  bgColor: bgColorInput?.value || '#111215',
  bgGradientStart: bgGradientStartColorInput?.value || (primaryColorInput?.value || '#6a717c'),
  bgGradientEnd: bgGradientEndColorInput?.value || (secondaryColorInput?.value || '#97aec8'),
  bgGradientStyle: bgGradientStyleSelect?.value || 'linear',
  bgGradientAngle: parseInt(bgGradientAngleRange?.value || '135', 10),
  bgGradientDirection: bgGradientDirectionSelect?.value || 'to bottom right',
  bgImageUrl: bgImageUrlInput?.value || '',
  // æ–°å¢ï¼šå¤šå›¾å±‚èƒŒæ™¯ä¸æ‹–åŠ¨ç»„ä»¶
  bgLayers: [],
  bgComponents: [],
  bgCompDrag: false,
  layout: layoutSelect?.value || 'label-left',
  letterSpacing: parseFloat(letterSpacingRange?.value || '0'),
  lineHeight: parseFloat(lineHeightRange?.value || '1.4'),
  titleFontSize: parseInt(titleFontSizeRange?.value || '20', 10),
  opacity: parseFloat(opacityRange?.value || '1'),
  dividerStyle: dividerStyleSelect?.value || 'line',
  
  // æ–°å¢ï¼šè¿›åº¦æ¡é£æ ¼/åŠ¨ç”»
  barStyle: barStyleSelect?.value || 'normal',
  barAnimation: barAnimationSelect?.value || 'none',
  // æ–°å¢ï¼šç™¾åˆ†æ¯”æ˜¾ç¤ºé£æ ¼
  percentDisplay: percentDisplaySelect?.value || 'center',

  // å…‰æ™•è®¾ç½®ï¼ˆé»˜è®¤è·Ÿéšä¸»/è¾…è‰²ï¼Œé¢‘ç‡=1.0sï¼‰
  glowColorA: (primaryColorInput?.value || '#85a6f8'),
  glowColorB: (secondaryColorInput?.value || '#95b3e8'),
  glowSpeed: 1.0,

  // é•¿æ–‡å­—ï¼šè¡Œè·ä¸ç‰¹æ•ˆ
  longTextLineHeight: parseFloat(longtextLineHeightRange?.value || '1.6'),
  longTextEffect: longtextEffectSelect?.value || 'none',

  // æ–°å¢ï¼šå€¼æ¡†å°ºå¯¸ä¸ä½ç½® + æ•´ä½“åç§»/é˜´å½±ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰
  valueBoxWidthPct: 100,          // 40~100ï¼ˆç›¸å¯¹æœ€å¤§ï¼‰
  valueBoxOffsetPct: 0,           // -40~40ï¼ˆ%ï¼‰
  itemOffsetPct: 0,               // -40~40ï¼ˆ%ï¼‰
  itemOffsetRightPct: 0,          // -40~40ï¼ˆ%ï¼‰å³ä¾§åç§»ï¼ˆmargin-rightï¼‰
  // æ–°å¢ï¼šæ ‡ç­¾/å€¼æ¯”ä¾‹ï¼ˆé»˜è®¤ 30% : 70%ï¼‰
  lvLabelPct: 30,

  // é¢„è§ˆ/å¯¼å‡ºæœ€å¤§å®½åº¦ï¼ˆç»Ÿä¸€ï¼Œé»˜è®¤600ï¼‰
  statusbarMaxWidth: parseInt(statusbarWidthRange?.value || '600', 10),

  // æ–°å¢ï¼šç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²ï¼ˆé»˜è®¤ä¸å¯ç”¨ï¼Œç•™ç©ºè¡¨ç¤ºä½¿ç”¨ä¸»é¢˜è‰²ï¼‰
  section2LabelColor: '',
  section2ValueColor: '',
  section2BarColor: '',
  section2DividerColor: '',

  // é¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±ï¼ˆå…¨å±€ï¼‰
  itemCardPerItemEnabled: !!(itemCardPerItemToggle?.checked || false),
  itemCardBgMode: itemCardBgModeSelect?.value || 'theme', // theme|none|color|gradient|image|url
  itemCardBgColor: itemCardBgColorInput?.value || '#111215',
  itemCardGradStart: itemCardGradStartInput?.value || (primaryColorInput?.value || '#6a717c'),
  itemCardGradEnd: itemCardGradEndInput?.value || (secondaryColorInput?.value || '#97aec8'),
  itemCardGradAngle: parseInt(itemCardGradAngleRange?.value || '135', 10),
  itemCardBgImageUrl: itemCardBgImageUrlInput?.value || '',
  itemCardBgUrl: itemCardBgUrlInput?.value || '',
  itemCardShadowEnabled: !!(itemCardShadowEnableCheckbox?.checked || false),
  itemCardShadowStrength: parseFloat(itemCardShadowStrengthRange?.value || '0.30') || 0.30,

  // æ–°å¢ï¼šæ ‡ç­¾/å€¼å­—ä½“ä¸æ ·å¼
  globalLabelFontFamily: globalLabelFontSelect?.value || (fontFamilySelect?.value || 'Noto Sans SC, sans-serif'),
  globalValueFontFamily: globalValueFontSelect?.value || (fontFamilySelect?.value || 'Noto Sans SC, sans-serif'),
  globalLabelWeight: parseInt(globalLabelWeightSelect?.value || '500', 10),
  globalValueWeight: parseInt(globalValueWeightSelect?.value || '600', 10),
  globalLabelFontSize: parseInt(globalLabelFontSizeRange?.value || '16', 10),
  globalValueFontSize: parseInt(globalValueFontSizeRange?.value || '16', 10),
  globalLabelItalic: !!(globalLabelItalicCheckbox?.checked || false),
  globalValueItalic: !!(globalValueItalicCheckbox?.checked || false),
  globalLabelUppercase: !!(globalLabelUppercaseCheckbox?.checked || false),
  globalValueUppercase: !!(globalValueUppercaseCheckbox?.checked || false),
  globalLabelReflect: !!(globalLabelReflectCheckbox?.checked || false),
  globalValueReflect: !!(globalValueReflectCheckbox?.checked || false),

  /* æ ‡é¢˜åŒºåŸŸè‡ªå®šä¹‰ï¼ˆé»˜è®¤ä¿æŒç°çŠ¶ï¼šä¸è¦†ç›–æ¨¡æ¿ï¼‰ */
  headerMinHeight: parseInt(headerMinHeightRange?.value || '0', 10) || 0,
  headerPaddingY: parseInt(headerPaddingYRange?.value || '0', 10) || 0,
  headerAlign: headerAlignSelect?.value || 'inherit',
  titleEnabled: !!(titleEnabledCheckbox?.checked ?? true),
  titleGapEnabled: !!(titleGapEnableCheckbox?.checked || false),
  titleGap: parseInt(titleGapRange?.value || '10', 10) || 10,

  titleColorMode: titleColorModeSelect?.value || 'theme', /* theme | solid | gradient */
  titleColorSolid: titleColorSolidInput?.value || '',
  titleGradStart: titleGradStartInput?.value || '',
  titleGradEnd: titleGradEndInput?.value || '',
  titleGradAngle: parseInt(titleGradAngleRange?.value || '0', 10) || 0,

  titleEffectGlow: !!(titleGlowEnableCheckbox?.checked || false),
  titleGlowIntensity: parseFloat(titleGlowIntensityRange?.value || '0.5') || 0.5,
  titleEffectShadow: !!(titleShadowEnableCheckbox?.checked || false),
  titleShadowStrength: parseFloat(titleShadowStrengthRange?.value || '0.3') || 0.3,

  // æ ‡é¢˜é«˜çº§æ ·å¼
  titleWeight: parseInt(titleWeightSelect?.value || '500', 10) || 500,
  titleItalic: !!(titleItalicCheckbox?.checked || false),
  titleUppercase: !!(titleUppercaseCheckbox?.checked || false),
  titleLetterSpacing: parseFloat(titleLetterSpacingRange?.value || '0') || 0,

  titleUnderlineStyle: titleUnderlineStyleSelect?.value || 'none',
  titleUnderlineColor: titleUnderlineColorInput?.value || '#ffffff',
  titleUnderlineThickness: parseInt(titleUnderlineThicknessRange?.value || '2', 10) || 2,
  titleUnderlineOffset: parseInt(titleUnderlineOffsetRange?.value || '4', 10) || 4,

  titleBadgeEnabled: !!(titleBadgeEnableCheckbox?.checked || false),
  titleBadgeColor: titleBadgeColorInput?.value || '#000000',


  /* æ–°å¢ï¼šåŠ¨ç”»å åŠ é…ç½® */
  starEnabled: !!(starEnabledCheckbox?.checked || false),
  starFrequency: parseFloat(starFrequencyRange?.value || '2'),
  starDensity: parseInt(starDensityRange?.value || '50', 10),
  starColor: starColorInput?.value || '#ffffff',

  sparkleEnabled: !!(sparkleEnabledCheckbox?.checked || false),
  sparkleDirection: sparkleDirectionSelect?.value || 'down',
  sparkleFrequency: parseFloat(sparkleFrequencyRange?.value || '2'),
  sparkleDensity: parseInt(sparkleDensityRange?.value || '20', 10),
  sparkleColor: sparkleColorInput?.value || '#ffd966',
  sparkleGlow: !!(sparkleGlowCheckbox?.checked || true),

  petalEnabled: !!(petalEnabledCheckbox?.checked || false),
  petalFrequency: parseFloat(petalFrequencyRange?.value || '5'),
  petalDensity: parseInt(petalDensityRange?.value || '20', 10),
  petalIconMode: petalIconModeSelect?.value || 'built-in',
  petalIconBuiltin: petalIconBuiltinSelect?.value || 'leaf',
  petalIconUrl: petalIconUrlInput?.value || '',
  
  // æ–°å¢ï¼šè‡ªå®šä¹‰å­—ä½“å¯¼å…¥
  customFonts: [] // å­˜å‚¨ç”¨æˆ·å¯¼å…¥çš„å­—ä½“ [{url, name, optgroupAdded}]
};

// === è‡ªå®šä¹‰å­—ä½“å¯¼å…¥åŠŸèƒ½ ===
const customFontUrlInput = document.getElementById('custom-font-url');
const customFontNameInput = document.getElementById('custom-font-name');
const btnImportCustomFont = document.getElementById('btn-import-custom-font');

// å¯¼å…¥å­—ä½“åˆ°é¡µé¢å¹¶æ·»åŠ åˆ°ä¸‹æ‹‰æ¡†ï¼ˆå¢å¼ºç‰ˆï¼šæ”¯æŒå»¶è¿ŸåŠ è½½ + å®æ—¶é¢„è§ˆæµ‹è¯•ï¼‰
/**
 * è‡ªå®šä¹‰å­—ä½“å¯¼å…¥ï¼ˆCSSé“¾æ¥ç‰ˆï¼‰
 * - é€‚é… Google Fonts / result.css ç­‰æä¾› CSS çš„é“¾æ¥
 * - ä½¿ç”¨ <link rel="stylesheet"> é¿å… @import å— CSP é™åˆ¶
 * - æ ‡å‡†åŒ– family åï¼›åŠ å…¥åˆ°é€‰æ‹©å™¨ï¼›é¢„è§ˆç«‹å³åº”ç”¨ï¼›å¯¼å‡ºåŒ…å« @import
 * - åˆ†é˜¶æ®µ document.fonts.check éªŒè¯åŠ è½½æˆåŠŸ
 */
async function importCustomFont() {
  try {
    const url = customFontUrlInput?.value?.trim();
    const nameHintRaw = customFontNameInput?.value?.trim() || '';
    if (!url) {
      alert('è¯·è¾“å…¥å­—ä½“ CSS é“¾æ¥\nç¤ºä¾‹ï¼šhttps://fonts.googleapis.com/css2?family=YourFont:wght@400;700&display=swap');
      return;
    }

    // åˆå§‹æŒ‰é’®çŠ¶æ€
    if (btnImportCustomFont) {
      btnImportCustomFont.disabled = true;
      btnImportCustomFont.innerHTML = '<i class="fa fa-spinner fa-spin"></i> åŠ è½½ä¸­...';
    }

    // æ³¨å…¥ <link rel="stylesheet">ï¼ˆé¿å… @import å— CSP å½±å“ï¼‰
    const linkId = 'custom-font-link-' + Date.now();
    const linkEl = document.createElement('link');
    linkEl.id = linkId;
    linkEl.rel = 'stylesheet';
    linkEl.href = url;
    // å¯¹äºæ ·å¼è¡¨é€šå¸¸æ— éœ€ crossoriginï¼›ç§»é™¤ä»¥é˜²ç‰¹å®šæºæŠ¥é”™
    document.head.appendChild(linkEl);

    // å°è¯•æ‹‰å– CSS å¹¶ä» @font-face ä¸­è‡ªåŠ¨æå– font-family
    let cssText = '';
    try {
      const res = await fetch(url, { mode: 'cors' });
      if (res && res.ok) {
        cssText = await res.text();
      }
    } catch (_e) {
      // å¿½ç•¥ç½‘ç»œé”™è¯¯ï¼Œåç»­ç”¨ç”¨æˆ·è¾“å…¥å…œåº•
    }

    // è§£æ CSS è·å– font-family åç§°åˆ—è¡¨
    const families = [];
    if (cssText && typeof cssText === 'string') {
      const rx = /font-family\s*:\s*['"]([^'"]+)['"]/gi;
      let m;
      const set = new Set();
      while ((m = rx.exec(cssText)) != null) {
        const fam = String(m[1] || '').trim();
        if (fam && !set.has(fam)) {
          set.add(fam);
          families.push(fam);
        }
      }
    }

    // å…œåº•ï¼šè‹¥æ— æ³•è§£æï¼Œåˆ™ä½¿ç”¨ç”¨æˆ·è¾“å…¥æç¤ºå
    const sanitize = (s) => String(s || '').replace(/['"]/g, '').split(',')[0].trim();
    const hintFamilyBare = sanitize(nameHintRaw);
    const chosenBare = families[0] || hintFamilyBare;

    if (!chosenBare) {
      if (btnImportCustomFont) {
        btnImportCustomFont.disabled = false;
        btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> å¯¼å…¥å­—ä½“';
      }
      alert('æœªèƒ½è‡ªåŠ¨è¯†åˆ«å­—ä½“åç§°ï¼Œè¯·åœ¨â€œå­—ä½“åç§°â€ä¸­å¡«å†™ CSS ä¸­ @font-face çš„ font-family åç§°ï¼Œä¾‹å¦‚ï¼š"YourFont"');
      return;
    }

    // æ ‡å‡†åŒ–ï¼šå¸¦å¼•å·ï¼ˆæœ‰ç©ºæ ¼æ—¶ï¼‰+ é»˜è®¤ fallback
    const normalizedValue = (chosenBare.includes(' ') ? `'${chosenBare}'` : chosenBare) + ', sans-serif';

    // é‡å¤æ£€æµ‹ï¼ˆURL æˆ– familyï¼‰
    const exists = customization.customFonts.some(f => {
      const fBare = sanitize(String(f.name || ''));
      return f.url === url || fBare === chosenBare;
    });
    if (exists) {
      // å·²æœ‰åˆ™ä»…åŒæ­¥é€‰æ‹©ä¸é¢„è§ˆ
      if (fontFamilySelect) fontFamilySelect.value = normalizedValue;
      customization.fontFamily = normalizedValue;
      customization.globalLabelFontFamily = normalizedValue;
      customization.globalValueFontFamily = normalizedValue;
      if (globalLabelFontSelect) globalLabelFontSelect.value = normalizedValue;
      if (globalValueFontSelect) globalValueFontSelect.value = normalizedValue;
      renderPreview();
      alert('è¯¥å­—ä½“å·²å¯¼å…¥ï¼Œå·²åº”ç”¨åˆ°é¢„è§ˆ');
      if (btnImportCustomFont) {
        btnImportCustomFont.disabled = false;
        btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> å¯¼å…¥å­—ä½“';
      }
      console.debug('[custom-font] å·²å­˜åœ¨ï¼Œç›´æ¥åº”ç”¨', { url, family: chosenBare });
      return;
    }

    // è®°å½•åˆ°çŠ¶æ€ï¼ˆç”¨äºå¯¼å‡ºç”Ÿæˆ @importï¼‰
    customization.customFonts.push({
      url,
      name: normalizedValue,
      linkId,
      type: 'css',
      optgroupAdded: false
    });

    // æ·»åŠ ä¸‹æ‹‰é€‰é¡¹å¹¶é€‰ä¸­
    addCustomFontToSelects(normalizedValue);
    if (fontFamilySelect) fontFamilySelect.value = normalizedValue;

    // åº”ç”¨åˆ°ä¸»ä½“/æ ‡ç­¾/å€¼å­—ä½“
    customization.fontFamily = normalizedValue;
    customization.globalLabelFontFamily = normalizedValue;
    customization.globalValueFontFamily = normalizedValue;
    if (globalLabelFontSelect) globalLabelFontSelect.value = normalizedValue;
    if (globalValueFontSelect) globalValueFontSelect.value = normalizedValue;

    // é¢„åŠ è½½å­—ä½“ï¼ˆå°½é‡ä¸é˜»å¡ UIï¼‰
    try {
      if (document.fonts && document.fonts.load) {
        // ä¸» family
        await document.fonts.load(`16px "${chosenBare}"`).catch(() => {});
        // è‹¥ CSS ä¸­æœ‰å¤š familyï¼ˆå¦‚å¯å˜å­—ä½“å‘½åï¼‰ï¼Œä¸€å¹¶é¢„åŠ è½½
        for (let i = 1; i < families.length; i++) {
          const fam = families[i];
          await document.fonts.load(`16px "${fam}"`).catch(() => {});
        }
      }
    } catch (_e) {}

    // åˆ·æ–°é¢„è§ˆ
    renderPreview();

    // åˆ†é˜¶æ®µæ£€æŸ¥åŠ è½½çŠ¶æ€ï¼ˆè¯Šæ–­ï¼‰
    const checkTimes = [600, 2000, 5000];
    let loadSuccess = false;
    checkTimes.forEach((delay, index) => {
      setTimeout(() => {
        if (loadSuccess) return;
        try {
          if (document.fonts && document.fonts.check) {
            const ok = document.fonts.check(`16px "${chosenBare}"`);
            if (ok) {
              loadSuccess = true;
              console.debug('[custom-font] åŠ è½½æˆåŠŸ', { family: chosenBare, url, t: delay });
              renderPreview();
              if (btnImportCustomFont) {
                btnImportCustomFont.disabled = false;
                btnImportCustomFont.innerHTML = '<i class="fa fa-check"></i> å¯¼å…¥æˆåŠŸ';
                setTimeout(() => {
                  if (btnImportCustomFont) btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> å¯¼å…¥å­—ä½“';
                }, 1800);
              }
            }
          }
        } catch (_e) {}

        if (index === checkTimes.length - 1) {
          if (btnImportCustomFont) {
            btnImportCustomFont.disabled = false;
            btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> å¯¼å…¥å­—ä½“';
          }
          if (!loadSuccess) {
            alert(`âš ï¸ å­—ä½“æ ·å¼å·²æ·»åŠ ï¼Œä½†æµè§ˆå™¨å°šæœªç¡®è®¤åŠ è½½æˆåŠŸ\n\nfamilyï¼š${chosenBare}\næ¥æºï¼š${url}\n\nå»ºè®®ï¼š\n- ç¨ç­‰ç‰‡åˆ»åå†æ¬¡æŸ¥çœ‹\n- ç¡®è®¤åç§°ä¸ CSS ä¸­ @font-face çš„ font-family ä¸€è‡´ï¼ˆå½“å‰å·²è‡ªåŠ¨è¯†åˆ«ï¼š${chosenBare}ï¼‰\n- æ£€æŸ¥æ§åˆ¶å°ç½‘ç»œ/CORS çŠ¶æ€`);
            console.warn('[custom-font] æœªç¡®è®¤åŠ è½½æˆåŠŸ', { family: chosenBare, url });
          } else {
            alert(`âœ… å­—ä½“å¯¼å…¥æˆåŠŸï¼š${chosenBare}\né¢„è§ˆå·²åº”ç”¨ï¼Œè¯·æ£€æŸ¥å³ä¾§æ•ˆæœã€‚`);
          }
        }
      }, delay);
    });

    // æ¸…ç©ºè¾“å…¥
    if (customFontUrlInput) customFontUrlInput.value = '';
    if (customFontNameInput) customFontNameInput.value = '';

    console.debug('[custom-font] æ³¨å…¥ CSS é“¾æ¥ & è‡ªåŠ¨è¯†åˆ« family', { linkId, url, familyDetected: chosenBare, families });
  } catch (e) {
    console.error('[custom-font] å¯¼å…¥å¤±è´¥', e);
    if (btnImportCustomFont) {
      btnImportCustomFont.disabled = false;
      btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> å¯¼å…¥å­—ä½“';
    }
    alert('âŒ å­—ä½“å¯¼å…¥å¤±è´¥\n\né”™è¯¯ï¼š' + (e?.message || 'æœªçŸ¥é”™è¯¯'));
  }
}

// æ·»åŠ è‡ªå®šä¹‰å­—ä½“åˆ°æ‰€æœ‰å­—ä½“é€‰æ‹©å™¨
function addCustomFontToSelects(fontName) {
  try {
    const selects = [
      fontFamilySelect,
      globalLabelFontSelect,
      globalValueFontSelect
    ].filter(Boolean);

    // è§„èŒƒåŒ–ï¼šé€‰é¡¹å€¼ä½¿ç”¨ CSS å®‰å…¨å€¼ï¼ˆå«å¼•å·ä¸ fallbackï¼‰
    const bare = String(fontName || '').replace(/['"]/g, '').split(',')[0].trim();
    const normalizedValue = (bare.includes(' ') ? `'${bare}'` : bare) + ', sans-serif';
    const displayText = bare;

    selects.forEach(sel => {
      // æ£€æŸ¥æ˜¯å¦å·²æœ‰"è‡ªå®šä¹‰å­—ä½“"åˆ†ç»„
      let optgroup = sel.querySelector('optgroup[label="ğŸ¨ è‡ªå®šä¹‰å­—ä½“"]');
      if (!optgroup) {
        optgroup = document.createElement('optgroup');
        optgroup.label = 'ğŸ¨ è‡ªå®šä¹‰å­—ä½“';
        sel.appendChild(optgroup);
      }

      // æ·»åŠ é€‰é¡¹ï¼ˆé¿å…é‡å¤ï¼šæŒ‰å€¼åˆ¤æ–­ï¼‰
      const existing = Array.from(optgroup.querySelectorAll('option')).some(opt => opt.value === normalizedValue);
      if (!existing) {
        const option = document.createElement('option');
        option.value = normalizedValue;    // å§‹ç»ˆæ˜¯ CSS å®‰å…¨å€¼
        option.textContent = displayText;  // æ˜¾ç¤ºçº¯ family å
        optgroup.appendChild(option);
      }
    });
  } catch (e) {
    console.warn('[custom-font] addCustomFontToSelects error', e);
  }
}

// ç»‘å®šå¯¼å…¥æŒ‰é’®äº‹ä»¶
if (btnImportCustomFont) {
  btnImportCustomFont.addEventListener('click', importCustomFont);
}

// æ”¯æŒå›è½¦é”®å¿«é€Ÿå¯¼å…¥
if (customFontNameInput) {
  customFontNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      importCustomFont();
    }
  });
}

 // æ¯”è¾ƒå½“å‰ä¸»é¢˜çš„ä¸ªæ€§åŒ–è®¾ç½®æ˜¯å¦å·²è¢«ä¿®æ”¹ï¼ˆç›¸å¯¹è¯¥ä¸»é¢˜é»˜è®¤æ´¾ç”ŸåŸºçº¿ï¼‰
function isCustomizationModified(theme) {
  const def = themeDefaults[theme] || {};
  // æ„é€ æ´¾ç”Ÿé»˜è®¤åŸºçº¿ï¼šglobalTextColor=secondaryColorã€globalBarColor=primaryColor
  const expected = {
    fontFamily: def.fontFamily,
    primaryColor: def.primaryColor,
    secondaryColor: def.secondaryColor,
    radius: def.radius,
    dividerStyle: def.dividerStyle,
    bgMode: def.bgMode ?? 'theme'
    // ç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²ä¸çº³å…¥â€œä¸»é¢˜ä¿®æ”¹â€åˆ¤æ–­
  };
  // è§„èŒƒåŒ–æ¯”è¾ƒï¼Œé¿å…å¤§å°å†™ä¸ç©ºç™½å·®å¼‚å½±å“åˆ¤æ–­
  const norm = v => {
    if (v == null) return '';
    if (typeof v === 'string') return v.trim().toLowerCase();
    return String(v);
  };
  return Object.keys(expected).some(k => norm(customization[k]) !== norm(expected[k]));
}

// åº”ç”¨ä¸»é¢˜é»˜è®¤å€¼å¹¶åŒæ­¥æ§åˆ¶é¢æ¿æ˜¾ç¤º
function applyThemeDefaults(theme) {
  const def = themeDefaults[theme] || {};
  if (!def) return;
  customization.fontFamily = def.fontFamily ?? customization.fontFamily;
  customization.primaryColor = def.primaryColor ?? customization.primaryColor;
  customization.secondaryColor = def.secondaryColor ?? customization.secondaryColor;
  customization.radius = def.radius ?? customization.radius;
  customization.dividerStyle = def.dividerStyle ?? customization.dividerStyle;
  customization.bgMode = def.bgMode ?? 'theme';
  customization.titleFontSize = def.titleFontSize ?? (customization.titleFontSize ?? 20);


  // æ–°å¢ï¼šæ ‡ç­¾/å€¼å­—ä½“ä¸æ ·å¼é»˜è®¤
  customization.globalLabelFontFamily = customization.globalLabelFontFamily || (def.fontFamily || customization.fontFamily);
  customization.globalValueFontFamily = customization.globalValueFontFamily || (def.fontFamily || customization.fontFamily);
  customization.globalLabelWeight = customization.globalLabelWeight || 500;
  customization.globalValueWeight = customization.globalValueWeight || 600;
  customization.globalLabelItalic = !!customization.globalLabelItalic;
  customization.globalValueItalic = !!customization.globalValueItalic;
  customization.globalLabelUppercase = !!customization.globalLabelUppercase;
  customization.globalValueUppercase = !!customization.globalValueUppercase;
  customization.globalLabelReflect = !!customization.globalLabelReflect;
  customization.globalValueReflect = !!customization.globalValueReflect;

  // åŒæ­¥æ§ä»¶æ˜¾ç¤º
  if (fontFamilySelect) fontFamilySelect.value = customization.fontFamily;
  if (primaryColorInput) primaryColorInput.value = customization.primaryColor;
  if (secondaryColorInput) secondaryColorInput.value = customization.secondaryColor;
  if (borderRadiusRange) borderRadiusRange.value = String(customization.radius);
  if (radiusValue) radiusValue.textContent = String(customization.radius);
  if (dividerStyleSelect) dividerStyleSelect.value = customization.dividerStyle;
  if (bgModeSelect) bgModeSelect.value = customization.bgMode;
  if (bgGradientStyleSelect) bgGradientStyleSelect.value = customization.bgGradientStyle || 'linear';
  if (bgGradientAngleRange) bgGradientAngleRange.value = String(customization.bgGradientAngle || 135);
  if (bgGradientAngleValue) bgGradientAngleValue.textContent = String(customization.bgGradientAngle || 135);
  if (bgGradientDirectionSelect) bgGradientDirectionSelect.value = customization.bgGradientDirection || 'to bottom right';

  // ç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²ä¸éšä¸»é¢˜åˆ‡æ¢é‡ç½®ä¸åŒæ­¥

  // åŒæ­¥ç¬¬ä¸‰éƒ¨åˆ†çš„å­—ä½“ä¸æ ·å¼æ§ä»¶
  if (globalLabelFontSelect) globalLabelFontSelect.value = customization.globalLabelFontFamily;
  if (globalValueFontSelect) globalValueFontSelect.value = customization.globalValueFontFamily;
  if (globalLabelWeightSelect) globalLabelWeightSelect.value = String(customization.globalLabelWeight);
  if (globalValueWeightSelect) globalValueWeightSelect.value = String(customization.globalValueWeight);
  if (globalLabelItalicCheckbox) globalLabelItalicCheckbox.checked = !!customization.globalLabelItalic;
  if (globalValueItalicCheckbox) globalValueItalicCheckbox.checked = !!customization.globalValueItalic;
  if (globalLabelUppercaseCheckbox) globalLabelUppercaseCheckbox.checked = !!customization.globalLabelUppercase;
  if (globalValueUppercaseCheckbox) globalValueUppercaseCheckbox.checked = !!customization.globalValueUppercase;
  if (globalLabelReflectCheckbox) globalLabelReflectCheckbox.checked = !!customization.globalLabelReflect;
  if (globalValueReflectCheckbox) globalValueReflectCheckbox.checked = !!customization.globalValueReflect;

  // åŒæ­¥å­—å·æ§ä»¶æ˜¾ç¤º
  if (titleFontSizeRange) titleFontSizeRange.value = String(customization.titleFontSize || 20);
  if (titleFontSizeValue) titleFontSizeValue.textContent = String(customization.titleFontSize || 20);
  if (globalLabelFontSizeRange) globalLabelFontSizeRange.value = String(customization.globalLabelFontSize || 16);
  if (globalLabelFontSizeValue) globalLabelFontSizeValue.textContent = String(customization.globalLabelFontSize || 16);
  if (globalValueFontSizeRange) globalValueFontSizeRange.value = String(customization.globalValueFontSize || 16);
  if (globalValueFontSizeValue) globalValueFontSizeValue.textContent = String(customization.globalValueFontSize || 16);

  // åŒæ­¥åŒåˆ—æ§ä»¶æ˜¾ç¤º
  if (twoColLabelPctRange) twoColLabelPctRange.value = String(customization.twoColLabelPct ?? 30);
  if (twoColLabelPctValue) twoColLabelPctValue.textContent = String(customization.twoColLabelPct ?? 30);
  if (twoColGapRange) twoColGapRange.value = String(customization.twoColGap ?? 12);
  if (twoColGapValue) twoColGapValue.textContent = String(customization.twoColGap ?? 12);
  updateTwoColumnFieldsVisibility();

  // åŒæ­¥ æ ‡ç­¾/å€¼ æ¯”ä¾‹æ§ä»¶æ˜¾ç¤º
  if (labelValueLabelPctRange) labelValueLabelPctRange.value = String(customization.lvLabelPct ?? 30);
  if (labelValueLabelPctValue) labelValueLabelPctValue.textContent = String(customization.lvLabelPct ?? 30);
  if (labelValueValuePctValue) labelValueValuePctValue.textContent = String(100 - (customization.lvLabelPct ?? 30));

  // åŒæ­¥ 2 é¢„è§ˆæœ€å¤§å®½åº¦æ§ä»¶
  if (statusbarWidthRange) statusbarWidthRange.value = String(customization.statusbarMaxWidth || 600);
  if (statusbarWidthValue) statusbarWidthValue.textContent = String(customization.statusbarMaxWidth || 600);

 
  // è¯Šæ–­æ—¥å¿—ï¼šä¸»é¢˜é»˜è®¤åº”ç”¨åè®°å½•é…è‰²/å­—ä½“/åœ†è§’/åˆ†å‰²çº¿/èƒŒæ™¯ä¸å¯¹æ¯”åº¦ã€åŠ¨ç”»å¼ºåº¦
  try {
    const cont = contrastRatio(customization.primaryColor, customization.secondaryColor);
    const coh = computeCoherence({
      theme,
      primaryColor: customization.primaryColor,
      secondaryColor: customization.secondaryColor,
      letterSpacing: customization.letterSpacing,
      lineHeight: customization.lineHeight,
      animationType: currentAnimation
    });
    console.log('[diag] applyThemeDefaults', {
      theme,
      fontFamily: customization.fontFamily,
      primary: customization.primaryColor,
      secondary: customization.secondaryColor,
      radius: customization.radius,
      dividerStyle: customization.dividerStyle,
      bgMode: customization.bgMode,
      contrast: Number(cont.toFixed(2)),
      animation: currentAnimation,
      animSpeed,
      animIntensity,
      coherence: coh
    });
  } catch (e) { console.warn('[diag] applyThemeDefaults error', e); }

}

// å†…ç½® SVG å›¾æ ‡ï¼ˆæ‰©å±• + é‡åšé½¿è½®ä¸ºä¸­å¿ƒå¯¹ç§°ï¼‰
(function(){
  // è¦†å†™ä¸»é¢˜é»˜è®¤ï¼šå›¾æ ‡ç­–ç•¥
  const __old_applyThemeDefaults = applyThemeDefaults;
  applyThemeDefaults = function(theme){
    __old_applyThemeDefaults(theme);
    try {
      // é»˜è®¤ç­–ç•¥ï¼šè’¸æ±½æœ‹å…‹å¯ç”¨å†…ç½®é½¿è½®å¹¶ç½®å·¦ï¼Œå…¶å®ƒä¸»é¢˜é»˜è®¤ä¸æ˜¾ç¤º
      if (theme === 'theme-steampunk') {
        customization.iconMode = 'built-in';
        customization.iconBuiltin = customization.iconBuiltin || 'cog';
        customization.iconPosition = 'left';
        customization.iconSize = customization.iconSize || 28;
      } else {
        customization.iconMode = customization.iconMode || 'none';
        customization.iconPosition = (customization.iconMode === 'none') ? 'none' : (customization.iconPosition || 'left');
        customization.iconSize = customization.iconSize || 28;
      }
      if (iconModeSelect) iconModeSelect.value = customization.iconMode || 'none';
      if (iconBuiltinSelect) iconBuiltinSelect.value = customization.iconBuiltin || 'cog';
      if (iconPositionSelect) iconPositionSelect.value = customization.iconPosition || 'none';
      if (iconSizeRange) iconSizeRange.value = String(customization.iconSize || 28);
      if (iconSizeValue) iconSizeValue.textContent = String(customization.iconSize || 28);
      updateIconFieldsVisibility();
    } catch(_e) {}
  };
})();
function getBuiltinIconSVG(name, size = 24, color = customization.primaryColor) {
 const common = `width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"`;
 const svg = inner => `<svg ${common}>${inner}</svg>`;
 const p = d => svg(`<path d="${d}"></path>`);
 const poly = pts => svg(`<polygon points="${pts}"></polygon>`);
 const circ = (cx, cy, r) => `<circle cx="${cx}" cy="${cy}" r="${r}"></circle>`;

 // ç¨‹åºåŒ–ä¸­å¿ƒå¯¹ç§°é½¿è½®ï¼š12é½¿ï¼Œå¤–å¾„â‰ˆ10.2ã€å†…å¾„â‰ˆ7.2ã€å­”å¾„â‰ˆ3.2ï¼Œä¸­å¿ƒ(12,12)
 function gear12() {
   const cx = 12, cy = 12;
   const teeth = 12;
   const rOuter = 10.2, rInner = 7.2, rBore = 3.2;
   const step = Math.PI * 2 / teeth;
   const aSide = step * 0.25;
   const pts = [];
   for (let i = 0; i < teeth; i++) {
     const base = i * step;
     const a0 = base;
     const a1 = base + aSide;
     const a2 = base + step / 2;
     const a3 = base + step - aSide;
     // å†…è°· -> å¤–ä¾§ -> é½¿å°– -> å›è½
     pts.push([cx + rInner * Math.cos(a0), cy + rInner * Math.sin(a0)]);
     pts.push([cx + rOuter * Math.cos(a1), cy + rOuter * Math.sin(a1)]);
     pts.push([cx + rOuter * Math.cos(a2), cy + rOuter * Math.sin(a2)]);
     pts.push([cx + rInner * Math.cos(a3), cy + rInner * Math.sin(a3)]);
   }
   const pointsStr = pts.map(([x, y]) => `${x.toFixed(2)} ${y.toFixed(2)}`).join(' ');
   const ring = `<polygon points="${pointsStr}"></polygon>`;
   const bore = circ(cx, cy, rBore);
   try { console.log('[icon] cog generated', { teeth, rOuter, rInner, rBore, cx, cy }); } catch (_e) {}
   return svg(ring + bore);
 }

 switch (name) {
   /* åŸºç¡€ */
   case 'shield': return p("M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z");
   case 'star': return poly("12 2 15.09 8.26 22 9.27 17 13.97 18.18 21 12 17.27 5.82 21 7 13.97 2 9.27 8.91 8.26 12 2");
   case 'heart': return p("M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z");
   case 'leaf': return p("M11 21C5 21 3 15 3 15S5 3 21 3c0 16-12 18-12 18z");
   case 'cog': return gear12();

   /* å¸¸ç”¨åŠŸèƒ½ */
   case 'search': return svg('<circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>');
   case 'refresh': return svg('<path d="M21 12a9 9 0 1 1-3.5-7.1"></path><polyline points="21 4 21 12 13 12"></polyline>');
   case 'download': return svg('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>');
   case 'upload': return svg('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 14 12 9 17 14"></polyline><line x1="12" y1="9" x2="12" y2="21"></line>');
   case 'copy': return svg('<rect x="9" y="9" width="13" height="13" rx="2"></rect><rect x="2" y="2" width="13" height="13" rx="2"></rect>');
   case 'link': return svg('<path d="M10 13a5 5 0 0 0 7.07 0l3.54-3.54a5 5 0 0 0-7.07-7.07L12.95 4"></path><path d="M14 11a5 5 0 0 1-7.07 0L3.39 7.46a5 5 0 1 1 7.07-7.07L7.05 4"></path>');

   /* ç”¨æˆ·/è§†å›¾ */
   case 'user': return svg('<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>');
   case 'eye': return svg('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>');
   case 'eye-off': return svg('<path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.77 21.77 0 0 1 5.06-6.88"></path><path d="M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a21.77 21.77 0 0 1-3.34 5.06"></path><line x1="1" y1="1" x2="23" y2="23"></line>');

   /* å®‰å…¨ */
   case 'lock': return svg('<rect x="5" y="11" width="14" height="10" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>');
   case 'unlock': return svg('<rect x="5" y="11" width="14" height="10" rx="2"></rect><path d="M7 11V9a5 5 0 0 1 9.5-2"></path>');

   /* æ’­æ”¾æ§åˆ¶ */
   case 'play': return svg('<polygon points="5 3 19 12 5 21 5 3"></polygon>');
   case 'pause': return svg('<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>');
   case 'stop': return svg('<rect x="6" y="6" width="12" height="12"></rect>');
   case 'forward': return svg('<polygon points="5 4 13 12 5 20 5 4"></polygon><polygon points="13 4 21 12 13 20 13 4"></polygon>');
   case 'rewind': return svg('<polygon points="19 4 11 12 19 20 19 4"></polygon><polygon points="11 4 3 12 11 20 11 4"></polygon>');

   /* é€šçŸ¥/çŠ¶æ€ */
   case 'bell': return svg('<path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>');
   case 'info': return svg('<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line>');
   case 'warning': return svg('<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12" y2="17"></line>');
   case 'check': return svg('<polyline points="20 6 9 17 4 12"></polyline>');
   case 'x': return svg('<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>');

   /* æ—¶é—´/æ¶ˆæ¯/åœ°ç‚¹ */
   case 'calendar': return svg('<rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>');
   case 'clock': return svg('<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>');
   case 'chat': return svg('<path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>');
   case 'map-pin': return svg('<path d="M21 10c0 5-9 12-9 12S3 15 3 10a9 9 0 1 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>');

   /* å…¶å®ƒ */
   case 'book': return svg('<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M4 4v15.5A2.5 2.5 0 0 0 6.5 22H20V4"></path>');
   case 'music': return svg('<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle>');
   case 'camera': return svg('<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle>');
   case 'plus': return svg('<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>');
   case 'minus': return svg('<line x1="5" y1="12" x2="19" y2="12"></line>');

   default: return '';
 }
}


// è¦†å†™ï¼šæ ‡é¢˜åŒºæ¸²æŸ“ï¼Œæ³¨å…¥å›¾æ ‡ä¸é¢œè‰²
function makeIconHTML() {
  try {
    if (customization.iconMode === 'none') return '';
    const size = customization.iconSize || 28;
    let inner = '';
    if (customization.iconMode === 'built-in') {
      inner = getBuiltinIconSVG(customization.iconBuiltin || 'cog', size, customization.primaryColor);
    } else {
      const url = esc(customization.iconUrl || '');
      inner = `<img src="${url}" alt="" style="width:${size}px;height:${size}px;object-fit:contain;filter: drop-shadow(0 0 2px rgba(0,0,0,.3));">`;
    }
    return `
      <span class="st-header-icon" style="
        width:${size}px; height:${size}px; border-radius:50%;
        display:grid; place-items:center;
      ">
        ${inner}
      </span>
    `;
  } catch(_e){ return ''; }
}
function getHeaderHTML2(theme, title) {
  // ç»Ÿä¸€è¯»å–çŠ¶æ€ï¼šä¼˜å…ˆä½¿ç”¨ Ny.State.customizationï¼Œå…¶æ¬¡ä½¿ç”¨æœ¬åœ° customization
  let __c = null;
  try { if (window.Ny && Ny.State && Ny.State.customization) __c = Ny.State.customization; } catch(_e){}
  __c = __c || customization || {};
  try { console.log('[dbg] getHeaderHTML2(inline): checking titleEnabled', { 
    hasNyState: !!(window.Ny && Ny.State && Ny.State.customization),
    titleEnabled: __c.titleEnabled,
    localCustomization: customization.titleEnabled,
    nyStateCustomization: (window.Ny && Ny.State && Ny.State.customization) ? Ny.State.customization.titleEnabled : 'N/A'
  }); } catch(_e){}
  if (__c && __c.titleEnabled === false) { try { console.log('[dbg] getHeaderHTML2(inline): title disabled, skip render', { titleEnabled: __c.titleEnabled }); } catch(_e){} return ''; }
  const t = esc(title || 'è§’è‰²çŠ¶æ€');

  // 1) è®¡ç®—æ ‡é¢˜æ ·å¼ï¼ˆå­—å·/å­—é‡/å­—å½¢/å¤§å†™/å­—è· + é¢œè‰²æˆ–æ¸å˜ + ä¸‹åˆ’çº¿ + ç‰¹æ•ˆï¼‰
  const themeColor = (customization.primaryColor || '#ffffff');
  const mode = (customization.titleColorMode || 'theme');

  const titleStyleParts = [
    `font-size:${customization.titleFontSize || 20}px`,
    `font-weight:${parseInt(customization.titleWeight || 500, 10) || 500}`,
    customization.titleItalic ? 'font-style:italic' : '',
    customization.titleUppercase ? 'text-transform:uppercase' : '',
    (typeof customization.titleLetterSpacing === 'number' ? `letter-spacing:${customization.titleLetterSpacing}em` : '')
  ].filter(Boolean);

  if (mode === 'solid') {
    const solid = (customization.titleColorSolid && customization.titleColorSolid.trim()) ? customization.titleColorSolid.trim() : themeColor;
    titleStyleParts.push(`color:${solid}`);
  } else if (mode === 'gradient') {
    const a = (customization.titleGradStart && customization.titleGradStart.trim()) ? customization.titleGradStart.trim() : (customization.primaryColor || themeColor);
    const b = (customization.titleGradEnd && customization.titleGradEnd.trim()) ? customization.titleGradEnd.trim() : (customization.secondaryColor || themeColor);
    const ang = Number(customization.titleGradAngle ?? 0) || 0;
    titleStyleParts.push(
      `background:linear-gradient(${ang}deg, ${a}, ${b})`,
      `-webkit-background-clip:text`,
      `background-clip:text`,
      `color:transparent`
    );
  } else {
    titleStyleParts.push(`color:${themeColor}`);
  }

  // ä¸‹åˆ’çº¿ï¼ˆä»…å½“æ ·å¼é noneï¼‰
  if ((customization.titleUnderlineStyle || 'none') !== 'none') {
    const uStyle = customization.titleUnderlineStyle || 'solid';
    const uColor = (customization.titleUnderlineColor && customization.titleUnderlineColor.trim()) ? customization.titleUnderlineColor.trim() : themeColor;
    const uThick = Math.max(1, parseInt(customization.titleUnderlineThickness || 2, 10) || 2);
    const uOffset = Math.max(0, parseInt(customization.titleUnderlineOffset || 4, 10) || 4);
    titleStyleParts.push(
      'text-decoration-line:underline',
      `text-decoration-style:${uStyle}`,
      `text-decoration-color:${uColor}`,
      `text-decoration-thickness:${uThick}px`,
      `text-underline-offset:${uOffset}px`
    );
  }

  // ç‰¹æ•ˆï¼šå…‰æ™• + é˜´å½±ï¼ˆtext-shadow å åŠ ï¼‰
  const ts = [];
  if (customization.titleEffectGlow) {
    const intensity = Math.max(0, Math.min(1, Number(customization.titleGlowIntensity || 0.5)));
    const glowColor = (mode === 'solid' && customization.titleColorSolid) ? customization.titleColorSolid : themeColor;
    const r1 = (6 + 10 * intensity).toFixed(1);
    const r2 = (12 + 18 * intensity).toFixed(1);
    ts.push(`0 0 ${r1}px ${glowColor}`, `0 0 ${r2}px ${glowColor}`);
  }
  if (customization.titleEffectShadow) {
    const s = Math.max(0, Math.min(1, Number(customization.titleShadowStrength || 0.3)));
    const y = (1 + 3 * s).toFixed(1);
    const blur = (2 + 6 * s).toFixed(1);
    ts.push(`0 ${y}px ${blur}px rgba(0,0,0,${0.45 + 0.3*s})`);
  }
  if (ts.length) titleStyleParts.push(`text-shadow:${ts.join(',')}`);

  // æ ‡é¢˜æ–‡æœ¬å†…è” span
  const titleInner = (theme === 'theme-cyber-grid')
    ? `<span class="st-title" style="${titleStyleParts.join('; ')}">[ ${t} ]</span>`
    : `<span class="st-title" style="${titleStyleParts.join('; ')}">${t}</span>`;

  // å¾½ç« åŒ…è£¹ï¼ˆå¯é€‰ï¼‰
  let titleSpan = titleInner;
  if (customization.titleBadgeEnabled) {
    const bColor = (customization.titleBadgeColor && customization.titleBadgeColor.trim()) ? customization.titleBadgeColor.trim() : '#000000';
    const badgeStyle = [
      `background: color-mix(in srgb, ${bColor} 30%, transparent)`,
      `padding:4px 8px`,
      `border-radius:8px`,
      'display:inline-block'
    ].join('; ');
    titleSpan = `<span class="st-title-badge" style="${badgeStyle}">${titleInner}</span>`;
  }

  // 2) æ ‡é¢˜å®¹å™¨ï¼ˆé«˜åº¦/å†…è¾¹è·/å¯¹é½/é—´è·ï¼‰
  const mh = Math.max(0, Number(customization.headerMinHeight || 0)) || 0;
  const py = Math.max(0, Number(customization.headerPaddingY || 0)) || 0;
  const gapEnabled = !!customization.titleGapEnabled;
  const gapPx = Math.max(0, Number(customization.titleGap || 10)) || 10;
  const align = customization.headerAlign || 'inherit';
  let justify = '';
  if (align === 'left') justify = 'flex-start';
  else if (align === 'center') justify = 'center';
  else if (align === 'right') justify = 'flex-end';

  const headerStyleParts = [];
  if (mh > 0) headerStyleParts.push(`min-height:${mh}px`);
  if (py > 0) headerStyleParts.push(`padding-block:${py}px`);
  if (gapEnabled) headerStyleParts.push(`gap:${gapPx}px`);
  if (justify) headerStyleParts.push(`justify-content:${justify}`);

  // 3) å›¾æ ‡æ³¨å…¥ä¸ä½ç½®
  const iconHTML = makeIconHTML();
  // é»˜è®¤ç­–ç•¥ï¼šè‹¥å¼€å¯å›¾æ ‡ä½†ä½ç½®ä¸º none æˆ–æœªå®šä¹‰ï¼Œåˆ™ç½®å·¦
  const pos = (customization.iconMode !== 'none' && (customization.iconPosition === 'none' || !customization.iconPosition))
    ? 'left'
    : (customization.iconPosition || 'none');

  let inner;
  if (pos === 'left') {
    inner = `${iconHTML}${titleSpan}`;
  } else if (pos === 'right') {
    inner = `${titleSpan}${iconHTML}`;
  } else {
    inner = `${titleSpan}`;
  }

  const headerStyle = headerStyleParts.join('; ');
  return `<div class="st-header" style="${headerStyle}">${inner}</div>`;
}

// å·¥å…·ï¼šç”Ÿæˆåˆ†å‰²çº¿ HTMLï¼ˆä¼˜å…ˆä½¿ç”¨ç¬¬ä¸‰éƒ¨åˆ†åˆ†å‰²çº¿é¢œè‰²ï¼‰
function dividerHTML() {
  // ä¼˜å…ˆå§”æ‰˜åˆ° Ny.Render.dividerHTMLï¼Œä¿æŒä¸é¢„è§ˆä¸€è‡´
  try {
    if (window.Ny && Ny.Render && typeof Ny.Render.dividerHTML === 'function') {
      return Ny.Render.dividerHTML(customization);
    }
  } catch (_e) {}
  // å›é€€ï¼šä¿æŒç°æœ‰è§†è§‰
  const dc = (customization.section2DividerColor && customization.section2DividerColor.trim().length > 0)
    ? customization.section2DividerColor
    : customization.primaryColor;
  if (customization.dividerStyle === 'dashed') {
    return `<hr style="border:none;border-top:1px dashed ${dc};height:0;opacity:.9;">`;
  }
  if (customization.dividerStyle === 'gradient') {
    return `<hr style="border:none;height:1px; background-image:linear-gradient(to right, transparent, ${dc}, transparent);">`;
  }
  return `<hr style="border:none;height:1px;background:${dc};">`;
}

// è¦†å†™ï¼šå†…å®¹é¡¹æ¸²æŸ“ï¼Œé€‚é…å¸ƒå±€ä¸é¢œè‰²ä¸å­—ä½“æ ·å¼ + è¿›åº¦æ¡é£æ ¼/åŠ¨ç”»
function buildItemsHTML(list, theme) {
  const pc = customization.primaryColor;
  const sc = customization.secondaryColor;
  const layout = customization.layout;

  // ç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²ï¼ˆä»…ä½œç”¨äºæ ‡ç­¾/å€¼ä¸æ»‘æ¡å¡«å……ï¼‰
  const s2Label = customization.section2LabelColor && customization.section2LabelColor.trim().length > 0 ? customization.section2LabelColor : '';
  const s2Value = customization.section2ValueColor && customization.section2ValueColor.trim().length > 0 ? customization.section2ValueColor : '';
  const s2Bar   = customization.section2BarColor   && customization.section2BarColor.trim().length   > 0 ? customization.section2BarColor   : '';

// ç»„åˆæ ·å¼ç‰‡æ®µå·¥å…·
  const styleJoin = parts => parts.filter(Boolean).join('; ');

  const labelFontFamily = customization.globalLabelFontFamily || customization.fontFamily;
  const valueFontFamily = customization.globalValueFontFamily || customization.fontFamily;
  const labelWeight = customization.globalLabelWeight || 500;
  const valueWeight = customization.globalValueWeight || 600;
  const labelFontSize = customization.globalLabelFontSize || 0;
  const valueFontSize = customization.globalValueFontSize || 0;
  const labelItalic = customization.globalLabelItalic ? 'font-style:italic' : '';
  const valueItalic = customization.globalValueItalic ? 'font-style:italic' : '';
  const labelUpper = customization.globalLabelUppercase ? 'text-transform:uppercase' : '';
  const valueUpper = customization.globalValueUppercase ? 'text-transform:uppercase' : '';
  const labelReflect = customization.globalLabelReflect ? '-webkit-box-reflect: below 0 linear-gradient(transparent, rgba(255,255,255,.15))' : '';
  const valueReflect = customization.globalValueReflect ? '-webkit-box-reflect: below 0 linear-gradient(transparent, rgba(255,255,255,.15))' : '';
  const reflectInlineBlock = 'display:inline-block';
  // é•¿æ–‡å­—ç‰¹æ•ˆä¸è¡Œè·ï¼ˆå·²æ”¹ä¸ºæ¯é¡¹ç‹¬ç«‹è®¾ç½®ï¼ŒæŒ‰æ¯ä¸ªé¡¹ç›®çš„ ltEffect/ltLineHeight è®¡ç®—ï¼‰

  // æ–°å¢ï¼šè¿›åº¦æ¡é£æ ¼ä¸åŠ¨ç”»
  const barStyle = customization.barStyle || 'normal';
  const barAnimation = customization.barAnimation || 'none';
  const barClassFromStyle = () => {
    switch (barStyle) {
      case 'glow': return 'pf-glow';
      case 'striped': return 'pf-striped';
      case 'glass': return 'pf-glass';
      default: return '';
    }
  };
  const barAnimClass = barAnimation === 'grow' ? 'pf-anim-grow' : '';

  // æ—§ç‰ˆè§’è‰²è¡Œå¸ƒå±€ï¼ˆå·²ç§»é™¤ï¼›ä»…ä¿ç•™å†å²å ä½è¯´æ˜ï¼‰
  if (false) { /* removed legacy role layout */
    const rows = [];
    let row = [];
    list.forEach(it => {
      if (it.type === 'row') {
        if (row.length) { rows.push(row); row = []; }
      } else if (it.type === 'divider') {
        if (row.length) { rows.push(row); row = []; }
        rows.push(['__HR__']);
      } else {
        row.push(it);
        if (row.length === 3) { rows.push(row); row = []; }
      }
    });
    if (row.length) rows.push(row);

    return rows.map(r => {
      if (r.length === 1 && r[0] === '__HR__') return dividerHTML();
      const itemsHTML = r.map(it => {
        if (it.type === 'text') {
          const labelColor = s2Label || it.labelColor || sc;
          const valueColor = s2Value || it.valueColor || pc;
          const lblStyle = styleJoin([
            `color:${labelColor}`,
            `font-family:${labelFontFamily}`,
            `font-weight:${labelWeight}`,
            labelFontSize ? `font-size:${labelFontSize}px` : '',
            labelItalic,
            labelUpper,
            customization.globalLabelReflect ? reflectInlineBlock : '',
            labelReflect
          ]);
          const valStyle = styleJoin([
            `color:${valueColor}`,
            `font-family:${valueFontFamily}`,
            `font-weight:${valueWeight}`,
            valueFontSize ? `font-size:${valueFontSize}px` : '',
            valueItalic,
            valueUpper,
            customization.globalValueReflect ? reflectInlineBlock : '',
            valueReflect
          ]);
          return `
            <div class="st-item">
              <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
              <div class="st-value st-text" style="${valStyle}">${esc(it.value || '')}</div>
            </div>
          `;
        }
        if (it.type === 'bar') {
          const p = clamp(parseInt(it.percent ?? 0, 10) || 0, 0, 100);
          const labelColor = s2Label || it.labelColor || sc;
          const fillColor  = s2Bar   || it.barColor || '';
          const classList = ['st-progress-bar-fill'];
          const styleParts = [];
          if (barAnimClass) classList.push(barAnimClass);
          const styleWidth = barAnimClass ? `width: var(--target); --target: ${p}%` : `width: ${p}%`;
          styleParts.push(styleWidth);
          if (fillColor) {
            styleParts.push(`background: ${esc(fillColor)}`);
            styleParts.push(`--bar-color: ${esc(fillColor)}`);
          } else {
            styleParts.push(`background: linear-gradient(90deg, ${pc}, ${sc})`);
            styleParts.push(`--bar-color: ${pc}`);
          }
          const fillStyle = `style="${styleParts.join('; ')}"`;
          const extraStyleClass = barClassFromStyle();
          if (extraStyleClass) classList.push(extraStyleClass);

          const lblStyle = styleJoin([
            `color:${labelColor}`,
            `font-family:${labelFontFamily}`,
            `font-weight:${labelWeight}`,
            labelFontSize ? `font-size:${labelFontSize}px` : '',
            labelItalic,
            labelUpper,
            customization.globalLabelReflect ? reflectInlineBlock : '',
            labelReflect
          ]);
          // å€¼å®¹å™¨æ ·å¼ï¼ˆç”¨äºå€’å½±/å¤§å†™ç­‰å¯¹æ•°å€¼æ–‡æœ¬ä¹Ÿç”Ÿæ•ˆï¼‰
          const valStyle = styleJoin([
            `font-family:${valueFontFamily}`,
            `font-weight:${valueWeight}`,
            valueFontSize ? `font-size:${valueFontSize}px` : '',
            valueItalic,
            valueUpper,
            customization.globalValueReflect ? reflectInlineBlock : '',
            valueReflect
          ]);
          return `
            <div class="st-item">
              <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
              <div class="st-value" style="width: clamp(120px, 40vw, calc(var(--_vb-base-max,160px) * var(--vb-width-pct,100) / 100)); transform: translateX(calc(1% * var(--vb-offset-pct, 0))); ${valStyle}">
                <div class="st-progress-bar" onclick="(function(bar){var s=bar.querySelector('.st-progress-percent');var show=!(bar.classList&amp;&amp;bar.classList.contains('show-percent'));if(bar.classList)bar.classList.toggle('show-percent',show);if(s){s.style.opacity=show?'1':'0';}})(this)">
                  <div class="${classList.join(' ')}" ${fillStyle}></div><span class="st-progress-percent" style="position:absolute;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;pointer-events:none;opacity:0;transition:opacity .3s;--pct:${p}%;">${p}%</span>
                </div>
              </div>
            </div>
          `;
        }
        return '';
      }).join('');
      // ç«–å‘åˆ†éš”çº¿é¢œè‰²ä»è·Ÿéšä¸»é¢˜ä¸»è‰²
      return `<div class="st-row" style="--rs-sep-color:${customization.primaryColor};">${itemsHTML}</div>`;
    }).join('');
  }

  /* è“è¾‰åˆ†å‰²ï¼ˆrole-rowsï¼‰å¸ƒå±€å·²ç§»é™¤ */

  // åŸé€»è¾‘ï¼ˆä¿ç•™ï¼‰â€”æ”¯æŒå…¨å±€é¢œè‰²ä¸å­—ä½“æ ·å¼è¦†ç›–ï¼ˆæœªè®¾ç½®æ—¶ä»ç”¨ä¸»/è¾…è‰²æˆ–æ¯é¡¹è‡ªå®šä¹‰ï¼‰+ è¿›åº¦æ¡é£æ ¼/åŠ¨ç”»
  return list.map(it => {
    if (it.type === 'divider') return dividerHTML();

    if (it.type === 'text') {
      const labelColor = s2Label || it.labelColor || sc;
      const valueColor = s2Value || it.valueColor || pc;
      const lblStyle = styleJoin([
        `color:${labelColor}`,
        `font-family:${labelFontFamily}`,
        `font-weight:${labelWeight}`,
        labelFontSize ? `font-size:${labelFontSize}px` : '',
        labelItalic,
        labelUpper,
        customization.globalLabelReflect ? reflectInlineBlock : '',
        labelReflect
      ]);
      const valStyleBase = styleJoin([
        `color:${valueColor}`,
        `font-family:${valueFontFamily}`,
        `font-weight:${valueWeight}`,
        valueFontSize ? `font-size:${valueFontSize}px` : '',
        valueItalic,
        valueUpper,
        customization.globalValueReflect ? reflectInlineBlock : '',
        valueReflect
      ]);
      // åŒåˆ—ï¼šæ¯é¡¹è‡ªèº«ä½¿ç”¨ 30/70 ç½‘æ ¼ï¼Œå·¦å³å‡å·¦å¯¹é½ï¼Œæ–‡æœ¬å¯è‡ªåŠ¨æ¢è¡Œ
      if (layout === 'two-column') {
        return `
          <div class="st-item" style="display:grid;grid-template-columns:var(--two-col-label,30%) var(--two-col-value,70%);column-gap:var(--two-col-gap,12px);align-items:start;">
            <div class="st-label" style="${lblStyle}; text-align:left;">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:left;">${esc(it.value || '')}</div>
          </div>
        `;
      }
      if (layout === 'stacked' || layout === 'center') {
        const align = (layout === 'center') ? 'center' : 'flex-start';
        const valueTextAlign = (layout === 'center') ? 'center' : 'right';
        return `
          <div class="st-item" style="display:flex;flex-direction:column;align-items:${align};gap:4px;">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:${valueTextAlign};">${esc(it.value || '')}</div>
          </div>
        `;
      } else if (layout === 'label-left') {
        // æ ‡ç­¾/å€¼æ¯”ä¾‹ç½‘æ ¼ï¼ˆ3:7 å¯è°ƒï¼‰ï¼Œå®¹å™¨ä¸å†™ display æ ·å¼ï¼Œäº¤ç”± CSS æ§åˆ¶
        return `
          <div class="st-item">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:right;">${esc(it.value || '')}</div>
          </div>
        `;
      } else {
        const dir = (layout === 'reverse') ? 'row-reverse' : 'row';
        const valueTextAlign = (layout === 'reverse') ? 'left' : 'right';
        return `
          <div class="st-item" style="display:flex;flex-direction:${dir};align-items:center;justify-content:space-between;">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:${valueTextAlign};">${esc(it.value || '')}</div>
          </div>
        `;
      }
    }
    if (it.type === 'longtext') {
      const labelColor = s2Label || it.labelColor || sc;
      const valueColor = s2Value || it.valueColor || pc;
      const lblStyle = styleJoin([
        `color:${labelColor}`,
        `font-family:${labelFontFamily}`,
        `font-weight:${labelWeight}`,
        labelFontSize ? `font-size:${labelFontSize}px` : '',
        labelItalic,
        labelUpper,
        customization.globalLabelReflect ? reflectInlineBlock : '',
        labelReflect
      ]);
      const valStyle = styleJoin([
        `color:${valueColor}`,
        `font-family:${valueFontFamily}`,
        `font-weight:${valueWeight}`,
        valueFontSize ? `font-size:${valueFontSize}px` : '',
        valueItalic,
        valueUpper,
        customization.globalValueReflect ? reflectInlineBlock : '',
        valueReflect
      ]);
      const spanAll = (customization.layout === 'two-column') ? 'grid-column: 1 / -1;' : '';
      const eff = it.ltEffect || 'none';
      const lh = (typeof it.ltLineHeight === 'number' ? it.ltLineHeight : 1.6);
      const effClass = (eff === 'fade' ? ' anim-fade-in' : (eff === 'slide' ? ' anim-slide-up' : ''));
      let effAttr = '';
      if (eff === 'typewriter') {
        const spd = isFinite(it.ltTwSpeedMs) ? Math.max(5, Math.min(200, Number(it.ltTwSpeedMs))) : 18;
        const dly = isFinite(it.ltTwDelayMs) ? Math.max(0, Number(it.ltTwDelayMs)) : 0;
        const caret = (it.ltTwCaret !== false) ? '1' : '0';
        effAttr = ` data-effect="typewriter" data-tw-speed="${spd}" data-tw-delay="${dly}" data-tw-caret="${caret}"`;
      }

      const indent = Math.max(0, Number(it.ltFirstIndentPx || 0)) || 0;
      const pTop = Math.max(0, Number(it.ltPadTopPx || 0)) || 0;
      const pRight = Math.max(0, Number(it.ltPadRightPx || 0)) || 0;
      const pBottom = Math.max(0, Number(it.ltPadBottomPx || 0)) || 0;
      const pLeft = Math.max(0, Number(it.ltPadLeftPx || 0)) || 0;
      const skip = false; // é¢„è§ˆä¸ç”Ÿæˆä¿æŒä¸€è‡´ï¼šä¸ç©ºå‡ºé¦–è¡Œ
      const padTopCss = `${pTop}px`;
      const dataSkip = '';

      // æ®µè½åˆ†å‰²ä¸æ¸²æŸ“
      const rawText = it.value || '';
      let paragraphs = rawText.split('\n');
      // å»é™¤é¦–å°¾ç©ºè¡Œï¼Œé¿å…å‡ºç°æ— æ•ˆçš„é¢å¤–ç©ºç™½
      while (paragraphs.length && paragraphs[0].trim() === '') paragraphs.shift();
      while (paragraphs.length && paragraphs[paragraphs.length - 1].trim() === '') paragraphs.pop();
      
      let contentHTML = '';
      
      if (eff === 'typewriter') {
        // æ‰“å­—æœºæ•ˆæœï¼šé¢„å…ˆç”Ÿæˆæ®µè½HTMLï¼Œè¿è¡Œæ—¶é€æ®µæ’­æ”¾
        const spd = isFinite(it.ltTwSpeedMs) ? Math.max(5, Math.min(200, Number(it.ltTwSpeedMs))) : 18;
        const dly = isFinite(it.ltTwDelayMs) ? Math.max(0, Number(it.ltTwDelayMs)) : 0;
        const caret = (it.ltTwCaret !== false) ? '1' : '0';
        effAttr = ` data-effect="typewriter" data-tw-speed="${spd}" data-tw-delay="${dly}" data-tw-caret="${caret}"`;
        
        // ä¸ºæ‰“å­—æœºæ•ˆæœç”Ÿæˆæ®µè½HTMLï¼Œæ¯æ®µç‹¬ç«‹ç¼©è¿›
        contentHTML = paragraphs.map((para, idx) => {
          const pStyle = `margin:0; padding:0; text-indent:${indent}px;`;
          return `<p style="${pStyle}">${esc(para)}</p>`;
        }).join('');
        
        return `
          <div class="st-item" style="display:block; ${spanAll}">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-longtext${effClass}"${effAttr}${dataSkip} style="${valStyle}; line-height:${lh}; white-space:normal; margin-top:6px; word-break:break-word; overflow-wrap:anywhere; background: rgba(255,255,255,.05); border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.08), 0 1px 8px rgba(0,0,0,.18); padding-top:${padTopCss}; padding-right:${pRight}px; padding-bottom:${pBottom}px; padding-left:${pLeft}px;">
              ${contentHTML}
            </div>
          </div>
        `;
      } else {
        // æ™®é€šæ•ˆæœï¼ˆfade/slide/noneï¼‰ï¼šæŒ‰æ®µè½åˆ†å‰²æ¸²æŸ“
        contentHTML = paragraphs.map((para, idx) => {
          const pStyle = `margin:0; padding:0; text-indent:${indent}px;`;
          return `<p style="${pStyle}">${esc(para)}</p>`;
        }).join('');
        
        return `
          <div class="st-item" style="display:block; ${spanAll}">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-longtext${effClass}" style="${valStyle}; line-height:${lh}; white-space:normal; margin-top:6px; word-break:break-word; overflow-wrap:anywhere; background: rgba(255,255,255,.05); border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.08), 0 1px 8px rgba(0,0,0,.18); padding-top:${padTopCss}; padding-right:${pRight}px; padding-bottom:${pBottom}px; padding-left:${pLeft}px;">
              ${contentHTML}
            </div>
          </div>
        `;
      }
    }

    if (it.type === 'bar') {
      const p = clamp(parseInt(it.percent ?? 0, 10) || 0, 0, 100);
      const labelColor = s2Label || it.labelColor || sc;
      const fillColor  = s2Bar   || it.barColor || ''; // ç•™ç©ºæ—¶ä½¿ç”¨å„ä¸»é¢˜ CSS é»˜è®¤
      const classList = ['st-progress-bar-fill'];
      const styleParts = [];
      if (barAnimClass) classList.push(barAnimClass);
      const styleWidth = barAnimClass ? `width: var(--target); --target: ${p}%` : `width: ${p}%`;
      styleParts.push(styleWidth);
      if (fillColor) {
        styleParts.push(`background: ${esc(fillColor)}`);
        styleParts.push(`--bar-color: ${esc(fillColor)}`);
      } else {
        styleParts.push(`background: linear-gradient(90deg, ${pc}, ${sc})`);
        styleParts.push(`--bar-color: ${pc}`);
      }
      const fillStyle = `style="${styleParts.join('; ')}"`;
      const extraStyleClass = barClassFromStyle();
      if (extraStyleClass) classList.push(extraStyleClass);

      const lblStyle = styleJoin([
        `color:${labelColor}`,
        `font-family:${labelFontFamily}`,
        `font-weight:${labelWeight}`,
        labelFontSize ? `font-size:${labelFontSize}px` : '',
        labelItalic,
        labelUpper,
        customization.globalLabelReflect ? reflectInlineBlock : '',
        labelReflect
      ]);
      const valStyle = styleJoin([
        `font-family:${valueFontFamily}`,
        `font-weight:${valueWeight}`,
        valueFontSize ? `font-size:${valueFontSize}px` : '',
        valueItalic,
        valueUpper,
        customization.globalValueReflect ? reflectInlineBlock : '',
        valueReflect
      ]);

      if (layout === 'stacked' || layout === 'center') {
        const align = layout === 'center' ? 'center' : 'flex-start';
        const valueWidth = '160px';
        return `
          <div class="st-item" style="display:flex;flex-direction:column;align-items:${align};gap:4px;">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value" style="width: clamp(120px, 40vw, calc(var(--_vb-base-max,160px) * var(--vb-width-pct,100) / 100)); transform: translateX(calc(1% * var(--vb-offset-pct, 0))); ${valStyle}">
              <div class="st-progress-bar" onclick="(function(bar){var s=bar.querySelector('.st-progress-percent');var show=!(bar.classList&amp;&amp;bar.classList.contains('show-percent'));if(bar.classList)bar.classList.toggle('show-percent',show);if(s){s.style.opacity=show?'1':'0';}})(this)">
                <div class="${classList.join(' ')}" ${fillStyle}></div><span class="st-progress-percent" style="position:absolute;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;pointer-events:none;opacity:0;transition:opacity .3s;--pct:${p}%;">${p}%</span>
              </div>
            </div>
          </div>
        `;
      }

      return `
        <div class="st-item" style="display:flex;align-items:center;justify-content:space-between;">
          <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
          <div class="st-value" style="width: clamp(120px, 40vw, calc(var(--_vb-base-max,160px) * var(--vb-width-pct,100) / 100)); transform: translateX(calc(1% * var(--vb-offset-pct, 0))); ${valStyle}">
            <div class="st-progress-bar" onclick="(function(bar){var s=bar.querySelector('.st-progress-percent');var show=!(bar.classList&amp;&amp;bar.classList.contains('show-percent'));if(bar.classList)bar.classList.toggle('show-percent',show);if(s){s.style.opacity=show?'1':'0';}})(this)">
              <div class="${classList.join(' ')}" ${fillStyle}></div><span class="st-progress-percent" style="position:absolute;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;pointer-events:none;opacity:0;transition:opacity .3s;--pct:${p}%;">${p}%</span>
            </div>
          </div>
        </div>
      `;
    }
    return '';
  }).join('');
}

/* æ–°å¢ï¼šæ¸²æŸ“ç²’å­å åŠ å±‚ï¼ˆæ˜Ÿæ˜Ÿ/ç¢å±‘/èŠ±ç“£ï¼‰ */
function renderFxLayers(wrapperEl){
  try {
    if (!wrapperEl) return;
    // æ¸…ç†æ—§å±‚
    wrapperEl.querySelectorAll('.fx-layer').forEach(n=>n.remove());
    const rect = wrapperEl.getBoundingClientRect();
    const W = rect.width || 600;
    const H = rect.height || 200;

    // å·¥å…·
    const rand = (min, max) => Math.random() * (max - min) + min;
    const randInt = (min, max) => Math.floor(rand(min, max + 1));
    const px = v => v + 'px';
    const pct = v => v + '%';

    // æ˜Ÿæ˜Ÿ
    if (customization.starEnabled) {
      const layer = document.createElement('div');
      layer.className = 'fx-layer fx-stars';
      layer.style.setProperty('--star-color', customization.starColor || '#ffffff');
      layer.style.setProperty('--star-speed', (customization.starFrequency || 2) + 's');
      const count = clamp(parseInt(customization.starDensity||0,10)||0, 0, 1000);
      for (let i=0; i<count; i++){
        const e = document.createElement('span');
        e.className = 'fx-star';
        const size = rand(1, 2.5);
        const x = rand(0, 100);
        const y = rand(0, 100);
        e.style.width = px(size);
        e.style.height = px(size);
        e.style.left = pct(x);
        e.style.top = pct(y);
        e.style.animationDelay = rand(0, customization.starFrequency||2) + 's';
        layer.appendChild(e);
      }
      wrapperEl.appendChild(layer);
    }

    // é—ªå…‰ç¢å±‘
    if (customization.sparkleEnabled) {
      const layer = document.createElement('div');
      layer.className = 'fx-layer fx-sparkles';
      layer.style.setProperty('--sparkle-color', customization.sparkleColor || '#ffd966');
      const speed = customization.sparkleFrequency || 2;
      const dir = customization.sparkleDirection === 'up' ? 'up' : 'down';
      const count = clamp(parseInt(customization.sparkleDensity||0,10)||0, 0, 1000);
      for (let i=0; i<count; i++){
        const e = document.createElement('span');
        e.className = 'fx-sparkle' + (customization.sparkleGlow ? ' glow' : '');
        const size = rand(2, 3.5);
        const x = rand(0, 100);
        const delay = rand(0, speed);
        e.style.width = px(size);
        e.style.height = px(size);
        e.style.left = pct(x);
        e.style.top = dir === 'down' ? '-5%' : '105%';
        e.style.animationDuration = speed + 's';
        e.style.animationName = dir === 'down' ? 'sparkleDown' : 'sparkleUp';
        e.style.animationDelay = delay + 's';
        e.style.animationIterationCount = 'infinite';
        e.style.animationTimingFunction = 'linear';
        layer.appendChild(e);
      }
      wrapperEl.appendChild(layer);
    }

    // èŠ±ç“£é£˜è½
    if (customization.petalEnabled) {
      const layer = document.createElement('div');
      layer.className = 'fx-layer fx-petals';
      const speed = customization.petalFrequency || 5;
      const count = clamp(parseInt(customization.petalDensity||0,10)||0, 0, 1000);
      for (let i=0; i<count; i++){
        const e = document.createElement('span');
        e.className = 'fx-petal';
        const x = rand(0, 100);
        const delay = rand(0, speed);
        const rot = rand(-30, 30);
        e.style.left = pct(x);
        e.style.top = '-10%';
        e.style.animationDuration = speed + 's';
        e.style.animationDelay = delay + 's';
        e.style.transform = 'rotate(' + rot + 'deg)';
        // å›¾æ ‡
        if (customization.petalIconMode === 'url' && customization.petalIconUrl){
          const img = document.createElement('img');
          img.src = customization.petalIconUrl;
          img.alt = '';
          e.appendChild(img);
        } else {
          const svg = getBuiltinIconSVG(customization.petalIconBuiltin || 'leaf', 18, customization.secondaryColor || '#ffffff');
          e.innerHTML = svg;
        }
        layer.appendChild(e);
      }
      wrapperEl.appendChild(layer);
    }
    console.log('[fx] renderFxLayers done', {
      starEnabled: customization.starEnabled, sparkleEnabled: customization.sparkleEnabled, petalEnabled: customization.petalEnabled
    });
  } catch (err) {
    console.warn('[fx] renderFxLayers error', err);
  }
}
 
// å¤šå›¾å±‚èƒŒæ™¯ä¸ç»„ä»¶ï¼šæ„å»º/æ‹–æ‹½/ç¼–è¾‘
function buildBgLayersHTML(layers){
  try{
    const L = Array.isArray(layers) ? layers : [];
    if (!L.length) return '';
    const html = L.map(l => {
      const op = isFinite(l?.opacity) ? Math.max(0, Math.min(1, Number(l.opacity))) : 1;
      if (l?.type === 'color') {
        const color = esc(l.color || '#000000');
        return `<div class="bg-layer" style="background:${color};opacity:${op};"></div>`;
      }
      if (l?.type === 'gradient') {
        const style = String(l.style || 'linear');
        const angle = Number(l.angle ?? 135) || 135;
        const dir = String(l.direction || 'to bottom right');
        const start = esc(l.start || customization.primaryColor || '#6a717c');
        const end = esc(l.end || customization.secondaryColor || '#97aec8');
        let grad;
        if (style === 'linear') {
          // çº¿æ€§ï¼šè§’åº¦ä¼˜å…ˆ
          grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
        } else if (style === 'radial') {
          // å¾„å‘ï¼šat ä½ç½®
          const pos = dir.replace(/^to\s+/, '');
          grad = `radial-gradient(at ${pos}, ${start}, ${end})`;
        } else if (style === 'conic') {
          // é”¥å½¢ï¼šfrom è§’åº¦ + at ä½ç½®
          const pos = dir.replace(/^to\s+/, '');
          grad = `conic-gradient(from ${angle}deg at ${pos}, ${start}, ${end})`;
        } else {
          grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
        }
        return `<div class="bg-layer" style="background:${grad};opacity:${op};"></div>`;
      }
      const src = esc(l?.src || '');
      const size = esc(l?.size || 'cover');
      const pos = esc(l?.position || 'center');
      const rep = esc(l?.repeat || 'no-repeat');
      return `<div class="bg-layer" style="background-image:url('${src}');background-size:${size};background-position:${pos};background-repeat:${rep};opacity:${op};"></div>`;
    }).join('');
    return `<div class="bg-layers">${html}</div>`;
  }catch(_e){ return ''; }
}
function buildBgComponentsHTML(components){
  try{
    const C = Array.isArray(components) ? components : [];
    if (!C.length) return '';
    const html = C.filter(c => c && c.visible !== false).map(c => {
      const id = esc(c.id || genId());
      const src = esc(c.src || '');
      const x = isFinite(c.x) ? Math.max(0, Math.min(100, Number(c.x))) : 50;
      const y = isFinite(c.y) ? Math.max(0, Math.min(100, Number(c.y))) : 50;
      const w = isFinite(c.w) ? Math.max(2, Math.min(100, Number(c.w))) : 20;
      const op = isFinite(c.opacity) ? Math.max(0, Math.min(1, Number(c.opacity))) : 1;
      return `<img class="bg-comp" data-id="${id}" src="${src}" alt="" style="left:${x}%;top:${y}%;width:${w}%;opacity:${op};">`;
    }).join('');
    return `<div class="bg-components-layer">${html}</div>`;
  }catch(_e){ return ''; }
}
function setupBgComponentDrag(wrapper){
  try{
    const layer = wrapper?.querySelector('.bg-components-layer');
    if (!layer) return;
    let dragging = null;
    const getRect = () => wrapper.getBoundingClientRect();
    
    // ç»Ÿä¸€çš„åæ ‡æå–ï¼ˆæ”¯æŒé¼ æ ‡å’Œè§¦æ‘¸ï¼‰
    function getCoords(e){
      if (e.touches && e.touches[0]) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }
      return { x: e.clientX, y: e.clientY };
    }
    
    function onDown(e){
      if (!customization.bgCompDrag) return;
      const el = e.target.closest('.bg-comp');
      if (!el) return;
      const id = el.getAttribute('data-id');
      const obj = (customization.bgComponents || []).find(c => c.id === id);
      if (!obj || obj.locked) return;
      e.preventDefault();
      el.classList.add('dragging');
      const rect = getRect();
      const coords = getCoords(e);
      const startX = coords.x, startY = coords.y;
      const startLeft = (isFinite(obj.x) ? obj.x : 50);
      const startTop = (isFinite(obj.y) ? obj.y : 50);
      dragging = { el, id, obj, rect, startX, startY, startLeft, startTop };
      
      // åŒæ—¶ç›‘å¬é¼ æ ‡å’Œè§¦æ‘¸äº‹ä»¶
      document.addEventListener('mousemove', onMove);
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('mouseup', onUp, { once: true });
      document.addEventListener('touchend', onUp, { once: true });
      document.addEventListener('touchcancel', onUp, { once: true });
    }
    
    function onMove(e){
      if (!dragging) return;
      e.preventDefault(); // é˜²æ­¢ç§»åŠ¨ç«¯æ»šåŠ¨
      const { rect, startX, startY, startLeft, startTop, obj, el } = dragging;
      const coords = getCoords(e);
      const dx = ((coords.x - startX) / rect.width) * 100;
      const dy = ((coords.y - startY) / rect.height) * 100;
      obj.x = Math.max(0, Math.min(100, startLeft + dx));
      obj.y = Math.max(0, Math.min(100, startTop + dy));
      el.style.left = obj.x + '%';
      el.style.top = obj.y + '%';
    }
    
    function onUp(){
      if (dragging?.el) dragging.el.classList.remove('dragging');
      dragging = null;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
      document.removeEventListener('touchcancel', onUp);
    }
    
    // åŒæ—¶ç›‘å¬é¼ æ ‡å’Œè§¦æ‘¸å¼€å§‹äº‹ä»¶
    layer.addEventListener('mousedown', onDown);
    layer.addEventListener('touchstart', onDown, { passive: false });
  }catch(_e){}
}
function ensureBgDock(){
  try{
    const pv = document.querySelector('.preview-panel');
    if (!pv) return;
    let dock = pv.querySelector('.bg-dock');
    if (!dock){
      dock = document.createElement('div');
      dock.className = 'bg-dock';
      pv.appendChild(dock);
    }
    if (customization.bgMode === 'layers' && customization.bgCompDrag){
      dock.textContent = 'æ‹–åŠ¨æ¨¡å¼ï¼šå¼€å¯ï¼ˆåœ¨é¢„è§ˆä¸­æ‹–åŠ¨ç»„ä»¶ï¼‰';
      dock.classList.add('show');
    }else{
      dock.classList.remove('show');
    }
  }catch(_e){}
}
function renderBgLayersEditor(){
  try{
    if (!bgLayersList) return;
    const layers = customization.bgLayers || [];
    bgLayersList.innerHTML = layers.map((l, i) => {
      const idx = i + 1;
      const base = `
        <div class="item-controls" data-layer-id="${esc(l.id||'')}">
          <div class="item-header">
            <span>${idx}. å›¾å±‚ - ${l.type === 'color' ? 'é¢œè‰²' : (l.type === 'gradient' ? 'æ¸å˜' : 'å›¾ç‰‡')}</span>
            <div class="item-actions" style="display:flex; gap:6px;">
              <button class="btn" data-action="layer-up" title="ä¸Šç§»">â¬†</button>
              <button class="btn" data-action="layer-down" title="ä¸‹ç§»">â¬‡</button>
              <button class="btn btn-delete" data-action="layer-del" title="åˆ é™¤">âœ•</button>
            </div>
          </div>
          ${l.type === 'color' ? `
            <div class="control-group">
              <label>é¢œè‰²</label>
              <input type="color" value="${esc(l.color||'#000000')}" data-field="layer-color">
            </div>
          ` : (l.type === 'gradient' ? `
            <div class="control-group">
              <label>æ ·å¼</label>
              <select data-field="layer-style">
                <option value="linear"${(l.style||'linear')==='linear'?' selected':''}>çº¿æ€§</option>
                <option value="radial"${(l.style||'linear')==='radial'?' selected':''}>å¾„å‘</option>
                <option value="conic"${(l.style||'linear')==='conic'?' selected':''}>é”¥å½¢</option>
              </select>
            </div>
            <div class="control-group">
              <label>è§’åº¦</label>
              <div class="range-row">
                <input type="range" min="0" max="360" step="1" value="${isFinite(l.angle)?Number(l.angle):135}" data-field="layer-angle">
                <span class="value-pill"><span>${isFinite(l.angle)?Number(l.angle):135}</span>Â°</span>
              </div>
            </div>
            <div class="control-group">
              <label>æ–¹å‘ / ä½ç½®</label>
              <select data-field="layer-direction" style="width:100%;">
                <option value="center"${(l.direction||'to bottom right')==='center'?' selected':''}>ä¸­å¿ƒ</option>
                <option value="top"${(l.direction||'to bottom right')==='top'?' selected':''}>ä¸Š</option>
                <option value="bottom"${(l.direction||'to bottom right')==='bottom'?' selected':''}>ä¸‹</option>
                <option value="left"${(l.direction||'to bottom right')==='left'?' selected':''}>å·¦</option>
                <option value="right"${(l.direction||'to bottom right')==='right'?' selected':''}>å³</option>
                <option value="top left"${(l.direction||'to bottom right')==='top left'?' selected':''}>å·¦ä¸Š</option>
                <option value="top right"${(l.direction||'to bottom right')==='top right'?' selected':''}>å³ä¸Š</option>
                <option value="bottom left"${(l.direction||'to bottom right')==='bottom left'?' selected':''}>å·¦ä¸‹</option>
                <option value="bottom right"${(l.direction||'to bottom right')==='bottom right'?' selected':''}>å³ä¸‹</option>
                <option value="to top"${(l.direction||'to bottom right')==='to top'?' selected':''}>çº¿æ€§ï¼šå‘ä¸Š</option>
                <option value="to bottom"${(l.direction||'to bottom right')==='to bottom'?' selected':''}>çº¿æ€§ï¼šå‘ä¸‹</option>
                <option value="to left"${(l.direction||'to bottom right')==='to left'?' selected':''}>çº¿æ€§ï¼šå‘å·¦</option>
                <option value="to right"${(l.direction||'to bottom right')==='to right'?' selected':''}>çº¿æ€§ï¼šå‘å³</option>
                <option value="to top left"${(l.direction||'to bottom right')==='to top left'?' selected':''}>çº¿æ€§ï¼šå·¦ä¸Š</option>
                <option value="to top right"${(l.direction||'to bottom right')==='to top right'?' selected':''}>çº¿æ€§ï¼šå³ä¸Š</option>
                <option value="to bottom left"${(l.direction||'to bottom right')==='to bottom left'?' selected':''}>çº¿æ€§ï¼šå·¦ä¸‹</option>
                <option value="to bottom right"${(l.direction||'to bottom right')==='to bottom right'?' selected':''}>çº¿æ€§ï¼šå³ä¸‹</option>
              </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="control-group">
                <label>èµ·è‰²</label>
                <input type="color" value="${esc(l.start||customization.primaryColor||'#6a717c')}" data-field="layer-start">
              </div>
              <div class="control-group">
                <label>ç»ˆè‰²</label>
                <input type="color" value="${esc(l.end||customization.secondaryColor||'#97aec8')}" data-field="layer-end">
              </div>
            </div>
          ` : `
            <div class="control-group">
              <label>å›¾ç‰‡ URL</label>
              <input type="text" value="${esc(l.src||'')}" placeholder="https://..." data-field="layer-src">
            </div>
          `)}
          <div class="control-group">
            <label>é€æ˜åº¦</label>
            <div class="range-row">
              <input type="range" min="0" max="1" step="0.05" value="${isFinite(l.opacity)?Number(l.opacity):1}" data-field="layer-opacity">
              <span class="value-pill"><span>${isFinite(l.opacity)?Number(l.opacity).toFixed(2):'1.00'}</span></span>
            </div>
          </div>
        </div>
      `;
      return base;
    }).join('');
  }catch(_e){}
}
function renderBgComponentsEditor(){
  try{
    if (!bgComponentsList) return;
    const comps = customization.bgComponents || [];
    bgComponentsList.innerHTML = comps.map((c, i) => {
      const idx = i + 1;
      const w = isFinite(c.w)? Number(c.w) : 20;
      const op = isFinite(c.opacity)? Number(c.opacity) : 1;
      const vis = (c.visible !== false);
      const locked = !!c.locked;
      return `
        <div class="item-controls" data-comp-id="${esc(c.id||'')}">
          <div class="item-header">
            <span>${idx}. ç»„ä»¶</span>
            <div class="item-actions" style="display:flex; gap:6px;">
              <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" data-field="comp-visible" ${vis?'checked':''}>æ˜¾ç¤º</label>
              <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" data-field="comp-locked" ${locked?'checked':''}>é”å®š</label>
              <button class="btn btn-delete" data-action="comp-del" title="åˆ é™¤">âœ•</button>
            </div>
          </div>
          <div class="control-group">
            <label>å›¾ç‰‡ URL</label>
            <input type="text" value="${esc(c.src||'')}" placeholder="https://..." data-field="comp-src">
          </div>
          <div class="control-group">
            <label>å®½åº¦(%)</label>
            <div class="range-row">
              <input type="range" min="2" max="100" step="1" value="${w}" data-field="comp-w">
              <span class="value-pill"><span>${w}</span>%</span>
            </div>
          </div>
          <div class="control-group">
            <label>é€æ˜åº¦</label>
            <div class="range-row">
              <input type="range" min="0" max="1" step="0.05" value="${op}" data-field="comp-opacity">
              <span class="value-pill"><span>${op.toFixed(2)}</span></span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }catch(_e){}
}
function setupBgEditorsEvents(){
  try{
    if (btnAddColorLayer) btnAddColorLayer.addEventListener('click', () => {
      customization.bgLayers = customization.bgLayers || [];
      customization.bgLayers.push({ id: genId(), type:'color', color:'#000000', opacity:0.5 });
      renderBgLayersEditor(); renderPreview();
    });
    if (btnAddGradientLayer) btnAddGradientLayer.addEventListener('click', () => {
      customization.bgLayers = customization.bgLayers || [];
      customization.bgLayers.push({
        id: genId(),
        type:'gradient',
        style:'linear',
        angle:135,
        direction:'to bottom right',
        start: customization.bgGradientStart || customization.primaryColor || '#6a717c',
        end: customization.bgGradientEnd || customization.secondaryColor || '#97aec8',
        opacity:1
      });
      renderBgLayersEditor(); renderPreview();
    });
    if (btnAddImageLayerUrl) btnAddImageLayerUrl.addEventListener('click', () => {
      const u = window.prompt('è¾“å…¥å›¾ç‰‡ URL:');
      if (!u) return;
      customization.bgLayers = customization.bgLayers || [];
      customization.bgLayers.push({ id: genId(), type:'image', src: u, opacity:1, size:'cover', position:'center', repeat:'no-repeat' });
      renderBgLayersEditor(); renderPreview();
    });
    if (bgLayersList) {
      bgLayersList.addEventListener('click', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-layer-id');
        const i = (customization.bgLayers||[]).findIndex(x => x.id === id);
        if (i < 0) return;
        const actBtn = e.target.closest('button[data-action]');
        if (!actBtn) return;
        const act = actBtn.dataset.action;
        if (act === 'layer-del') customization.bgLayers.splice(i,1);
        if (act === 'layer-up' && i > 0) [customization.bgLayers[i-1], customization.bgLayers[i]] = [customization.bgLayers[i], customization.bgLayers[i-1]];
        if (act === 'layer-down' && i < customization.bgLayers.length-1) [customization.bgLayers[i+1], customization.bgLayers[i]] = [customization.bgLayers[i], customization.bgLayers[i+1]];
        renderBgLayersEditor(); renderPreview();
      });
      bgLayersList.addEventListener('input', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-layer-id');
        const l = (customization.bgLayers||[]).find(x => x.id === id);
        if (!l) return;
        const field = e.target.dataset.field;
        if (field === 'layer-color') l.color = e.target.value;
        if (field === 'layer-src') l.src = e.target.value;
        if (field === 'layer-style') l.style = e.target.value;
        if (field === 'layer-angle') {
          const v = parseInt(e.target.value||'135', 10);
          l.angle = Math.max(0, Math.min(360, isNaN(v)?135:v));
          const pillA = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pillA) pillA.textContent = String(l.angle);
        }
        if (field === 'layer-direction') l.direction = e.target.value;
        if (field === 'layer-start') l.start = e.target.value;
        if (field === 'layer-end') l.end = e.target.value;
        if (field === 'layer-opacity') {
          const v = parseFloat(e.target.value||'1') || 0;
          l.opacity = Math.max(0, Math.min(1, v));
          const pill = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pill) pill.textContent = l.opacity.toFixed(2);
        }
        renderPreview();
      });
    }
    if (btnAddCompUrl) btnAddCompUrl.addEventListener('click', () => {
      const u = window.prompt('è¾“å…¥ç»„ä»¶å›¾ç‰‡ URL:');
      if (!u) return;
      customization.bgComponents = customization.bgComponents || [];
      customization.bgComponents.push({ id: genId(), src: u, x:50, y:50, w:20, opacity:1, visible:true, locked:false });
      renderBgComponentsEditor(); renderPreview();
    });
    if (bgCompDragToggle) bgCompDragToggle.addEventListener('change', (e) => {
      customization.bgCompDrag = !!e.target.checked;
      ensureBgDock();
    });
    if (bgComponentsList){
      bgComponentsList.addEventListener('click', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-comp-id');
        const i = (customization.bgComponents||[]).findIndex(x => x.id === id);
        if (i < 0) return;
        const btn = e.target.closest('button[data-action]');
        if (btn && btn.dataset.action === 'comp-del') {
          customization.bgComponents.splice(i,1);
          renderBgComponentsEditor(); renderPreview();
        }
      });
      bgComponentsList.addEventListener('input', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-comp-id');
        const c = (customization.bgComponents||[]).find(x => x.id === id);
        if (!c) return;
        const field = e.target.dataset.field;
        if (field === 'comp-src') c.src = e.target.value;
        if (field === 'comp-w') { c.w = Math.max(2, Math.min(100, parseInt(e.target.value||'20',10)||20)); const pill = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pill) pill.textContent = c.w; }
        if (field === 'comp-opacity') { const v = parseFloat(e.target.value||'1')||1; c.opacity = Math.max(0, Math.min(1, v)); const pill = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pill) pill.textContent = c.opacity.toFixed(2); }
        if (field === 'comp-visible') c.visible = !!e.target.checked;
        if (field === 'comp-locked') c.locked = !!e.target.checked;
        renderPreview();
      });
    }
  }catch(_e){}
}

// è¦†å†™ï¼šä¸»é¢„è§ˆæ¸²æŸ“ï¼Œæ³¨å…¥èƒŒæ™¯/å­—ä½“/åœ†è§’/å­—è·/è¡Œè·ä»¥åŠåŒåˆ—å¸ƒå±€
function renderPreview() {
  const headerHTML = getHeaderHTML2(currentTheme, currentTitle);
  const itemsHTML = buildItemsHTML(items, currentTheme);
 
  // st-body å¸ƒå±€æ§åˆ¶
  let bodyStyle = '';
   // å¤–å±‚é¢å¤–ç±»ï¼šåŒåˆ—å¸ƒå±€ + æ ‡ç­¾/å€¼æ¯”ä¾‹å¸ƒå±€ï¼ˆé™¤â€œä¸Šä¸‹å †å /å±…ä¸­/åŒåˆ—â€å¤–å‡å¯ç”¨ï¼‰
   let wrapperExtraClass = '';
   if (customization.layout === 'two-column') wrapperExtraClass += ' layout-two-column';
   // æ‰©å±•æ¯”ä¾‹å¸ƒå±€é€‚ç”¨èŒƒå›´ï¼šé™¤ stacked/center/two-column å¤–ï¼Œå…¶ä»–å¸ƒå±€å¯ç”¨æ¯”ä¾‹æ …æ ¼
   if (customization.layout !== 'stacked' && customization.layout !== 'center' && customization.layout !== 'two-column') wrapperExtraClass += ' ratio-layout';
 
  // å¤–å±‚æ ·å¼æ§åˆ¶
  let wrapperStyle = `
    font-family:${customization.fontFamily};
    border-radius:${customization.radius}px;
    letter-spacing:${customization.letterSpacing}em;
    line-height:${customization.lineHeight};
    opacity:${customization.opacity};
  `;
  // 1.5 é¢„è§ˆå®½åº¦æ§åˆ¶ï¼šå›ºå®šä¸º 100% å®¹å™¨å®½åº¦ + max-width é™åˆ¶ï¼ˆclamp è§„åˆ™ï¼‰
  const __maxW = customization.statusbarMaxWidth || 600;
  // å§‹ç»ˆå±…ä¸­æ˜¾ç¤ºï¼šè¶…å®½æ—¶ä»¥ max-width æ”¶ç¼©å¹¶é€šè¿‡ margin:0 auto å±…ä¸­
  wrapperStyle += `width: 100%; max-width: clamp(280px, 92vw, ${__maxW}px); margin: 0 auto;`;

  // åŒåˆ—æ¨¡å¼ï¼šæ³¨å…¥åˆ—æ¯”ä¾‹ä¸é—´è·å˜é‡
  if (customization.layout === 'two-column') {
    const lp = clamp(parseInt(customization.twoColLabelPct ?? 30, 10) || 30, 10, 50);
    const gap = clamp(parseInt(customization.twoColGap ?? 12, 10) || 12, 0, 40);
    const vp = 100 - lp;
    wrapperStyle += `--two-col-label:${lp}%;--two-col-value:${vp}%;--two-col-gap:${gap}px;`;
  }
   // æ ‡ç­¾/å€¼æ¯”ä¾‹å˜é‡ï¼ˆé™¤â€œä¸Šä¸‹å †å /å±…ä¸­/åŒåˆ—â€å¤–å‡ä½¿ç”¨ï¼‰
   if (customization.layout !== 'stacked' && customization.layout !== 'center' && customization.layout !== 'two-column') {
     const lv = clamp(parseInt(customization.lvLabelPct ?? 30, 10) || 30, 10, 50);
     wrapperStyle += `--lv-label:${lv}%;--lv-value:${100 - lv}%;`;
   }

  // èƒŒæ™¯æ¨¡å¼
  const bgMode = customization.bgMode;
  if (bgMode === 'color') {
    wrapperStyle += `background:${customization.bgColor} !important;`;
  } else if (bgMode === 'gradient') {
    const start = (customization.bgGradientStart && customization.bgGradientStart.trim().length > 0) ? customization.bgGradientStart : customization.primaryColor;
    const end   = (customization.bgGradientEnd && customization.bgGradientEnd.trim().length > 0) ? customization.bgGradientEnd   : customization.secondaryColor;
    const style = (customization.bgGradientStyle || 'linear');
    const angle = Number(customization.bgGradientAngle ?? 135) || 135;
    const dir   = (customization.bgGradientDirection || 'to bottom right');
    let grad;
    if (style === 'linear') {
      // çº¿æ€§ï¼šè§’åº¦ä¼˜å…ˆ
      grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
    } else if (style === 'radial') {
      const pos = String(dir || 'center').replace(/^to\s+/, '');
      grad = `radial-gradient(at ${pos}, ${start}, ${end})`;
    } else if (style === 'conic') {
      const pos = String(dir || 'center').replace(/^to\s+/, '');
      grad = `conic-gradient(from ${angle}deg at ${pos}, ${start}, ${end})`;
    } else {
      grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
    }
    wrapperStyle += `background:${grad} !important;`;
  } else if (bgMode === 'image') {
    const url = esc(customization.bgImageUrl || '');
    wrapperStyle += `background-image:url('${url}');background-size:cover;background-position:center;`;
  } else if (bgMode === 'layers') {
    // ç”±è‡ªå®šä¹‰å¤šå›¾å±‚æ¥ç®¡èƒŒæ™¯
    wrapperStyle += `background:transparent !important;`;
  } else if (bgMode === 'none') {
    wrapperStyle += `background:transparent !important;`;
  }

  // å…¨å±€è¿›åº¦æ¡é¢œè‰²å˜é‡ï¼ˆç”¨äºè§å…‰ç­‰æ•ˆæœï¼‰
  const wrapperBarColor = (customization.section2BarColor && customization.section2BarColor.trim().length > 0)
    ? customization.section2BarColor
    : customization.primaryColor;
  wrapperStyle += `--bar-color:${wrapperBarColor};`;

  // ç¬¬ä¸‰éƒ¨åˆ†ï¼šå€¼æ¡†/æ•´ä½“åç§»ä¸é˜´å½±ï¼ˆä»¥ CSS å˜é‡ä¼ é€’åˆ°æ ·å¼å±‚ï¼Œé»˜è®¤ä¸è¶Šç•Œï¼‰
  (function(){
    const pct = Math.max(40, Math.min(100, Number(customization.valueBoxWidthPct ?? 100)));
    const vOff = Math.max(-40, Math.min(40, Number(customization.valueBoxOffsetPct ?? 0)));
    const iOff = Math.max(-40, Math.min(40, Number(customization.itemOffsetPct ?? 0)));
    wrapperStyle += `--vb-width-pct:${pct};--vb-offset-pct:${vOff};--item-offset-pct:${iOff};--item-offset-right-pct:${customization.itemOffsetRightPct ?? 0};`;
  })();

 
  // ç»„åˆ HTML
  const bgLayersHTML = (customization.bgMode === 'layers') ? buildBgLayersHTML(customization.bgLayers) : '';
  const bgCompsHTML = (customization.bgMode === 'layers') ? buildBgComponentsHTML(customization.bgComponents) : '';
  const html = `
    <div class="status-preview-wrapper ${currentTheme} percent-style-${customization.percentDisplay || 'center'}${wrapperExtraClass}" style="${wrapperStyle}">
      ${bgLayersHTML}
      ${bgCompsHTML}
      ${headerHTML}
      <div class="st-body" style="${bodyStyle}">
        ${itemsHTML}
      </div>
    </div>
  `;
  previewContainer.innerHTML = html;
  const wrapper = previewContainer.querySelector('.status-preview-wrapper');
  // åº”ç”¨æ¯ä¸ªé¡¹ç›®çš„å±€éƒ¨â€œå€¼æ¡†ä¸æ•´ä½“åç§»â€è¦†ç›–ï¼ˆé€šè¿‡ CSS å˜é‡ï¼‰
  try {
    const itemNodes = wrapper ? wrapper.querySelectorAll('.st-body .st-item') : [];
    let __idx = 0;
    items.forEach(it => {
      if (it.type === 'divider') return;
      const el = itemNodes[__idx++];
      if (!el) return;
      const valEl = el.querySelector('.st-value');
      // å€¼æ¡†/æ•´ä½“åç§» CSS å˜é‡
      if (isFinite(it.itemOffsetPct)) el.style.setProperty('--item-offset-pct', clamp(parseFloat(it.itemOffsetPct) || 0, -40, 40));
      if (isFinite(it.itemOffsetRightPct)) el.style.setProperty('--item-offset-right-pct', clamp(parseFloat(it.itemOffsetRightPct) || 0, -40, 40));
      if (valEl) {
        if (isFinite(it.vbWidthPct)) valEl.style.setProperty('--vb-width-pct', clamp(parseFloat(it.vbWidthPct) || 100, 40, 100));
        if (isFinite(it.vbOffsetPct)) valEl.style.setProperty('--vb-offset-pct', clamp(parseFloat(it.vbOffsetPct) || 0, -40, 40));
      }
      // é¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±ï¼ˆå…¨å±€ + å±€éƒ¨è¦†ç›–ï¼‰
      (function applyCardBgShadow(){
        try {
          // åŸºäºå…¨å±€åˆå§‹åŒ–
          let mode = customization.itemCardBgMode || 'theme';
          let color = customization.itemCardBgColor || '#111215';
          let gStart = customization.itemCardGradStart || customization.primaryColor;
          let gEnd = customization.itemCardGradEnd || customization.secondaryColor;
          let gAngle = Number(customization.itemCardGradAngle ?? 135) || 135;
          let imgUrl = customization.itemCardBgImageUrl || '';
          let url = customization.itemCardBgUrl || '';

          // å±€éƒ¨è¦†ç›–ï¼šæ”¯æŒ inherit/theme/none/color/gradient/image/url
          if (customization.itemCardPerItemEnabled && it) {
            const localModeRaw = it.cardBgMode;
            if (localModeRaw && String(localModeRaw) !== 'inherit') {
              mode = String(localModeRaw);
            }
            if (mode === 'color') {
              if (it.cardBgColor) color = it.cardBgColor;
            } else if (mode === 'gradient') {
              if (it.cardGradStart) gStart = it.cardGradStart;
              if (it.cardGradEnd) gEnd = it.cardGradEnd;
              if (isFinite(it.cardGradAngle)) gAngle = Number(it.cardGradAngle);
            } else if (mode === 'image') {
              const localImg = (it.cardBgImageUrl != null ? String(it.cardBgImageUrl) : (it.cardImageUrl != null ? String(it.cardImageUrl) : ''));
              if (localImg.trim()) imgUrl = localImg.trim();
            } else if (mode === 'url') {
              const localUrl = (it.cardBgUrl != null ? String(it.cardBgUrl) : (it.cardUrl != null ? String(it.cardUrl) : ''));
              if (localUrl.trim()) url = localUrl.trim();
            }
            // theme/none/inherit: æŒ‰ç…§ mode å¤„ç†ï¼Œå…¶ä½™å­—æ®µå¿½ç•¥
          }

          // åº”ç”¨èƒŒæ™¯
          el.style.background = ''; // reset
          el.style.backgroundImage = '';
          el.style.backgroundSize = '';
          el.style.backgroundPosition = '';
          el.style.backgroundRepeat = '';
          if (mode === 'none') {
            el.style.background = 'transparent';
          } else if (mode === 'color') {
            el.style.background = color;
          } else if (mode === 'gradient') {
            el.style.background = `linear-gradient(${gAngle}deg, ${gStart}, ${gEnd})`;
          } else if (mode === 'image') {
            if (imgUrl && imgUrl.trim()) {
              el.style.backgroundImage = `url('${esc(imgUrl)}')`;
              el.style.backgroundSize = 'cover';
              el.style.backgroundPosition = 'center';
              el.style.backgroundRepeat = 'no-repeat';
            }
          } else if (mode === 'url') {
            if (url && url.trim()) {
              el.style.backgroundImage = `url('${esc(url)}')`;
              el.style.backgroundSize = 'cover';
              el.style.backgroundPosition = 'center';
              el.style.backgroundRepeat = 'no-repeat';
            }
          } // theme: ä¿æŒæ¨¡æ¿é»˜è®¤ï¼Œä¸é¢å¤–è®¾ç½®

          // é˜´å½±ï¼šå±€éƒ¨ä¼˜å…ˆ
          let shadowOn = !!customization.itemCardShadowEnabled;
          let shadowStrength = Number(customization.itemCardShadowStrength || 0.30);
          if (customization.itemCardPerItemEnabled) {
            if (it.cardShadowEnable != null) shadowOn = !!it.cardShadowEnable;
            if (isFinite(it.cardShadowStrength)) shadowStrength = Number(it.cardShadowStrength);
          }
          if (shadowOn) {
            const s = Math.max(0, Math.min(1, shadowStrength));
            const y = (4 + 8 * s).toFixed(1);
            const blur = (10 + 18 * s).toFixed(1);
            el.style.boxShadow = `0 ${y}px ${blur}px rgba(0,0,0,${0.2 + 0.3*s})`;
          } else {
            el.style.boxShadow = '';
          }
        } catch (_e) {}
      })();
    });
    console.log('[diag] per-item overrides applied', items.map(it => ({ id: it.id, vbWidthPct: it.vbWidthPct, vbOffsetPct: it.vbOffsetPct, itemOffsetPct: it.itemOffsetPct, itemOffsetRightPct: it.itemOffsetRightPct, cardUrl: it.cardUrl, cardShadowEnable: it.cardShadowEnable, cardShadowStrength: it.cardShadowStrength })));
  } catch (e) {
    console.warn('[diag] per-item overrides error', e);
  }
  if (customization.bgMode === 'layers') { setupBgComponentDrag(wrapper); ensureBgDock(); }
  // ä¼˜å…ˆä½¿ç”¨ 1.5 é«˜åº¦è®¾ç½®ï¼Œå…¶æ¬¡ä½¿ç”¨å®½åº¦è°ƒèŠ‚æ—¶äº§ç”Ÿçš„é”å®šé«˜åº¦ï¼Œæœ€åæ¢å¤è‡ªåŠ¨é«˜åº¦
  if (wrapper) {
    // å§‹ç»ˆä½¿ç”¨å†…å®¹è‡ªé€‚åº”é«˜åº¦ï¼Œä¸åšé”å®š
    wrapper.style.height = '';
    wrapper.style.overflow = '';
  }
  renderFxLayers(wrapper);
  applyAnimation();

  // é•¿æ–‡å­—æ‰“å­—æœºç‰¹æ•ˆï¼šé€æ®µè½æ’­æ”¾ï¼Œä¿æŒæ®µè½ç»“æ„å’Œé¦–å­—ç¼©è¿›
  try {
    const nodes = wrapper?.querySelectorAll('.st-longtext[data-effect="typewriter"]');
    nodes?.forEach(el => {
      // è·å–æ‰€æœ‰æ®µè½å…ƒç´ 
      const paragraphs = el.querySelectorAll('p');
      if (!paragraphs || paragraphs.length === 0) {
        // å›é€€ï¼šå¦‚æœæ²¡æœ‰æ®µè½ç»“æ„ï¼Œä½¿ç”¨åŸæœ‰é€»è¾‘
        const full = el.textContent || '';
        el.textContent = '';
        const spd = Math.max(5, Math.min(200, parseInt(el.getAttribute('data-tw-speed') || '18', 10) || 18));
        const delay = Math.max(0, parseInt(el.getAttribute('data-tw-delay') || '0', 10) || 0);
        const caretOn = (el.getAttribute('data-tw-caret') !== '0');
        let i = 0;
        const tick = function(){
          if (i >= full.length) { el.textContent = full; return; }
          i++;
          if (caretOn && i < full.length) {
            el.textContent = full.slice(0, i) + 'â–Œ';
          } else {
            el.textContent = full.slice(0, i);
          }
          setTimeout(tick, spd);
        };
        setTimeout(tick, delay);
        return;
      }
      
      // æ–°é€»è¾‘ï¼šé€æ®µè½æ‰“å­—ï¼Œä¿æŒæ®µè½ç»“æ„å’Œé¦–å­—ç¼©è¿›
      const spd = Math.max(5, Math.min(200, parseInt(el.getAttribute('data-tw-speed') || '18', 10) || 18));
      const baseDelay = Math.max(0, parseInt(el.getAttribute('data-tw-delay') || '0', 10) || 0);
      const caretOn = (el.getAttribute('data-tw-caret') !== '0');
      
      let cumulativeDelay = baseDelay;
      
      paragraphs.forEach((p, pIdx) => {
        const fullText = p.textContent || '';
        p.textContent = ''; // æ¸…ç©ºæ®µè½å†…å®¹ä½†ä¿ç•™æ ‡ç­¾å’Œæ ·å¼
        
        let charIndex = 0;
        
        const typeParagraph = function() {
          if (charIndex >= fullText.length) {
            p.textContent = fullText;
            return;
          }
          
          charIndex++;
          if (caretOn && charIndex < fullText.length) {
            p.textContent = fullText.slice(0, charIndex) + 'â–Œ';
          } else {
            p.textContent = fullText.slice(0, charIndex);
          }
          
          setTimeout(typeParagraph, spd);
        };
        
        // å¯åŠ¨å½“å‰æ®µè½çš„æ‰“å­—æ•ˆæœï¼Œä½¿ç”¨ç´¯ç§¯å»¶è¿Ÿç¡®ä¿é¡ºåº
        setTimeout(typeParagraph, cumulativeDelay);
        
        // è®¡ç®—ä¸‹ä¸€æ®µè½çš„èµ·å§‹å»¶è¿Ÿï¼šå½“å‰æ®µè½å­—ç¬¦æ•° Ã— æ‰“å­—é€Ÿåº¦
        cumulativeDelay += fullText.length * spd;
      });
    });
  } catch (_e) {}

  // è¯Šæ–­æ—¥å¿—ï¼šé¢„è§ˆæ¸²æŸ“åçš„åè°ƒåº¦/åŠ¨ç”»å‚æ•°ä¸å½“å‰ items å¿«ç…§
  try {
    const coh = computeCoherence({
      theme: currentTheme,
      primaryColor: customization.primaryColor,
      secondaryColor: customization.secondaryColor,
      letterSpacing: customization.letterSpacing,
      lineHeight: customization.lineHeight,
      animationType: currentAnimation
    });
    console.log('[diag] renderPreview', {
      theme: currentTheme,
      layout: customization.layout,
      fontFamily: customization.fontFamily,
      barStyle: customization.barStyle,
      barAnimation: customization.barAnimation,
      animation: currentAnimation,
      animSpeed,
      animIntensity,
      coherence: coh,
      items: snapshot()
    });
  } catch (e) { console.warn('[diag] renderPreview error', e); }

  // åŒæ­¥å½“å‰é¢„è§ˆçŠ¶æ€åˆ° Ny.Stateï¼Œç¡®ä¿å¯¼å‡ºä¾§(Ny.Export/Ny.CodeGen)ä¸é¢„è§ˆä¸€è‡´
  try {
    if (window.Ny && Ny.State) {
      var S = Ny.State;
      if (S.currentTheme !== currentTheme && typeof S.applyThemeDefaults === 'function') {
        // ä»…å½“ä¸»é¢˜ä¸ä¸€è‡´æ—¶æ‰åˆ‡æ¢ä¸»é¢˜ï¼›éšå³ç”¨ patchCustomization è¦†ç›–å®šåˆ¶é¡¹ï¼Œé¿å…é»˜è®¤è¦†ç›–
        S.applyThemeDefaults(currentTheme);
      }
      if (typeof S.setTitle === 'function') S.setTitle(currentTitle);
      if (typeof S.setItems === 'function') S.setItems(JSON.parse(JSON.stringify(items)));
      if (typeof S.setAnimations === 'function') S.setAnimations(currentEnterAnimation, currentLoopAnimation);
      if (typeof S.setAnimParams === 'function') S.setAnimParams(animSpeed, animIntensity);
      if (typeof S.patchCustomization === 'function') S.patchCustomization(Object.assign({}, customization));
    }
  } catch (_e) {}

}

// äº‹ä»¶ç»‘å®šå·¥å…·
function bind(el, type, handler) { if (el) el.addEventListener(type, handler); }

// äº‹ä»¶è”åŠ¨
/**
 * ä¸»ä½“å­—ä½“é€‰æ‹©å˜æ›´ï¼š
 * - åŒæ­¥æ ‡ç­¾/å€¼å­—ä½“åˆ°ä¸»ä½“å­—ä½“ï¼ˆé»˜è®¤ä¸€è‡´ï¼Œé¿å…å‡ºç°â€œé€‰æ‹©äº†æ–°å­—ä½“ä½†æ–‡æœ¬ä»ç”¨æ—§å­—ä½“â€çš„æƒ…å†µï¼‰
 * - é¢„åŠ è½½æ–° familyï¼Œåˆ·æ–°é¢„è§ˆ
 */
bind(fontFamilySelect, 'change', e => {
  const newVal = e.target.value;
  const oldWrapper = customization.fontFamily;

  // æ›´æ–°ä¸»ä½“å­—ä½“
  customization.fontFamily = newVal;

  // å¼ºåˆ¶åŒæ­¥ï¼šæ ‡ç­¾/å€¼å­—ä½“ä¸ä¸»ä½“ä¸€è‡´ï¼ˆç”¨æˆ·å¦‚éœ€ä¸åŒï¼Œå¯åœ¨â€œé«˜çº§å­—ä½“æ ·å¼â€ä¸­å†å•ç‹¬ä¿®æ”¹ï¼‰
  customization.globalLabelFontFamily = newVal;
  customization.globalValueFontFamily = newVal;
  if (globalLabelFontSelect) globalLabelFontSelect.value = newVal;
  if (globalValueFontSelect) globalValueFontSelect.value = newVal;

  // ä¼˜åŒ–ï¼šé¢„åŠ è½½å­—ä½“å¹¶æ™ºèƒ½ç­‰å¾…ï¼Œé¿å…å›¾è£‚
  try {
    const fam = String(newVal).replace(/['"]/g, '').split(',')[0].trim();
    if (fam && document.fonts && document.fonts.load) {
      let rendered = false;
      const doRender = () => {
        if (!rendered) {
          rendered = true;
          renderPreview();
        }
      };
      
      // ç­–ç•¥1ï¼šç­‰å¾…å­—ä½“åŠ è½½ï¼ˆæˆåŠŸæˆ–å¤±è´¥éƒ½æ¸²æŸ“ï¼‰
      document.fonts.load(`16px "${fam}"`).then(() => {
        console.debug('[font-change] font loaded successfully', { family: fam });
        doRender();
      }).catch(() => {
        console.warn('[font-change] font load failed, using fallback', { family: fam });
        doRender();
      });
      
      // ç­–ç•¥2ï¼šè¶…æ—¶ä¿æŠ¤ï¼ˆ500msåå¼ºåˆ¶æ¸²æŸ“ï¼Œç»™äºˆæ›´å……è¶³æ—¶é—´ï¼‰
      setTimeout(doRender, 500);
      
      // ç­–ç•¥3ï¼šæ£€æŸ¥å­—ä½“æ˜¯å¦å·²ç¼“å­˜/å¯ç”¨ï¼ˆåŒæ­¥æ£€æŸ¥ï¼‰
      if (document.fonts.check && document.fonts.check(`16px "${fam}"`)) {
        console.debug('[font-change] font already available', { family: fam });
        doRender();
      }
    } else {
      // æµè§ˆå™¨ä¸æ”¯æŒ font loading APIï¼Œç›´æ¥æ¸²æŸ“
      renderPreview();
    }
  } catch (_e) {
    // å‡ºé”™æ—¶ä¹Ÿè¦æ¸²æŸ“
    renderPreview();
  }

  console.debug('[font-change] wrapper/global synced', { oldWrapper, newVal });
});
bind(primaryColorInput, 'input', e => { customization.primaryColor = e.target.value; if (primaryColorCodeInput) primaryColorCodeInput.value = e.target.value; renderPreview(); });
bind(secondaryColorInput, 'input', e => { customization.secondaryColor = e.target.value; if (secondaryColorCodeInput) secondaryColorCodeInput.value = e.target.value; renderPreview(); });
// é¢œè‰²ä»£ç è¾“å…¥è”åŠ¨ï¼ˆä¸»/è¾…è‰²ï¼‰
bind(primaryColorCodeInput, 'input', e => {
  customization.primaryColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && primaryColorInput) primaryColorInput.value = v;
  renderPreview();
});
bind(secondaryColorCodeInput, 'input', e => {
  customization.secondaryColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && secondaryColorInput) secondaryColorInput.value = v;
  renderPreview();
});

bind(borderRadiusRange, 'input', e => {
  customization.radius = parseInt(e.target.value || '0', 10);
  if (radiusValue) radiusValue.textContent = String(customization.radius);
  renderPreview();
});

bind(bgModeSelect, 'change', e => { customization.bgMode = e.target.value; updateBgFieldsVisibility(); renderPreview(); });
bind(bgColorInput, 'input', e => { customization.bgColor = e.target.value; if (bgColorCodeInput) bgColorCodeInput.value = e.target.value; renderPreview(); });
// é¢œè‰²ä»£ç è¾“å…¥è”åŠ¨ï¼ˆçº¯è‰²èƒŒæ™¯ï¼‰
bind(bgColorCodeInput, 'input', e => {
  customization.bgColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && bgColorInput) bgColorInput.value = v;
  renderPreview();
});
bind(bgGradientStartColorInput, 'input', e => { customization.bgGradientStart = e.target.value; if (bgGradientStartCodeInput) bgGradientStartCodeInput.value = e.target.value; renderPreview(); });
bind(bgGradientStartCodeInput, 'input', e => {
  customization.bgGradientStart = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && bgGradientStartColorInput) bgGradientStartColorInput.value = v;
  renderPreview();
});
bind(bgGradientEndColorInput, 'input', e => { customization.bgGradientEnd = e.target.value; if (bgGradientEndCodeInput) bgGradientEndCodeInput.value = e.target.value; renderPreview(); });
bind(bgGradientEndCodeInput, 'input', e => {
  customization.bgGradientEnd = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && bgGradientEndColorInput) bgGradientEndColorInput.value = v;
  renderPreview();
});
bind(bgGradientStyleSelect, 'change', e => { customization.bgGradientStyle = e.target.value; renderPreview(); });
bind(bgGradientAngleRange, 'input', e => {
  customization.bgGradientAngle = parseInt(e.target.value || '135', 10);
  if (bgGradientAngleValue) bgGradientAngleValue.textContent = String(customization.bgGradientAngle);
  renderPreview();
});
bind(bgGradientDirectionSelect, 'change', e => { customization.bgGradientDirection = e.target.value; renderPreview(); });
bind(bgImageUrlInput, 'input', e => { customization.bgImageUrl = e.target.value; renderPreview(); });


bind(layoutSelect, 'change', e => {
  customization.layout = e.target.value;
  updateTwoColumnFieldsVisibility();
  // åŒæ­¥åŒåˆ—æ§ä»¶çš„å€¼å±•ç¤º
  if (twoColLabelPctRange && twoColLabelPctValue) {
    twoColLabelPctRange.value = String(customization.twoColLabelPct ?? 30);
    twoColLabelPctValue.textContent = String(customization.twoColLabelPct ?? 30);
  }
  if (twoColGapRange && twoColGapValue) {
    twoColGapRange.value = String(customization.twoColGap ?? 12);
    twoColGapValue.textContent = String(customization.twoColGap ?? 12);
  }
  renderPreview();
});
bind(letterSpacingRange, 'input', e => {
  customization.letterSpacing = parseFloat(e.target.value || '0');
  if (letterSpacingValue) letterSpacingValue.textContent = customization.letterSpacing.toFixed(2);
  renderPreview();
});
bind(lineHeightRange, 'input', e => {
  customization.lineHeight = parseFloat(e.target.value || '1.4');
  if (lineHeightValue) lineHeightValue.textContent = customization.lineHeight.toFixed(2);
  renderPreview();
});

/* åŒåˆ—è®¾ç½®è”åŠ¨ */
bind(twoColLabelPctRange, 'input', e => {
  customization.twoColLabelPct = clamp(parseInt(e.target.value || '30', 10) || 30, 10, 50);
  if (twoColLabelPctValue) twoColLabelPctValue.textContent = String(customization.twoColLabelPct);
  renderPreview();
});
bind(twoColGapRange, 'input', e => {
  customization.twoColGap = clamp(parseInt(e.target.value || '12', 10) || 12, 0, 40);
  if (twoColGapValue) twoColGapValue.textContent = String(customization.twoColGap);
  renderPreview();
});
/* æ ‡é¢˜å¯ç”¨å¼€å…³ */
bind(titleEnabledCheckbox, 'change', e => {
  customization.titleEnabled = !!e.target.checked;
  // åŒæ­¥åˆ° Ny.State.customizationï¼ˆå¦‚æœå­˜åœ¨ï¼‰
  try {
    if (window.Ny && Ny.State && Ny.State.customization) {
      Ny.State.customization.titleEnabled = customization.titleEnabled;
    }
  } catch(_e){}
  console.log('[titleEnabledCheckbox] titleEnabled changed to:', customization.titleEnabled);
  renderPreview();
});
/* æ ‡é¢˜å­—å· */
bind(titleFontSizeRange, 'input', e => {
  customization.titleFontSize = parseInt(e.target.value || '20', 10);
  if (titleFontSizeValue) titleFontSizeValue.textContent = String(customization.titleFontSize);
  renderPreview();
});

// æ ‡é¢˜åŒºåŸŸè‡ªå®šä¹‰ï¼šæ˜¾éšè”åŠ¨
function updateTitleColorFieldsVisibility(){
  try{
    const mode = titleColorModeSelect?.value || 'theme';
    if (titleColorSolidGroup) titleColorSolidGroup.style.display = (mode === 'solid') ? '' : 'none';
    if (titleColorGradientGroup) titleColorGradientGroup.style.display = (mode === 'gradient') ? '' : 'none';
  }catch(_e){}
}

// æ ‡é¢˜é«˜åº¦/å†…è¾¹è·
bind(headerMinHeightRange, 'input', e => {
  customization.headerMinHeight = parseInt(e.target.value || '0', 10) || 0;
  if (headerMinHeightValue) headerMinHeightValue.textContent = String(customization.headerMinHeight);
  renderPreview();
});
bind(headerPaddingYRange, 'input', e => {
  customization.headerPaddingY = parseInt(e.target.value || '0', 10) || 0;
  if (headerPaddingYValue) headerPaddingYValue.textContent = String(customization.headerPaddingY);
  renderPreview();
});

// å¯¹é½
bind(headerAlignSelect, 'change', e => {
  customization.headerAlign = e.target.value || 'inherit';
  renderPreview();
});

// é—´è·
bind(titleGapEnableCheckbox, 'change', e => {
  const on = !!e.target.checked;
  customization.titleGapEnabled = on;
  if (titleGapRange) titleGapRange.disabled = !on;
  renderPreview();
});
bind(titleGapRange, 'input', e => {
  customization.titleGap = parseInt(e.target.value || '10', 10) || 10;
  if (titleGapValue) titleGapValue.textContent = String(customization.titleGap);
  renderPreview();
});

// é¢œè‰²æ¨¡å¼
bind(titleColorModeSelect, 'change', e => {
  customization.titleColorMode = e.target.value || 'theme';
  updateTitleColorFieldsVisibility();
  renderPreview();
});
bind(titleColorSolidInput, 'input', e => {
  customization.titleColorSolid = e.target.value;
  if (titleColorSolidCodeInput) titleColorSolidCodeInput.value = e.target.value;
  renderPreview();
});
bind(titleColorSolidCodeInput, 'input', e => {
  customization.titleColorSolid = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleColorSolidInput) titleColorSolidInput.value = v;
  renderPreview();
});
bind(titleGradStartInput, 'input', e => {
  customization.titleGradStart = e.target.value;
  if (titleGradStartCodeInput) titleGradStartCodeInput.value = e.target.value;
  renderPreview();
});
bind(titleGradStartCodeInput, 'input', e => {
  customization.titleGradStart = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleGradStartInput) titleGradStartInput.value = v;
  renderPreview();
});
bind(titleGradEndInput, 'input', e => {
  customization.titleGradEnd = e.target.value;
  if (titleGradEndCodeInput) titleGradEndCodeInput.value = e.target.value;
  renderPreview();
});
bind(titleGradEndCodeInput, 'input', e => {
  customization.titleGradEnd = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleGradEndInput) titleGradEndInput.value = v;
  renderPreview();
});
bind(titleGradAngleRange, 'input', e => {
  customization.titleGradAngle = parseInt(e.target.value || '0', 10) || 0;
  if (titleGradAngleValue) titleGradAngleValue.textContent = String(customization.titleGradAngle);
  renderPreview();
});

// ç‰¹æ•ˆ
bind(titleGlowEnableCheckbox, 'change', e => {
  customization.titleEffectGlow = !!e.target.checked;
  if (titleGlowIntensityRange) titleGlowIntensityRange.disabled = !customization.titleEffectGlow;
  renderPreview();
});
bind(titleGlowIntensityRange, 'input', e => {
  customization.titleGlowIntensity = parseFloat(e.target.value || '0.5') || 0.5;
  if (titleGlowIntensityValue) titleGlowIntensityValue.textContent = customization.titleGlowIntensity.toFixed(2);
  renderPreview();
});
bind(titleShadowEnableCheckbox, 'change', e => {
  customization.titleEffectShadow = !!e.target.checked;
  if (titleShadowStrengthRange) titleShadowStrengthRange.disabled = !customization.titleEffectShadow;
  renderPreview();
});
bind(titleShadowStrengthRange, 'input', e => {
  customization.titleShadowStrength = parseFloat(e.target.value || '0.3') || 0.3;
  if (titleShadowStrengthValue) titleShadowStrengthValue.textContent = customization.titleShadowStrength.toFixed(2);
  renderPreview();
});

// æ ‡é¢˜é«˜çº§æ ·å¼ç»‘å®š
bind(titleWeightSelect, 'change', e => { customization.titleWeight = parseInt(e.target.value || '500', 10) || 500; renderPreview(); });
bind(titleItalicCheckbox, 'change', e => { customization.titleItalic = !!e.target.checked; renderPreview(); });
bind(titleUppercaseCheckbox, 'change', e => { customization.titleUppercase = !!e.target.checked; renderPreview(); });
bind(titleLetterSpacingRange, 'input', e => {
  customization.titleLetterSpacing = parseFloat(e.target.value || '0') || 0;
  if (titleLetterSpacingValue) titleLetterSpacingValue.textContent = customization.titleLetterSpacing.toFixed(2);
  renderPreview();
});

// ä¸‹åˆ’çº¿
bind(titleUnderlineStyleSelect, 'change', e => { customization.titleUnderlineStyle = e.target.value || 'none'; renderPreview(); });
bind(titleUnderlineColorInput, 'input', e => { customization.titleUnderlineColor = e.target.value; if (titleUnderlineColorCodeInput) titleUnderlineColorCodeInput.value = e.target.value; renderPreview(); });
bind(titleUnderlineColorCodeInput, 'input', e => {
  customization.titleUnderlineColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleUnderlineColorInput) titleUnderlineColorInput.value = v;
  renderPreview();
});
bind(titleUnderlineThicknessRange, 'input', e => {
  customization.titleUnderlineThickness = parseInt(e.target.value || '2', 10) || 2;
  if (titleUnderlineThicknessValue) titleUnderlineThicknessValue.textContent = String(customization.titleUnderlineThickness);
  renderPreview();
});
bind(titleUnderlineOffsetRange, 'input', e => {
  customization.titleUnderlineOffset = parseInt(e.target.value || '4', 10) || 4;
  if (titleUnderlineOffsetValue) titleUnderlineOffsetValue.textContent = String(customization.titleUnderlineOffset);
  renderPreview();
});

// æ ‡é¢˜å¾½ç« 
bind(titleBadgeEnableCheckbox, 'change', e => { customization.titleBadgeEnabled = !!e.target.checked; renderPreview(); });
bind(titleBadgeColorInput, 'input', e => { customization.titleBadgeColor = e.target.value; if (titleBadgeColorCodeInput) titleBadgeColorCodeInput.value = e.target.value; renderPreview(); });
bind(titleBadgeColorCodeInput, 'input', e => {
  customization.titleBadgeColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleBadgeColorInput) titleBadgeColorInput.value = v;
  renderPreview();
});


// åˆå§‹é¢œè‰²æ§ä»¶æ˜¾éš
updateTitleColorFieldsVisibility();
if (titleGapRange) titleGapRange.disabled = !customization.titleGapEnabled;
if (titleGlowIntensityRange) titleGlowIntensityRange.disabled = !customization.titleEffectGlow;
if (titleShadowStrengthRange) titleShadowStrengthRange.disabled = !customization.titleEffectShadow;
// æ ‡ç­¾/å€¼å­—å·
bind(globalLabelFontSizeRange, 'input', e => {
  customization.globalLabelFontSize = parseInt(e.target.value || '16', 10);
  if (globalLabelFontSizeValue) globalLabelFontSizeValue.textContent = String(customization.globalLabelFontSize);
  renderPreview();
});
bind(globalValueFontSizeRange, 'input', e => {
  customization.globalValueFontSize = parseInt(e.target.value || '16', 10);
  if (globalValueFontSizeValue) globalValueFontSizeValue.textContent = String(customization.globalValueFontSize);
  renderPreview();
});
bind(opacityRange, 'input', e => {
  customization.opacity = parseFloat(e.target.value || '1');
  if (opacityValue) opacityValue.textContent = customization.opacity.toFixed(2);
  renderPreview();
});
// 2ï¼šé¢„è§ˆæœ€å¤§å®½åº¦è”åŠ¨
bind(statusbarWidthRange, 'input', e => {
  // ä»…è°ƒæ•´æœ€å¤§å®½åº¦ï¼Œä¸é”å®šé«˜åº¦ï¼›é«˜åº¦éšå†…å®¹ï¼ˆé¡¹ç›®æ•°é‡ï¼‰è‡ªé€‚åº”å˜åŒ–
  customization.statusbarMaxWidth = clamp(parseInt(e.target.value || '600', 10) || 600, 300, 1200);
  if (statusbarWidthValue) statusbarWidthValue.textContent = String(customization.statusbarMaxWidth);
  renderPreview();
});
bind(dividerStyleSelect, 'change', e => { customization.dividerStyle = e.target.value; renderPreview(); });
bind(barStyleSelect, 'change', e => { customization.barStyle = e.target.value; renderItemsEditor(); renderPreview(); });
bind(barAnimationSelect, 'change', e => { customization.barAnimation = e.target.value; renderPreview(); });
bind(percentDisplaySelect, 'change', e => { customization.percentDisplay = e.target.value; renderPreview(); });

// é¡¹ç›®å¡ç‰‡èƒŒæ™¯ä¸é˜´å½±ï¼ˆå…¨å±€ï¼‰
bind(itemCardPerItemToggle, 'change', e => { customization.itemCardPerItemEnabled = !!e.target.checked; renderItemsEditor(); renderPreview(); });
bind(itemCardBgModeSelect, 'change', e => { customization.itemCardBgMode = e.target.value; updateItemCardBgFieldsVisibility(); renderPreview(); });
bind(itemCardBgColorInput, 'input', e => { customization.itemCardBgColor = e.target.value; if (itemCardBgColorCodeInput) itemCardBgColorCodeInput.value = e.target.value; renderPreview(); });
bind(itemCardBgColorCodeInput, 'input', e => { customization.itemCardBgColor = e.target.value; const v=e.target.value; if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && itemCardBgColorInput) itemCardBgColorInput.value = v; renderPreview(); });
bind(itemCardGradStartInput, 'input', e => { customization.itemCardGradStart = e.target.value; if (itemCardGradStartCodeInput) itemCardGradStartCodeInput.value = e.target.value; renderPreview(); });
bind(itemCardGradStartCodeInput, 'input', e => { customization.itemCardGradStart = e.target.value; const v=e.target.value; if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && itemCardGradStartInput) itemCardGradStartInput.value = v; renderPreview(); });
bind(itemCardGradEndInput, 'input', e => { customization.itemCardGradEnd = e.target.value; if (itemCardGradEndCodeInput) itemCardGradEndCodeInput.value = e.target.value; renderPreview(); });
bind(itemCardGradEndCodeInput, 'input', e => { customization.itemCardGradEnd = e.target.value; const v=e.target.value; if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && itemCardGradEndInput) itemCardGradEndInput.value = v; renderPreview(); });
bind(itemCardGradAngleRange, 'input', e => { customization.itemCardGradAngle = parseInt(e.target.value || '135', 10); if (itemCardGradAngleValue) itemCardGradAngleValue.textContent = String(customization.itemCardGradAngle); renderPreview(); });
bind(itemCardBgImageUrlInput, 'input', e => { customization.itemCardBgImageUrl = e.target.value; renderPreview(); });
bind(itemCardBgUrlInput, 'input', e => { customization.itemCardBgUrl = e.target.value; renderPreview(); });
bind(itemCardShadowEnableCheckbox, 'change', e => { customization.itemCardShadowEnabled = !!e.target.checked; if (itemCardShadowStrengthRange) itemCardShadowStrengthRange.disabled = !customization.itemCardShadowEnabled; renderPreview(); });
bind(itemCardShadowStrengthRange, 'input', e => { customization.itemCardShadowStrength = parseFloat(e.target.value || '0.30') || 0.30; if (itemCardShadowStrengthValue) itemCardShadowStrengthValue.textContent = customization.itemCardShadowStrength.toFixed(2); renderPreview(); });

// å…‰æ™•è®¾ç½®è”åŠ¨
bind(glowColorAInput, 'input', e => { customization.glowColorA = e.target.value; if (glowColorACodeInput) glowColorACodeInput.value = e.target.value; applyAnimation(); });
bind(glowColorACodeInput, 'input', e => {
  customization.glowColorA = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && glowColorAInput) glowColorAInput.value = v;
  applyAnimation();
});
bind(glowColorBInput, 'input', e => { customization.glowColorB = e.target.value; if (glowColorBCodeInput) glowColorBCodeInput.value = e.target.value; applyAnimation(); });
bind(glowColorBCodeInput, 'input', e => {
  customization.glowColorB = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && glowColorBInput) glowColorBInput.value = v;
  applyAnimation();
});
bind(glowSpeedRange, 'input', e => { customization.glowSpeed = parseFloat(e.target.value || '1'); if (glowSpeedValue) glowSpeedValue.textContent = customization.glowSpeed.toFixed(1); applyAnimation(); });

// é•¿æ–‡å­—ï¼šè¡Œè·ä¸ç‰¹æ•ˆ
bind(longtextLineHeightRange, 'input', e => {
  customization.longTextLineHeight = parseFloat(e.target.value || '1.6');
  if (longtextLineHeightValue) longtextLineHeightValue.textContent = customization.longTextLineHeight.toFixed(2);
  renderPreview();
});
bind(longtextEffectSelect, 'change', e => {
  customization.longTextEffect = e.target.value || 'none';
  renderPreview();
});

// æ–°å¢ï¼šç¬¬ä¸‰éƒ¨åˆ† å€¼æ¡†å°ºå¯¸/ä½ç½® + æ•´ä½“åç§»/é˜´å½± äº‹ä»¶è”åŠ¨
bind(valueBoxWidthPctRange, 'input', e => {
  customization.valueBoxWidthPct = clamp(parseInt(e.target.value || '100', 10) || 100, 40, 100);
  if (valueBoxWidthPctValue) valueBoxWidthPctValue.textContent = String(customization.valueBoxWidthPct);
  renderPreview();
});
bind(valueBoxOffsetPctRange, 'input', e => {
  customization.valueBoxOffsetPct = clamp(parseInt(e.target.value || '0', 10) || 0, -40, 40);
  if (valueBoxOffsetPctValue) valueBoxOffsetPctValue.textContent = String(customization.valueBoxOffsetPct);
  renderPreview();
});
bind(itemOffsetPctRange, 'input', e => {
  customization.itemOffsetPct = clamp(parseInt(e.target.value || '0', 10) || 0, -40, 40);
  if (itemOffsetPctValue) itemOffsetPctValue.textContent = String(customization.itemOffsetPct);
  renderPreview();
});

bind(itemOffsetRightPctRange, 'input', e => {
  customization.itemOffsetRightPct = clamp(parseInt(e.target.value || '0', 10) || 0, -40, 40);
  if (itemOffsetRightPctValue) itemOffsetRightPctValue.textContent = String(customization.itemOffsetRightPct);
  renderPreview();
});

// æ–°å¢ï¼šæ ‡ç­¾/å€¼æ¯”ä¾‹è”åŠ¨ï¼ˆä»…å·¦å³æ’åˆ—ï¼‰
bind(labelValueLabelPctRange, 'input', e => {
  customization.lvLabelPct = clamp(parseInt(e.target.value || '30', 10) || 30, 10, 50);
  if (labelValueLabelPctValue) labelValueLabelPctValue.textContent = String(customization.lvLabelPct);
  if (labelValueValuePctValue) labelValueValuePctValue.textContent = String(100 - customization.lvLabelPct);
  renderPreview();
});

// å§”æ‰˜ç‚¹å‡»ï¼šç»Ÿä¸€åˆ‡æ¢é¢„è§ˆä¸­çš„ç™¾åˆ†æ¯”æ˜¾ç¤ºï¼Œé¿å…ä¸å†…è” onclick åŒé‡è§¦å‘é€ æˆâ€œæ¥å›åˆ‡æ¢ä¸ºåŸçŠ¶æ€â€
document.addEventListener('click', (e) => {
  const bar = e.target.closest('.st-progress-bar');
  if (!bar) return;
  // è‹¥è¯¥æ¡å¸¦æœ‰å†…è” onclickï¼Œåˆ™äº¤ç»™å†…è”å¤„ç†ï¼Œé˜²æ­¢åŒé‡åˆ‡æ¢
  if (bar.getAttribute && bar.getAttribute('onclick')) {
    return;
  }
  const pctEl = bar.querySelector('.st-progress-percent');
  if (pctEl) {
    const show = !bar.classList.contains('show-percent');
    bar.classList.toggle('show-percent', show);
    // åŒæ­¥å†…è” opacityï¼Œå…¼å®¹å¤šå¤„ç”Ÿæˆç‰‡æ®µçš„è¡Œä¸º
    pctEl.style.opacity = show ? '1' : '0';
    console.log('[diag] pct-toggle-preview', {
      show,
      percentStyle: customization.percentDisplay,
      theme: currentTheme
    });
  }
});

// æ–°å¢ï¼šç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²è”åŠ¨ï¼ˆä»…å½±å“â€œçŠ¶æ€é¡¹ç›®â€ï¼‰
bind(section2LabelColorInput, 'input', e => { customization.section2LabelColor = e.target.value; if (section2LabelColorCodeInput) section2LabelColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
bind(section2ValueColorInput, 'input', e => { customization.section2ValueColor = e.target.value; if (section2ValueColorCodeInput) section2ValueColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
bind(section2BarColorInput, 'input', e => { customization.section2BarColor = e.target.value; if (section2BarColorCodeInput) section2BarColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
bind(section2DividerColorInput, 'input', e => { customization.section2DividerColor = e.target.value; if (section2DividerColorCodeInput) section2DividerColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
// é¢œè‰²ä»£ç è¾“å…¥è”åŠ¨ï¼ˆç¬¬ä¸‰éƒ¨åˆ†é¡¹ç›®é¢œè‰²ï¼‰
bind(section2LabelColorCodeInput, 'input', e => {
  customization.section2LabelColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2LabelColorInput) section2LabelColorInput.value = v;
  renderItemsEditor(); renderPreview();
});
bind(section2ValueColorCodeInput, 'input', e => {
  customization.section2ValueColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2ValueColorInput) section2ValueColorInput.value = v;
  renderItemsEditor(); renderPreview();
});
bind(section2BarColorCodeInput, 'input', e => {
  customization.section2BarColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2BarColorInput) section2BarColorInput.value = v;
  renderItemsEditor(); renderPreview();
});
bind(section2DividerColorCodeInput, 'input', e => {
  customization.section2DividerColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2DividerColorInput) section2DividerColorInput.value = v;
  renderItemsEditor(); renderPreview();
});

// æ–°å¢ï¼šæ ‡ç­¾/å€¼å­—ä½“ä¸æ ·å¼è”åŠ¨ï¼ˆç¬¬ä¸‰éƒ¨åˆ†ï¼‰- ä¼˜åŒ–ï¼šæ™ºèƒ½ç­‰å¾…å­—ä½“åŠ è½½
bind(globalLabelFontSelect, 'change', e => { 
  customization.globalLabelFontFamily = e.target.value; 
  const fam = String(e.target.value).replace(/['"]/g, '').split(',')[0].trim();
  if (fam && document.fonts && document.fonts.load) {
    let rendered = false;
    const doRender = () => { if (!rendered) { rendered = true; renderPreview(); } };
    document.fonts.load(`16px "${fam}"`).then(doRender).catch(doRender);
    setTimeout(doRender, 500);
    if (document.fonts.check && document.fonts.check(`16px "${fam}"`)) doRender();
  } else {
    renderPreview();
  }
});
bind(globalValueFontSelect, 'change', e => { 
  customization.globalValueFontFamily = e.target.value; 
  const fam = String(e.target.value).replace(/['"]/g, '').split(',')[0].trim();
  if (fam && document.fonts && document.fonts.load) {
    let rendered = false;
    const doRender = () => { if (!rendered) { rendered = true; renderPreview(); } };
    document.fonts.load(`16px "${fam}"`).then(doRender).catch(doRender);
    setTimeout(doRender, 500);
    if (document.fonts.check && document.fonts.check(`16px "${fam}"`)) doRender();
  } else {
    renderPreview();
  }
});
bind(globalLabelWeightSelect, 'change', e => { customization.globalLabelWeight = parseInt(e.target.value || '500', 10); renderPreview(); });
bind(globalValueWeightSelect, 'change', e => { customization.globalValueWeight = parseInt(e.target.value || '600', 10); renderPreview(); });
bind(globalLabelItalicCheckbox, 'change', e => { customization.globalLabelItalic = !!e.target.checked; renderPreview(); });
bind(globalValueItalicCheckbox, 'change', e => { customization.globalValueItalic = !!e.target.checked; renderPreview(); });
bind(globalLabelUppercaseCheckbox, 'change', e => { customization.globalLabelUppercase = !!e.target.checked; renderPreview(); });
bind(globalValueUppercaseCheckbox, 'change', e => { customization.globalValueUppercase = !!e.target.checked; renderPreview(); });
bind(globalLabelReflectCheckbox, 'change', e => { customization.globalLabelReflect = !!e.target.checked; renderPreview(); });
bind(globalValueReflectCheckbox, 'change', e => { customization.globalValueReflect = !!e.target.checked; renderPreview(); });

/* æ–°å¢ï¼šåŠ¨ç”»å åŠ è”åŠ¨ */
bind(starEnabledCheckbox, 'change', e => { customization.starEnabled = !!e.target.checked; renderPreview(); });
bind(starFrequencyRange, 'input', e => { customization.starFrequency = parseFloat(e.target.value || '2'); if (starFrequencyValue) starFrequencyValue.textContent = customization.starFrequency.toFixed(1); renderPreview(); });
bind(starDensityRange, 'input', e => { customization.starDensity = parseInt(e.target.value || '50', 10); if (starDensityValue) starDensityValue.textContent = String(customization.starDensity); renderPreview(); });
bind(starColorInput, 'input', e => { customization.starColor = e.target.value; if (starColorCodeInput) starColorCodeInput.value = e.target.value; renderPreview(); });
bind(starColorCodeInput, 'input', e => {
  customization.starColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && starColorInput) starColorInput.value = v;
  renderPreview();
});

bind(sparkleEnabledCheckbox, 'change', e => { customization.sparkleEnabled = !!e.target.checked; renderPreview(); });
bind(sparkleDirectionSelect, 'change', e => { customization.sparkleDirection = e.target.value; renderPreview(); });
bind(sparkleFrequencyRange, 'input', e => { customization.sparkleFrequency = parseFloat(e.target.value || '2'); if (sparkleFrequencyValue) sparkleFrequencyValue.textContent = customization.sparkleFrequency.toFixed(1); renderPreview(); });
bind(sparkleDensityRange, 'input', e => { customization.sparkleDensity = parseInt(e.target.value || '20', 10); if (sparkleDensityValue) sparkleDensityValue.textContent = String(customization.sparkleDensity); renderPreview(); });
bind(sparkleColorInput, 'input', e => { customization.sparkleColor = e.target.value; if (sparkleColorCodeInput) sparkleColorCodeInput.value = e.target.value; renderPreview(); });
bind(sparkleColorCodeInput, 'input', e => {
  customization.sparkleColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && sparkleColorInput) sparkleColorInput.value = v;
  renderPreview();
});
bind(sparkleGlowCheckbox, 'change', e => { customization.sparkleGlow = !!e.target.checked; renderPreview(); });

bind(petalEnabledCheckbox, 'change', e => { customization.petalEnabled = !!e.target.checked; renderPreview(); });
bind(petalFrequencyRange, 'input', e => { customization.petalFrequency = parseFloat(e.target.value || '5'); if (petalFrequencyValue) petalFrequencyValue.textContent = customization.petalFrequency.toFixed(1); renderPreview(); });
bind(petalDensityRange, 'input', e => { customization.petalDensity = parseInt(e.target.value || '20', 10); if (petalDensityValue) petalDensityValue.textContent = String(customization.petalDensity); renderPreview(); });
bind(petalIconModeSelect, 'change', e => { customization.petalIconMode = e.target.value; renderPreview(); });
bind(petalIconBuiltinSelect, 'change', e => { customization.petalIconBuiltin = e.target.value; renderPreview(); });
bind(petalIconUrlInput, 'input', e => { customization.petalIconUrl = e.target.value; renderPreview(); });

// å›¾æ ‡äº‹ä»¶è”åŠ¨
bind(iconModeSelect, 'change', e => {
  customization.iconMode = e.target.value;
  if (customization.iconMode !== 'none' && (customization.iconPosition === 'none' || !customization.iconPosition)) {
    customization.iconPosition = 'left';
    if (iconPositionSelect) iconPositionSelect.value = 'left';
  } else if (customization.iconMode === 'none') {
    customization.iconPosition = 'none';
    if (iconPositionSelect) iconPositionSelect.value = 'none';
  }
  updateIconFieldsVisibility();
  renderPreview();
});
bind(iconBuiltinSelect, 'change', e => { customization.iconBuiltin = e.target.value; renderPreview(); });
bind(iconUrlInput, 'input', e => { customization.iconUrl = e.target.value; renderPreview(); });
bind(iconSizeRange, 'input', e => {
  customization.iconSize = parseInt(e.target.value || '28', 10);
  if (iconSizeValue) iconSizeValue.textContent = String(customization.iconSize);
  renderPreview();
});
bind(iconPositionSelect, 'change', e => { customization.iconPosition = e.target.value; renderPreview(); });
 
// é¦–æ¬¡åˆ·æ–°ä»¥åº”ç”¨é»˜è®¤å€¼ï¼ˆç§»é™¤ä¸€æ¬¡ï¼Œä»¥é¿å…è¦†ç›–ä¸»é¢˜é»˜è®¤å€¼çš„é¦–æ¬¡æ¸²æŸ“ï¼‰
    
    // -----------------------
    // åˆå§‹åŒ–
    // -----------------------
    try {
      applyThemeDefaults(currentTheme);
      updateAddItemOptionVisibility();
      renderItemsEditor();
      setupCollapsibleSections();
      updateBgFieldsVisibility();
      updateIconFieldsVisibility();
      updateItemCardBgFieldsVisibility();

      // åˆå§‹åŒ–å¤šå›¾å±‚/ç»„ä»¶ç¼–è¾‘ UI ä¸äº‹ä»¶
      renderBgLayersEditor();
      renderBgComponentsEditor();
      setupBgEditorsEvents();

      renderPreview();
      console.groupCollapsed('[ui] section-2 grouping');
      try { document.querySelectorAll('#section-2 .form-group-box').forEach((box,i)=>console.log(i+1, box.getAttribute('data-title')||'(untitled)', box.querySelectorAll('.control-group').length)); } catch(_e) {}
      console.groupEnd();
      // å¯åŠ¨æ—¶å…ˆå°†â€œ3. è¾“å‡ºä»£ç â€ç§»å…¥å¼¹çª—ï¼Œå·¦ä¾§åŸå§‹æ¨¡å—å·²éšè—
      // ç§»é™¤å³ä¸‹è§’â€œå¯¼å‡ºæœ€å¤§å®½åº¦(px)â€è®¾ç½®ï¼Œå¯¼å‡ºå®½åº¦éš 2 é¢„è§ˆæœ€å¤§å®½åº¦
      try {
        const expMax = document.getElementById('export-max-width');
        if (expMax) {
          const grp = expMax.closest('.control-group');
          if (grp && grp.parentNode) grp.parentNode.removeChild(grp);
        }
      } catch (_e) {}
    } catch (e) {
      console.error('[init] error', e);
      if (previewContainer) {
        previewContainer.innerHTML = '<div style="color:#ff8080;padding:12px;border:1px solid #ff8080;border-radius:6px;background:rgba(255,0,0,.06);">åˆå§‹åŒ–å¤±è´¥ï¼Œå·²åŠ è½½é™çº§é¢„è§ˆã€‚è¯·æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯è¯¦æƒ…ã€‚</div>';
      }
    }
    speedValue.textContent = animSpeed.toFixed(1);
    intensityValue.textContent = animIntensity.toFixed(2);
  // === å›¾ç‰‡ç»„ä»¶ï¼šè£å‰ªä¸è¾¹ç¼˜ç‰¹æ•ˆ æ‰©å±• ===
try {
  // è®¡ç®—é™„åŠ æ ·å¼ï¼ˆæ”¯æŒå¤šç‰¹æ•ˆå åŠ ï¼‰
  function __nyCompExtraStyle(c){
    try{
      const crop = c && c.crop ? c.crop : {top:0,right:0,bottom:0,left:0};
      const t = Math.max(0, Math.min(50, Number(crop.top || 0)));
      const r = Math.max(0, Math.min(50, Number(crop.right || 0)));
      const b = Math.max(0, Math.min(50, Number(crop.bottom || 0)));
      const l = Math.max(0, Math.min(50, Number(crop.left || 0)));
      let css = '';
      
      // è£å‰ª
      if (t||r||b||l){
        css += `clip-path: inset(${t}% ${r}% ${b}% ${l}%);`;
      }
      
      // å¤šç‰¹æ•ˆå åŠ æ”¯æŒ
      const effs = (c && c.effects) || {};
      const col = customization.primaryColor || '#ffffff';
      const filters = [];
      
      // åœ†è§’
      if (effs.rounded && isFinite(effs.roundedRadius)){
        css += `border-radius:${Math.max(0, Number(effs.roundedRadius))}px;`;
      }
      
      // å‘å…‰ï¼ˆfilterï¼‰
      if (effs.glow && isFinite(effs.glowStrength)){
        const blur = (Math.max(0, Number(effs.glowStrength)) * 0.4 + 6).toFixed(1);
        filters.push(`drop-shadow(0 0 ${blur}px ${col})`);
      }
      
      // é˜´å½±ï¼ˆfilterï¼‰
      if (effs.shadow){
        filters.push(`drop-shadow(0 6px 16px rgba(0,0,0,.35))`);
      }
      
      // ç»„åˆ filter
      if (filters.length > 0){
        css += `filter: ${filters.join(' ')};`;
      }
      
      // æŸ”åŒ–è¾¹ç¼˜ï¼ˆmaskï¼Œç‹¬ç«‹äº filterï¼‰
      if (effs.feather && isFinite(effs.featherStrength)){
        const s = Math.max(0, Math.min(50, Number(effs.featherStrength)));
        const inner = Math.max(60, 98 - s);
        const mask = `radial-gradient(circle at 50% 50%, #000 ${inner}%, transparent 100%)`;
        css += `-webkit-mask-image:${mask};mask-image:${mask};`;
      }
      
      return css;
    }catch(_e){ return ''; }
  }

  // è¦†ç›–ï¼šç»„ä»¶ HTML ç”Ÿæˆï¼Œæ³¨å…¥è£å‰ª/ç‰¹æ•ˆæ ·å¼
  const __ny_old_buildBgComponentsHTML = buildBgComponentsHTML;
  buildBgComponentsHTML = function(components){
    try{
      const C = Array.isArray(components) ? components : [];
      if (!C.length) return '';
      const html = C.filter(c => c && c.visible !== false).map(c => {
        const id = esc(c.id || genId());
        const src = esc(c.src || '');
        const x = isFinite(c.x) ? Math.max(0, Math.min(100, Number(c.x))) : 50;
        const y = isFinite(c.y) ? Math.max(0, Math.min(100, Number(c.y))) : 50;
        const w = isFinite(c.w) ? Math.max(2, Math.min(100, Number(c.w))) : 20;
        const op = isFinite(c.opacity) ? Math.max(0, Math.min(1, Number(c.opacity))) : 1;
        const extra = __nyCompExtraStyle(c);
        return `<img class="bg-comp" data-id="${id}" src="${src}" alt="" style="left:${x}%;top:${y}%;width:${w}%;opacity:${op};${extra}">`;
      }).join('');
      return `<div class="bg-components-layer">${html}</div>`;
    }catch(e){
      try { return __ny_old_buildBgComponentsHTML(components); } catch(_e){ return ''; }
    }
  };

  // å¢å¼ºï¼šä¸ºæ¯ä¸ªç»„ä»¶æ¡ç›®é™„åŠ "è£å‰ª/è¾¹ç¼˜ç‰¹æ•ˆ"æ§åˆ¶é¢æ¿
  function __ny_enhanceComponentsEditorUI(){
    try{
      const list = document.getElementById('bg-components-list');
      if (!list) return;
      const comps = customization.bgComponents || [];
      list.querySelectorAll('.item-controls').forEach(card => {
        if (!card.getAttribute('data-comp-id')) return;
        if (card.querySelector('.comp-adv-controls')) return;
        const id = card.getAttribute('data-comp-id');
        const c = comps.find(x => x.id === id);
        if (!c) return;
        c.crop = c.crop || {top:0,right:0,bottom:0,left:0};
        ['top','right','bottom','left'].forEach(k => { if(!isFinite(c.crop[k])) c.crop[k]=0; });
        
        // å¤šç‰¹æ•ˆæ”¯æŒï¼šæ”¹ä¸ºå¯¹è±¡å­˜å‚¨
        c.effects = c.effects || {};
        if (!isFinite(c.effects.roundedRadius)) c.effects.roundedRadius = 0;
        if (!isFinite(c.effects.glowStrength)) c.effects.glowStrength = 0;
        if (!isFinite(c.effects.featherStrength)) c.effects.featherStrength = 0;
        c.effects.rounded = !!(c.effects.rounded);
        c.effects.glow = !!(c.effects.glow);
        c.effects.shadow = !!(c.effects.shadow);
        c.effects.feather = !!(c.effects.feather);

        const html = `
<div class="comp-adv-controls" style="margin-top:10px; border-top:1px dashed var(--border-color); padding-top:10px;">
  <div class="control-group">
    <label>è£å‰ª(%)</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">ä¸Š</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.top}" data-field="comp-crop-top" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">å³</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.right}" data-field="comp-crop-right" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">ä¸‹</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.bottom}" data-field="comp-crop-bottom" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">å·¦</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.left}" data-field="comp-crop-left" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
    </div>
  </div>
  <div class="control-group">
    <label>è¾¹ç¼˜ç‰¹æ•ˆï¼ˆå¯å¤šé€‰ï¼‰</label>
    <div style="display:grid;gap:8px;margin-top:6px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-rounded" ${c.effects.rounded?'checked':''}>
        <span>åœ†è§’</span>
      </label>
      <div style="margin-left:24px;display:${c.effects.rounded?'block':'none'};" data-role="comp-effect-rounded-param">
        <div class="range-row" style="gap:6px;">
          <label style="color:var(--text-secondary);font-size:11px;min-width:48px;">åŠå¾„</label>
          <input type="range" min="0" max="50" step="1" value="${c.effects.roundedRadius}" data-field="comp-effect-rounded-radius" style="flex:1;">
          <span class="value-pill" style="min-width:48px;"><span>${c.effects.roundedRadius}</span>px</span>
        </div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-glow" ${c.effects.glow?'checked':''}>
        <span>å‘å…‰</span>
      </label>
      <div style="margin-left:24px;display:${c.effects.glow?'block':'none'};" data-role="comp-effect-glow-param">
        <div class="range-row" style="gap:6px;">
          <label style="color:var(--text-secondary);font-size:11px;min-width:48px;">å¼ºåº¦</label>
          <input type="range" min="0" max="50" step="1" value="${c.effects.glowStrength}" data-field="comp-effect-glow-strength" style="flex:1;">
          <span class="value-pill" style="min-width:48px;"><span>${c.effects.glowStrength}</span></span>
        </div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-shadow" ${c.effects.shadow?'checked':''}>
        <span>é˜´å½±</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-feather" ${c.effects.feather?'checked':''}>
        <span>æŸ”åŒ–è¾¹ç¼˜</span>
      </label>
      <div style="margin-left:24px;display:${c.effects.feather?'block':'none'};" data-role="comp-effect-feather-param">
        <div class="range-row" style="gap:6px;">
          <label style="color:var(--text-secondary);font-size:11px;min-width:48px;">å¼ºåº¦</label>
          <input type="range" min="0" max="50" step="1" value="${c.effects.featherStrength}" data-field="comp-effect-feather-strength" style="flex:1;">
          <span class="value-pill" style="min-width:48px;"><span>${c.effects.featherStrength}</span></span>
        </div>
      </div>
    </div>
  </div>
</div>`;
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        card.appendChild(wrap);
      });
    }catch(_e){}
  }

  // åŒ…è£…åŸæœ‰ç¼–è¾‘å™¨æ¸²æŸ“å‡½æ•°
  if (typeof renderBgComponentsEditor === 'function'){
    const __ny_old_renderBgComponentsEditor = renderBgComponentsEditor;
    renderBgComponentsEditor = function(){
      __ny_old_renderBgComponentsEditor();
      __ny_enhanceComponentsEditorUI();
    };
    // ç«‹å³å¢å¼ºä¸€æ¬¡ï¼ˆå½“å‰ç•Œé¢ï¼‰
    try { __ny_enhanceComponentsEditorUI(); } catch(_e){}
  }

  // äº‹ä»¶å§”æ‰˜ï¼šè£å‰ª/ç‰¹æ•ˆï¼ˆæ”¯æŒå¤šç‰¹æ•ˆï¼‰
  if (bgComponentsList){
    bgComponentsList.addEventListener('input', (e) => {
      const root = e.target.closest('.item-controls'); if (!root) return;
      const id = root.getAttribute('data-comp-id');
      const c = (customization.bgComponents || []).find(x => x.id === id); if (!c) return;
      const field = e.target.dataset.field;
      if (!field) return;
      c.crop = c.crop || {top:0,right:0,bottom:0,left:0};
      c.effects = c.effects || {};
      function setPill(el, txt){ try{ el.closest('.range-row').querySelector('.value-pill span').textContent = txt; }catch(_e){} }
      
      // è£å‰ª
      if (field === 'comp-crop-top'){ c.crop.top = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      else if (field === 'comp-crop-right'){ c.crop.right = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      else if (field === 'comp-crop-bottom'){ c.crop.bottom = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      else if (field === 'comp-crop-left'){ c.crop.left = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      // åœ†è§’å‚æ•°
      else if (field === 'comp-effect-rounded-radius'){ c.effects.roundedRadius = clamp(parseInt(e.target.value||'0',10) || 0, 0, 200); setPill(e.target, c.effects.roundedRadius); renderPreview(); }
      // å‘å…‰å‚æ•°
      else if (field === 'comp-effect-glow-strength'){ c.effects.glowStrength = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); setPill(e.target, c.effects.glowStrength); renderPreview(); }
      // æŸ”åŒ–è¾¹ç¼˜å‚æ•°
      else if (field === 'comp-effect-feather-strength'){ c.effects.featherStrength = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); setPill(e.target, c.effects.featherStrength); renderPreview(); }
    });
    
    bgComponentsList.addEventListener('change', (e) => {
      const root = e.target.closest('.item-controls'); if (!root) return;
      const id = root.getAttribute('data-comp-id');
      const c = (customization.bgComponents || []).find(x => x.id === id); if (!c) return;
      const field = e.target.dataset.field;
      if (!field) return;
      c.effects = c.effects || {};
      
      // å¤šç‰¹æ•ˆå¤é€‰æ¡†
      if (field === 'comp-effect-rounded'){
        c.effects.rounded = !!e.target.checked;
        const paramDiv = root.querySelector('[data-role="comp-effect-rounded-param"]');
        if (paramDiv) paramDiv.style.display = c.effects.rounded ? 'block' : 'none';
        renderPreview();
      }
      else if (field === 'comp-effect-glow'){
        c.effects.glow = !!e.target.checked;
        const paramDiv = root.querySelector('[data-role="comp-effect-glow-param"]');
        if (paramDiv) paramDiv.style.display = c.effects.glow ? 'block' : 'none';
        renderPreview();
      }
      else if (field === 'comp-effect-shadow'){
        c.effects.shadow = !!e.target.checked;
        renderPreview();
      }
      else if (field === 'comp-effect-feather'){
        c.effects.feather = !!e.target.checked;
        const paramDiv = root.querySelector('[data-role="comp-effect-feather-param"]');
        if (paramDiv) paramDiv.style.display = c.effects.feather ? 'block' : 'none';
        renderPreview();
      }
    });
  }
}catch(_e){}

})();</script>

<!-- Ny.Adhere externalized to js/app.adhere.js; inline adherence block removed -->

<!-- å·²è¿ç§»åˆ° js/app.collapse.jsï¼Œç§»é™¤æ­¤å†…è”åˆå§‹åŒ–ä»¥é¿å…é‡å¤ç»‘å®š -->
<!-- Mobile-friendly full color picker (modal) -->
<div id="color-picker-modal" class="cpk-modal" aria-hidden="true">
  <div class="cpk-backdrop"></div>
  <div class="cpk-dialog" role="dialog" aria-modal="true" aria-label="é€‰æ‹©é¢œè‰²">
    <div class="cpk-header">
      <span>é€‰æ‹©é¢œè‰²</span>
      <button type="button" class="cpk-close">å…³é—­</button>
    </div>
    <div class="cpk-body">
      <div class="cpk-sv-wrap"><canvas id="cpk-sv"></canvas></div>
      <div>
        <div class="cpk-h-wrap"><canvas id="cpk-h"></canvas></div>
        <div class="cpk-preview">
          <div id="cpk-old" class="cpk-swatch" title="åŸè‰²"></div>
          <div id="cpk-new" class="cpk-swatch" title="æ–°è‰²"></div>
        </div>
      </div>
      <div class="cpk-hex-row">
        <span>#</span>
        <input id="cpk-hex" type="text" inputmode="latin" placeholder="RRGGBB æˆ– #RRGGBB" autocomplete="off">
      </div>
    </div>
    <div class="cpk-actions">
      <button type="button" id="cpk-cancel" class="cpk-btn">å–æ¶ˆ</button>
      <button type="button" id="cpk-ok" class="cpk-btn primary">ç¡®å®š</button>
    </div>
  </div>
</div>
<script defer src="js/app.utils.js"></script>
<script defer src="js/app.render.js"></script>
<script defer src="js/app.merged.js"></script>
<script defer src="js/app.codegen.js"></script>
<script defer src="js/app.params.js"></script>
<script defer src="js/app.export.js"></script>
<script defer src="js/app.ui.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', function() {
    try { if (window.Ny && Ny.Adhere && Ny.Adhere.init) Ny.Adhere.init(); } catch(_e){}
  });
</script>
<script defer src="js/app.colorpicker.mobile.js"></script>
<!-- 
  åˆå§‹åŒ–é€»è¾‘å·²ç§»è‡³ app.render.js çš„ window.load äº‹ä»¶ç›‘å¬å™¨ä¸­
  é¿å…é‡å¤åˆå§‹åŒ–å¯¼è‡´çš„çŠ¶æ€è¦†ç›–é—®é¢˜
-->
</body>
</html>
