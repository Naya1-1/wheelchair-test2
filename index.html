<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ny-前端轮椅 - SillyTavern状态栏生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="ny-themes.css">
    <link rel="stylesheet" href="ny-ui.css">
    <link rel="stylesheet" href="ny-ui-fonts.css">
    <link rel="stylesheet" href="ny-ui-effects.css">
</head>
<body>
 
    <div class="generator-container">
        <div class="controls-panel">
            <h1>Ny-前端轮椅</h1>
            <p class="subtitle">SillyTavern状态栏生成器</p>
 
            <div id="global-style-mount"></div>
            <script src="js/sections/section.global.style.js"></script>
            <script>
              try { if (window.Ny && Ny.Sections && Ny.Sections.renderGlobalStyle) Ny.Sections.renderGlobalStyle(); } catch (_e) {}
            </script>
 
            <div id="customization-mount"></div>
<script src="js/sections/section.customization.parts.js"></script>
<script src="js/sections/section.customization.js"></script>
<script>
  try { if (window.Ny && Ny.Sections && Ny.Sections.renderCustomization) Ny.Sections.renderCustomization(); } catch (_e) {}
</script>
<script src="js/sections/section.items.parts.js"></script>
<script src="js/sections/section.items.js"></script>
<script>
  try { if (window.Ny && Ny.Sections && Ny.Sections.renderItems) Ny.Sections.renderItems(); } catch (_e) {}
</script>
<div class="control-section collapsible" id="section-2">
                <h3>3. 状态项目 <span class="toggle-icon">▾</span></h3>
                <div class="section-body">
                <div class="form-group-box" data-title="配色与进度条样式"><div class="form-box-title">配色与进度条样式</div>
                <div class="control-group">
                    <label>第三部分项目颜色</label>
                    <div class="compact-colors-grid">
                        <div class="color-cell">
                            <label for="section2-label-color-input">标签颜色</label>
                            <div class="color-row">
                                <input type="color" id="section2-label-color-input" value="#6a717c">
                                <input type="text" id="section2-label-color-code-input" placeholder="#RRGGBB 或 CSS颜色" value="#6a717c">
                            </div>
                        </div>
                        <div class="color-cell">
                            <label for="section2-value-color-input">值颜色</label>
                            <div class="color-row">
                                <input type="color" id="section2-value-color-input" value="#97aec8">
                                <input type="text" id="section2-value-color-code-input" placeholder="#RRGGBB 或 CSS颜色" value="#97aec8">
                            </div>
                        </div>
                        <div class="color-cell">
                            <label for="section2-bar-color-input">滑条颜色</label>
                            <div class="color-row">
                                <input type="color" id="section2-bar-color-input" value="#6a717c">
                                <input type="text" id="section2-bar-color-code-input" placeholder="#RRGGBB 或 CSS颜色" value="#6a717c">
                            </div>
                        </div>
                        <div class="color-cell">
                            <label for="section2-divider-color-input">分割线颜色</label>
                            <div class="color-row">
                                <input type="color" id="section2-divider-color-input" value="#6a717c">
                                <input type="text" id="section2-divider-color-code-input" placeholder="#RRGGBB 或 CSS颜色" value="#6a717c">
                            </div>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">仅作用于第三部分的项目（分割线、标签、滑条），不影响标题与模板全局配色。</p>
                </div>

                <div class="control-group">
                    <label>进度条样式</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label for="bar-style-select">样式</label>
                            <select id="bar-style-select">
                                <option value="normal">标准</option>
                                <option value="glow">荧光</option>
                                <option value="striped">斜纹</option>
                                <option value="glass">玻璃光泽</option>
                            </select>
                        </div>
                        <div>
                            <label for="bar-animation-select">动画</label>
                            <select id="bar-animation-select">
                                <option value="none">无</option>
                                <option value="grow">逐渐增长到固定数值</option>
                            </select>
                        </div>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">选择全局进度条风格与动画，可与上方颜色联动。</p>
                </div>

                <div class="control-group">
                    <label for="percent-display-select">百分比显示</label>
                    <select id="percent-display-select">
                        <option value="center">中心覆盖</option>
                        <option value="badge">右侧徽章</option>
                        <option value="tooltip">上方气泡</option>
                        <option value="follow">末端跟随</option>
                        <option value="toast">下方吐司</option>
                    </select>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">点击进度条显示/隐藏百分比，可切换显示风格。</p>
                </div>
                </div>

                <!-- 新增：项目卡片背景与阴影（第三部分） -->
                <div class="form-group-box" data-title="项目卡片背景与阴影">
                  <div class="form-box-title">项目卡片背景与阴影</div>

                  <div class="control-group">
                    <label style="display:flex;align-items:center;gap:8px;">
                      <input type="checkbox" id="item-bg-shadow-per-item-toggle">
                      允许每个项目独立设置背景与阴影
                    </label>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      开启后，可在“项目编辑”中为单个项目设置背景与阴影，局部设置将优先于下方全局设置。
                    </p>
                  </div>

                  <div class="control-group">
                    <label for="item-card-bg-mode-select">背景模式（全局）</label>
                    <select id="item-card-bg-mode-select">
                      <option value="theme">跟随模板</option>
                      <option value="none">无背景（透明）</option>
                      <option value="color">纯色</option>
                      <option value="gradient">渐变</option>
                      <option value="image">图片</option>
                      <option value="url">自定义URL背景</option>
                    </select>
                  </div>

                  <!-- 纯色（全局） -->
                  <div class="control-group" id="item-card-bg-color-group" style="display:none;">
                    <label for="item-card-bg-color-input">纯色背景</label>
                    <input type="color" id="item-card-bg-color-input" value="#111215">
                    <input type="text" id="item-card-bg-color-code-input" placeholder="#RRGGBB 或 CSS颜色" value="#111215" style="margin-top:6px;">
                  </div>

                  <!-- 渐变（全局） -->
                  <div class="control-group" id="item-card-bg-gradient-group" style="display:none;">
                    <label>渐变背景</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:8px;">
                      <div>
                        <label for="item-card-grad-start-color-input">起色</label>
                        <input type="color" id="item-card-grad-start-color-input" value="#6a717c">
                        <input type="text" id="item-card-grad-start-code-input" placeholder="#RRGGBB 或 CSS颜色" value="#6a717c" style="margin-top:6px;">
                      </div>
                      <div>
                        <label for="item-card-grad-end-color-input">终色</label>
                        <input type="color" id="item-card-grad-end-color-input" value="#97aec8">
                        <input type="text" id="item-card-grad-end-code-input" placeholder="#RRGGBB 或 CSS颜色" value="#97aec8" style="margin-top:6px;">
                      </div>
                    </div>
                    <div class="range-row" style="margin-top:8px;">
                      <label>角度(°)</label>
                      <input type="range" id="item-card-grad-angle-range" min="0" max="360" step="1" value="135">
                      <span class="value-pill"><span id="item-card-grad-angle-value">135</span>°</span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      示例：linear-gradient(135deg, 起色, 终色)
                    </p>
                  </div>

                  <!-- 图片（全局） -->
                  <div class="control-group" id="item-card-bg-image-group" style="display:none;">
                    <label for="item-card-bg-image-url">背景图片 URL</label>
                    <input type="url" id="item-card-bg-image-url" placeholder="https://example.com/card-bg.jpg">
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      背景默认使用 cover/center/no-repeat。
                    </p>
                  </div>

                  <!-- 自定义URL背景（全局） -->
                  <div class="control-group" id="item-card-bg-url-group" style="display:none;">
                    <label for="item-card-bg-url-input">自定义 URL 背景</label>
                    <input type="url" id="item-card-bg-url-input" placeholder="https://example.com/your-image.png">
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      与“图片”一致，使用 cover/center/no-repeat；该项用于补充“背景模式”未包含的自定义 URL 场景。
                    </p>
                  </div>

                  <!-- 阴影（全局） -->
                  <div class="control-group" id="item-card-shadow-group">
                    <label style="display:flex;align-items:center;gap:8px;">
                      <input type="checkbox" id="item-card-shadow-enable"> 启用阴影（全局）
                    </label>
                    <div class="range-row" style="margin-top:6px;">
                      <label>强度</label>
                      <input type="range" id="item-card-shadow-strength-range" min="0" max="1" step="0.05" value="0.30" disabled>
                      <span class="value-pill"><span id="item-card-shadow-strength-value">0.30</span></span>
                    </div>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                      局部项目也可设置阴影；当开启局部设置时，项目内的阴影将覆盖此处全局设置。
                    </p>
                  </div>
                </div>
                <div class="form-group-box sm" data-title="长文字设置（全局）" style="display:none;">
                <div class="form-box-title">长文字设置（全局）</div>
                <div class="control-group" id="longtext-settings-group" style="display:none;"></div>
                </div>

                <div class="form-group-box" data-title="值框与整体偏移"><div class="form-box-title">值框与整体偏移</div>
                <!-- 新增：值框宽度/位置 与 项目整体偏移/阴影（仅作用于“第三部分 状态项目”） -->
                <div class="control-group">
                  <label>值框宽度与位置（第三部分）</label>
                  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div class="range-row">
                      <label>宽度(相对最大 %)</label>
                      <input type="range" id="value-box-width-pct-range" min="40" max="100" step="1" value="100">
                      <span class="value-pill"><span id="value-box-width-pct-value">100</span>%</span>
                    </div>
                    <div class="range-row">
                      <label>值框水平偏移(%)</label>
                      <input type="range" id="value-box-offset-pct-range" min="-40" max="40" step="1" value="0">
                      <span class="value-pill"><span id="value-box-offset-pct-value">0</span>%</span>
                    </div>
                  </div>
                </div>

                <!-- 新增：标签/值比例（默认 3:7，可调 10%~50% 标签占比） -->
                <div class="control-group">
                  <label>标签/值比例（第三部分）</label>
                  <div class="range-row">
                    <label>标签占比(%)</label>
                    <input type="range" id="label-value-label-pct-range" min="10" max="50" step="1" value="30">
                    <span class="value-pill"><span id="label-value-label-pct-value">30</span>% / <span id="label-value-value-pct-value">70</span>%</span>
                  </div>
                  <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                    仅在“文字排列方式=左右排列（默认）”时生效；“上下堆叠/双列”保持各自布局设定。
                  </p>
                </div>

                <div class="control-group">
                  <label>项目整体偏移（第三部分）</label>
                  <div class="range-row">
                    <label>整体水平偏移(%)</label>
                    <input type="range" id="item-offset-pct-range" min="-40" max="40" step="1" value="0">
                    <span class="value-pill"><span id="item-offset-pct-value">0</span>%</span>
                  </div>
                  <div class="range-row">
                    <label>整体右侧偏移(%)</label>
                    <input type="range" id="item-offset-right-pct-range" min="-40" max="40" step="1" value="0">
                    <span class="value-pill"><span id="item-offset-right-pct-value">0</span>%</span>
                  </div>

                  <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">默认宽度为最大值；偏移范围受限，避免超出背景边界。</p>
                </div>
                </div>

                <div class="form-group-box" data-title="状态项目字体样式"><div class="form-box-title">状态项目字体样式</div>
                <div class="control-group">
                    <label>高级字体样式</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <div>
                            <label for="global-label-font-select">标签字体</label>
                            <select id="global-label-font-select">
                                <option value="Noto Sans SC, sans-serif">Noto Sans SC（默认）</option>
                                <option value="Inter, Noto Sans SC, sans-serif">Inter</option>
                                <option value="Georgia, Songti SC, serif">Georgia / 宋体</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                                <option value="'Times New Roman', Georgia, serif">Times New Roman</option>
                                <optgroup label="📱 像素体">
                                    <option value="'BoutiqueBitmap9x9', monospace">精品点阵体9×9</option>
                                </optgroup>
                                <optgroup label="✨ 英文花体">
                                    <option value="'Dancing Script', cursive">Dancing Script（舞动花体）</option>
                                    <option value="'Pacifico', cursive">Pacifico（温和花体）</option>
                                    <option value="'Great Vibes', cursive">Great Vibes（优雅花体）</option>
                                    <option value="'Allura', cursive">Allura（华丽花体）</option>
                                </optgroup>
                                <optgroup label="✍️ 手写体">
                                    <option value="'Caveat', cursive">Caveat（休闲手写）</option>
                                    <option value="'Indie Flower', cursive">Indie Flower（独立手写）</option>
                                    <option value="'Shadows Into Light', cursive">Shadows Into Light（阴影手写）</option>
                                    <option value="'Permanent Marker', cursive">Permanent Marker（马克笔）</option>
                                </optgroup>
                                <optgroup label="🚀 科技感">
                                    <option value="'Rajdhani', sans-serif">Rajdhani（现代科技）</option>
                                    <option value="'Audiowide', cursive">Audiowide（数字科技）</option>
                                    <option value="'Electrolize', sans-serif">Electrolize（电子科技）</option>
                                </optgroup>
                                <optgroup label="🎨 中文艺术">
                                    <option value="'Ma Shan Zheng', cursive">马善政楷体</option>
                                    <option value="'ZCOOL XiaoWei', serif">站酷小薇LOGO体</option>
                                    <option value="'Long Cang', cursive">龙藏体</option>
                                    <option value="'Zhi Mang Xing', cursive">志莽行体</option>
                                </optgroup>
                                <optgroup label="📖 衬线体">
                                    <option value="'Merriweather', serif">Merriweather（优雅衬线）</option>
                                    <option value="'Playfair Display', serif">Playfair Display（展示衬线）</option>
                                </optgroup>
                                <optgroup label="🔤 无衬线扩展">
                                    <option value="'Roboto', sans-serif">Roboto（现代无衬线）</option>
                                    <option value="'Montserrat', sans-serif">Montserrat（时尚无衬线）</option>
                                </optgroup>
                            </select>
                        </div>
                        <div>
                            <label for="global-value-font-select">值字体</label>
                            <select id="global-value-font-select">
                                <option value="Noto Sans SC, sans-serif">Noto Sans SC（默认）</option>
                                <option value="Inter, Noto Sans SC, sans-serif">Inter</option>
                                <option value="Georgia, Songti SC, serif">Georgia / 宋体</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                                <option value="'Times New Roman', Georgia, serif">Times New Roman</option>
                                <optgroup label="📱 像素体">
                                    <option value="'BoutiqueBitmap9x9', monospace">精品点阵体9×9</option>
                                </optgroup>
                                <optgroup label="✨ 英文花体">
                                    <option value="'Dancing Script', cursive">Dancing Script（舞动花体）</option>
                                    <option value="'Pacifico', cursive">Pacifico（温和花体）</option>
                                    <option value="'Great Vibes', cursive">Great Vibes（优雅花体）</option>
                                    <option value="'Allura', cursive">Allura（华丽花体）</option>
                                </optgroup>
                                <optgroup label="✍️ 手写体">
                                    <option value="'Caveat', cursive">Caveat（休闲手写）</option>
                                    <option value="'Indie Flower', cursive">Indie Flower（独立手写）</option>
                                    <option value="'Shadows Into Light', cursive">Shadows Into Light（阴影手写）</option>
                                    <option value="'Permanent Marker', cursive">Permanent Marker（马克笔）</option>
                                </optgroup>
                                <optgroup label="🚀 科技感">
                                    <option value="'Rajdhani', sans-serif">Rajdhani（现代科技）</option>
                                    <option value="'Audiowide', cursive">Audiowide（数字科技）</option>
                                    <option value="'Electrolize', sans-serif">Electrolize（电子科技）</option>
                                </optgroup>
                                <optgroup label="🎨 中文艺术">
                                    <option value="'Ma Shan Zheng', cursive">马善政楷体</option>
                                    <option value="'ZCOOL XiaoWei', serif">站酷小薇LOGO体</option>
                                    <option value="'Long Cang', cursive">龙藏体</option>
                                    <option value="'Zhi Mang Xing', cursive">志莽行体</option>
                                </optgroup>
                                <optgroup label="📖 衬线体">
                                    <option value="'Merriweather', serif">Merriweather（优雅衬线）</option>
                                    <option value="'Playfair Display', serif">Playfair Display（展示衬线）</option>
                                </optgroup>
                                <optgroup label="🔤 无衬线扩展">
                                    <option value="'Roboto', sans-serif">Roboto（现代无衬线）</option>
                                    <option value="'Montserrat', sans-serif">Montserrat（时尚无衬线）</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div class="range-row">
                            <label>标签字号</label>
                            <input type="range" id="global-label-font-size-range" min="10" max="36" step="1" value="16">
                            <span class="value-pill"><span id="global-label-font-size-value">16</span>px</span>
                        </div>
                        <div class="range-row">
                            <label>值字号</label>
                            <input type="range" id="global-value-font-size-range" min="10" max="36" step="1" value="16">
                            <span class="value-pill"><span id="global-value-font-size-value">16</span>px</span>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <div>
                            <label>标签样式</label>
                            <div style="display:grid; gap:8px;">
                                <select id="global-label-weight-select">
                                    <option value="400">常规(400)</option>
                                    <option value="500">中等(500)</option>
                                    <option value="600">半粗(600)</option>
                                    <option value="700">加粗(700)</option>
                                </select>
                                <div style="display:flex; align-items:center; gap:6px; flex-wrap: nowrap; font-size:12px; white-space:nowrap; margin-top:6px; grid-row:2;">
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-label-italic-checkbox">倾斜</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-label-uppercase-checkbox">大写</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-label-reflect-checkbox">倒影</label>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label>值样式</label>
                            <div style="display:grid; gap:8px;">
                                <select id="global-value-weight-select">
                                    <option value="400">常规(400)</option>
                                    <option value="500">中等(500)</option>
                                    <option value="600">半粗(600)</option>
                                    <option value="700">加粗(700)</option>
                                </select>
                                <div style="display:flex; align-items:center; gap:6px; flex-wrap: nowrap; font-size:12px; white-space:nowrap; margin-top:6px; grid-row:2;">
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-value-italic-checkbox">倾斜</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-value-uppercase-checkbox">大写</label>
                                    <label style="display:flex;align-items:center;gap:6px;"><input type="checkbox" id="global-value-reflect-checkbox">倒影</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <div class="form-group-box" data-title="项目编辑"><div class="form-box-title">项目编辑</div>
                <div id="items-container">
                    <div class="item-controls">
                        <div class="item-header"><span>地点 (文本)</span><button class="btn-delete">X</button></div>
                    </div>
                    <div class="item-controls">
                        <div class="item-header"><span>情绪 (进度条)</span><button class="btn-delete">X</button></div>
                    </div>
                    <div class="item-controls">
                        <div class="item-header"><span>分割线</span><button class="btn-delete">X</button></div>
                    </div>
                </div>
                <div class="control-group" style="margin-top: 20px;">
                    <label for="add-item-select">添加新项目</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="add-item-select">
                            <option value="text">文本</option>
                            <option value="longtext">长文字</option>
                            <option value="bar">进度条/数值条</option>
                            <option value="divider">分割线</option>
                        </select>
                        <button class="btn btn-primary" style="width: auto; flex-shrink: 0;">添加</button>
                    </div>
                </div>
                </div>
            </div>
            </div>
 
            <div class="control-section collapsible" id="section-3">
                <h3>3. 输出代码 <span class="toggle-icon">▾</span></h3>
                <div class="section-body">
                <!-- 已移除：导出最大宽度设置，改由“2 模板个性化 → 预览最大宽度”统一控制 -->

                <div class="control-group">
                    <label for="xml-wrapper-name">AI 输出包裹标签名（自动使用上方“状态栏标题”，仅用于查看）</label>
                    <input type="text" id="xml-wrapper-name" value="角色状态" placeholder="将生成 <状态栏标题状态栏>...</状态栏标题状态栏>" readonly>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">
                        输出格式示例：<名字状态栏> 地点：... 情绪：... </名字状态栏>。默认来源：状态栏标题。
                    </p>
                </div>
                <div class="control-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                        <label>AI 输出模板</label>
                        <button class="btn-copy" data-target="ai-template-inline">复制</button>
                    </div>
                    <textarea id="ai-template-inline" class="code-area" rows="8" readonly></textarea>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">用于提示 AI 输出 <名字状态栏> ... </名字状态栏> 结构的示例模板。</p>
                </div>
                
                <!-- 新增：实时状态栏 HTML（与右侧预览保持一致） -->
                <div class="control-group">
                    <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;">
                        <label>状态栏 HTML（实时生成）</label>
                        <button class="btn-copy" data-target="statusbar-code-live">复制</button>
                    </div>
                    <textarea id="statusbar-code-live" class="code-area" rows="24" readonly></textarea>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">此处实时展示与右侧预览一致的状态栏 HTML，弹窗打开时将自动同步。</p>
                </div>
                
                <div class="control-group">
                    <button id="btn-download-json" class="btn btn-primary" style="width: 100%;">下载酒馆正则</button>
                </div>
            </div>
            </div>
 
        </div>
 
        <div class="preview-panel">
            <div id="live-preview-container"></div>
        </div>
 
        <div class="output-panel">
            <div class="generate-btn-container">
                <button id="device-toggle-btn" title="仅影响右侧预览，不改变导出代码">📱 手机端</button>
                <button id="generate-btn">✨ 生成代码</button>
            </div>
            <div id="code-output" class="code-output" style="display:none;">
                <!-- 右下角旧模块保留在DOM，此处不再承载“3. 输出代码” -->
                <div class="code-block">
                    <div class="code-block-header">输出状态栏代码（HTML、CSS、JS） <button class="btn-copy" data-target="statusbar-code">复制</button></div>
                    <textarea id="statusbar-code" class="code-area" rows="28" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">正则方案（按标签匹配值） <button class="btn-copy" data-target="regex-recipe">复制</button></div>
                    <textarea id="regex-recipe" class="code-area" rows="14" readonly></textarea>
                </div>

                <!-- SillyTavern 集成四件套输出 -->
                <div class="code-block">
                    <div class="code-block-header">1) 原始代码（Standalone HTML，用于参考/单独预览） <button class="btn-copy" data-target="original-code">复制</button></div>
                    <textarea id="original-code" class="code-area" rows="28" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">2) AI 输出模板（XML 包裹，贴给 AI 生成） <button class="btn-copy" data-target="ai-template">复制</button></div>
                    <textarea id="ai-template" class="code-area" rows="10" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">3) findRegex（捕获 <名字状态栏>...</名字状态栏>）
                      <div>
                        <button class="btn-copy" id="btn-copy-find-raw" data-clip="">复制原生</button>
                        <button class="btn-copy" id="btn-copy-find-json" data-clip="">复制JSON-safe</button>
                      </div>
                    </div>
                    <textarea id="find-regex" class="code-area" rows="3" readonly></textarea>
                </div>
                <div class="code-block">
                    <div class="code-block-header">4) replaceString（务必使用“复制原生”；围栏版不执行脚本，仅用于展示）
                      <div>
                        <button class="btn-copy" id="btn-copy-rep-raw" data-clip="">复制原生</button>
                        <button class="btn-copy" id="btn-copy-rep-fenced" data-clip="">复制围栏版</button>
                        <button class="btn-copy" id="btn-copy-rep-raw-json" data-clip="">复制JSON-safe(原生)</button>
                        <button class="btn-copy" id="btn-copy-rep-fenced-json" data-clip="">复制JSON-safe(围栏)</button>
                      </div>
                    </div>
                    <textarea id="replace-string" class="code-area" rows="28" readonly></textarea>
                </div>

                <div style="display:flex; justify-content:flex-end; margin-top:10px;">
                    <button id="close-output" class="btn">关闭</button>
                </div>
            </div>
            <!-- 输出代码弹窗（承载左侧“3. 输出代码”） -->
            <div id="code-modal">
              <div class="modal-backdrop"></div>
              <div class="modal-dialog">
                <div class="modal-header">
                  <span>输出代码</span>
                  <button id="code-modal-close" class="btn">关闭</button>
                </div>
                <div id="moved-section3-modal"></div>
              </div>
            </div>
        </div>
    </div>

 <script>
  (() => {
    // Disable overlapping inline event bindings; external Ny.UI/Ny.Export will handle generate/copy/modal/download.
    window.NY_DISABLE_INLINE = true;
    const themeOptions = document.querySelectorAll('.theme-option');
    const titleInput = document.getElementById('title-input');
    const previewContainer = document.getElementById('live-preview-container');

    const enterAnimSelect = document.getElementById('enter-animation-select');
    const loopAnimSelect = document.getElementById('loop-animation-select');
    const animSpeedRange = document.getElementById('animation-speed');
    const animIntensityRange = document.getElementById('animation-intensity');
    const speedValue = document.getElementById('speed-value');
    const intensityValue = document.getElementById('intensity-value');

    const itemsContainer = document.getElementById('items-container');
    const addItemSelect = document.getElementById('add-item-select');
    // “添加”按钮：取下拉框同一行的那个按钮（加容错）
    let addItemBtn = null;
    try {
      addItemBtn = addItemSelect ? (addItemSelect.closest('div') ? addItemSelect.closest('div').querySelector('button') : null) : null;
    } catch (_e) {
      addItemBtn = null;
    }

    // 旧版“换行”选项已移除；保留兼容占位
    function updateAddItemOptionVisibility() {
      // removed: row option no longer supported
      try {} catch (_e) {}
    }

    // ===== 界面模式（白天/黑夜）初始化与切换，仅影响页面 UI，不改变生成逻辑 =====
    const uiModeSelect = document.getElementById('ui-mode-select');
    (function initUiMode(){
      try {
        // 强制默认暗色：首次加载不读取系统偏好或历史偏好
        document.body.classList.remove('ui-light'); // 暗色为基线
        if (uiModeSelect) uiModeSelect.value = 'dark';
        // 不清理本地存储，以便用户后续手动切换仍可持久化；但每次初始均为暗色
      } catch (_e) {}
    })();
    if (uiModeSelect) {
      uiModeSelect.addEventListener('change', (e) => {
        const v = (e.target.value === 'light') ? 'light' : 'dark';
        if (v === 'light') document.body.classList.add('ui-light');
        else document.body.classList.remove('ui-light');
        try { localStorage.setItem('ny-ui-mode', v); } catch (_e) {}
      });
    }

    let currentTheme = 'theme-mystic-noir';
    let currentTitle = '角色状态';
    let currentEnterAnimation = 'none';
    let currentLoopAnimation = 'none';
    let currentAnimation = 'none';
    let animSpeed = 1.0;
    let animIntensity = 0.70;
    // 预览固定高度：当调整宽度时锁定当前高度，避免随宽度变化
    let fixedWrapperHeight = null;

    // 统一状态：items
    let items = [
      { id: genId(), type: 'text', label: '地点', value: '迷雾森林 · 深处' },
      { id: genId(), type: 'bar',  label: '情绪', percent: 60 },
      { id: genId(), type: 'divider' },
      {
        id: genId(),
        type: 'longtext',
        label: '说明',
        value: '第一段文字，这是测试首字缩进的第一段。\n第二段文字，换行后也应该有首字缩进。\n第三段文字，继续测试多段落的缩进效果。',
        ltLineHeight: 1.6,
        ltEffect: 'none',
        ltSkipFirstLine: false,
        ltFirstIndentPx: 32,
        ltPadTopPx: 0,
        ltPadRightPx: 0,
        ltPadBottomPx: 0,
        ltPadLeftPx: 0,
        ltTwSpeedMs: 18,
        ltTwDelayMs: 0,
        ltTwCaret: true
      }
    ];

    // -----------------------
    // 工具
    // -----------------------
    function genId() {
      return 'it_' + Math.random().toString(36).slice(2, 9);
    }
    function esc(s = '') {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
    // delegate to external Ny.Utils.clamp to avoid inline duplicate
    function clamp(n, min, max) {
      try {
        if (window.Ny && Ny.Utils && typeof Ny.Utils.clamp === 'function') {
          return Ny.Utils.clamp(n, min, max);
        }
      } catch (_e) {}
      return Math.max(min, Math.min(max, n));
    }
    // 由“状态栏标题”派生 AI 包裹标签名字（委托 Ny.Utils.toWrapperNameFromTitle）
    function toWrapperNameFromTitle(title) {
      try {
        if (window.Ny && Ny.Utils && typeof Ny.Utils.toWrapperNameFromTitle === 'function') {
          return Ny.Utils.toWrapperNameFromTitle(title);
        }
        const name = String(title || '').replace(/[^A-Za-z0-9\u4E00-\u9FFF_-]+/g, '').trim();
        return name || '状态';
      } catch (_e) {
        return '状态';
      }
    }
    const typeName = t => ({text:'文本', longtext:'长文字', bar:'进度条', divider:'分割线'}[t] || t);
    const snapshot = () => JSON.parse(JSON.stringify(items));

    // 新增：诊断辅助函数（避免未定义报错；仅用于日志）
    function contrastRatio(c1, c2) {
      try {
        function hexToRgb(hex) {
          const h = String(hex || '').trim();
          if (!/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(h)) return [0, 0, 0];
          const s = h.slice(1);
          const full = s.length === 3 ? s.split('').map(ch => ch + ch).join('') : s;
          const r = parseInt(full.slice(0, 2), 16);
          const g = parseInt(full.slice(2, 4), 16);
          const b = parseInt(full.slice(4, 6), 16);
          return [r, g, b];
        }
        function srgbToLin(v) {
          v = v / 255;
          return v <= 0.03928 ? v / 12.92 : Math.pow((v + 0.055) / 1.055, 2.4);
        }
        function luminance(rgb) {
          const [r, g, b] = rgb;
          const R = srgbToLin(r), G = srgbToLin(g), B = srgbToLin(b);
          return 0.2126 * R + 0.7152 * G + 0.0722 * B;
        }
        const L1 = luminance(hexToRgb(c1));
        const L2 = luminance(hexToRgb(c2));
        const hi = Math.max(L1, L2), lo = Math.min(L1, L2);
        return (hi + 0.05) / (lo + 0.05);
      } catch (_e) {
        return 1;
      }
    }
    function computeCoherence(opts) {
      try {
        const { primaryColor, secondaryColor, letterSpacing = 0, lineHeight = 1.4, animationType = 'none' } = (opts || {});
        const cr = contrastRatio(primaryColor, secondaryColor);
        let score = 0.5 + Math.min(cr, 7) / 14; // 基于对比度的基线
        if (lineHeight >= 1.2 && lineHeight <= 1.8) score += 0.1;
        if (letterSpacing > 0.5) score -= 0.05;
        if (animationType !== 'none') score += 0.05;
        return Number(Math.max(0, Math.min(1, score)).toFixed(2));
      } catch (_e) {
        return 0.5;
      }
    }

    // -----------------------
    // 预览渲染（严格由 items 状态驱动）
    // -----------------------
    // removed: legacy getHeaderHTML() duplicate; use enhanced [getHeaderHTML2()](前端轮椅4.0.original.html:2163) below for parity

// removed: legacy buildItemsHTML(list) duplicate; using enhanced version below

    // removed: legacy renderPreview() duplicate; use enhanced [renderPreview()](前端轮椅4.0.original.html:3108) implementation with backgrounds, variables, FX, and per-item overrides

    // -----------------------
    // 左侧编辑面板渲染（由 items 状态驱动）
    // -----------------------
    function renderItemsEditor() {
      // 记录当前已折叠的项目（在重渲染时保持折叠状态）
      let prevCollapsedIds = new Set();
      try {
        prevCollapsedIds = new Set(
          Array.from(itemsContainer.querySelectorAll('.item-controls.collapsed'))
            .map(el => el.getAttribute('data-id'))
        );
      } catch (_e) {}

      itemsContainer.innerHTML = items.map((it, idx) => {
        const titleText = `${esc(it.label || typeName(it.type))} (${typeName(it.type)})`;
        const collapsedClass = prevCollapsedIds.has(it.id) ? ' collapsed' : '';
        return `
          <div class="item-controls collapsible${collapsedClass}" data-id="${it.id}">
            <div class="item-header">
              <span>${idx + 1}. ${titleText}</span>
              <div style="display:flex;align-items:center;gap:8px;">
                <div class="item-actions">
                  <button class="btn" data-action="up" data-id="${it.id}" title="上移"><i class="fa-solid fa-chevron-up"></i></button>
                  <button class="btn" data-action="down" data-id="${it.id}" title="下移"><i class="fa-solid fa-chevron-down"></i></button>
                  <button class="btn btn-delete" data-action="delete" data-id="${it.id}" title="删除"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <span class="item-collapse-toggle" title="折叠/展开">▾</span>
              </div>
            </div>
            ${renderItemInputs(it)}
          </div>
        `;
      }).join('');
      
      // 注入：局部卡片背景与阴影控制（仅当开启“每项目独立设置”）
      try {
        if (customization.itemCardPerItemEnabled) {
          const partsFn = (window.Ny && Ny.Sections && Ny.Sections.ItemsParts && typeof Ny.Sections.ItemsParts.perItemCardBox === 'function')
            ? Ny.Sections.ItemsParts.perItemCardBox
            : null;

          items.forEach(it => {
            const card = itemsContainer.querySelector(`.item-controls[data-id="${it.id}"]`);
            if (!card || card.querySelector('.per-item-card-box')) return;

            if (partsFn) {
              const html = partsFn(it, customization);
              if (html && typeof html === 'string') {
                // 直接插入 perItemCardBox 返回的完整节点（内含 per-item-card-box 类）
                card.insertAdjacentHTML('beforeend', html);
              }
            } else {
              // 安全回退：仅 URL + 阴影
              const csEnabled = !!it.cardShadowEnable;
              const csStrength = isFinite(it.cardShadowStrength) ? it.cardShadowStrength : (customization.itemCardShadowStrength || 0.30);
              const urlVal = esc(it.cardUrl || '');
              const box = document.createElement('div');
              box.className = 'inline-subbox per-item-card-box';
              box.innerHTML = `
                <div class="form-box-title">卡片背景与阴影（局部覆盖）</div>
                <div class="control-group">
                  <label>自定义 URL 背景（留空则跟随全局）</label>
                  <input type="url" value="${urlVal}" data-field="cardUrl" data-id="${it.id}" placeholder="https://example.com/card.png">
                </div>
                <div class="control-group">
                  <label style="display:flex;align-items:center;gap:8px;">
                    <input type="checkbox" ${csEnabled ? 'checked' : ''} data-field="cardShadowEnable" data-id="${it.id}">
                    阴影（局部）
                  </label>
                  <div class="range-row" style="margin-top:6px;">
                    <label>强度</label>
                    <input type="range" min="0" max="1" step="0.05" value="${csStrength}" ${csEnabled ? '' : 'disabled'} data-field="cardShadowStrength" data-id="${it.id}">
                    <span class="value-pill"><span>${Number(csStrength).toFixed(2)}</span></span>
                  </div>
                </div>
              `;
              card.appendChild(box);
            }
          });
        } else {
          // 清理已注入的局部控制
          itemsContainer.querySelectorAll('.per-item-card-box').forEach(n => n.remove());
        }
      } catch (_e) {}
    }

    function renderItemInputs(it) {
      if (it.type === 'text') {
        const vbw = isFinite(it.vbWidthPct) ? clamp(parseInt(it.vbWidthPct, 10) || 100, 40, 100) : (customization.valueBoxWidthPct || 100);
        const vbo = isFinite(it.vbOffsetPct) ? clamp(parseInt(it.vbOffsetPct, 10) || 0, -40, 40) : (customization.valueBoxOffsetPct || 0);
        const iol = isFinite(it.itemOffsetPct) ? clamp(parseInt(it.itemOffsetPct, 10) || 0, -40, 40) : (customization.itemOffsetPct || 0);
        const ior = isFinite(it.itemOffsetRightPct) ? clamp(parseInt(it.itemOffsetRightPct, 10) || 0, -40, 40) : (customization.itemOffsetRightPct || 0);
        return `
          <div class="control-group">
            <label>标签</label>
            <input type="text" value="${esc(it.label || '')}" data-field="label" data-id="${it.id}">
          </div>
          <div class="control-group">
            <label>值</label>
            <input type="text" value="${esc(it.value || '')}" data-field="value" data-id="${it.id}">
          </div>
          <div class="inline-subbox">
            <div class="form-box-title">局部值框与偏移</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="range-row">
                <label>宽度(相对最大 %)</label>
                <input type="range" min="40" max="100" step="1" value="${vbw}" data-field="vbWidthPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbw}</span>%</span>
              </div>
              <div class="range-row">
                <label>值框水平偏移(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${vbo}" data-field="vbOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbo}</span>%</span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;">
              <div class="range-row">
                <label>整体水平偏移(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${iol}" data-field="itemOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${iol}</span>%</span>
              </div>
              <div class="range-row">
                <label>整体右侧偏移(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${ior}" data-field="itemOffsetRightPct" data-id="${it.id}">
                <span class="value-pill"><span>${ior}</span>%</span>
              </div>
            </div>
          </div>
        `;
      }
      if (it.type === 'longtext') {
        const lh = (typeof it.ltLineHeight === 'number' ? it.ltLineHeight : 1.6);
        const eff = it.ltEffect || 'none';
        return `
          <div class="control-group">
            <label>标签</label>
            <input type="text" value="${esc(it.label || '')}" data-field="label" data-id="${it.id}">
          </div>
          <div class="control-group">
            <label>长文字</label>
            <textarea rows="4" data-field="value" data-id="${it.id}" style="width:100%;padding:8px 12px;border-radius:6px;border:1px solid var(--border-color);background:var(--bg-control);color:var(--text-primary);">${esc(it.value || '')}</textarea>
          </div>
          <div class="inline-subbox collapsible lt-typo-box">
            <div class="form-box-title" tabindex="0">排版与动画</div>
            <div class="control-group">
              <label>行间距</label>
              <div class="range-row">
                <input type="range" min="1" max="3" step="0.05" value="${lh}" data-field="ltLineHeight" data-id="${it.id}">
                <span class="value-pill"><span>${(typeof lh === 'number' && lh.toFixed ? lh.toFixed(2) : lh)}</span></span>
              </div>
            </div>

            <div class="control-group">
              <label style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" ${it.ltSkipFirstLine ? 'checked' : ''} data-field="ltSkipFirstLine" data-id="${it.id}">
                空出首行
              </label>
              <p style="color: var(--text-secondary); font-size: 12px; margin-top:6px;">启用后，在首行预留一行高度，不渲染文字。</p>
            </div>

            <div class="control-group">
              <label>首字缩进(px)</label>
              <input type="number" min="0" step="1" value="${isFinite(it.ltFirstIndentPx)?Number(it.ltFirstIndentPx):0}" data-field="ltFirstIndentPx" data-id="${it.id}" style="width:100px;">
            </div>

            <div class="control-group">
              <label>长文字与边框的距离（内边距，px）</label>
              <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">上</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadTopPx)?Number(it.ltPadTopPx):0}" data-field="ltPadTopPx" data-id="${it.id}" style="width:100%;">
                </div>
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">右</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadRightPx)?Number(it.ltPadRightPx):0}" data-field="ltPadRightPx" data-id="${it.id}" style="width:100%;">
                </div>
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">下</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadBottomPx)?Number(it.ltPadBottomPx):0}" data-field="ltPadBottomPx" data-id="${it.id}" style="width:100%;">
                </div>
                <div>
                  <label style="font-size:12px;color:var(--text-secondary);">左</label>
                  <input type="number" min="0" step="1" value="${isFinite(it.ltPadLeftPx)?Number(it.ltPadLeftPx):0}" data-field="ltPadLeftPx" data-id="${it.id}" style="width:100%;">
                </div>
              </div>
            </div>

            <div class="control-group">
              <label>动画特效</label>
              <select data-field="ltEffect" data-id="${it.id}">
                <option value="none"${eff==='none'?' selected':''}>无</option>
                <option value="typewriter"${eff==='typewriter'?' selected':''}>打字机</option>
                <option value="fade"${eff==='fade'?' selected':''}>淡入</option>
                <option value="slide"${eff==='slide'?' selected':''}>上滑</option>
              </select>
            </div>

            <div class="control-group" data-role="lt-typewriter-options" style="${eff==='typewriter'?'':'display:none;'}">
              <label>打字机设置</label>
              <div class="range-row">
                <label>速度(毫秒/字符)</label>
                <input type="range" min="5" max="200" step="1" value="${isFinite(it.ltTwSpeedMs)?Number(it.ltTwSpeedMs):18}" data-field="ltTwSpeedMs" data-id="${it.id}">
                <span class="value-pill"><span>${isFinite(it.ltTwSpeedMs)?Number(it.ltTwSpeedMs):18}</span></span>
              </div>
              <div style="display:flex;align-items:center;gap:8px;margin-top:6px;">
                <label style="min-width:100px;">开始延迟(ms)</label>
                <input type="number" min="0" step="50" value="${isFinite(it.ltTwDelayMs)?Number(it.ltTwDelayMs):0}" data-field="ltTwDelayMs" data-id="${it.id}" style="width:120px;">
              </div>
              <div class="control-group" style="margin-top:6px;">
                <label style="display:flex;align-items:center;gap:8px;">
                  <input type="checkbox" ${it.ltTwCaret !== false ? 'checked' : ''} data-field="ltTwCaret" data-id="${it.id}">
                  显示光标闪烁
                </label>
              </div>
            </div>
          </div>
        `;
      }
      if (it.type === 'bar') {
        const p = clamp(parseInt(it.percent ?? 0, 10) || 0, 0, 100);
        const accent = esc(customization.section2BarColor || customization.primaryColor);
        const vbw = isFinite(it.vbWidthPct) ? clamp(parseInt(it.vbWidthPct, 10) || 100, 40, 100) : (customization.valueBoxWidthPct || 100);
        const vbo = isFinite(it.vbOffsetPct) ? clamp(parseInt(it.vbOffsetPct, 10) || 0, -40, 40) : (customization.valueBoxOffsetPct || 0);
        const iol = isFinite(it.itemOffsetPct) ? clamp(parseInt(it.itemOffsetPct, 10) || 0, -40, 40) : (customization.itemOffsetPct || 0);
        const ior = isFinite(it.itemOffsetRightPct) ? clamp(parseInt(it.itemOffsetRightPct, 10) || 0, -40, 40) : (customization.itemOffsetRightPct || 0);
        return `
          <div class="control-group">
            <label>标签</label>
            <input type="text" value="${esc(it.label || '')}" data-field="label" data-id="${it.id}">
          </div>
          <div class="control-group">
            <label>百分比</label>
            <div class="range-row">
              <input type="range" min="0" max="100" step="1" value="${p}" data-field="percent" data-id="${it.id}" style="accent-color:${accent}">
              <span class="value-pill"><span>${p}%</span></span>
            </div>
          </div>
          <div class="inline-subbox">
            <div class="form-box-title">局部值框与偏移</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div class="range-row">
                <label>宽度(相对最大 %)</label>
                <input type="range" min="40" max="100" step="1" value="${vbw}" data-field="vbWidthPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbw}</span>%</span>
              </div>
              <div class="range-row">
                <label>值框水平偏移(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${vbo}" data-field="vbOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${vbo}</span>%</span>
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:8px;">
              <div class="range-row">
                <label>整体水平偏移(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${iol}" data-field="itemOffsetPct" data-id="${it.id}">
                <span class="value-pill"><span>${iol}</span>%</span>
              </div>
              <div class="range-row">
                <label>整体右侧偏移(%)</label>
                <input type="range" min="-40" max="40" step="1" value="${ior}" data-field="itemOffsetRightPct" data-id="${it.id}">
                <span class="value-pill"><span>${ior}</span>%</span>
              </div>
            </div>
          </div>
        `;
      }
      // divider / row 无控件
      return '';
    }

    // -----------------------
    // 动画
    // -----------------------
    function applyAnimation() {
      const wrapper = previewContainer.querySelector('.status-preview-wrapper');
      if (!wrapper) return;
      // 基本变量
      wrapper.style.setProperty('--anim-speed', `${animSpeed}s`);
      wrapper.style.setProperty('--anim-intensity', `${animIntensity}`);
      // 光晕变量（跟随自定义或主/辅色）
      try {
        const a = (customization.glowColorA && customization.glowColorA.trim()) ? customization.glowColorA : (customization.primaryColor || '#85a6f8');
        const b = (customization.glowColorB && customization.glowColorB.trim()) ? customization.glowColorB : (customization.secondaryColor || '#95b3e8');
        const gs = (typeof customization.glowSpeed === 'number' ? customization.glowSpeed : 1.0);
        wrapper.style.setProperty('--glow-color-a', a);
        wrapper.style.setProperty('--glow-color-b', b);
        wrapper.style.setProperty('--glow-speed', `${gs}s`);
      } catch(_e){}
      // 清理所有动画类
      wrapper.classList.remove('anim-none','anim-fade-in','anim-slide-up','anim-pulse','anim-neon-glow','anim-shimmer','anim-tilt-3d','anim-breathe','anim-gloss');
      // 映射：进入动画与长驻动画
      const enterMap = { none:'', fade:'anim-fade-in', slide:'anim-slide-up' };
      const loopMap  = { none:'', pulse:'anim-pulse', neon:'anim-neon-glow', shimmer:'anim-shimmer', tilt3d:'anim-tilt-3d', breathe:'anim-breathe', gloss:'anim-gloss' };
      const enterCls = enterMap[currentEnterAnimation] || '';
      const loopCls  = loopMap[currentLoopAnimation]  || '';
      if (enterCls) wrapper.classList.add(enterCls);
      if (loopCls)  wrapper.classList.add(loopCls);
    }

    // -----------------------
    // 事件绑定
    // -----------------------
    // 主题切换
    themeOptions.forEach(option => {
      option.addEventListener('click', () => {
        const nextTheme = option.dataset.theme;
        if (!nextTheme || nextTheme === currentTheme) return;
        // 若当前主题个性化与默认值不一致，则提示
        const modified = isCustomizationModified(currentTheme);
        if (modified) {
          const ok = window.confirm('切换模板将清空当前模板的颜色等个性化设置，并应用新模板默认配置。确定继续吗？');
          if (!ok) return;
        }
        themeOptions.forEach(opt => opt.classList.remove('active'));
        option.classList.add('active');
        currentTheme = nextTheme;
        // 应用新模板默认值（颜色/字体/圆角/分割线/背景模式）
        applyThemeDefaults(currentTheme);
        updateAddItemOptionVisibility();
        renderPreview();
      });
    });

    // 标题
    titleInput.addEventListener('input', (e) => {
      currentTitle = e.target.value;
      const w = document.getElementById('xml-wrapper-name');
      if (w) w.value = toWrapperNameFromTitle(currentTitle);
      renderPreview();
    });

    // 动画
    if (enterAnimSelect) {
      enterAnimSelect.addEventListener('change', (e) => {
        currentEnterAnimation = e.target.value;
        // 统一动画描述，避免未定义变量导致点击崩溃
        currentAnimation = (currentEnterAnimation !== 'none' || currentLoopAnimation !== 'none')
          ? `${currentEnterAnimation}+${currentLoopAnimation}`
          : 'none';
        renderPreview();
      });
    }
    if (loopAnimSelect) {
      loopAnimSelect.addEventListener('change', (e) => {
        currentLoopAnimation = e.target.value;
        // 统一动画描述，避免未定义变量导致点击崩溃
        currentAnimation = (currentEnterAnimation !== 'none' || currentLoopAnimation !== 'none')
          ? `${currentEnterAnimation}+${currentLoopAnimation}`
          : 'none';
        renderPreview();
      });
    }
    animSpeedRange.addEventListener('input', (e) => {
      animSpeed = parseFloat(e.target.value);
      speedValue.textContent = animSpeed.toFixed(1);
      applyAnimation();
    });
    animIntensityRange.addEventListener('input', (e) => {
      animIntensity = parseFloat(e.target.value);
      intensityValue.textContent = animIntensity.toFixed(2);
      applyAnimation();
    });

    // 添加项目
    if (addItemBtn) {
      addItemBtn.addEventListener('click', () => {
        const t = addItemSelect ? addItemSelect.value : 'text';
        let newItem;
        if (t === 'text') {
          newItem = { id: genId(), type: 'text', label: '标签', value: '值' };
        } else if (t === 'longtext') {
          newItem = {
            id: genId(),
            type: 'longtext',
            label: '说明',
            value: '在此填写长段文字…',
            ltLineHeight: 1.6,
            ltEffect: 'none',
            ltSkipFirstLine: false,
            ltFirstIndentPx: 0,
            ltPadTopPx: 0,
            ltPadRightPx: 0,
            ltPadBottomPx: 0,
            ltPadLeftPx: 0,
            ltTwSpeedMs: 18,
            ltTwDelayMs: 0,
            ltTwCaret: true
          };
        } else if (t === 'bar') {
          newItem = { id: genId(), type: 'bar', label: '进度', percent: 50 };
        } else if (t === 'divider') {
          newItem = { id: genId(), type: 'divider' };
        } else {
          newItem = { id: genId(), type: 'text', label: '标签', value: '值' };
        }
        items.push(newItem);
        renderItemsEditor();
        renderPreview();
        console.log('[ADD]', snapshot());
      });
    } else {
      console.warn('[ui] addItemBtn not found; skip binding');
    }

    // 编辑/删除/排序 与 折叠（事件委托）
    itemsContainer.addEventListener('click', (e) => {
      // 折叠/展开：最右侧小三角
      const tog = e.target.closest('.item-collapse-toggle');
      if (tog) {
        const card = tog.closest('.item-controls');
        if (card) card.classList.toggle('collapsed');
        return;
      }

      // 子组折叠：点击“排版与动画”子框标题折叠/展开
      const subTitle = e.target.closest('.inline-subbox .form-box-title');
      if (subTitle) {
        const box = subTitle.closest('.inline-subbox');
        if (box && box.classList.contains('collapsible')) {
          box.classList.toggle('collapsed');
        }
        return;
      }

      const btn = e.target.closest('button[data-action]');
      if (!btn) return;
      const action = btn.dataset.action;
      const id = btn.dataset.id;
      const idx = items.findIndex(it => it.id === id);
      if (idx === -1) return;

      if (action === 'delete') {
        items.splice(idx, 1);
        renderItemsEditor();
        renderPreview();
        console.log('[DELETE]', id, snapshot());
      } else if (action === 'up') {
        if (idx > 0) {
          [items[idx - 1], items[idx]] = [items[idx], items[idx - 1]];
          renderItemsEditor();
          renderPreview();
          console.log('[MOVE_UP]', id, snapshot());
        }
      } else if (action === 'down') {
        if (idx < items.length - 1) {
          [items[idx], items[idx + 1]] = [items[idx + 1], items[idx]];
          renderItemsEditor();
          renderPreview();
          console.log('[MOVE_DOWN]', id, snapshot());
        }
      }
    });

    // 键盘可访问性：在子框标题上按 Enter/Space 折叠/展开
    itemsContainer.addEventListener('keydown', (e) => {
      const t = e.target;
      if (t && t.classList && t.classList.contains('form-box-title')) {
        const box = t.closest('.inline-subbox.collapsible');
        if (box && (e.key === 'Enter' || e.key === ' ')) {
          e.preventDefault();
          box.classList.toggle('collapsed');
        }
      }
    });

    itemsContainer.addEventListener('input', (e) => {
      const field = e.target.dataset.field;
      if (!field) return;
      const id = e.target.dataset.id;
      const item = items.find(it => it.id === id);
      if (!item) return;
     
      if (field === 'label') {
        item.label = e.target.value;
        // 即时同步本项标题，避免等待整表重绘
        try {
          const card = e.target.closest('.item-controls');
          const hdr = card && card.querySelector('.item-header > span');
          const idx2 = items.findIndex(x => x && x.id === item.id);
          const tn = typeName(item.type);
          const tLabel = (item.label && item.label.trim()) ? item.label : tn;
          if (hdr) hdr.textContent = (idx2 >= 0 ? (idx2 + 1) + '. ' : '') + tLabel + ' (' + tn + ')';
        } catch(_e){}
      } else if (field === 'value') {
        item.value = e.target.value;
      } else if (field === 'percent') {
        item.percent = clamp(parseInt(e.target.value, 10) || 0, 0, 100);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = item.percent + '%';
      } else if (field === 'labelColor') {
        item.labelColor = e.target.value;
      } else if (field === 'valueColor') {
        item.valueColor = e.target.value;
      } else if (field === 'barColor') {
        item.barColor = e.target.value;
      } else if (field === 'ltLineHeight') {
        item.ltLineHeight = clamp(parseFloat(e.target.value) || 1.6, 1, 3);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = item.ltLineHeight.toFixed(2);
      } else if (field === 'ltEffect') {
        item.ltEffect = e.target.value;
      } else if (field === 'ltFirstIndentPx') {
        item.ltFirstIndentPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadTopPx') {
        item.ltPadTopPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadRightPx') {
        item.ltPadRightPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadBottomPx') {
        item.ltPadBottomPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'ltPadLeftPx') {
        item.ltPadLeftPx = Math.max(0, parseInt(e.target.value, 10) || 0);
      } else if (field === 'vbWidthPct') {
        item.vbWidthPct = clamp(parseInt(e.target.value, 10) || 100, 40, 100);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.vbWidthPct);
      } else if (field === 'vbOffsetPct') {
        item.vbOffsetPct = clamp(parseInt(e.target.value, 10) || 0, -40, 40);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.vbOffsetPct);
      } else if (field === 'itemOffsetPct') {
        item.itemOffsetPct = clamp(parseInt(e.target.value, 10) || 0, -40, 40);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.itemOffsetPct);
      } else if (field === 'itemOffsetRightPct') {
        item.itemOffsetRightPct = clamp(parseInt(e.target.value, 10) || 0, -40, 40);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.itemOffsetRightPct);
      } else if (field === 'cardBgColor') {
        item.cardBgColor = e.target.value;
      } else if (field === 'cardBgColorCode') {
        item.cardBgColor = e.target.value;
        const v = e.target.value;
        const colorInp = e.target.closest('.control-group')?.querySelector('input[type="color"][data-field="cardBgColor"]');
        if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && colorInp) colorInp.value = v;
      } else if (field === 'cardGradStart') {
        item.cardGradStart = e.target.value;
      } else if (field === 'cardGradEnd') {
        item.cardGradEnd = e.target.value;
      } else if (field === 'cardGradAngle') {
        item.cardGradAngle = clamp(parseInt(e.target.value, 10) || 135, 0, 360);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.cardGradAngle);
      } else if (field === 'cardImageUrl') {
        item.cardImageUrl = e.target.value;
      } else if (field === 'cardUrl') {
        item.cardUrl = e.target.value;
      } else if (field === 'cardShadowStrength') {
        item.cardShadowStrength = clamp(parseFloat(e.target.value) || 0.30, 0, 1);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = Number(item.cardShadowStrength).toFixed(2);
      } else if (field === 'ltTwSpeedMs') {
        item.ltTwSpeedMs = clamp(parseInt(e.target.value, 10) || 18, 5, 200);
        const pill = e.target.closest('.range-row')?.querySelector('.value-pill > span');
        if (pill) pill.textContent = String(item.ltTwSpeedMs);
      } else if (field === 'ltTwDelayMs') {
        item.ltTwDelayMs = Math.max(0, parseInt(e.target.value, 10) || 0);
      }
      renderPreview();
      console.log('[UPDATE]', { id, field, value: e.target.value }, snapshot());
    });
    
    // 额外：局部卡片背景与阴影的选择/开关
    itemsContainer.addEventListener('change', (e) => {
      const field = e.target.dataset.field;
      if (!field) return;
      const id = e.target.dataset.id;
      const item = items.find(it => it.id === id);
      if (!item) return;
      if (field === 'ltSkipFirstLine') {
        item.ltSkipFirstLine = !!e.target.checked;
      } else if (field === 'cardShadowEnable') {
        item.cardShadowEnable = !!e.target.checked;
        // 启用/禁用强度滑条
        try {
          const range = e.target.closest('.control-group')?.querySelector('input[type="range"][data-field="cardShadowStrength"]');
          if (range) range.disabled = !item.cardShadowEnable;
        } catch (_e) {}
      } else if (field === 'cardBgMode') {
        item.cardBgMode = e.target.value || '';
        const root = e.target.closest('.inline-subbox') || e.target.closest('.item-controls');
        if (root) {
          const show = (q, vis) => { const el = root.querySelector(q); if (el) el.style.display = vis ? '' : 'none'; };
          show('[data-role="card-bg-color"]', item.cardBgMode === 'color');
          show('[data-role="card-bg-gradient"]', item.cardBgMode === 'gradient');
          show('[data-role="card-bg-image"]', item.cardBgMode === 'image');
          show('[data-role="card-bg-url"]', item.cardBgMode === 'url');
        }
      } else if (field === 'ltTwCaret') {
        item.ltTwCaret = !!e.target.checked;
      } else if (field === 'ltEffect') {
        item.ltEffect = e.target.value;
        const root = e.target.closest('.inline-subbox') || e.target.closest('.item-controls');
        if (root) {
          const box = root.querySelector('[data-role="lt-typewriter-options"]');
          if (box) box.style.display = (item.ltEffect === 'typewriter') ? '' : 'none';
        }
      }
      renderPreview();
      console.log('[UPDATE:change]', { id, field, value: e.target.value }, snapshot());
    });

// ===== 模板个性化：状态与联动（背景 / 图标 / 字体 / 颜色 / 圆角 / 布局） =====
const fontFamilySelect = document.getElementById('font-family-select');
const primaryColorInput = document.getElementById('primary-color-input');
const secondaryColorInput = document.getElementById('secondary-color-input');
const primaryColorCodeInput = document.getElementById('primary-color-code-input');
const secondaryColorCodeInput = document.getElementById('secondary-color-code-input');
const borderRadiusRange = document.getElementById('border-radius-range');
const radiusValue = document.getElementById('radius-value');

const bgModeSelect = document.getElementById('bg-mode-select');
const bgColorInput = document.getElementById('bg-color-input');
const bgColorCodeInput = document.getElementById('bg-color-code-input');
const bgGradientStartColorInput = document.getElementById('bg-gradient-start-color-input');
const bgGradientStartCodeInput = document.getElementById('bg-gradient-start-code-input');
const bgGradientEndColorInput = document.getElementById('bg-gradient-end-color-input');
const bgGradientEndCodeInput = document.getElementById('bg-gradient-end-code-input');
const bgGradientStyleSelect = document.getElementById('bg-gradient-style-select');
const bgGradientAngleRange = document.getElementById('bg-gradient-angle-range');
const bgGradientAngleValue = document.getElementById('bg-gradient-angle-value');
const bgGradientDirectionSelect = document.getElementById('bg-gradient-direction-select');
const bgImageUrlInput = document.getElementById('bg-image-url');


const iconModeSelect = document.getElementById('icon-mode-select');
const iconBuiltinSelect = document.getElementById('icon-built-in-select');
const iconUrlInput = document.getElementById('icon-url-input');
const iconSizeRange = document.getElementById('icon-size-range');
const iconSizeValue = document.getElementById('icon-size-value');
const iconPositionSelect = document.getElementById('icon-position-select');

const layoutSelect = document.getElementById('layout-select');
const letterSpacingRange = document.getElementById('letter-spacing-range');
const letterSpacingValue = document.getElementById('letter-spacing-value');
const lineHeightRange = document.getElementById('line-height-range');
const lineHeightValue = document.getElementById('line-height-value');
const opacityRange = document.getElementById('opacity-range');
const opacityValue = document.getElementById('opacity-value');
const dividerStyleSelect = document.getElementById('divider-style-select');
const barStyleSelect = document.getElementById('bar-style-select');
const barAnimationSelect = document.getElementById('bar-animation-select');
const percentDisplaySelect = document.getElementById('percent-display-select');
const longtextLineHeightRange = document.getElementById('longtext-line-height-range');
const longtextLineHeightValue = document.getElementById('longtext-line-height-value');
const longtextEffectSelect = document.getElementById('longtext-effect-select');

/* 双列设置控件 */
const twoColSettingsGroup = document.getElementById('two-col-settings');
const twoColLabelPctRange = document.getElementById('two-col-label-pct-range');
const twoColLabelPctValue = document.getElementById('two-col-label-pct-value');
const twoColGapRange = document.getElementById('two-col-gap-range');
const twoColGapValue = document.getElementById('two-col-gap-value');
/* 光晕设置控件 */
const glowColorAInput = document.getElementById('glow-color-a-input');
const glowColorACodeInput = document.getElementById('glow-color-a-code-input');
const glowColorBInput = document.getElementById('glow-color-b-input');
const glowColorBCodeInput = document.getElementById('glow-color-b-code-input');
const glowSpeedRange = document.getElementById('glow-speed-range');
const glowSpeedValue = document.getElementById('glow-speed-value');

// 新增：值框宽度/位置 与 项目整体偏移/阴影（第三部分）
const valueBoxWidthPctRange = document.getElementById('value-box-width-pct-range');
const valueBoxWidthPctValue = document.getElementById('value-box-width-pct-value');
const valueBoxOffsetPctRange = document.getElementById('value-box-offset-pct-range');
const valueBoxOffsetPctValue = document.getElementById('value-box-offset-pct-value');

// 新增：标签/值占比（第三部分）
const labelValueLabelPctRange = document.getElementById('label-value-label-pct-range');
const labelValueLabelPctValue = document.getElementById('label-value-label-pct-value');
const labelValueValuePctValue = document.getElementById('label-value-value-pct-value');

const itemOffsetPctRange = document.getElementById('item-offset-pct-range');
const itemOffsetPctValue = document.getElementById('item-offset-pct-value');
const itemOffsetRightPctRange = document.getElementById('item-offset-right-pct-range');
const itemOffsetRightPctValue = document.getElementById('item-offset-right-pct-value');

// 项目卡片背景与阴影（全局+局部）
const itemCardPerItemToggle = document.getElementById('item-bg-shadow-per-item-toggle');
const itemCardBgModeSelect = document.getElementById('item-card-bg-mode-select');
const itemCardBgColorInput = document.getElementById('item-card-bg-color-input');
const itemCardBgColorCodeInput = document.getElementById('item-card-bg-color-code-input');
const itemCardGradStartInput = document.getElementById('item-card-grad-start-color-input');
const itemCardGradStartCodeInput = document.getElementById('item-card-grad-start-code-input');
const itemCardGradEndInput = document.getElementById('item-card-grad-end-color-input');
const itemCardGradEndCodeInput = document.getElementById('item-card-grad-end-code-input');
const itemCardGradAngleRange = document.getElementById('item-card-grad-angle-range');
const itemCardGradAngleValue = document.getElementById('item-card-grad-angle-value');
const itemCardBgImageUrlInput = document.getElementById('item-card-bg-image-url');
const itemCardBgUrlInput = document.getElementById('item-card-bg-url-input');
const itemCardShadowEnableCheckbox = document.getElementById('item-card-shadow-enable');
const itemCardShadowStrengthRange = document.getElementById('item-card-shadow-strength-range');
const itemCardShadowStrengthValue = document.getElementById('item-card-shadow-strength-value');

const itemCardBgColorGroup = document.getElementById('item-card-bg-color-group');
const itemCardBgGradientGroup = document.getElementById('item-card-bg-gradient-group');
const itemCardBgImageGroup = document.getElementById('item-card-bg-image-group');
const itemCardBgUrlGroup = document.getElementById('item-card-bg-url-group');


// 新增：第三部分项目颜色控制（仅影响“状态项目”渲染）
const section2LabelColorInput = document.getElementById('section2-label-color-input');
const section2ValueColorInput = document.getElementById('section2-value-color-input');
const section2BarColorInput = document.getElementById('section2-bar-color-input');
const section2DividerColorInput = document.getElementById('section2-divider-color-input');
const section2LabelColorCodeInput = document.getElementById('section2-label-color-code-input');
const section2ValueColorCodeInput = document.getElementById('section2-value-color-code-input');
const section2BarColorCodeInput = document.getElementById('section2-bar-color-code-input');
const section2DividerColorCodeInput = document.getElementById('section2-divider-color-code-input');

// 新增：全局标签/值字体与样式控制
const globalLabelFontSelect = document.getElementById('global-label-font-select');
const globalValueFontSelect = document.getElementById('global-value-font-select');
const globalLabelWeightSelect = document.getElementById('global-label-weight-select');
const globalValueWeightSelect = document.getElementById('global-value-weight-select');
const globalLabelItalicCheckbox = document.getElementById('global-label-italic-checkbox');
const globalValueItalicCheckbox = document.getElementById('global-value-italic-checkbox');
const globalLabelUppercaseCheckbox = document.getElementById('global-label-uppercase-checkbox');
const globalValueUppercaseCheckbox = document.getElementById('global-value-uppercase-checkbox');
const globalLabelReflectCheckbox = document.getElementById('global-label-reflect-checkbox');
const globalValueReflectCheckbox = document.getElementById('global-value-reflect-checkbox');
const statusbarWidthRange = document.getElementById('statusbar-width-range');
const statusbarWidthValue = document.getElementById('statusbar-width-value');



// 标题字号（1.5个性化）
const titleEnabledCheckbox = document.getElementById('title-enabled-checkbox');
const titleFontSizeRange = document.getElementById('title-font-size-range');
const titleFontSizeValue = document.getElementById('title-font-size-value');

/* 标题区域自定义控件 */
const headerMinHeightRange = document.getElementById('header-min-height-range');
const headerMinHeightValue = document.getElementById('header-min-height-value');
const headerPaddingYRange = document.getElementById('header-padding-y-range');
const headerPaddingYValue = document.getElementById('header-padding-y-value');
const headerAlignSelect = document.getElementById('header-align-select');

const titleGapEnableCheckbox = document.getElementById('title-gap-enable');
const titleGapRange = document.getElementById('title-gap-range');
const titleGapValue = document.getElementById('title-gap-value');

const titleColorModeSelect = document.getElementById('title-color-mode-select');
const titleColorSolidGroup = document.getElementById('title-color-solid-group');
const titleColorSolidInput = document.getElementById('title-color-solid-input');
const titleColorSolidCodeInput = document.getElementById('title-color-solid-code-input');

const titleColorGradientGroup = document.getElementById('title-color-gradient-group');
const titleGradStartInput = document.getElementById('title-grad-start-input');
const titleGradStartCodeInput = document.getElementById('title-grad-start-code-input');
const titleGradEndInput = document.getElementById('title-grad-end-input');
const titleGradEndCodeInput = document.getElementById('title-grad-end-code-input');
const titleGradAngleRange = document.getElementById('title-grad-angle-range');
const titleGradAngleValue = document.getElementById('title-grad-angle-value');

const titleGlowEnableCheckbox = document.getElementById('title-glow-enable');
const titleGlowIntensityRange = document.getElementById('title-glow-intensity-range');
const titleGlowIntensityValue = document.getElementById('title-glow-intensity-value');

const titleShadowEnableCheckbox = document.getElementById('title-shadow-enable');
const titleShadowStrengthRange = document.getElementById('title-shadow-strength-range');
const titleShadowStrengthValue = document.getElementById('title-shadow-strength-value');

// 标题高级样式控件
const titleWeightSelect = document.getElementById('title-weight-select');
const titleItalicCheckbox = document.getElementById('title-italic-checkbox');
const titleUppercaseCheckbox = document.getElementById('title-uppercase-checkbox');
const titleLetterSpacingRange = document.getElementById('title-letter-spacing-range');
const titleLetterSpacingValue = document.getElementById('title-letter-spacing-value');

// 下划线
const titleUnderlineStyleSelect = document.getElementById('title-underline-style-select');
const titleUnderlineColorInput = document.getElementById('title-underline-color-input');
const titleUnderlineColorCodeInput = document.getElementById('title-underline-color-code-input');
const titleUnderlineThicknessRange = document.getElementById('title-underline-thickness-range');
const titleUnderlineThicknessValue = document.getElementById('title-underline-thickness-value');
const titleUnderlineOffsetRange = document.getElementById('title-underline-offset-range');
const titleUnderlineOffsetValue = document.getElementById('title-underline-offset-value');

// 标题徽章背景
const titleBadgeEnableCheckbox = document.getElementById('title-badge-enable');
const titleBadgeColorInput = document.getElementById('title-badge-color-input');
const titleBadgeColorCodeInput = document.getElementById('title-badge-color-code-input');


// 状态项目字号（第三部分）
const globalLabelFontSizeRange = document.getElementById('global-label-font-size-range');
const globalLabelFontSizeValue = document.getElementById('global-label-font-size-value');
const globalValueFontSizeRange = document.getElementById('global-value-font-size-range');
const globalValueFontSizeValue = document.getElementById('global-value-font-size-value');

/* 折叠与动态显隐：背景 / 图标 控件分组引用 */
const iconModeGroup = document.getElementById('icon-mode-group');
const iconBuiltinGroup = document.getElementById('icon-built-in-group');
const iconUrlGroup = document.getElementById('icon-url-group');
const iconSizeGroup = document.getElementById('icon-size-group');
const iconPositionGroup = document.getElementById('icon-position-group');

const bgColorGroup = document.getElementById('bg-color-group');
const bgGradientGroup = document.getElementById('bg-gradient-group');
const bgImageGroup = document.getElementById('bg-image-group');
const bgLayersGroup = document.getElementById('bg-layers-group');
const bgComponentsGroup = document.getElementById('bg-components-group');
const bgLayersBox = document.getElementById('bg-layers-box');


/* 多图层/组件控制引用 */
const btnAddColorLayer = document.getElementById('btn-add-color-layer');
const btnAddGradientLayer = document.getElementById('btn-add-gradient-layer');
const btnAddImageLayerUrl = document.getElementById('btn-add-image-layer-url');
const bgLayersList = document.getElementById('bg-layers-list');

const btnAddCompUrl = document.getElementById('btn-add-comp-url');
const bgCompDragToggle = document.getElementById('bg-comp-drag-toggle');
const bgComponentsList = document.getElementById('bg-components-list');

/* 背景类型显隐：仅显示所选类型的设置 */
function updateBgFieldsVisibility() {
  try {
    const mode = bgModeSelect?.value || 'theme';
    const show = (el, visible) => { if (el) el.style.display = visible ? '' : 'none'; };
    show(bgColorGroup, mode === 'color');
    show(bgGradientGroup, mode === 'gradient');
    show(bgImageGroup, mode === 'image');
    show(bgLayersBox, mode === 'layers');
    show(bgLayersGroup, mode === 'layers');
    show(bgComponentsGroup, mode === 'layers');
    if (mode === 'theme' || mode === 'none') {
      show(bgColorGroup, false);
      show(bgGradientGroup, false);
      show(bgImageGroup, false);
      show(bgLayersBox, false);
      show(bgLayersGroup, false);
      show(bgComponentsGroup, false);
    }
  } catch (err) { console.warn('[ui] updateBgFieldsVisibility error', err); }
}
function updateIconFieldsVisibility() {
  try {
    const mode = iconModeSelect?.value || 'none';
    const show = (el, visible) => { if (el) el.style.display = visible ? '' : 'none'; };
    if (mode === 'none') {
      show(iconBuiltinGroup, false);
      show(iconUrlGroup, false);
      show(iconSizeGroup, false);
      show(iconPositionGroup, false);
    } else if (mode === 'built-in') {
      show(iconBuiltinGroup, true);
      show(iconUrlGroup, false);
      show(iconSizeGroup, true);
      show(iconPositionGroup, true);
    } else {
      show(iconBuiltinGroup, false);
      show(iconUrlGroup, true);
      show(iconSizeGroup, true);
      show(iconPositionGroup, true);
    }
  } catch (err) { console.warn('[ui] updateIconFieldsVisibility error', err); }
}


/* 双列设置显隐：仅当布局选择“双列”时显示调节面板 */
function updateTwoColumnFieldsVisibility() {
  try {
    const layout = layoutSelect?.value || 'label-left';
    if (twoColSettingsGroup) {
      twoColSettingsGroup.style.display = (layout === 'two-column') ? '' : 'none';
    }
  } catch (err) { console.warn('[ui] updateTwoColumnFieldsVisibility error', err); }
}

/* 项目卡片背景与阴影：全局字段显隐联动（根据“背景模式（全局）”选择显示对应配置块） */
function updateItemCardBgFieldsVisibility() {
  try {
    const mode = itemCardBgModeSelect?.value || 'theme';
    const show = (el, vis) => { if (el) el.style.display = vis ? '' : 'none'; };
    show(itemCardBgColorGroup, mode === 'color');
    show(itemCardBgGradientGroup, mode === 'gradient');
    show(itemCardBgImageGroup, mode === 'image');
    show(itemCardBgUrlGroup, mode === 'url');
    if (mode === 'theme' || mode === 'none') {
      show(itemCardBgColorGroup, false);
      show(itemCardBgGradientGroup, false);
      show(itemCardBgImageGroup, false);
      show(itemCardBgUrlGroup, false);
    }
    if (itemCardShadowStrengthRange) {
      itemCardShadowStrengthRange.disabled = !(itemCardShadowEnableCheckbox?.checked);
    }
  } catch (err) { console.warn('[ui] updateItemCardBgFieldsVisibility error', err); }
}

/* 折叠功能：1、1.5、2、3 部分均可折叠 */
function setupCollapsibleSections() {
  try {
    document.querySelectorAll('.control-section.collapsible > h3').forEach(h3 => {
      const sec = h3.parentElement;
      h3.addEventListener('click', () => {
        sec.classList.toggle('collapsed');
      });
    });
  } catch (err) { console.warn('[ui] setupCollapsibleSections error', err); }
}

/* 新增：动画叠加控件 */
const starEnabledCheckbox = document.getElementById('star-enabled');
const starFrequencyRange = document.getElementById('star-frequency-range');
const starFrequencyValue = document.getElementById('star-frequency-value');
const starDensityRange = document.getElementById('star-density-range');
const starDensityValue = document.getElementById('star-density-value');
const starColorInput = document.getElementById('star-color-input');
const starColorCodeInput = document.getElementById('star-color-code-input');

const sparkleEnabledCheckbox = document.getElementById('sparkle-enabled');
const sparkleDirectionSelect = document.getElementById('sparkle-direction-select');
const sparkleFrequencyRange = document.getElementById('sparkle-frequency-range');
const sparkleFrequencyValue = document.getElementById('sparkle-frequency-value');
const sparkleDensityRange = document.getElementById('sparkle-density-range');
const sparkleDensityValue = document.getElementById('sparkle-density-value');
const sparkleColorInput = document.getElementById('sparkle-color-input');
const sparkleColorCodeInput = document.getElementById('sparkle-color-code-input');
const sparkleGlowCheckbox = document.getElementById('sparkle-glow-checkbox');

const petalEnabledCheckbox = document.getElementById('petal-enabled');
const petalFrequencyRange = document.getElementById('petal-frequency-range');
const petalFrequencyValue = document.getElementById('petal-frequency-value');
const petalDensityRange = document.getElementById('petal-density-range');
const petalDensityValue = document.getElementById('petal-density-value');
const petalIconModeSelect = document.getElementById('petal-icon-mode-select');
const petalIconBuiltinSelect = document.getElementById('petal-icon-built-in-select');
const petalIconUrlInput = document.getElementById('petal-icon-url-input');

// 主题默认配置（最佳配色）
const themeDefaults = {
  'theme-mystic-noir':        { fontFamily: 'Georgia, Songti SC, serif',                                       primaryColor: '#c8cbd2', secondaryColor: '#d6d6d6', radius: 12, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 20 },
  'theme-cyber-grid':         { fontFamily: "'Courier New', Courier, monospace",                                primaryColor: '#FF6A3D', secondaryColor: '#9DAAF2', radius: 4,  dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-neon-night':         { fontFamily: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",                  primaryColor: '#00f7ff', secondaryColor: '#ff00a6', radius: 14, dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-glassmorphism':      { fontFamily: 'Inter, Noto Sans SC, sans-serif',                                  primaryColor: '#6EE7F9', secondaryColor: '#A78BFA', radius: 16, dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-steampunk':          { fontFamily: "Cinzel, 'Noto Serif SC', 'Times New Roman', Georgia, 'Songti SC', serif", primaryColor: '#B08D57', secondaryColor: '#F1E6D0', radius: 12, dividerStyle: 'dashed',   bgMode: 'theme', titleFontSize: 22 },
  'theme-paper-journal':      { fontFamily: "'Noto Serif SC', 'Songti SC', Georgia, serif",                      primaryColor: '#B48A60', secondaryColor: '#2A2A2A', radius: 12, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 22 },
  'theme-pixel-retro':        { fontFamily: "'Courier New', Courier, monospace",                                 primaryColor: '#64FF64', secondaryColor: '#C8C8C8', radius: 6,  dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 18 },
  'theme-modern-minimal':     { fontFamily: "Inter, 'Noto Sans SC', sans-serif",                                 primaryColor: '#FFFFFF', secondaryColor: '#9FA6B2', radius: 12, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 20 },
  'theme-nature-aura':        { fontFamily: "'Noto Serif SC', 'Songti SC', Georgia, serif",                      primaryColor: '#64D58B', secondaryColor: '#A7D7C5', radius: 14, dividerStyle: 'gradient', bgMode: 'theme', titleFontSize: 22 },
  'theme-ink-wash':           { fontFamily: "'Noto Serif SC', 'Songti SC', Georgia, serif",                      primaryColor: '#2A2A2A', secondaryColor: '#7A6248', radius: 14, dividerStyle: 'line',     bgMode: 'theme', titleFontSize: 22 }
};

// 初始个性化状态（以控件值为基准，随后叠加当前主题默认）
let customization = {
  fontFamily: fontFamilySelect?.value || 'Noto Sans SC, sans-serif',
  primaryColor: primaryColorInput?.value || '#6a717c',
  secondaryColor: secondaryColorInput?.value || '#97aec8',
  radius: parseInt(borderRadiusRange?.value || '12', 10),
  bgMode: bgModeSelect?.value || 'theme',
  bgColor: bgColorInput?.value || '#111215',
  bgGradientStart: bgGradientStartColorInput?.value || (primaryColorInput?.value || '#6a717c'),
  bgGradientEnd: bgGradientEndColorInput?.value || (secondaryColorInput?.value || '#97aec8'),
  bgGradientStyle: bgGradientStyleSelect?.value || 'linear',
  bgGradientAngle: parseInt(bgGradientAngleRange?.value || '135', 10),
  bgGradientDirection: bgGradientDirectionSelect?.value || 'to bottom right',
  bgImageUrl: bgImageUrlInput?.value || '',
  // 新增：多图层背景与拖动组件
  bgLayers: [],
  bgComponents: [],
  bgCompDrag: false,
  layout: layoutSelect?.value || 'label-left',
  letterSpacing: parseFloat(letterSpacingRange?.value || '0'),
  lineHeight: parseFloat(lineHeightRange?.value || '1.4'),
  titleFontSize: parseInt(titleFontSizeRange?.value || '20', 10),
  opacity: parseFloat(opacityRange?.value || '1'),
  dividerStyle: dividerStyleSelect?.value || 'line',
  
  // 新增：进度条风格/动画
  barStyle: barStyleSelect?.value || 'normal',
  barAnimation: barAnimationSelect?.value || 'none',
  // 新增：百分比显示风格
  percentDisplay: percentDisplaySelect?.value || 'center',

  // 光晕设置（默认跟随主/辅色，频率=1.0s）
  glowColorA: (primaryColorInput?.value || '#85a6f8'),
  glowColorB: (secondaryColorInput?.value || '#95b3e8'),
  glowSpeed: 1.0,

  // 长文字：行距与特效
  longTextLineHeight: parseFloat(longtextLineHeightRange?.value || '1.6'),
  longTextEffect: longtextEffectSelect?.value || 'none',

  // 新增：值框尺寸与位置 + 整体偏移/阴影（第三部分）
  valueBoxWidthPct: 100,          // 40~100（相对最大）
  valueBoxOffsetPct: 0,           // -40~40（%）
  itemOffsetPct: 0,               // -40~40（%）
  itemOffsetRightPct: 0,          // -40~40（%）右侧偏移（margin-right）
  // 新增：标签/值比例（默认 30% : 70%）
  lvLabelPct: 30,

  // 预览/导出最大宽度（统一，默认600）
  statusbarMaxWidth: parseInt(statusbarWidthRange?.value || '600', 10),

  // 新增：第三部分项目颜色（默认不启用，留空表示使用主题色）
  section2LabelColor: '',
  section2ValueColor: '',
  section2BarColor: '',
  section2DividerColor: '',

  // 项目卡片背景与阴影（全局）
  itemCardPerItemEnabled: !!(itemCardPerItemToggle?.checked || false),
  itemCardBgMode: itemCardBgModeSelect?.value || 'theme', // theme|none|color|gradient|image|url
  itemCardBgColor: itemCardBgColorInput?.value || '#111215',
  itemCardGradStart: itemCardGradStartInput?.value || (primaryColorInput?.value || '#6a717c'),
  itemCardGradEnd: itemCardGradEndInput?.value || (secondaryColorInput?.value || '#97aec8'),
  itemCardGradAngle: parseInt(itemCardGradAngleRange?.value || '135', 10),
  itemCardBgImageUrl: itemCardBgImageUrlInput?.value || '',
  itemCardBgUrl: itemCardBgUrlInput?.value || '',
  itemCardShadowEnabled: !!(itemCardShadowEnableCheckbox?.checked || false),
  itemCardShadowStrength: parseFloat(itemCardShadowStrengthRange?.value || '0.30') || 0.30,

  // 新增：标签/值字体与样式
  globalLabelFontFamily: globalLabelFontSelect?.value || (fontFamilySelect?.value || 'Noto Sans SC, sans-serif'),
  globalValueFontFamily: globalValueFontSelect?.value || (fontFamilySelect?.value || 'Noto Sans SC, sans-serif'),
  globalLabelWeight: parseInt(globalLabelWeightSelect?.value || '500', 10),
  globalValueWeight: parseInt(globalValueWeightSelect?.value || '600', 10),
  globalLabelFontSize: parseInt(globalLabelFontSizeRange?.value || '16', 10),
  globalValueFontSize: parseInt(globalValueFontSizeRange?.value || '16', 10),
  globalLabelItalic: !!(globalLabelItalicCheckbox?.checked || false),
  globalValueItalic: !!(globalValueItalicCheckbox?.checked || false),
  globalLabelUppercase: !!(globalLabelUppercaseCheckbox?.checked || false),
  globalValueUppercase: !!(globalValueUppercaseCheckbox?.checked || false),
  globalLabelReflect: !!(globalLabelReflectCheckbox?.checked || false),
  globalValueReflect: !!(globalValueReflectCheckbox?.checked || false),

  /* 标题区域自定义（默认保持现状：不覆盖模板） */
  headerMinHeight: parseInt(headerMinHeightRange?.value || '0', 10) || 0,
  headerPaddingY: parseInt(headerPaddingYRange?.value || '0', 10) || 0,
  headerAlign: headerAlignSelect?.value || 'inherit',
  titleEnabled: !!(titleEnabledCheckbox?.checked ?? true),
  titleGapEnabled: !!(titleGapEnableCheckbox?.checked || false),
  titleGap: parseInt(titleGapRange?.value || '10', 10) || 10,

  titleColorMode: titleColorModeSelect?.value || 'theme', /* theme | solid | gradient */
  titleColorSolid: titleColorSolidInput?.value || '',
  titleGradStart: titleGradStartInput?.value || '',
  titleGradEnd: titleGradEndInput?.value || '',
  titleGradAngle: parseInt(titleGradAngleRange?.value || '0', 10) || 0,

  titleEffectGlow: !!(titleGlowEnableCheckbox?.checked || false),
  titleGlowIntensity: parseFloat(titleGlowIntensityRange?.value || '0.5') || 0.5,
  titleEffectShadow: !!(titleShadowEnableCheckbox?.checked || false),
  titleShadowStrength: parseFloat(titleShadowStrengthRange?.value || '0.3') || 0.3,

  // 标题高级样式
  titleWeight: parseInt(titleWeightSelect?.value || '500', 10) || 500,
  titleItalic: !!(titleItalicCheckbox?.checked || false),
  titleUppercase: !!(titleUppercaseCheckbox?.checked || false),
  titleLetterSpacing: parseFloat(titleLetterSpacingRange?.value || '0') || 0,

  titleUnderlineStyle: titleUnderlineStyleSelect?.value || 'none',
  titleUnderlineColor: titleUnderlineColorInput?.value || '#ffffff',
  titleUnderlineThickness: parseInt(titleUnderlineThicknessRange?.value || '2', 10) || 2,
  titleUnderlineOffset: parseInt(titleUnderlineOffsetRange?.value || '4', 10) || 4,

  titleBadgeEnabled: !!(titleBadgeEnableCheckbox?.checked || false),
  titleBadgeColor: titleBadgeColorInput?.value || '#000000',


  /* 新增：动画叠加配置 */
  starEnabled: !!(starEnabledCheckbox?.checked || false),
  starFrequency: parseFloat(starFrequencyRange?.value || '2'),
  starDensity: parseInt(starDensityRange?.value || '50', 10),
  starColor: starColorInput?.value || '#ffffff',

  sparkleEnabled: !!(sparkleEnabledCheckbox?.checked || false),
  sparkleDirection: sparkleDirectionSelect?.value || 'down',
  sparkleFrequency: parseFloat(sparkleFrequencyRange?.value || '2'),
  sparkleDensity: parseInt(sparkleDensityRange?.value || '20', 10),
  sparkleColor: sparkleColorInput?.value || '#ffd966',
  sparkleGlow: !!(sparkleGlowCheckbox?.checked || true),

  petalEnabled: !!(petalEnabledCheckbox?.checked || false),
  petalFrequency: parseFloat(petalFrequencyRange?.value || '5'),
  petalDensity: parseInt(petalDensityRange?.value || '20', 10),
  petalIconMode: petalIconModeSelect?.value || 'built-in',
  petalIconBuiltin: petalIconBuiltinSelect?.value || 'leaf',
  petalIconUrl: petalIconUrlInput?.value || '',
  
  // 新增：自定义字体导入
  customFonts: [] // 存储用户导入的字体 [{url, name, optgroupAdded}]
};

// === 自定义字体导入功能 ===
const customFontUrlInput = document.getElementById('custom-font-url');
const customFontNameInput = document.getElementById('custom-font-name');
const btnImportCustomFont = document.getElementById('btn-import-custom-font');

// 导入字体到页面并添加到下拉框（增强版：支持延迟加载 + 实时预览测试）
/**
 * 自定义字体导入（CSS链接版）
 * - 适配 Google Fonts / result.css 等提供 CSS 的链接
 * - 使用 <link rel="stylesheet"> 避免 @import 受 CSP 限制
 * - 标准化 family 名；加入到选择器；预览立即应用；导出包含 @import
 * - 分阶段 document.fonts.check 验证加载成功
 */
async function importCustomFont() {
  try {
    const url = customFontUrlInput?.value?.trim();
    const nameHintRaw = customFontNameInput?.value?.trim() || '';
    if (!url) {
      alert('请输入字体 CSS 链接\n示例：https://fonts.googleapis.com/css2?family=YourFont:wght@400;700&display=swap');
      return;
    }

    // 初始按钮状态
    if (btnImportCustomFont) {
      btnImportCustomFont.disabled = true;
      btnImportCustomFont.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 加载中...';
    }

    // 注入 <link rel="stylesheet">（避免 @import 受 CSP 影响）
    const linkId = 'custom-font-link-' + Date.now();
    const linkEl = document.createElement('link');
    linkEl.id = linkId;
    linkEl.rel = 'stylesheet';
    linkEl.href = url;
    // 对于样式表通常无需 crossorigin；移除以防特定源报错
    document.head.appendChild(linkEl);

    // 尝试拉取 CSS 并从 @font-face 中自动提取 font-family
    let cssText = '';
    try {
      const res = await fetch(url, { mode: 'cors' });
      if (res && res.ok) {
        cssText = await res.text();
      }
    } catch (_e) {
      // 忽略网络错误，后续用用户输入兜底
    }

    // 解析 CSS 获取 font-family 名称列表
    const families = [];
    if (cssText && typeof cssText === 'string') {
      const rx = /font-family\s*:\s*['"]([^'"]+)['"]/gi;
      let m;
      const set = new Set();
      while ((m = rx.exec(cssText)) != null) {
        const fam = String(m[1] || '').trim();
        if (fam && !set.has(fam)) {
          set.add(fam);
          families.push(fam);
        }
      }
    }

    // 兜底：若无法解析，则使用用户输入提示名
    const sanitize = (s) => String(s || '').replace(/['"]/g, '').split(',')[0].trim();
    const hintFamilyBare = sanitize(nameHintRaw);
    const chosenBare = families[0] || hintFamilyBare;

    if (!chosenBare) {
      if (btnImportCustomFont) {
        btnImportCustomFont.disabled = false;
        btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> 导入字体';
      }
      alert('未能自动识别字体名称，请在“字体名称”中填写 CSS 中 @font-face 的 font-family 名称，例如："YourFont"');
      return;
    }

    // 标准化：带引号（有空格时）+ 默认 fallback
    const normalizedValue = (chosenBare.includes(' ') ? `'${chosenBare}'` : chosenBare) + ', sans-serif';

    // 重复检测（URL 或 family）
    const exists = customization.customFonts.some(f => {
      const fBare = sanitize(String(f.name || ''));
      return f.url === url || fBare === chosenBare;
    });
    if (exists) {
      // 已有则仅同步选择与预览
      if (fontFamilySelect) fontFamilySelect.value = normalizedValue;
      customization.fontFamily = normalizedValue;
      customization.globalLabelFontFamily = normalizedValue;
      customization.globalValueFontFamily = normalizedValue;
      if (globalLabelFontSelect) globalLabelFontSelect.value = normalizedValue;
      if (globalValueFontSelect) globalValueFontSelect.value = normalizedValue;
      renderPreview();
      alert('该字体已导入，已应用到预览');
      if (btnImportCustomFont) {
        btnImportCustomFont.disabled = false;
        btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> 导入字体';
      }
      console.debug('[custom-font] 已存在，直接应用', { url, family: chosenBare });
      return;
    }

    // 记录到状态（用于导出生成 @import）
    customization.customFonts.push({
      url,
      name: normalizedValue,
      linkId,
      type: 'css',
      optgroupAdded: false
    });

    // 添加下拉选项并选中
    addCustomFontToSelects(normalizedValue);
    if (fontFamilySelect) fontFamilySelect.value = normalizedValue;

    // 应用到主体/标签/值字体
    customization.fontFamily = normalizedValue;
    customization.globalLabelFontFamily = normalizedValue;
    customization.globalValueFontFamily = normalizedValue;
    if (globalLabelFontSelect) globalLabelFontSelect.value = normalizedValue;
    if (globalValueFontSelect) globalValueFontSelect.value = normalizedValue;

    // 预加载字体（尽量不阻塞 UI）
    try {
      if (document.fonts && document.fonts.load) {
        // 主 family
        await document.fonts.load(`16px "${chosenBare}"`).catch(() => {});
        // 若 CSS 中有多 family（如可变字体命名），一并预加载
        for (let i = 1; i < families.length; i++) {
          const fam = families[i];
          await document.fonts.load(`16px "${fam}"`).catch(() => {});
        }
      }
    } catch (_e) {}

    // 刷新预览
    renderPreview();

    // 分阶段检查加载状态（诊断）
    const checkTimes = [600, 2000, 5000];
    let loadSuccess = false;
    checkTimes.forEach((delay, index) => {
      setTimeout(() => {
        if (loadSuccess) return;
        try {
          if (document.fonts && document.fonts.check) {
            const ok = document.fonts.check(`16px "${chosenBare}"`);
            if (ok) {
              loadSuccess = true;
              console.debug('[custom-font] 加载成功', { family: chosenBare, url, t: delay });
              renderPreview();
              if (btnImportCustomFont) {
                btnImportCustomFont.disabled = false;
                btnImportCustomFont.innerHTML = '<i class="fa fa-check"></i> 导入成功';
                setTimeout(() => {
                  if (btnImportCustomFont) btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> 导入字体';
                }, 1800);
              }
            }
          }
        } catch (_e) {}

        if (index === checkTimes.length - 1) {
          if (btnImportCustomFont) {
            btnImportCustomFont.disabled = false;
            btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> 导入字体';
          }
          if (!loadSuccess) {
            alert(`⚠️ 字体样式已添加，但浏览器尚未确认加载成功\n\nfamily：${chosenBare}\n来源：${url}\n\n建议：\n- 稍等片刻后再次查看\n- 确认名称与 CSS 中 @font-face 的 font-family 一致（当前已自动识别：${chosenBare}）\n- 检查控制台网络/CORS 状态`);
            console.warn('[custom-font] 未确认加载成功', { family: chosenBare, url });
          } else {
            alert(`✅ 字体导入成功：${chosenBare}\n预览已应用，请检查右侧效果。`);
          }
        }
      }, delay);
    });

    // 清空输入
    if (customFontUrlInput) customFontUrlInput.value = '';
    if (customFontNameInput) customFontNameInput.value = '';

    console.debug('[custom-font] 注入 CSS 链接 & 自动识别 family', { linkId, url, familyDetected: chosenBare, families });
  } catch (e) {
    console.error('[custom-font] 导入失败', e);
    if (btnImportCustomFont) {
      btnImportCustomFont.disabled = false;
      btnImportCustomFont.innerHTML = '<i class="fa fa-download"></i> 导入字体';
    }
    alert('❌ 字体导入失败\n\n错误：' + (e?.message || '未知错误'));
  }
}

// 添加自定义字体到所有字体选择器
function addCustomFontToSelects(fontName) {
  try {
    const selects = [
      fontFamilySelect,
      globalLabelFontSelect,
      globalValueFontSelect
    ].filter(Boolean);

    // 规范化：选项值使用 CSS 安全值（含引号与 fallback）
    const bare = String(fontName || '').replace(/['"]/g, '').split(',')[0].trim();
    const normalizedValue = (bare.includes(' ') ? `'${bare}'` : bare) + ', sans-serif';
    const displayText = bare;

    selects.forEach(sel => {
      // 检查是否已有"自定义字体"分组
      let optgroup = sel.querySelector('optgroup[label="🎨 自定义字体"]');
      if (!optgroup) {
        optgroup = document.createElement('optgroup');
        optgroup.label = '🎨 自定义字体';
        sel.appendChild(optgroup);
      }

      // 添加选项（避免重复：按值判断）
      const existing = Array.from(optgroup.querySelectorAll('option')).some(opt => opt.value === normalizedValue);
      if (!existing) {
        const option = document.createElement('option');
        option.value = normalizedValue;    // 始终是 CSS 安全值
        option.textContent = displayText;  // 显示纯 family 名
        optgroup.appendChild(option);
      }
    });
  } catch (e) {
    console.warn('[custom-font] addCustomFontToSelects error', e);
  }
}

// 绑定导入按钮事件
if (btnImportCustomFont) {
  btnImportCustomFont.addEventListener('click', importCustomFont);
}

// 支持回车键快速导入
if (customFontNameInput) {
  customFontNameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      importCustomFont();
    }
  });
}

 // 比较当前主题的个性化设置是否已被修改（相对该主题默认派生基线）
function isCustomizationModified(theme) {
  const def = themeDefaults[theme] || {};
  // 构造派生默认基线：globalTextColor=secondaryColor、globalBarColor=primaryColor
  const expected = {
    fontFamily: def.fontFamily,
    primaryColor: def.primaryColor,
    secondaryColor: def.secondaryColor,
    radius: def.radius,
    dividerStyle: def.dividerStyle,
    bgMode: def.bgMode ?? 'theme'
    // 第三部分项目颜色不纳入“主题修改”判断
  };
  // 规范化比较，避免大小写与空白差异影响判断
  const norm = v => {
    if (v == null) return '';
    if (typeof v === 'string') return v.trim().toLowerCase();
    return String(v);
  };
  return Object.keys(expected).some(k => norm(customization[k]) !== norm(expected[k]));
}

// 应用主题默认值并同步控制面板显示
function applyThemeDefaults(theme) {
  const def = themeDefaults[theme] || {};
  if (!def) return;
  customization.fontFamily = def.fontFamily ?? customization.fontFamily;
  customization.primaryColor = def.primaryColor ?? customization.primaryColor;
  customization.secondaryColor = def.secondaryColor ?? customization.secondaryColor;
  customization.radius = def.radius ?? customization.radius;
  customization.dividerStyle = def.dividerStyle ?? customization.dividerStyle;
  customization.bgMode = def.bgMode ?? 'theme';
  customization.titleFontSize = def.titleFontSize ?? (customization.titleFontSize ?? 20);


  // 新增：标签/值字体与样式默认
  customization.globalLabelFontFamily = customization.globalLabelFontFamily || (def.fontFamily || customization.fontFamily);
  customization.globalValueFontFamily = customization.globalValueFontFamily || (def.fontFamily || customization.fontFamily);
  customization.globalLabelWeight = customization.globalLabelWeight || 500;
  customization.globalValueWeight = customization.globalValueWeight || 600;
  customization.globalLabelItalic = !!customization.globalLabelItalic;
  customization.globalValueItalic = !!customization.globalValueItalic;
  customization.globalLabelUppercase = !!customization.globalLabelUppercase;
  customization.globalValueUppercase = !!customization.globalValueUppercase;
  customization.globalLabelReflect = !!customization.globalLabelReflect;
  customization.globalValueReflect = !!customization.globalValueReflect;

  // 同步控件显示
  if (fontFamilySelect) fontFamilySelect.value = customization.fontFamily;
  if (primaryColorInput) primaryColorInput.value = customization.primaryColor;
  if (secondaryColorInput) secondaryColorInput.value = customization.secondaryColor;
  if (borderRadiusRange) borderRadiusRange.value = String(customization.radius);
  if (radiusValue) radiusValue.textContent = String(customization.radius);
  if (dividerStyleSelect) dividerStyleSelect.value = customization.dividerStyle;
  if (bgModeSelect) bgModeSelect.value = customization.bgMode;
  if (bgGradientStyleSelect) bgGradientStyleSelect.value = customization.bgGradientStyle || 'linear';
  if (bgGradientAngleRange) bgGradientAngleRange.value = String(customization.bgGradientAngle || 135);
  if (bgGradientAngleValue) bgGradientAngleValue.textContent = String(customization.bgGradientAngle || 135);
  if (bgGradientDirectionSelect) bgGradientDirectionSelect.value = customization.bgGradientDirection || 'to bottom right';

  // 第三部分项目颜色不随主题切换重置与同步

  // 同步第三部分的字体与样式控件
  if (globalLabelFontSelect) globalLabelFontSelect.value = customization.globalLabelFontFamily;
  if (globalValueFontSelect) globalValueFontSelect.value = customization.globalValueFontFamily;
  if (globalLabelWeightSelect) globalLabelWeightSelect.value = String(customization.globalLabelWeight);
  if (globalValueWeightSelect) globalValueWeightSelect.value = String(customization.globalValueWeight);
  if (globalLabelItalicCheckbox) globalLabelItalicCheckbox.checked = !!customization.globalLabelItalic;
  if (globalValueItalicCheckbox) globalValueItalicCheckbox.checked = !!customization.globalValueItalic;
  if (globalLabelUppercaseCheckbox) globalLabelUppercaseCheckbox.checked = !!customization.globalLabelUppercase;
  if (globalValueUppercaseCheckbox) globalValueUppercaseCheckbox.checked = !!customization.globalValueUppercase;
  if (globalLabelReflectCheckbox) globalLabelReflectCheckbox.checked = !!customization.globalLabelReflect;
  if (globalValueReflectCheckbox) globalValueReflectCheckbox.checked = !!customization.globalValueReflect;

  // 同步字号控件显示
  if (titleFontSizeRange) titleFontSizeRange.value = String(customization.titleFontSize || 20);
  if (titleFontSizeValue) titleFontSizeValue.textContent = String(customization.titleFontSize || 20);
  if (globalLabelFontSizeRange) globalLabelFontSizeRange.value = String(customization.globalLabelFontSize || 16);
  if (globalLabelFontSizeValue) globalLabelFontSizeValue.textContent = String(customization.globalLabelFontSize || 16);
  if (globalValueFontSizeRange) globalValueFontSizeRange.value = String(customization.globalValueFontSize || 16);
  if (globalValueFontSizeValue) globalValueFontSizeValue.textContent = String(customization.globalValueFontSize || 16);

  // 同步双列控件显示
  if (twoColLabelPctRange) twoColLabelPctRange.value = String(customization.twoColLabelPct ?? 30);
  if (twoColLabelPctValue) twoColLabelPctValue.textContent = String(customization.twoColLabelPct ?? 30);
  if (twoColGapRange) twoColGapRange.value = String(customization.twoColGap ?? 12);
  if (twoColGapValue) twoColGapValue.textContent = String(customization.twoColGap ?? 12);
  updateTwoColumnFieldsVisibility();

  // 同步 标签/值 比例控件显示
  if (labelValueLabelPctRange) labelValueLabelPctRange.value = String(customization.lvLabelPct ?? 30);
  if (labelValueLabelPctValue) labelValueLabelPctValue.textContent = String(customization.lvLabelPct ?? 30);
  if (labelValueValuePctValue) labelValueValuePctValue.textContent = String(100 - (customization.lvLabelPct ?? 30));

  // 同步 2 预览最大宽度控件
  if (statusbarWidthRange) statusbarWidthRange.value = String(customization.statusbarMaxWidth || 600);
  if (statusbarWidthValue) statusbarWidthValue.textContent = String(customization.statusbarMaxWidth || 600);

 
  // 诊断日志：主题默认应用后记录配色/字体/圆角/分割线/背景与对比度、动画强度
  try {
    const cont = contrastRatio(customization.primaryColor, customization.secondaryColor);
    const coh = computeCoherence({
      theme,
      primaryColor: customization.primaryColor,
      secondaryColor: customization.secondaryColor,
      letterSpacing: customization.letterSpacing,
      lineHeight: customization.lineHeight,
      animationType: currentAnimation
    });
    console.log('[diag] applyThemeDefaults', {
      theme,
      fontFamily: customization.fontFamily,
      primary: customization.primaryColor,
      secondary: customization.secondaryColor,
      radius: customization.radius,
      dividerStyle: customization.dividerStyle,
      bgMode: customization.bgMode,
      contrast: Number(cont.toFixed(2)),
      animation: currentAnimation,
      animSpeed,
      animIntensity,
      coherence: coh
    });
  } catch (e) { console.warn('[diag] applyThemeDefaults error', e); }

}

// 内置 SVG 图标（扩展 + 重做齿轮为中心对称）
(function(){
  // 覆写主题默认：图标策略
  const __old_applyThemeDefaults = applyThemeDefaults;
  applyThemeDefaults = function(theme){
    __old_applyThemeDefaults(theme);
    try {
      // 默认策略：蒸汽朋克启用内置齿轮并置左，其它主题默认不显示
      if (theme === 'theme-steampunk') {
        customization.iconMode = 'built-in';
        customization.iconBuiltin = customization.iconBuiltin || 'cog';
        customization.iconPosition = 'left';
        customization.iconSize = customization.iconSize || 28;
      } else {
        customization.iconMode = customization.iconMode || 'none';
        customization.iconPosition = (customization.iconMode === 'none') ? 'none' : (customization.iconPosition || 'left');
        customization.iconSize = customization.iconSize || 28;
      }
      if (iconModeSelect) iconModeSelect.value = customization.iconMode || 'none';
      if (iconBuiltinSelect) iconBuiltinSelect.value = customization.iconBuiltin || 'cog';
      if (iconPositionSelect) iconPositionSelect.value = customization.iconPosition || 'none';
      if (iconSizeRange) iconSizeRange.value = String(customization.iconSize || 28);
      if (iconSizeValue) iconSizeValue.textContent = String(customization.iconSize || 28);
      updateIconFieldsVisibility();
    } catch(_e) {}
  };
})();
function getBuiltinIconSVG(name, size = 24, color = customization.primaryColor) {
 const common = `width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"`;
 const svg = inner => `<svg ${common}>${inner}</svg>`;
 const p = d => svg(`<path d="${d}"></path>`);
 const poly = pts => svg(`<polygon points="${pts}"></polygon>`);
 const circ = (cx, cy, r) => `<circle cx="${cx}" cy="${cy}" r="${r}"></circle>`;

 // 程序化中心对称齿轮：12齿，外径≈10.2、内径≈7.2、孔径≈3.2，中心(12,12)
 function gear12() {
   const cx = 12, cy = 12;
   const teeth = 12;
   const rOuter = 10.2, rInner = 7.2, rBore = 3.2;
   const step = Math.PI * 2 / teeth;
   const aSide = step * 0.25;
   const pts = [];
   for (let i = 0; i < teeth; i++) {
     const base = i * step;
     const a0 = base;
     const a1 = base + aSide;
     const a2 = base + step / 2;
     const a3 = base + step - aSide;
     // 内谷 -> 外侧 -> 齿尖 -> 回落
     pts.push([cx + rInner * Math.cos(a0), cy + rInner * Math.sin(a0)]);
     pts.push([cx + rOuter * Math.cos(a1), cy + rOuter * Math.sin(a1)]);
     pts.push([cx + rOuter * Math.cos(a2), cy + rOuter * Math.sin(a2)]);
     pts.push([cx + rInner * Math.cos(a3), cy + rInner * Math.sin(a3)]);
   }
   const pointsStr = pts.map(([x, y]) => `${x.toFixed(2)} ${y.toFixed(2)}`).join(' ');
   const ring = `<polygon points="${pointsStr}"></polygon>`;
   const bore = circ(cx, cy, rBore);
   try { console.log('[icon] cog generated', { teeth, rOuter, rInner, rBore, cx, cy }); } catch (_e) {}
   return svg(ring + bore);
 }

 switch (name) {
   /* 基础 */
   case 'shield': return p("M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z");
   case 'star': return poly("12 2 15.09 8.26 22 9.27 17 13.97 18.18 21 12 17.27 5.82 21 7 13.97 2 9.27 8.91 8.26 12 2");
   case 'heart': return p("M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 1 0-7.78 7.78L12 21.23l8.84-8.84a5.5 5.5 0 0 0 0-7.78z");
   case 'leaf': return p("M11 21C5 21 3 15 3 15S5 3 21 3c0 16-12 18-12 18z");
   case 'cog': return gear12();

   /* 常用功能 */
   case 'search': return svg('<circle cx="11" cy="11" r="7"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line>');
   case 'refresh': return svg('<path d="M21 12a9 9 0 1 1-3.5-7.1"></path><polyline points="21 4 21 12 13 12"></polyline>');
   case 'download': return svg('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line>');
   case 'upload': return svg('<path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 14 12 9 17 14"></polyline><line x1="12" y1="9" x2="12" y2="21"></line>');
   case 'copy': return svg('<rect x="9" y="9" width="13" height="13" rx="2"></rect><rect x="2" y="2" width="13" height="13" rx="2"></rect>');
   case 'link': return svg('<path d="M10 13a5 5 0 0 0 7.07 0l3.54-3.54a5 5 0 0 0-7.07-7.07L12.95 4"></path><path d="M14 11a5 5 0 0 1-7.07 0L3.39 7.46a5 5 0 1 1 7.07-7.07L7.05 4"></path>');

   /* 用户/视图 */
   case 'user': return svg('<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>');
   case 'eye': return svg('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>');
   case 'eye-off': return svg('<path d="M17.94 17.94A10.94 10.94 0 0 1 12 20c-7 0-11-8-11-8a21.77 21.77 0 0 1 5.06-6.88"></path><path d="M9.9 4.24A10.94 10.94 0 0 1 12 4c7 0 11 8 11 8a21.77 21.77 0 0 1-3.34 5.06"></path><line x1="1" y1="1" x2="23" y2="23"></line>');

   /* 安全 */
   case 'lock': return svg('<rect x="5" y="11" width="14" height="10" rx="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path>');
   case 'unlock': return svg('<rect x="5" y="11" width="14" height="10" rx="2"></rect><path d="M7 11V9a5 5 0 0 1 9.5-2"></path>');

   /* 播放控制 */
   case 'play': return svg('<polygon points="5 3 19 12 5 21 5 3"></polygon>');
   case 'pause': return svg('<rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect>');
   case 'stop': return svg('<rect x="6" y="6" width="12" height="12"></rect>');
   case 'forward': return svg('<polygon points="5 4 13 12 5 20 5 4"></polygon><polygon points="13 4 21 12 13 20 13 4"></polygon>');
   case 'rewind': return svg('<polygon points="19 4 11 12 19 20 19 4"></polygon><polygon points="11 4 3 12 11 20 11 4"></polygon>');

   /* 通知/状态 */
   case 'bell': return svg('<path d="M18 8a6 6 0 0 0-12 0c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>');
   case 'info': return svg('<circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="8"></line>');
   case 'warning': return svg('<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12" y2="17"></line>');
   case 'check': return svg('<polyline points="20 6 9 17 4 12"></polyline>');
   case 'x': return svg('<line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line>');

   /* 时间/消息/地点 */
   case 'calendar': return svg('<rect x="3" y="4" width="18" height="18" rx="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>');
   case 'clock': return svg('<circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>');
   case 'chat': return svg('<path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>');
   case 'map-pin': return svg('<path d="M21 10c0 5-9 12-9 12S3 15 3 10a9 9 0 1 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle>');

   /* 其它 */
   case 'book': return svg('<path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M4 4v15.5A2.5 2.5 0 0 0 6.5 22H20V4"></path>');
   case 'music': return svg('<path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle>');
   case 'camera': return svg('<path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h3l2-3h8l2 3h3a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle>');
   case 'plus': return svg('<line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line>');
   case 'minus': return svg('<line x1="5" y1="12" x2="19" y2="12"></line>');

   default: return '';
 }
}


// 覆写：标题区渲染，注入图标与颜色
function makeIconHTML() {
  try {
    if (customization.iconMode === 'none') return '';
    const size = customization.iconSize || 28;
    let inner = '';
    if (customization.iconMode === 'built-in') {
      inner = getBuiltinIconSVG(customization.iconBuiltin || 'cog', size, customization.primaryColor);
    } else {
      const url = esc(customization.iconUrl || '');
      inner = `<img src="${url}" alt="" style="width:${size}px;height:${size}px;object-fit:contain;filter: drop-shadow(0 0 2px rgba(0,0,0,.3));">`;
    }
    return `
      <span class="st-header-icon" style="
        width:${size}px; height:${size}px; border-radius:50%;
        display:grid; place-items:center;
      ">
        ${inner}
      </span>
    `;
  } catch(_e){ return ''; }
}
function getHeaderHTML2(theme, title) {
  // 统一读取状态：优先使用 Ny.State.customization，其次使用本地 customization
  let __c = null;
  try { if (window.Ny && Ny.State && Ny.State.customization) __c = Ny.State.customization; } catch(_e){}
  __c = __c || customization || {};
  try { console.log('[dbg] getHeaderHTML2(inline): checking titleEnabled', { 
    hasNyState: !!(window.Ny && Ny.State && Ny.State.customization),
    titleEnabled: __c.titleEnabled,
    localCustomization: customization.titleEnabled,
    nyStateCustomization: (window.Ny && Ny.State && Ny.State.customization) ? Ny.State.customization.titleEnabled : 'N/A'
  }); } catch(_e){}
  if (__c && __c.titleEnabled === false) { try { console.log('[dbg] getHeaderHTML2(inline): title disabled, skip render', { titleEnabled: __c.titleEnabled }); } catch(_e){} return ''; }
  const t = esc(title || '角色状态');

  // 1) 计算标题样式（字号/字重/字形/大写/字距 + 颜色或渐变 + 下划线 + 特效）
  const themeColor = (customization.primaryColor || '#ffffff');
  const mode = (customization.titleColorMode || 'theme');

  const titleStyleParts = [
    `font-size:${customization.titleFontSize || 20}px`,
    `font-weight:${parseInt(customization.titleWeight || 500, 10) || 500}`,
    customization.titleItalic ? 'font-style:italic' : '',
    customization.titleUppercase ? 'text-transform:uppercase' : '',
    (typeof customization.titleLetterSpacing === 'number' ? `letter-spacing:${customization.titleLetterSpacing}em` : '')
  ].filter(Boolean);

  if (mode === 'solid') {
    const solid = (customization.titleColorSolid && customization.titleColorSolid.trim()) ? customization.titleColorSolid.trim() : themeColor;
    titleStyleParts.push(`color:${solid}`);
  } else if (mode === 'gradient') {
    const a = (customization.titleGradStart && customization.titleGradStart.trim()) ? customization.titleGradStart.trim() : (customization.primaryColor || themeColor);
    const b = (customization.titleGradEnd && customization.titleGradEnd.trim()) ? customization.titleGradEnd.trim() : (customization.secondaryColor || themeColor);
    const ang = Number(customization.titleGradAngle ?? 0) || 0;
    titleStyleParts.push(
      `background:linear-gradient(${ang}deg, ${a}, ${b})`,
      `-webkit-background-clip:text`,
      `background-clip:text`,
      `color:transparent`
    );
  } else {
    titleStyleParts.push(`color:${themeColor}`);
  }

  // 下划线（仅当样式非 none）
  if ((customization.titleUnderlineStyle || 'none') !== 'none') {
    const uStyle = customization.titleUnderlineStyle || 'solid';
    const uColor = (customization.titleUnderlineColor && customization.titleUnderlineColor.trim()) ? customization.titleUnderlineColor.trim() : themeColor;
    const uThick = Math.max(1, parseInt(customization.titleUnderlineThickness || 2, 10) || 2);
    const uOffset = Math.max(0, parseInt(customization.titleUnderlineOffset || 4, 10) || 4);
    titleStyleParts.push(
      'text-decoration-line:underline',
      `text-decoration-style:${uStyle}`,
      `text-decoration-color:${uColor}`,
      `text-decoration-thickness:${uThick}px`,
      `text-underline-offset:${uOffset}px`
    );
  }

  // 特效：光晕 + 阴影（text-shadow 叠加）
  const ts = [];
  if (customization.titleEffectGlow) {
    const intensity = Math.max(0, Math.min(1, Number(customization.titleGlowIntensity || 0.5)));
    const glowColor = (mode === 'solid' && customization.titleColorSolid) ? customization.titleColorSolid : themeColor;
    const r1 = (6 + 10 * intensity).toFixed(1);
    const r2 = (12 + 18 * intensity).toFixed(1);
    ts.push(`0 0 ${r1}px ${glowColor}`, `0 0 ${r2}px ${glowColor}`);
  }
  if (customization.titleEffectShadow) {
    const s = Math.max(0, Math.min(1, Number(customization.titleShadowStrength || 0.3)));
    const y = (1 + 3 * s).toFixed(1);
    const blur = (2 + 6 * s).toFixed(1);
    ts.push(`0 ${y}px ${blur}px rgba(0,0,0,${0.45 + 0.3*s})`);
  }
  if (ts.length) titleStyleParts.push(`text-shadow:${ts.join(',')}`);

  // 标题文本内联 span
  const titleInner = (theme === 'theme-cyber-grid')
    ? `<span class="st-title" style="${titleStyleParts.join('; ')}">[ ${t} ]</span>`
    : `<span class="st-title" style="${titleStyleParts.join('; ')}">${t}</span>`;

  // 徽章包裹（可选）
  let titleSpan = titleInner;
  if (customization.titleBadgeEnabled) {
    const bColor = (customization.titleBadgeColor && customization.titleBadgeColor.trim()) ? customization.titleBadgeColor.trim() : '#000000';
    const badgeStyle = [
      `background: color-mix(in srgb, ${bColor} 30%, transparent)`,
      `padding:4px 8px`,
      `border-radius:8px`,
      'display:inline-block'
    ].join('; ');
    titleSpan = `<span class="st-title-badge" style="${badgeStyle}">${titleInner}</span>`;
  }

  // 2) 标题容器（高度/内边距/对齐/间距）
  const mh = Math.max(0, Number(customization.headerMinHeight || 0)) || 0;
  const py = Math.max(0, Number(customization.headerPaddingY || 0)) || 0;
  const gapEnabled = !!customization.titleGapEnabled;
  const gapPx = Math.max(0, Number(customization.titleGap || 10)) || 10;
  const align = customization.headerAlign || 'inherit';
  let justify = '';
  if (align === 'left') justify = 'flex-start';
  else if (align === 'center') justify = 'center';
  else if (align === 'right') justify = 'flex-end';

  const headerStyleParts = [];
  if (mh > 0) headerStyleParts.push(`min-height:${mh}px`);
  if (py > 0) headerStyleParts.push(`padding-block:${py}px`);
  if (gapEnabled) headerStyleParts.push(`gap:${gapPx}px`);
  if (justify) headerStyleParts.push(`justify-content:${justify}`);

  // 3) 图标注入与位置
  const iconHTML = makeIconHTML();
  // 默认策略：若开启图标但位置为 none 或未定义，则置左
  const pos = (customization.iconMode !== 'none' && (customization.iconPosition === 'none' || !customization.iconPosition))
    ? 'left'
    : (customization.iconPosition || 'none');

  let inner;
  if (pos === 'left') {
    inner = `${iconHTML}${titleSpan}`;
  } else if (pos === 'right') {
    inner = `${titleSpan}${iconHTML}`;
  } else {
    inner = `${titleSpan}`;
  }

  const headerStyle = headerStyleParts.join('; ');
  return `<div class="st-header" style="${headerStyle}">${inner}</div>`;
}

// 工具：生成分割线 HTML（优先使用第三部分分割线颜色）
function dividerHTML() {
  // 优先委托到 Ny.Render.dividerHTML，保持与预览一致
  try {
    if (window.Ny && Ny.Render && typeof Ny.Render.dividerHTML === 'function') {
      return Ny.Render.dividerHTML(customization);
    }
  } catch (_e) {}
  // 回退：保持现有视觉
  const dc = (customization.section2DividerColor && customization.section2DividerColor.trim().length > 0)
    ? customization.section2DividerColor
    : customization.primaryColor;
  if (customization.dividerStyle === 'dashed') {
    return `<hr style="border:none;border-top:1px dashed ${dc};height:0;opacity:.9;">`;
  }
  if (customization.dividerStyle === 'gradient') {
    return `<hr style="border:none;height:1px; background-image:linear-gradient(to right, transparent, ${dc}, transparent);">`;
  }
  return `<hr style="border:none;height:1px;background:${dc};">`;
}

// 覆写：内容项渲染，适配布局与颜色与字体样式 + 进度条风格/动画
function buildItemsHTML(list, theme) {
  const pc = customization.primaryColor;
  const sc = customization.secondaryColor;
  const layout = customization.layout;

  // 第三部分项目颜色（仅作用于标签/值与滑条填充）
  const s2Label = customization.section2LabelColor && customization.section2LabelColor.trim().length > 0 ? customization.section2LabelColor : '';
  const s2Value = customization.section2ValueColor && customization.section2ValueColor.trim().length > 0 ? customization.section2ValueColor : '';
  const s2Bar   = customization.section2BarColor   && customization.section2BarColor.trim().length   > 0 ? customization.section2BarColor   : '';

// 组合样式片段工具
  const styleJoin = parts => parts.filter(Boolean).join('; ');

  const labelFontFamily = customization.globalLabelFontFamily || customization.fontFamily;
  const valueFontFamily = customization.globalValueFontFamily || customization.fontFamily;
  const labelWeight = customization.globalLabelWeight || 500;
  const valueWeight = customization.globalValueWeight || 600;
  const labelFontSize = customization.globalLabelFontSize || 0;
  const valueFontSize = customization.globalValueFontSize || 0;
  const labelItalic = customization.globalLabelItalic ? 'font-style:italic' : '';
  const valueItalic = customization.globalValueItalic ? 'font-style:italic' : '';
  const labelUpper = customization.globalLabelUppercase ? 'text-transform:uppercase' : '';
  const valueUpper = customization.globalValueUppercase ? 'text-transform:uppercase' : '';
  const labelReflect = customization.globalLabelReflect ? '-webkit-box-reflect: below 0 linear-gradient(transparent, rgba(255,255,255,.15))' : '';
  const valueReflect = customization.globalValueReflect ? '-webkit-box-reflect: below 0 linear-gradient(transparent, rgba(255,255,255,.15))' : '';
  const reflectInlineBlock = 'display:inline-block';
  // 长文字特效与行距（已改为每项独立设置，按每个项目的 ltEffect/ltLineHeight 计算）

  // 新增：进度条风格与动画
  const barStyle = customization.barStyle || 'normal';
  const barAnimation = customization.barAnimation || 'none';
  const barClassFromStyle = () => {
    switch (barStyle) {
      case 'glow': return 'pf-glow';
      case 'striped': return 'pf-striped';
      case 'glass': return 'pf-glass';
      default: return '';
    }
  };
  const barAnimClass = barAnimation === 'grow' ? 'pf-anim-grow' : '';

  // 旧版角色行布局（已移除；仅保留历史占位说明）
  if (false) { /* removed legacy role layout */
    const rows = [];
    let row = [];
    list.forEach(it => {
      if (it.type === 'row') {
        if (row.length) { rows.push(row); row = []; }
      } else if (it.type === 'divider') {
        if (row.length) { rows.push(row); row = []; }
        rows.push(['__HR__']);
      } else {
        row.push(it);
        if (row.length === 3) { rows.push(row); row = []; }
      }
    });
    if (row.length) rows.push(row);

    return rows.map(r => {
      if (r.length === 1 && r[0] === '__HR__') return dividerHTML();
      const itemsHTML = r.map(it => {
        if (it.type === 'text') {
          const labelColor = s2Label || it.labelColor || sc;
          const valueColor = s2Value || it.valueColor || pc;
          const lblStyle = styleJoin([
            `color:${labelColor}`,
            `font-family:${labelFontFamily}`,
            `font-weight:${labelWeight}`,
            labelFontSize ? `font-size:${labelFontSize}px` : '',
            labelItalic,
            labelUpper,
            customization.globalLabelReflect ? reflectInlineBlock : '',
            labelReflect
          ]);
          const valStyle = styleJoin([
            `color:${valueColor}`,
            `font-family:${valueFontFamily}`,
            `font-weight:${valueWeight}`,
            valueFontSize ? `font-size:${valueFontSize}px` : '',
            valueItalic,
            valueUpper,
            customization.globalValueReflect ? reflectInlineBlock : '',
            valueReflect
          ]);
          return `
            <div class="st-item">
              <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
              <div class="st-value st-text" style="${valStyle}">${esc(it.value || '')}</div>
            </div>
          `;
        }
        if (it.type === 'bar') {
          const p = clamp(parseInt(it.percent ?? 0, 10) || 0, 0, 100);
          const labelColor = s2Label || it.labelColor || sc;
          const fillColor  = s2Bar   || it.barColor || '';
          const classList = ['st-progress-bar-fill'];
          const styleParts = [];
          if (barAnimClass) classList.push(barAnimClass);
          const styleWidth = barAnimClass ? `width: var(--target); --target: ${p}%` : `width: ${p}%`;
          styleParts.push(styleWidth);
          if (fillColor) {
            styleParts.push(`background: ${esc(fillColor)}`);
            styleParts.push(`--bar-color: ${esc(fillColor)}`);
          } else {
            styleParts.push(`background: linear-gradient(90deg, ${pc}, ${sc})`);
            styleParts.push(`--bar-color: ${pc}`);
          }
          const fillStyle = `style="${styleParts.join('; ')}"`;
          const extraStyleClass = barClassFromStyle();
          if (extraStyleClass) classList.push(extraStyleClass);

          const lblStyle = styleJoin([
            `color:${labelColor}`,
            `font-family:${labelFontFamily}`,
            `font-weight:${labelWeight}`,
            labelFontSize ? `font-size:${labelFontSize}px` : '',
            labelItalic,
            labelUpper,
            customization.globalLabelReflect ? reflectInlineBlock : '',
            labelReflect
          ]);
          // 值容器样式（用于倒影/大写等对数值文本也生效）
          const valStyle = styleJoin([
            `font-family:${valueFontFamily}`,
            `font-weight:${valueWeight}`,
            valueFontSize ? `font-size:${valueFontSize}px` : '',
            valueItalic,
            valueUpper,
            customization.globalValueReflect ? reflectInlineBlock : '',
            valueReflect
          ]);
          return `
            <div class="st-item">
              <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
              <div class="st-value" style="width: clamp(120px, 40vw, calc(var(--_vb-base-max,160px) * var(--vb-width-pct,100) / 100)); transform: translateX(calc(1% * var(--vb-offset-pct, 0))); ${valStyle}">
                <div class="st-progress-bar" onclick="(function(bar){var s=bar.querySelector('.st-progress-percent');var show=!(bar.classList&amp;&amp;bar.classList.contains('show-percent'));if(bar.classList)bar.classList.toggle('show-percent',show);if(s){s.style.opacity=show?'1':'0';}})(this)">
                  <div class="${classList.join(' ')}" ${fillStyle}></div><span class="st-progress-percent" style="position:absolute;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;pointer-events:none;opacity:0;transition:opacity .3s;--pct:${p}%;">${p}%</span>
                </div>
              </div>
            </div>
          `;
        }
        return '';
      }).join('');
      // 竖向分隔线颜色仍跟随主题主色
      return `<div class="st-row" style="--rs-sep-color:${customization.primaryColor};">${itemsHTML}</div>`;
    }).join('');
  }

  /* 蓝辉分割（role-rows）布局已移除 */

  // 原逻辑（保留）—支持全局颜色与字体样式覆盖（未设置时仍用主/辅色或每项自定义）+ 进度条风格/动画
  return list.map(it => {
    if (it.type === 'divider') return dividerHTML();

    if (it.type === 'text') {
      const labelColor = s2Label || it.labelColor || sc;
      const valueColor = s2Value || it.valueColor || pc;
      const lblStyle = styleJoin([
        `color:${labelColor}`,
        `font-family:${labelFontFamily}`,
        `font-weight:${labelWeight}`,
        labelFontSize ? `font-size:${labelFontSize}px` : '',
        labelItalic,
        labelUpper,
        customization.globalLabelReflect ? reflectInlineBlock : '',
        labelReflect
      ]);
      const valStyleBase = styleJoin([
        `color:${valueColor}`,
        `font-family:${valueFontFamily}`,
        `font-weight:${valueWeight}`,
        valueFontSize ? `font-size:${valueFontSize}px` : '',
        valueItalic,
        valueUpper,
        customization.globalValueReflect ? reflectInlineBlock : '',
        valueReflect
      ]);
      // 双列：每项自身使用 30/70 网格，左右均左对齐，文本可自动换行
      if (layout === 'two-column') {
        return `
          <div class="st-item" style="display:grid;grid-template-columns:var(--two-col-label,30%) var(--two-col-value,70%);column-gap:var(--two-col-gap,12px);align-items:start;">
            <div class="st-label" style="${lblStyle}; text-align:left;">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:left;">${esc(it.value || '')}</div>
          </div>
        `;
      }
      if (layout === 'stacked' || layout === 'center') {
        const align = (layout === 'center') ? 'center' : 'flex-start';
        const valueTextAlign = (layout === 'center') ? 'center' : 'right';
        return `
          <div class="st-item" style="display:flex;flex-direction:column;align-items:${align};gap:4px;">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:${valueTextAlign};">${esc(it.value || '')}</div>
          </div>
        `;
      } else if (layout === 'label-left') {
        // 标签/值比例网格（3:7 可调），容器不写 display 样式，交由 CSS 控制
        return `
          <div class="st-item">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:right;">${esc(it.value || '')}</div>
          </div>
        `;
      } else {
        const dir = (layout === 'reverse') ? 'row-reverse' : 'row';
        const valueTextAlign = (layout === 'reverse') ? 'left' : 'right';
        return `
          <div class="st-item" style="display:flex;flex-direction:${dir};align-items:center;justify-content:space-between;">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-text" style="${valStyleBase}; text-align:${valueTextAlign};">${esc(it.value || '')}</div>
          </div>
        `;
      }
    }
    if (it.type === 'longtext') {
      const labelColor = s2Label || it.labelColor || sc;
      const valueColor = s2Value || it.valueColor || pc;
      const lblStyle = styleJoin([
        `color:${labelColor}`,
        `font-family:${labelFontFamily}`,
        `font-weight:${labelWeight}`,
        labelFontSize ? `font-size:${labelFontSize}px` : '',
        labelItalic,
        labelUpper,
        customization.globalLabelReflect ? reflectInlineBlock : '',
        labelReflect
      ]);
      const valStyle = styleJoin([
        `color:${valueColor}`,
        `font-family:${valueFontFamily}`,
        `font-weight:${valueWeight}`,
        valueFontSize ? `font-size:${valueFontSize}px` : '',
        valueItalic,
        valueUpper,
        customization.globalValueReflect ? reflectInlineBlock : '',
        valueReflect
      ]);
      const spanAll = (customization.layout === 'two-column') ? 'grid-column: 1 / -1;' : '';
      const eff = it.ltEffect || 'none';
      const lh = (typeof it.ltLineHeight === 'number' ? it.ltLineHeight : 1.6);
      const effClass = (eff === 'fade' ? ' anim-fade-in' : (eff === 'slide' ? ' anim-slide-up' : ''));
      let effAttr = '';
      if (eff === 'typewriter') {
        const spd = isFinite(it.ltTwSpeedMs) ? Math.max(5, Math.min(200, Number(it.ltTwSpeedMs))) : 18;
        const dly = isFinite(it.ltTwDelayMs) ? Math.max(0, Number(it.ltTwDelayMs)) : 0;
        const caret = (it.ltTwCaret !== false) ? '1' : '0';
        effAttr = ` data-effect="typewriter" data-tw-speed="${spd}" data-tw-delay="${dly}" data-tw-caret="${caret}"`;
      }

      const indent = Math.max(0, Number(it.ltFirstIndentPx || 0)) || 0;
      const pTop = Math.max(0, Number(it.ltPadTopPx || 0)) || 0;
      const pRight = Math.max(0, Number(it.ltPadRightPx || 0)) || 0;
      const pBottom = Math.max(0, Number(it.ltPadBottomPx || 0)) || 0;
      const pLeft = Math.max(0, Number(it.ltPadLeftPx || 0)) || 0;
      const skip = false; // 预览与生成保持一致：不空出首行
      const padTopCss = `${pTop}px`;
      const dataSkip = '';

      // 段落分割与渲染
      const rawText = it.value || '';
      let paragraphs = rawText.split('\n');
      // 去除首尾空行，避免出现无效的额外空白
      while (paragraphs.length && paragraphs[0].trim() === '') paragraphs.shift();
      while (paragraphs.length && paragraphs[paragraphs.length - 1].trim() === '') paragraphs.pop();
      
      let contentHTML = '';
      
      if (eff === 'typewriter') {
        // 打字机效果：预先生成段落HTML，运行时逐段播放
        const spd = isFinite(it.ltTwSpeedMs) ? Math.max(5, Math.min(200, Number(it.ltTwSpeedMs))) : 18;
        const dly = isFinite(it.ltTwDelayMs) ? Math.max(0, Number(it.ltTwDelayMs)) : 0;
        const caret = (it.ltTwCaret !== false) ? '1' : '0';
        effAttr = ` data-effect="typewriter" data-tw-speed="${spd}" data-tw-delay="${dly}" data-tw-caret="${caret}"`;
        
        // 为打字机效果生成段落HTML，每段独立缩进
        contentHTML = paragraphs.map((para, idx) => {
          const pStyle = `margin:0; padding:0; text-indent:${indent}px;`;
          return `<p style="${pStyle}">${esc(para)}</p>`;
        }).join('');
        
        return `
          <div class="st-item" style="display:block; ${spanAll}">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-longtext${effClass}"${effAttr}${dataSkip} style="${valStyle}; line-height:${lh}; white-space:normal; margin-top:6px; word-break:break-word; overflow-wrap:anywhere; background: rgba(255,255,255,.05); border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.08), 0 1px 8px rgba(0,0,0,.18); padding-top:${padTopCss}; padding-right:${pRight}px; padding-bottom:${pBottom}px; padding-left:${pLeft}px;">
              ${contentHTML}
            </div>
          </div>
        `;
      } else {
        // 普通效果（fade/slide/none）：按段落分割渲染
        contentHTML = paragraphs.map((para, idx) => {
          const pStyle = `margin:0; padding:0; text-indent:${indent}px;`;
          return `<p style="${pStyle}">${esc(para)}</p>`;
        }).join('');
        
        return `
          <div class="st-item" style="display:block; ${spanAll}">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value st-longtext${effClass}" style="${valStyle}; line-height:${lh}; white-space:normal; margin-top:6px; word-break:break-word; overflow-wrap:anywhere; background: rgba(255,255,255,.05); border-radius:8px; box-shadow: inset 0 0 10px rgba(0,0,0,.08), 0 1px 8px rgba(0,0,0,.18); padding-top:${padTopCss}; padding-right:${pRight}px; padding-bottom:${pBottom}px; padding-left:${pLeft}px;">
              ${contentHTML}
            </div>
          </div>
        `;
      }
    }

    if (it.type === 'bar') {
      const p = clamp(parseInt(it.percent ?? 0, 10) || 0, 0, 100);
      const labelColor = s2Label || it.labelColor || sc;
      const fillColor  = s2Bar   || it.barColor || ''; // 留空时使用各主题 CSS 默认
      const classList = ['st-progress-bar-fill'];
      const styleParts = [];
      if (barAnimClass) classList.push(barAnimClass);
      const styleWidth = barAnimClass ? `width: var(--target); --target: ${p}%` : `width: ${p}%`;
      styleParts.push(styleWidth);
      if (fillColor) {
        styleParts.push(`background: ${esc(fillColor)}`);
        styleParts.push(`--bar-color: ${esc(fillColor)}`);
      } else {
        styleParts.push(`background: linear-gradient(90deg, ${pc}, ${sc})`);
        styleParts.push(`--bar-color: ${pc}`);
      }
      const fillStyle = `style="${styleParts.join('; ')}"`;
      const extraStyleClass = barClassFromStyle();
      if (extraStyleClass) classList.push(extraStyleClass);

      const lblStyle = styleJoin([
        `color:${labelColor}`,
        `font-family:${labelFontFamily}`,
        `font-weight:${labelWeight}`,
        labelFontSize ? `font-size:${labelFontSize}px` : '',
        labelItalic,
        labelUpper,
        customization.globalLabelReflect ? reflectInlineBlock : '',
        labelReflect
      ]);
      const valStyle = styleJoin([
        `font-family:${valueFontFamily}`,
        `font-weight:${valueWeight}`,
        valueFontSize ? `font-size:${valueFontSize}px` : '',
        valueItalic,
        valueUpper,
        customization.globalValueReflect ? reflectInlineBlock : '',
        valueReflect
      ]);

      if (layout === 'stacked' || layout === 'center') {
        const align = layout === 'center' ? 'center' : 'flex-start';
        const valueWidth = '160px';
        return `
          <div class="st-item" style="display:flex;flex-direction:column;align-items:${align};gap:4px;">
            <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
            <div class="st-value" style="width: clamp(120px, 40vw, calc(var(--_vb-base-max,160px) * var(--vb-width-pct,100) / 100)); transform: translateX(calc(1% * var(--vb-offset-pct, 0))); ${valStyle}">
              <div class="st-progress-bar" onclick="(function(bar){var s=bar.querySelector('.st-progress-percent');var show=!(bar.classList&amp;&amp;bar.classList.contains('show-percent'));if(bar.classList)bar.classList.toggle('show-percent',show);if(s){s.style.opacity=show?'1':'0';}})(this)">
                <div class="${classList.join(' ')}" ${fillStyle}></div><span class="st-progress-percent" style="position:absolute;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;pointer-events:none;opacity:0;transition:opacity .3s;--pct:${p}%;">${p}%</span>
              </div>
            </div>
          </div>
        `;
      }

      return `
        <div class="st-item" style="display:flex;align-items:center;justify-content:space-between;">
          <div class="st-label" style="${lblStyle}">${esc(it.label || '')}</div>
          <div class="st-value" style="width: clamp(120px, 40vw, calc(var(--_vb-base-max,160px) * var(--vb-width-pct,100) / 100)); transform: translateX(calc(1% * var(--vb-offset-pct, 0))); ${valStyle}">
            <div class="st-progress-bar" onclick="(function(bar){var s=bar.querySelector('.st-progress-percent');var show=!(bar.classList&amp;&amp;bar.classList.contains('show-percent'));if(bar.classList)bar.classList.toggle('show-percent',show);if(s){s.style.opacity=show?'1':'0';}})(this)">
              <div class="${classList.join(' ')}" ${fillStyle}></div><span class="st-progress-percent" style="position:absolute;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;pointer-events:none;opacity:0;transition:opacity .3s;--pct:${p}%;">${p}%</span>
            </div>
          </div>
        </div>
      `;
    }
    return '';
  }).join('');
}

/* 新增：渲染粒子叠加层（星星/碎屑/花瓣） */
function renderFxLayers(wrapperEl){
  try {
    if (!wrapperEl) return;
    // 清理旧层
    wrapperEl.querySelectorAll('.fx-layer').forEach(n=>n.remove());
    const rect = wrapperEl.getBoundingClientRect();
    const W = rect.width || 600;
    const H = rect.height || 200;

    // 工具
    const rand = (min, max) => Math.random() * (max - min) + min;
    const randInt = (min, max) => Math.floor(rand(min, max + 1));
    const px = v => v + 'px';
    const pct = v => v + '%';

    // 星星
    if (customization.starEnabled) {
      const layer = document.createElement('div');
      layer.className = 'fx-layer fx-stars';
      layer.style.setProperty('--star-color', customization.starColor || '#ffffff');
      layer.style.setProperty('--star-speed', (customization.starFrequency || 2) + 's');
      const count = clamp(parseInt(customization.starDensity||0,10)||0, 0, 1000);
      for (let i=0; i<count; i++){
        const e = document.createElement('span');
        e.className = 'fx-star';
        const size = rand(1, 2.5);
        const x = rand(0, 100);
        const y = rand(0, 100);
        e.style.width = px(size);
        e.style.height = px(size);
        e.style.left = pct(x);
        e.style.top = pct(y);
        e.style.animationDelay = rand(0, customization.starFrequency||2) + 's';
        layer.appendChild(e);
      }
      wrapperEl.appendChild(layer);
    }

    // 闪光碎屑
    if (customization.sparkleEnabled) {
      const layer = document.createElement('div');
      layer.className = 'fx-layer fx-sparkles';
      layer.style.setProperty('--sparkle-color', customization.sparkleColor || '#ffd966');
      const speed = customization.sparkleFrequency || 2;
      const dir = customization.sparkleDirection === 'up' ? 'up' : 'down';
      const count = clamp(parseInt(customization.sparkleDensity||0,10)||0, 0, 1000);
      for (let i=0; i<count; i++){
        const e = document.createElement('span');
        e.className = 'fx-sparkle' + (customization.sparkleGlow ? ' glow' : '');
        const size = rand(2, 3.5);
        const x = rand(0, 100);
        const delay = rand(0, speed);
        e.style.width = px(size);
        e.style.height = px(size);
        e.style.left = pct(x);
        e.style.top = dir === 'down' ? '-5%' : '105%';
        e.style.animationDuration = speed + 's';
        e.style.animationName = dir === 'down' ? 'sparkleDown' : 'sparkleUp';
        e.style.animationDelay = delay + 's';
        e.style.animationIterationCount = 'infinite';
        e.style.animationTimingFunction = 'linear';
        layer.appendChild(e);
      }
      wrapperEl.appendChild(layer);
    }

    // 花瓣飘落
    if (customization.petalEnabled) {
      const layer = document.createElement('div');
      layer.className = 'fx-layer fx-petals';
      const speed = customization.petalFrequency || 5;
      const count = clamp(parseInt(customization.petalDensity||0,10)||0, 0, 1000);
      for (let i=0; i<count; i++){
        const e = document.createElement('span');
        e.className = 'fx-petal';
        const x = rand(0, 100);
        const delay = rand(0, speed);
        const rot = rand(-30, 30);
        e.style.left = pct(x);
        e.style.top = '-10%';
        e.style.animationDuration = speed + 's';
        e.style.animationDelay = delay + 's';
        e.style.transform = 'rotate(' + rot + 'deg)';
        // 图标
        if (customization.petalIconMode === 'url' && customization.petalIconUrl){
          const img = document.createElement('img');
          img.src = customization.petalIconUrl;
          img.alt = '';
          e.appendChild(img);
        } else {
          const svg = getBuiltinIconSVG(customization.petalIconBuiltin || 'leaf', 18, customization.secondaryColor || '#ffffff');
          e.innerHTML = svg;
        }
        layer.appendChild(e);
      }
      wrapperEl.appendChild(layer);
    }
    console.log('[fx] renderFxLayers done', {
      starEnabled: customization.starEnabled, sparkleEnabled: customization.sparkleEnabled, petalEnabled: customization.petalEnabled
    });
  } catch (err) {
    console.warn('[fx] renderFxLayers error', err);
  }
}
 
// 多图层背景与组件：构建/拖拽/编辑
function buildBgLayersHTML(layers){
  try{
    const L = Array.isArray(layers) ? layers : [];
    if (!L.length) return '';
    const html = L.map(l => {
      const op = isFinite(l?.opacity) ? Math.max(0, Math.min(1, Number(l.opacity))) : 1;
      if (l?.type === 'color') {
        const color = esc(l.color || '#000000');
        return `<div class="bg-layer" style="background:${color};opacity:${op};"></div>`;
      }
      if (l?.type === 'gradient') {
        const style = String(l.style || 'linear');
        const angle = Number(l.angle ?? 135) || 135;
        const dir = String(l.direction || 'to bottom right');
        const start = esc(l.start || customization.primaryColor || '#6a717c');
        const end = esc(l.end || customization.secondaryColor || '#97aec8');
        let grad;
        if (style === 'linear') {
          // 线性：角度优先
          grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
        } else if (style === 'radial') {
          // 径向：at 位置
          const pos = dir.replace(/^to\s+/, '');
          grad = `radial-gradient(at ${pos}, ${start}, ${end})`;
        } else if (style === 'conic') {
          // 锥形：from 角度 + at 位置
          const pos = dir.replace(/^to\s+/, '');
          grad = `conic-gradient(from ${angle}deg at ${pos}, ${start}, ${end})`;
        } else {
          grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
        }
        return `<div class="bg-layer" style="background:${grad};opacity:${op};"></div>`;
      }
      const src = esc(l?.src || '');
      const size = esc(l?.size || 'cover');
      const pos = esc(l?.position || 'center');
      const rep = esc(l?.repeat || 'no-repeat');
      return `<div class="bg-layer" style="background-image:url('${src}');background-size:${size};background-position:${pos};background-repeat:${rep};opacity:${op};"></div>`;
    }).join('');
    return `<div class="bg-layers">${html}</div>`;
  }catch(_e){ return ''; }
}
function buildBgComponentsHTML(components){
  try{
    const C = Array.isArray(components) ? components : [];
    if (!C.length) return '';
    const html = C.filter(c => c && c.visible !== false).map(c => {
      const id = esc(c.id || genId());
      const src = esc(c.src || '');
      const x = isFinite(c.x) ? Math.max(0, Math.min(100, Number(c.x))) : 50;
      const y = isFinite(c.y) ? Math.max(0, Math.min(100, Number(c.y))) : 50;
      const w = isFinite(c.w) ? Math.max(2, Math.min(100, Number(c.w))) : 20;
      const op = isFinite(c.opacity) ? Math.max(0, Math.min(1, Number(c.opacity))) : 1;
      return `<img class="bg-comp" data-id="${id}" src="${src}" alt="" style="left:${x}%;top:${y}%;width:${w}%;opacity:${op};">`;
    }).join('');
    return `<div class="bg-components-layer">${html}</div>`;
  }catch(_e){ return ''; }
}
function setupBgComponentDrag(wrapper){
  try{
    const layer = wrapper?.querySelector('.bg-components-layer');
    if (!layer) return;
    let dragging = null;
    const getRect = () => wrapper.getBoundingClientRect();
    
    // 统一的坐标提取（支持鼠标和触摸）
    function getCoords(e){
      if (e.touches && e.touches[0]) {
        return { x: e.touches[0].clientX, y: e.touches[0].clientY };
      }
      return { x: e.clientX, y: e.clientY };
    }
    
    function onDown(e){
      if (!customization.bgCompDrag) return;
      const el = e.target.closest('.bg-comp');
      if (!el) return;
      const id = el.getAttribute('data-id');
      const obj = (customization.bgComponents || []).find(c => c.id === id);
      if (!obj || obj.locked) return;
      e.preventDefault();
      el.classList.add('dragging');
      const rect = getRect();
      const coords = getCoords(e);
      const startX = coords.x, startY = coords.y;
      const startLeft = (isFinite(obj.x) ? obj.x : 50);
      const startTop = (isFinite(obj.y) ? obj.y : 50);
      dragging = { el, id, obj, rect, startX, startY, startLeft, startTop };
      
      // 同时监听鼠标和触摸事件
      document.addEventListener('mousemove', onMove);
      document.addEventListener('touchmove', onMove, { passive: false });
      document.addEventListener('mouseup', onUp, { once: true });
      document.addEventListener('touchend', onUp, { once: true });
      document.addEventListener('touchcancel', onUp, { once: true });
    }
    
    function onMove(e){
      if (!dragging) return;
      e.preventDefault(); // 防止移动端滚动
      const { rect, startX, startY, startLeft, startTop, obj, el } = dragging;
      const coords = getCoords(e);
      const dx = ((coords.x - startX) / rect.width) * 100;
      const dy = ((coords.y - startY) / rect.height) * 100;
      obj.x = Math.max(0, Math.min(100, startLeft + dx));
      obj.y = Math.max(0, Math.min(100, startTop + dy));
      el.style.left = obj.x + '%';
      el.style.top = obj.y + '%';
    }
    
    function onUp(){
      if (dragging?.el) dragging.el.classList.remove('dragging');
      dragging = null;
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('touchmove', onMove);
      document.removeEventListener('touchend', onUp);
      document.removeEventListener('touchcancel', onUp);
    }
    
    // 同时监听鼠标和触摸开始事件
    layer.addEventListener('mousedown', onDown);
    layer.addEventListener('touchstart', onDown, { passive: false });
  }catch(_e){}
}
function ensureBgDock(){
  try{
    const pv = document.querySelector('.preview-panel');
    if (!pv) return;
    let dock = pv.querySelector('.bg-dock');
    if (!dock){
      dock = document.createElement('div');
      dock.className = 'bg-dock';
      pv.appendChild(dock);
    }
    if (customization.bgMode === 'layers' && customization.bgCompDrag){
      dock.textContent = '拖动模式：开启（在预览中拖动组件）';
      dock.classList.add('show');
    }else{
      dock.classList.remove('show');
    }
  }catch(_e){}
}
function renderBgLayersEditor(){
  try{
    if (!bgLayersList) return;
    const layers = customization.bgLayers || [];
    bgLayersList.innerHTML = layers.map((l, i) => {
      const idx = i + 1;
      const base = `
        <div class="item-controls" data-layer-id="${esc(l.id||'')}">
          <div class="item-header">
            <span>${idx}. 图层 - ${l.type === 'color' ? '颜色' : (l.type === 'gradient' ? '渐变' : '图片')}</span>
            <div class="item-actions" style="display:flex; gap:6px;">
              <button class="btn" data-action="layer-up" title="上移">⬆</button>
              <button class="btn" data-action="layer-down" title="下移">⬇</button>
              <button class="btn btn-delete" data-action="layer-del" title="删除">✕</button>
            </div>
          </div>
          ${l.type === 'color' ? `
            <div class="control-group">
              <label>颜色</label>
              <input type="color" value="${esc(l.color||'#000000')}" data-field="layer-color">
            </div>
          ` : (l.type === 'gradient' ? `
            <div class="control-group">
              <label>样式</label>
              <select data-field="layer-style">
                <option value="linear"${(l.style||'linear')==='linear'?' selected':''}>线性</option>
                <option value="radial"${(l.style||'linear')==='radial'?' selected':''}>径向</option>
                <option value="conic"${(l.style||'linear')==='conic'?' selected':''}>锥形</option>
              </select>
            </div>
            <div class="control-group">
              <label>角度</label>
              <div class="range-row">
                <input type="range" min="0" max="360" step="1" value="${isFinite(l.angle)?Number(l.angle):135}" data-field="layer-angle">
                <span class="value-pill"><span>${isFinite(l.angle)?Number(l.angle):135}</span>°</span>
              </div>
            </div>
            <div class="control-group">
              <label>方向 / 位置</label>
              <select data-field="layer-direction" style="width:100%;">
                <option value="center"${(l.direction||'to bottom right')==='center'?' selected':''}>中心</option>
                <option value="top"${(l.direction||'to bottom right')==='top'?' selected':''}>上</option>
                <option value="bottom"${(l.direction||'to bottom right')==='bottom'?' selected':''}>下</option>
                <option value="left"${(l.direction||'to bottom right')==='left'?' selected':''}>左</option>
                <option value="right"${(l.direction||'to bottom right')==='right'?' selected':''}>右</option>
                <option value="top left"${(l.direction||'to bottom right')==='top left'?' selected':''}>左上</option>
                <option value="top right"${(l.direction||'to bottom right')==='top right'?' selected':''}>右上</option>
                <option value="bottom left"${(l.direction||'to bottom right')==='bottom left'?' selected':''}>左下</option>
                <option value="bottom right"${(l.direction||'to bottom right')==='bottom right'?' selected':''}>右下</option>
                <option value="to top"${(l.direction||'to bottom right')==='to top'?' selected':''}>线性：向上</option>
                <option value="to bottom"${(l.direction||'to bottom right')==='to bottom'?' selected':''}>线性：向下</option>
                <option value="to left"${(l.direction||'to bottom right')==='to left'?' selected':''}>线性：向左</option>
                <option value="to right"${(l.direction||'to bottom right')==='to right'?' selected':''}>线性：向右</option>
                <option value="to top left"${(l.direction||'to bottom right')==='to top left'?' selected':''}>线性：左上</option>
                <option value="to top right"${(l.direction||'to bottom right')==='to top right'?' selected':''}>线性：右上</option>
                <option value="to bottom left"${(l.direction||'to bottom right')==='to bottom left'?' selected':''}>线性：左下</option>
                <option value="to bottom right"${(l.direction||'to bottom right')==='to bottom right'?' selected':''}>线性：右下</option>
              </select>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <div class="control-group">
                <label>起色</label>
                <input type="color" value="${esc(l.start||customization.primaryColor||'#6a717c')}" data-field="layer-start">
              </div>
              <div class="control-group">
                <label>终色</label>
                <input type="color" value="${esc(l.end||customization.secondaryColor||'#97aec8')}" data-field="layer-end">
              </div>
            </div>
          ` : `
            <div class="control-group">
              <label>图片 URL</label>
              <input type="text" value="${esc(l.src||'')}" placeholder="https://..." data-field="layer-src">
            </div>
          `)}
          <div class="control-group">
            <label>透明度</label>
            <div class="range-row">
              <input type="range" min="0" max="1" step="0.05" value="${isFinite(l.opacity)?Number(l.opacity):1}" data-field="layer-opacity">
              <span class="value-pill"><span>${isFinite(l.opacity)?Number(l.opacity).toFixed(2):'1.00'}</span></span>
            </div>
          </div>
        </div>
      `;
      return base;
    }).join('');
  }catch(_e){}
}
function renderBgComponentsEditor(){
  try{
    if (!bgComponentsList) return;
    const comps = customization.bgComponents || [];
    bgComponentsList.innerHTML = comps.map((c, i) => {
      const idx = i + 1;
      const w = isFinite(c.w)? Number(c.w) : 20;
      const op = isFinite(c.opacity)? Number(c.opacity) : 1;
      const vis = (c.visible !== false);
      const locked = !!c.locked;
      return `
        <div class="item-controls" data-comp-id="${esc(c.id||'')}">
          <div class="item-header">
            <span>${idx}. 组件</span>
            <div class="item-actions" style="display:flex; gap:6px;">
              <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" data-field="comp-visible" ${vis?'checked':''}>显示</label>
              <label style="display:flex;align-items:center;gap:4px;font-size:12px;"><input type="checkbox" data-field="comp-locked" ${locked?'checked':''}>锁定</label>
              <button class="btn btn-delete" data-action="comp-del" title="删除">✕</button>
            </div>
          </div>
          <div class="control-group">
            <label>图片 URL</label>
            <input type="text" value="${esc(c.src||'')}" placeholder="https://..." data-field="comp-src">
          </div>
          <div class="control-group">
            <label>宽度(%)</label>
            <div class="range-row">
              <input type="range" min="2" max="100" step="1" value="${w}" data-field="comp-w">
              <span class="value-pill"><span>${w}</span>%</span>
            </div>
          </div>
          <div class="control-group">
            <label>透明度</label>
            <div class="range-row">
              <input type="range" min="0" max="1" step="0.05" value="${op}" data-field="comp-opacity">
              <span class="value-pill"><span>${op.toFixed(2)}</span></span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }catch(_e){}
}
function setupBgEditorsEvents(){
  try{
    if (btnAddColorLayer) btnAddColorLayer.addEventListener('click', () => {
      customization.bgLayers = customization.bgLayers || [];
      customization.bgLayers.push({ id: genId(), type:'color', color:'#000000', opacity:0.5 });
      renderBgLayersEditor(); renderPreview();
    });
    if (btnAddGradientLayer) btnAddGradientLayer.addEventListener('click', () => {
      customization.bgLayers = customization.bgLayers || [];
      customization.bgLayers.push({
        id: genId(),
        type:'gradient',
        style:'linear',
        angle:135,
        direction:'to bottom right',
        start: customization.bgGradientStart || customization.primaryColor || '#6a717c',
        end: customization.bgGradientEnd || customization.secondaryColor || '#97aec8',
        opacity:1
      });
      renderBgLayersEditor(); renderPreview();
    });
    if (btnAddImageLayerUrl) btnAddImageLayerUrl.addEventListener('click', () => {
      const u = window.prompt('输入图片 URL:');
      if (!u) return;
      customization.bgLayers = customization.bgLayers || [];
      customization.bgLayers.push({ id: genId(), type:'image', src: u, opacity:1, size:'cover', position:'center', repeat:'no-repeat' });
      renderBgLayersEditor(); renderPreview();
    });
    if (bgLayersList) {
      bgLayersList.addEventListener('click', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-layer-id');
        const i = (customization.bgLayers||[]).findIndex(x => x.id === id);
        if (i < 0) return;
        const actBtn = e.target.closest('button[data-action]');
        if (!actBtn) return;
        const act = actBtn.dataset.action;
        if (act === 'layer-del') customization.bgLayers.splice(i,1);
        if (act === 'layer-up' && i > 0) [customization.bgLayers[i-1], customization.bgLayers[i]] = [customization.bgLayers[i], customization.bgLayers[i-1]];
        if (act === 'layer-down' && i < customization.bgLayers.length-1) [customization.bgLayers[i+1], customization.bgLayers[i]] = [customization.bgLayers[i], customization.bgLayers[i+1]];
        renderBgLayersEditor(); renderPreview();
      });
      bgLayersList.addEventListener('input', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-layer-id');
        const l = (customization.bgLayers||[]).find(x => x.id === id);
        if (!l) return;
        const field = e.target.dataset.field;
        if (field === 'layer-color') l.color = e.target.value;
        if (field === 'layer-src') l.src = e.target.value;
        if (field === 'layer-style') l.style = e.target.value;
        if (field === 'layer-angle') {
          const v = parseInt(e.target.value||'135', 10);
          l.angle = Math.max(0, Math.min(360, isNaN(v)?135:v));
          const pillA = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pillA) pillA.textContent = String(l.angle);
        }
        if (field === 'layer-direction') l.direction = e.target.value;
        if (field === 'layer-start') l.start = e.target.value;
        if (field === 'layer-end') l.end = e.target.value;
        if (field === 'layer-opacity') {
          const v = parseFloat(e.target.value||'1') || 0;
          l.opacity = Math.max(0, Math.min(1, v));
          const pill = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pill) pill.textContent = l.opacity.toFixed(2);
        }
        renderPreview();
      });
    }
    if (btnAddCompUrl) btnAddCompUrl.addEventListener('click', () => {
      const u = window.prompt('输入组件图片 URL:');
      if (!u) return;
      customization.bgComponents = customization.bgComponents || [];
      customization.bgComponents.push({ id: genId(), src: u, x:50, y:50, w:20, opacity:1, visible:true, locked:false });
      renderBgComponentsEditor(); renderPreview();
    });
    if (bgCompDragToggle) bgCompDragToggle.addEventListener('change', (e) => {
      customization.bgCompDrag = !!e.target.checked;
      ensureBgDock();
    });
    if (bgComponentsList){
      bgComponentsList.addEventListener('click', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-comp-id');
        const i = (customization.bgComponents||[]).findIndex(x => x.id === id);
        if (i < 0) return;
        const btn = e.target.closest('button[data-action]');
        if (btn && btn.dataset.action === 'comp-del') {
          customization.bgComponents.splice(i,1);
          renderBgComponentsEditor(); renderPreview();
        }
      });
      bgComponentsList.addEventListener('input', (e) => {
        const root = e.target.closest('.item-controls'); if (!root) return;
        const id = root.getAttribute('data-comp-id');
        const c = (customization.bgComponents||[]).find(x => x.id === id);
        if (!c) return;
        const field = e.target.dataset.field;
        if (field === 'comp-src') c.src = e.target.value;
        if (field === 'comp-w') { c.w = Math.max(2, Math.min(100, parseInt(e.target.value||'20',10)||20)); const pill = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pill) pill.textContent = c.w; }
        if (field === 'comp-opacity') { const v = parseFloat(e.target.value||'1')||1; c.opacity = Math.max(0, Math.min(1, v)); const pill = e.target.closest('.range-row')?.querySelector('.value-pill span'); if (pill) pill.textContent = c.opacity.toFixed(2); }
        if (field === 'comp-visible') c.visible = !!e.target.checked;
        if (field === 'comp-locked') c.locked = !!e.target.checked;
        renderPreview();
      });
    }
  }catch(_e){}
}

// 覆写：主预览渲染，注入背景/字体/圆角/字距/行距以及双列布局
function renderPreview() {
  const headerHTML = getHeaderHTML2(currentTheme, currentTitle);
  const itemsHTML = buildItemsHTML(items, currentTheme);
 
  // st-body 布局控制
  let bodyStyle = '';
   // 外层额外类：双列布局 + 标签/值比例布局（除“上下堆叠/居中/双列”外均启用）
   let wrapperExtraClass = '';
   if (customization.layout === 'two-column') wrapperExtraClass += ' layout-two-column';
   // 扩展比例布局适用范围：除 stacked/center/two-column 外，其他布局启用比例栅格
   if (customization.layout !== 'stacked' && customization.layout !== 'center' && customization.layout !== 'two-column') wrapperExtraClass += ' ratio-layout';
 
  // 外层样式控制
  let wrapperStyle = `
    font-family:${customization.fontFamily};
    border-radius:${customization.radius}px;
    letter-spacing:${customization.letterSpacing}em;
    line-height:${customization.lineHeight};
    opacity:${customization.opacity};
  `;
  // 1.5 预览宽度控制：固定为 100% 容器宽度 + max-width 限制（clamp 规则）
  const __maxW = customization.statusbarMaxWidth || 600;
  // 始终居中显示：超宽时以 max-width 收缩并通过 margin:0 auto 居中
  wrapperStyle += `width: 100%; max-width: clamp(280px, 92vw, ${__maxW}px); margin: 0 auto;`;

  // 双列模式：注入列比例与间距变量
  if (customization.layout === 'two-column') {
    const lp = clamp(parseInt(customization.twoColLabelPct ?? 30, 10) || 30, 10, 50);
    const gap = clamp(parseInt(customization.twoColGap ?? 12, 10) || 12, 0, 40);
    const vp = 100 - lp;
    wrapperStyle += `--two-col-label:${lp}%;--two-col-value:${vp}%;--two-col-gap:${gap}px;`;
  }
   // 标签/值比例变量（除“上下堆叠/居中/双列”外均使用）
   if (customization.layout !== 'stacked' && customization.layout !== 'center' && customization.layout !== 'two-column') {
     const lv = clamp(parseInt(customization.lvLabelPct ?? 30, 10) || 30, 10, 50);
     wrapperStyle += `--lv-label:${lv}%;--lv-value:${100 - lv}%;`;
   }

  // 背景模式
  const bgMode = customization.bgMode;
  if (bgMode === 'color') {
    wrapperStyle += `background:${customization.bgColor} !important;`;
  } else if (bgMode === 'gradient') {
    const start = (customization.bgGradientStart && customization.bgGradientStart.trim().length > 0) ? customization.bgGradientStart : customization.primaryColor;
    const end   = (customization.bgGradientEnd && customization.bgGradientEnd.trim().length > 0) ? customization.bgGradientEnd   : customization.secondaryColor;
    const style = (customization.bgGradientStyle || 'linear');
    const angle = Number(customization.bgGradientAngle ?? 135) || 135;
    const dir   = (customization.bgGradientDirection || 'to bottom right');
    let grad;
    if (style === 'linear') {
      // 线性：角度优先
      grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
    } else if (style === 'radial') {
      const pos = String(dir || 'center').replace(/^to\s+/, '');
      grad = `radial-gradient(at ${pos}, ${start}, ${end})`;
    } else if (style === 'conic') {
      const pos = String(dir || 'center').replace(/^to\s+/, '');
      grad = `conic-gradient(from ${angle}deg at ${pos}, ${start}, ${end})`;
    } else {
      grad = `linear-gradient(${angle}deg, ${start}, ${end})`;
    }
    wrapperStyle += `background:${grad} !important;`;
  } else if (bgMode === 'image') {
    const url = esc(customization.bgImageUrl || '');
    wrapperStyle += `background-image:url('${url}');background-size:cover;background-position:center;`;
  } else if (bgMode === 'layers') {
    // 由自定义多图层接管背景
    wrapperStyle += `background:transparent !important;`;
  } else if (bgMode === 'none') {
    wrapperStyle += `background:transparent !important;`;
  }

  // 全局进度条颜色变量（用于荧光等效果）
  const wrapperBarColor = (customization.section2BarColor && customization.section2BarColor.trim().length > 0)
    ? customization.section2BarColor
    : customization.primaryColor;
  wrapperStyle += `--bar-color:${wrapperBarColor};`;

  // 第三部分：值框/整体偏移与阴影（以 CSS 变量传递到样式层，默认不越界）
  (function(){
    const pct = Math.max(40, Math.min(100, Number(customization.valueBoxWidthPct ?? 100)));
    const vOff = Math.max(-40, Math.min(40, Number(customization.valueBoxOffsetPct ?? 0)));
    const iOff = Math.max(-40, Math.min(40, Number(customization.itemOffsetPct ?? 0)));
    wrapperStyle += `--vb-width-pct:${pct};--vb-offset-pct:${vOff};--item-offset-pct:${iOff};--item-offset-right-pct:${customization.itemOffsetRightPct ?? 0};`;
  })();

 
  // 组合 HTML
  const bgLayersHTML = (customization.bgMode === 'layers') ? buildBgLayersHTML(customization.bgLayers) : '';
  const bgCompsHTML = (customization.bgMode === 'layers') ? buildBgComponentsHTML(customization.bgComponents) : '';
  const html = `
    <div class="status-preview-wrapper ${currentTheme} percent-style-${customization.percentDisplay || 'center'}${wrapperExtraClass}" style="${wrapperStyle}">
      ${bgLayersHTML}
      ${bgCompsHTML}
      ${headerHTML}
      <div class="st-body" style="${bodyStyle}">
        ${itemsHTML}
      </div>
    </div>
  `;
  previewContainer.innerHTML = html;
  const wrapper = previewContainer.querySelector('.status-preview-wrapper');
  // 应用每个项目的局部“值框与整体偏移”覆盖（通过 CSS 变量）
  try {
    const itemNodes = wrapper ? wrapper.querySelectorAll('.st-body .st-item') : [];
    let __idx = 0;
    items.forEach(it => {
      if (it.type === 'divider') return;
      const el = itemNodes[__idx++];
      if (!el) return;
      const valEl = el.querySelector('.st-value');
      // 值框/整体偏移 CSS 变量
      if (isFinite(it.itemOffsetPct)) el.style.setProperty('--item-offset-pct', clamp(parseFloat(it.itemOffsetPct) || 0, -40, 40));
      if (isFinite(it.itemOffsetRightPct)) el.style.setProperty('--item-offset-right-pct', clamp(parseFloat(it.itemOffsetRightPct) || 0, -40, 40));
      if (valEl) {
        if (isFinite(it.vbWidthPct)) valEl.style.setProperty('--vb-width-pct', clamp(parseFloat(it.vbWidthPct) || 100, 40, 100));
        if (isFinite(it.vbOffsetPct)) valEl.style.setProperty('--vb-offset-pct', clamp(parseFloat(it.vbOffsetPct) || 0, -40, 40));
      }
      // 项目卡片背景与阴影（全局 + 局部覆盖）
      (function applyCardBgShadow(){
        try {
          // 基于全局初始化
          let mode = customization.itemCardBgMode || 'theme';
          let color = customization.itemCardBgColor || '#111215';
          let gStart = customization.itemCardGradStart || customization.primaryColor;
          let gEnd = customization.itemCardGradEnd || customization.secondaryColor;
          let gAngle = Number(customization.itemCardGradAngle ?? 135) || 135;
          let imgUrl = customization.itemCardBgImageUrl || '';
          let url = customization.itemCardBgUrl || '';

          // 局部覆盖：支持 inherit/theme/none/color/gradient/image/url
          if (customization.itemCardPerItemEnabled && it) {
            const localModeRaw = it.cardBgMode;
            if (localModeRaw && String(localModeRaw) !== 'inherit') {
              mode = String(localModeRaw);
            }
            if (mode === 'color') {
              if (it.cardBgColor) color = it.cardBgColor;
            } else if (mode === 'gradient') {
              if (it.cardGradStart) gStart = it.cardGradStart;
              if (it.cardGradEnd) gEnd = it.cardGradEnd;
              if (isFinite(it.cardGradAngle)) gAngle = Number(it.cardGradAngle);
            } else if (mode === 'image') {
              const localImg = (it.cardBgImageUrl != null ? String(it.cardBgImageUrl) : (it.cardImageUrl != null ? String(it.cardImageUrl) : ''));
              if (localImg.trim()) imgUrl = localImg.trim();
            } else if (mode === 'url') {
              const localUrl = (it.cardBgUrl != null ? String(it.cardBgUrl) : (it.cardUrl != null ? String(it.cardUrl) : ''));
              if (localUrl.trim()) url = localUrl.trim();
            }
            // theme/none/inherit: 按照 mode 处理，其余字段忽略
          }

          // 应用背景
          el.style.background = ''; // reset
          el.style.backgroundImage = '';
          el.style.backgroundSize = '';
          el.style.backgroundPosition = '';
          el.style.backgroundRepeat = '';
          if (mode === 'none') {
            el.style.background = 'transparent';
          } else if (mode === 'color') {
            el.style.background = color;
          } else if (mode === 'gradient') {
            el.style.background = `linear-gradient(${gAngle}deg, ${gStart}, ${gEnd})`;
          } else if (mode === 'image') {
            if (imgUrl && imgUrl.trim()) {
              el.style.backgroundImage = `url('${esc(imgUrl)}')`;
              el.style.backgroundSize = 'cover';
              el.style.backgroundPosition = 'center';
              el.style.backgroundRepeat = 'no-repeat';
            }
          } else if (mode === 'url') {
            if (url && url.trim()) {
              el.style.backgroundImage = `url('${esc(url)}')`;
              el.style.backgroundSize = 'cover';
              el.style.backgroundPosition = 'center';
              el.style.backgroundRepeat = 'no-repeat';
            }
          } // theme: 保持模板默认，不额外设置

          // 阴影：局部优先
          let shadowOn = !!customization.itemCardShadowEnabled;
          let shadowStrength = Number(customization.itemCardShadowStrength || 0.30);
          if (customization.itemCardPerItemEnabled) {
            if (it.cardShadowEnable != null) shadowOn = !!it.cardShadowEnable;
            if (isFinite(it.cardShadowStrength)) shadowStrength = Number(it.cardShadowStrength);
          }
          if (shadowOn) {
            const s = Math.max(0, Math.min(1, shadowStrength));
            const y = (4 + 8 * s).toFixed(1);
            const blur = (10 + 18 * s).toFixed(1);
            el.style.boxShadow = `0 ${y}px ${blur}px rgba(0,0,0,${0.2 + 0.3*s})`;
          } else {
            el.style.boxShadow = '';
          }
        } catch (_e) {}
      })();
    });
    console.log('[diag] per-item overrides applied', items.map(it => ({ id: it.id, vbWidthPct: it.vbWidthPct, vbOffsetPct: it.vbOffsetPct, itemOffsetPct: it.itemOffsetPct, itemOffsetRightPct: it.itemOffsetRightPct, cardUrl: it.cardUrl, cardShadowEnable: it.cardShadowEnable, cardShadowStrength: it.cardShadowStrength })));
  } catch (e) {
    console.warn('[diag] per-item overrides error', e);
  }
  if (customization.bgMode === 'layers') { setupBgComponentDrag(wrapper); ensureBgDock(); }
  // 优先使用 1.5 高度设置，其次使用宽度调节时产生的锁定高度，最后恢复自动高度
  if (wrapper) {
    // 始终使用内容自适应高度，不做锁定
    wrapper.style.height = '';
    wrapper.style.overflow = '';
  }
  renderFxLayers(wrapper);
  applyAnimation();

  // 长文字打字机特效：逐段落播放，保持段落结构和首字缩进
  try {
    const nodes = wrapper?.querySelectorAll('.st-longtext[data-effect="typewriter"]');
    nodes?.forEach(el => {
      // 获取所有段落元素
      const paragraphs = el.querySelectorAll('p');
      if (!paragraphs || paragraphs.length === 0) {
        // 回退：如果没有段落结构，使用原有逻辑
        const full = el.textContent || '';
        el.textContent = '';
        const spd = Math.max(5, Math.min(200, parseInt(el.getAttribute('data-tw-speed') || '18', 10) || 18));
        const delay = Math.max(0, parseInt(el.getAttribute('data-tw-delay') || '0', 10) || 0);
        const caretOn = (el.getAttribute('data-tw-caret') !== '0');
        let i = 0;
        const tick = function(){
          if (i >= full.length) { el.textContent = full; return; }
          i++;
          if (caretOn && i < full.length) {
            el.textContent = full.slice(0, i) + '▌';
          } else {
            el.textContent = full.slice(0, i);
          }
          setTimeout(tick, spd);
        };
        setTimeout(tick, delay);
        return;
      }
      
      // 新逻辑：逐段落打字，保持段落结构和首字缩进
      const spd = Math.max(5, Math.min(200, parseInt(el.getAttribute('data-tw-speed') || '18', 10) || 18));
      const baseDelay = Math.max(0, parseInt(el.getAttribute('data-tw-delay') || '0', 10) || 0);
      const caretOn = (el.getAttribute('data-tw-caret') !== '0');
      
      let cumulativeDelay = baseDelay;
      
      paragraphs.forEach((p, pIdx) => {
        const fullText = p.textContent || '';
        p.textContent = ''; // 清空段落内容但保留标签和样式
        
        let charIndex = 0;
        
        const typeParagraph = function() {
          if (charIndex >= fullText.length) {
            p.textContent = fullText;
            return;
          }
          
          charIndex++;
          if (caretOn && charIndex < fullText.length) {
            p.textContent = fullText.slice(0, charIndex) + '▌';
          } else {
            p.textContent = fullText.slice(0, charIndex);
          }
          
          setTimeout(typeParagraph, spd);
        };
        
        // 启动当前段落的打字效果，使用累积延迟确保顺序
        setTimeout(typeParagraph, cumulativeDelay);
        
        // 计算下一段落的起始延迟：当前段落字符数 × 打字速度
        cumulativeDelay += fullText.length * spd;
      });
    });
  } catch (_e) {}

  // 诊断日志：预览渲染后的协调度/动画参数与当前 items 快照
  try {
    const coh = computeCoherence({
      theme: currentTheme,
      primaryColor: customization.primaryColor,
      secondaryColor: customization.secondaryColor,
      letterSpacing: customization.letterSpacing,
      lineHeight: customization.lineHeight,
      animationType: currentAnimation
    });
    console.log('[diag] renderPreview', {
      theme: currentTheme,
      layout: customization.layout,
      fontFamily: customization.fontFamily,
      barStyle: customization.barStyle,
      barAnimation: customization.barAnimation,
      animation: currentAnimation,
      animSpeed,
      animIntensity,
      coherence: coh,
      items: snapshot()
    });
  } catch (e) { console.warn('[diag] renderPreview error', e); }

  // 同步当前预览状态到 Ny.State，确保导出侧(Ny.Export/Ny.CodeGen)与预览一致
  try {
    if (window.Ny && Ny.State) {
      var S = Ny.State;
      if (S.currentTheme !== currentTheme && typeof S.applyThemeDefaults === 'function') {
        // 仅当主题不一致时才切换主题；随即用 patchCustomization 覆盖定制项，避免默认覆盖
        S.applyThemeDefaults(currentTheme);
      }
      if (typeof S.setTitle === 'function') S.setTitle(currentTitle);
      if (typeof S.setItems === 'function') S.setItems(JSON.parse(JSON.stringify(items)));
      if (typeof S.setAnimations === 'function') S.setAnimations(currentEnterAnimation, currentLoopAnimation);
      if (typeof S.setAnimParams === 'function') S.setAnimParams(animSpeed, animIntensity);
      if (typeof S.patchCustomization === 'function') S.patchCustomization(Object.assign({}, customization));
    }
  } catch (_e) {}

}

// 事件绑定工具
function bind(el, type, handler) { if (el) el.addEventListener(type, handler); }

// 事件联动
/**
 * 主体字体选择变更：
 * - 同步标签/值字体到主体字体（默认一致，避免出现“选择了新字体但文本仍用旧字体”的情况）
 * - 预加载新 family，刷新预览
 */
bind(fontFamilySelect, 'change', e => {
  const newVal = e.target.value;
  const oldWrapper = customization.fontFamily;

  // 更新主体字体
  customization.fontFamily = newVal;

  // 强制同步：标签/值字体与主体一致（用户如需不同，可在“高级字体样式”中再单独修改）
  customization.globalLabelFontFamily = newVal;
  customization.globalValueFontFamily = newVal;
  if (globalLabelFontSelect) globalLabelFontSelect.value = newVal;
  if (globalValueFontSelect) globalValueFontSelect.value = newVal;

  // 优化：预加载字体并智能等待，避免图裂
  try {
    const fam = String(newVal).replace(/['"]/g, '').split(',')[0].trim();
    if (fam && document.fonts && document.fonts.load) {
      let rendered = false;
      const doRender = () => {
        if (!rendered) {
          rendered = true;
          renderPreview();
        }
      };
      
      // 策略1：等待字体加载（成功或失败都渲染）
      document.fonts.load(`16px "${fam}"`).then(() => {
        console.debug('[font-change] font loaded successfully', { family: fam });
        doRender();
      }).catch(() => {
        console.warn('[font-change] font load failed, using fallback', { family: fam });
        doRender();
      });
      
      // 策略2：超时保护（500ms后强制渲染，给予更充足时间）
      setTimeout(doRender, 500);
      
      // 策略3：检查字体是否已缓存/可用（同步检查）
      if (document.fonts.check && document.fonts.check(`16px "${fam}"`)) {
        console.debug('[font-change] font already available', { family: fam });
        doRender();
      }
    } else {
      // 浏览器不支持 font loading API，直接渲染
      renderPreview();
    }
  } catch (_e) {
    // 出错时也要渲染
    renderPreview();
  }

  console.debug('[font-change] wrapper/global synced', { oldWrapper, newVal });
});
bind(primaryColorInput, 'input', e => { customization.primaryColor = e.target.value; if (primaryColorCodeInput) primaryColorCodeInput.value = e.target.value; renderPreview(); });
bind(secondaryColorInput, 'input', e => { customization.secondaryColor = e.target.value; if (secondaryColorCodeInput) secondaryColorCodeInput.value = e.target.value; renderPreview(); });
// 颜色代码输入联动（主/辅色）
bind(primaryColorCodeInput, 'input', e => {
  customization.primaryColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && primaryColorInput) primaryColorInput.value = v;
  renderPreview();
});
bind(secondaryColorCodeInput, 'input', e => {
  customization.secondaryColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && secondaryColorInput) secondaryColorInput.value = v;
  renderPreview();
});

bind(borderRadiusRange, 'input', e => {
  customization.radius = parseInt(e.target.value || '0', 10);
  if (radiusValue) radiusValue.textContent = String(customization.radius);
  renderPreview();
});

bind(bgModeSelect, 'change', e => { customization.bgMode = e.target.value; updateBgFieldsVisibility(); renderPreview(); });
bind(bgColorInput, 'input', e => { customization.bgColor = e.target.value; if (bgColorCodeInput) bgColorCodeInput.value = e.target.value; renderPreview(); });
// 颜色代码输入联动（纯色背景）
bind(bgColorCodeInput, 'input', e => {
  customization.bgColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && bgColorInput) bgColorInput.value = v;
  renderPreview();
});
bind(bgGradientStartColorInput, 'input', e => { customization.bgGradientStart = e.target.value; if (bgGradientStartCodeInput) bgGradientStartCodeInput.value = e.target.value; renderPreview(); });
bind(bgGradientStartCodeInput, 'input', e => {
  customization.bgGradientStart = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && bgGradientStartColorInput) bgGradientStartColorInput.value = v;
  renderPreview();
});
bind(bgGradientEndColorInput, 'input', e => { customization.bgGradientEnd = e.target.value; if (bgGradientEndCodeInput) bgGradientEndCodeInput.value = e.target.value; renderPreview(); });
bind(bgGradientEndCodeInput, 'input', e => {
  customization.bgGradientEnd = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && bgGradientEndColorInput) bgGradientEndColorInput.value = v;
  renderPreview();
});
bind(bgGradientStyleSelect, 'change', e => { customization.bgGradientStyle = e.target.value; renderPreview(); });
bind(bgGradientAngleRange, 'input', e => {
  customization.bgGradientAngle = parseInt(e.target.value || '135', 10);
  if (bgGradientAngleValue) bgGradientAngleValue.textContent = String(customization.bgGradientAngle);
  renderPreview();
});
bind(bgGradientDirectionSelect, 'change', e => { customization.bgGradientDirection = e.target.value; renderPreview(); });
bind(bgImageUrlInput, 'input', e => { customization.bgImageUrl = e.target.value; renderPreview(); });


bind(layoutSelect, 'change', e => {
  customization.layout = e.target.value;
  updateTwoColumnFieldsVisibility();
  // 同步双列控件的值展示
  if (twoColLabelPctRange && twoColLabelPctValue) {
    twoColLabelPctRange.value = String(customization.twoColLabelPct ?? 30);
    twoColLabelPctValue.textContent = String(customization.twoColLabelPct ?? 30);
  }
  if (twoColGapRange && twoColGapValue) {
    twoColGapRange.value = String(customization.twoColGap ?? 12);
    twoColGapValue.textContent = String(customization.twoColGap ?? 12);
  }
  renderPreview();
});
bind(letterSpacingRange, 'input', e => {
  customization.letterSpacing = parseFloat(e.target.value || '0');
  if (letterSpacingValue) letterSpacingValue.textContent = customization.letterSpacing.toFixed(2);
  renderPreview();
});
bind(lineHeightRange, 'input', e => {
  customization.lineHeight = parseFloat(e.target.value || '1.4');
  if (lineHeightValue) lineHeightValue.textContent = customization.lineHeight.toFixed(2);
  renderPreview();
});

/* 双列设置联动 */
bind(twoColLabelPctRange, 'input', e => {
  customization.twoColLabelPct = clamp(parseInt(e.target.value || '30', 10) || 30, 10, 50);
  if (twoColLabelPctValue) twoColLabelPctValue.textContent = String(customization.twoColLabelPct);
  renderPreview();
});
bind(twoColGapRange, 'input', e => {
  customization.twoColGap = clamp(parseInt(e.target.value || '12', 10) || 12, 0, 40);
  if (twoColGapValue) twoColGapValue.textContent = String(customization.twoColGap);
  renderPreview();
});
/* 标题启用开关 */
bind(titleEnabledCheckbox, 'change', e => {
  customization.titleEnabled = !!e.target.checked;
  // 同步到 Ny.State.customization（如果存在）
  try {
    if (window.Ny && Ny.State && Ny.State.customization) {
      Ny.State.customization.titleEnabled = customization.titleEnabled;
    }
  } catch(_e){}
  console.log('[titleEnabledCheckbox] titleEnabled changed to:', customization.titleEnabled);
  renderPreview();
});
/* 标题字号 */
bind(titleFontSizeRange, 'input', e => {
  customization.titleFontSize = parseInt(e.target.value || '20', 10);
  if (titleFontSizeValue) titleFontSizeValue.textContent = String(customization.titleFontSize);
  renderPreview();
});

// 标题区域自定义：显隐联动
function updateTitleColorFieldsVisibility(){
  try{
    const mode = titleColorModeSelect?.value || 'theme';
    if (titleColorSolidGroup) titleColorSolidGroup.style.display = (mode === 'solid') ? '' : 'none';
    if (titleColorGradientGroup) titleColorGradientGroup.style.display = (mode === 'gradient') ? '' : 'none';
  }catch(_e){}
}

// 标题高度/内边距
bind(headerMinHeightRange, 'input', e => {
  customization.headerMinHeight = parseInt(e.target.value || '0', 10) || 0;
  if (headerMinHeightValue) headerMinHeightValue.textContent = String(customization.headerMinHeight);
  renderPreview();
});
bind(headerPaddingYRange, 'input', e => {
  customization.headerPaddingY = parseInt(e.target.value || '0', 10) || 0;
  if (headerPaddingYValue) headerPaddingYValue.textContent = String(customization.headerPaddingY);
  renderPreview();
});

// 对齐
bind(headerAlignSelect, 'change', e => {
  customization.headerAlign = e.target.value || 'inherit';
  renderPreview();
});

// 间距
bind(titleGapEnableCheckbox, 'change', e => {
  const on = !!e.target.checked;
  customization.titleGapEnabled = on;
  if (titleGapRange) titleGapRange.disabled = !on;
  renderPreview();
});
bind(titleGapRange, 'input', e => {
  customization.titleGap = parseInt(e.target.value || '10', 10) || 10;
  if (titleGapValue) titleGapValue.textContent = String(customization.titleGap);
  renderPreview();
});

// 颜色模式
bind(titleColorModeSelect, 'change', e => {
  customization.titleColorMode = e.target.value || 'theme';
  updateTitleColorFieldsVisibility();
  renderPreview();
});
bind(titleColorSolidInput, 'input', e => {
  customization.titleColorSolid = e.target.value;
  if (titleColorSolidCodeInput) titleColorSolidCodeInput.value = e.target.value;
  renderPreview();
});
bind(titleColorSolidCodeInput, 'input', e => {
  customization.titleColorSolid = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleColorSolidInput) titleColorSolidInput.value = v;
  renderPreview();
});
bind(titleGradStartInput, 'input', e => {
  customization.titleGradStart = e.target.value;
  if (titleGradStartCodeInput) titleGradStartCodeInput.value = e.target.value;
  renderPreview();
});
bind(titleGradStartCodeInput, 'input', e => {
  customization.titleGradStart = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleGradStartInput) titleGradStartInput.value = v;
  renderPreview();
});
bind(titleGradEndInput, 'input', e => {
  customization.titleGradEnd = e.target.value;
  if (titleGradEndCodeInput) titleGradEndCodeInput.value = e.target.value;
  renderPreview();
});
bind(titleGradEndCodeInput, 'input', e => {
  customization.titleGradEnd = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleGradEndInput) titleGradEndInput.value = v;
  renderPreview();
});
bind(titleGradAngleRange, 'input', e => {
  customization.titleGradAngle = parseInt(e.target.value || '0', 10) || 0;
  if (titleGradAngleValue) titleGradAngleValue.textContent = String(customization.titleGradAngle);
  renderPreview();
});

// 特效
bind(titleGlowEnableCheckbox, 'change', e => {
  customization.titleEffectGlow = !!e.target.checked;
  if (titleGlowIntensityRange) titleGlowIntensityRange.disabled = !customization.titleEffectGlow;
  renderPreview();
});
bind(titleGlowIntensityRange, 'input', e => {
  customization.titleGlowIntensity = parseFloat(e.target.value || '0.5') || 0.5;
  if (titleGlowIntensityValue) titleGlowIntensityValue.textContent = customization.titleGlowIntensity.toFixed(2);
  renderPreview();
});
bind(titleShadowEnableCheckbox, 'change', e => {
  customization.titleEffectShadow = !!e.target.checked;
  if (titleShadowStrengthRange) titleShadowStrengthRange.disabled = !customization.titleEffectShadow;
  renderPreview();
});
bind(titleShadowStrengthRange, 'input', e => {
  customization.titleShadowStrength = parseFloat(e.target.value || '0.3') || 0.3;
  if (titleShadowStrengthValue) titleShadowStrengthValue.textContent = customization.titleShadowStrength.toFixed(2);
  renderPreview();
});

// 标题高级样式绑定
bind(titleWeightSelect, 'change', e => { customization.titleWeight = parseInt(e.target.value || '500', 10) || 500; renderPreview(); });
bind(titleItalicCheckbox, 'change', e => { customization.titleItalic = !!e.target.checked; renderPreview(); });
bind(titleUppercaseCheckbox, 'change', e => { customization.titleUppercase = !!e.target.checked; renderPreview(); });
bind(titleLetterSpacingRange, 'input', e => {
  customization.titleLetterSpacing = parseFloat(e.target.value || '0') || 0;
  if (titleLetterSpacingValue) titleLetterSpacingValue.textContent = customization.titleLetterSpacing.toFixed(2);
  renderPreview();
});

// 下划线
bind(titleUnderlineStyleSelect, 'change', e => { customization.titleUnderlineStyle = e.target.value || 'none'; renderPreview(); });
bind(titleUnderlineColorInput, 'input', e => { customization.titleUnderlineColor = e.target.value; if (titleUnderlineColorCodeInput) titleUnderlineColorCodeInput.value = e.target.value; renderPreview(); });
bind(titleUnderlineColorCodeInput, 'input', e => {
  customization.titleUnderlineColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleUnderlineColorInput) titleUnderlineColorInput.value = v;
  renderPreview();
});
bind(titleUnderlineThicknessRange, 'input', e => {
  customization.titleUnderlineThickness = parseInt(e.target.value || '2', 10) || 2;
  if (titleUnderlineThicknessValue) titleUnderlineThicknessValue.textContent = String(customization.titleUnderlineThickness);
  renderPreview();
});
bind(titleUnderlineOffsetRange, 'input', e => {
  customization.titleUnderlineOffset = parseInt(e.target.value || '4', 10) || 4;
  if (titleUnderlineOffsetValue) titleUnderlineOffsetValue.textContent = String(customization.titleUnderlineOffset);
  renderPreview();
});

// 标题徽章
bind(titleBadgeEnableCheckbox, 'change', e => { customization.titleBadgeEnabled = !!e.target.checked; renderPreview(); });
bind(titleBadgeColorInput, 'input', e => { customization.titleBadgeColor = e.target.value; if (titleBadgeColorCodeInput) titleBadgeColorCodeInput.value = e.target.value; renderPreview(); });
bind(titleBadgeColorCodeInput, 'input', e => {
  customization.titleBadgeColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && titleBadgeColorInput) titleBadgeColorInput.value = v;
  renderPreview();
});


// 初始颜色控件显隐
updateTitleColorFieldsVisibility();
if (titleGapRange) titleGapRange.disabled = !customization.titleGapEnabled;
if (titleGlowIntensityRange) titleGlowIntensityRange.disabled = !customization.titleEffectGlow;
if (titleShadowStrengthRange) titleShadowStrengthRange.disabled = !customization.titleEffectShadow;
// 标签/值字号
bind(globalLabelFontSizeRange, 'input', e => {
  customization.globalLabelFontSize = parseInt(e.target.value || '16', 10);
  if (globalLabelFontSizeValue) globalLabelFontSizeValue.textContent = String(customization.globalLabelFontSize);
  renderPreview();
});
bind(globalValueFontSizeRange, 'input', e => {
  customization.globalValueFontSize = parseInt(e.target.value || '16', 10);
  if (globalValueFontSizeValue) globalValueFontSizeValue.textContent = String(customization.globalValueFontSize);
  renderPreview();
});
bind(opacityRange, 'input', e => {
  customization.opacity = parseFloat(e.target.value || '1');
  if (opacityValue) opacityValue.textContent = customization.opacity.toFixed(2);
  renderPreview();
});
// 2：预览最大宽度联动
bind(statusbarWidthRange, 'input', e => {
  // 仅调整最大宽度，不锁定高度；高度随内容（项目数量）自适应变化
  customization.statusbarMaxWidth = clamp(parseInt(e.target.value || '600', 10) || 600, 300, 1200);
  if (statusbarWidthValue) statusbarWidthValue.textContent = String(customization.statusbarMaxWidth);
  renderPreview();
});
bind(dividerStyleSelect, 'change', e => { customization.dividerStyle = e.target.value; renderPreview(); });
bind(barStyleSelect, 'change', e => { customization.barStyle = e.target.value; renderItemsEditor(); renderPreview(); });
bind(barAnimationSelect, 'change', e => { customization.barAnimation = e.target.value; renderPreview(); });
bind(percentDisplaySelect, 'change', e => { customization.percentDisplay = e.target.value; renderPreview(); });

// 项目卡片背景与阴影（全局）
bind(itemCardPerItemToggle, 'change', e => { customization.itemCardPerItemEnabled = !!e.target.checked; renderItemsEditor(); renderPreview(); });
bind(itemCardBgModeSelect, 'change', e => { customization.itemCardBgMode = e.target.value; updateItemCardBgFieldsVisibility(); renderPreview(); });
bind(itemCardBgColorInput, 'input', e => { customization.itemCardBgColor = e.target.value; if (itemCardBgColorCodeInput) itemCardBgColorCodeInput.value = e.target.value; renderPreview(); });
bind(itemCardBgColorCodeInput, 'input', e => { customization.itemCardBgColor = e.target.value; const v=e.target.value; if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && itemCardBgColorInput) itemCardBgColorInput.value = v; renderPreview(); });
bind(itemCardGradStartInput, 'input', e => { customization.itemCardGradStart = e.target.value; if (itemCardGradStartCodeInput) itemCardGradStartCodeInput.value = e.target.value; renderPreview(); });
bind(itemCardGradStartCodeInput, 'input', e => { customization.itemCardGradStart = e.target.value; const v=e.target.value; if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && itemCardGradStartInput) itemCardGradStartInput.value = v; renderPreview(); });
bind(itemCardGradEndInput, 'input', e => { customization.itemCardGradEnd = e.target.value; if (itemCardGradEndCodeInput) itemCardGradEndCodeInput.value = e.target.value; renderPreview(); });
bind(itemCardGradEndCodeInput, 'input', e => { customization.itemCardGradEnd = e.target.value; const v=e.target.value; if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && itemCardGradEndInput) itemCardGradEndInput.value = v; renderPreview(); });
bind(itemCardGradAngleRange, 'input', e => { customization.itemCardGradAngle = parseInt(e.target.value || '135', 10); if (itemCardGradAngleValue) itemCardGradAngleValue.textContent = String(customization.itemCardGradAngle); renderPreview(); });
bind(itemCardBgImageUrlInput, 'input', e => { customization.itemCardBgImageUrl = e.target.value; renderPreview(); });
bind(itemCardBgUrlInput, 'input', e => { customization.itemCardBgUrl = e.target.value; renderPreview(); });
bind(itemCardShadowEnableCheckbox, 'change', e => { customization.itemCardShadowEnabled = !!e.target.checked; if (itemCardShadowStrengthRange) itemCardShadowStrengthRange.disabled = !customization.itemCardShadowEnabled; renderPreview(); });
bind(itemCardShadowStrengthRange, 'input', e => { customization.itemCardShadowStrength = parseFloat(e.target.value || '0.30') || 0.30; if (itemCardShadowStrengthValue) itemCardShadowStrengthValue.textContent = customization.itemCardShadowStrength.toFixed(2); renderPreview(); });

// 光晕设置联动
bind(glowColorAInput, 'input', e => { customization.glowColorA = e.target.value; if (glowColorACodeInput) glowColorACodeInput.value = e.target.value; applyAnimation(); });
bind(glowColorACodeInput, 'input', e => {
  customization.glowColorA = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && glowColorAInput) glowColorAInput.value = v;
  applyAnimation();
});
bind(glowColorBInput, 'input', e => { customization.glowColorB = e.target.value; if (glowColorBCodeInput) glowColorBCodeInput.value = e.target.value; applyAnimation(); });
bind(glowColorBCodeInput, 'input', e => {
  customization.glowColorB = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && glowColorBInput) glowColorBInput.value = v;
  applyAnimation();
});
bind(glowSpeedRange, 'input', e => { customization.glowSpeed = parseFloat(e.target.value || '1'); if (glowSpeedValue) glowSpeedValue.textContent = customization.glowSpeed.toFixed(1); applyAnimation(); });

// 长文字：行距与特效
bind(longtextLineHeightRange, 'input', e => {
  customization.longTextLineHeight = parseFloat(e.target.value || '1.6');
  if (longtextLineHeightValue) longtextLineHeightValue.textContent = customization.longTextLineHeight.toFixed(2);
  renderPreview();
});
bind(longtextEffectSelect, 'change', e => {
  customization.longTextEffect = e.target.value || 'none';
  renderPreview();
});

// 新增：第三部分 值框尺寸/位置 + 整体偏移/阴影 事件联动
bind(valueBoxWidthPctRange, 'input', e => {
  customization.valueBoxWidthPct = clamp(parseInt(e.target.value || '100', 10) || 100, 40, 100);
  if (valueBoxWidthPctValue) valueBoxWidthPctValue.textContent = String(customization.valueBoxWidthPct);
  renderPreview();
});
bind(valueBoxOffsetPctRange, 'input', e => {
  customization.valueBoxOffsetPct = clamp(parseInt(e.target.value || '0', 10) || 0, -40, 40);
  if (valueBoxOffsetPctValue) valueBoxOffsetPctValue.textContent = String(customization.valueBoxOffsetPct);
  renderPreview();
});
bind(itemOffsetPctRange, 'input', e => {
  customization.itemOffsetPct = clamp(parseInt(e.target.value || '0', 10) || 0, -40, 40);
  if (itemOffsetPctValue) itemOffsetPctValue.textContent = String(customization.itemOffsetPct);
  renderPreview();
});

bind(itemOffsetRightPctRange, 'input', e => {
  customization.itemOffsetRightPct = clamp(parseInt(e.target.value || '0', 10) || 0, -40, 40);
  if (itemOffsetRightPctValue) itemOffsetRightPctValue.textContent = String(customization.itemOffsetRightPct);
  renderPreview();
});

// 新增：标签/值比例联动（仅左右排列）
bind(labelValueLabelPctRange, 'input', e => {
  customization.lvLabelPct = clamp(parseInt(e.target.value || '30', 10) || 30, 10, 50);
  if (labelValueLabelPctValue) labelValueLabelPctValue.textContent = String(customization.lvLabelPct);
  if (labelValueValuePctValue) labelValueValuePctValue.textContent = String(100 - customization.lvLabelPct);
  renderPreview();
});

// 委托点击：统一切换预览中的百分比显示，避免与内联 onclick 双重触发造成“来回切换为原状态”
document.addEventListener('click', (e) => {
  const bar = e.target.closest('.st-progress-bar');
  if (!bar) return;
  // 若该条带有内联 onclick，则交给内联处理，防止双重切换
  if (bar.getAttribute && bar.getAttribute('onclick')) {
    return;
  }
  const pctEl = bar.querySelector('.st-progress-percent');
  if (pctEl) {
    const show = !bar.classList.contains('show-percent');
    bar.classList.toggle('show-percent', show);
    // 同步内联 opacity，兼容多处生成片段的行为
    pctEl.style.opacity = show ? '1' : '0';
    console.log('[diag] pct-toggle-preview', {
      show,
      percentStyle: customization.percentDisplay,
      theme: currentTheme
    });
  }
});

// 新增：第三部分项目颜色联动（仅影响“状态项目”）
bind(section2LabelColorInput, 'input', e => { customization.section2LabelColor = e.target.value; if (section2LabelColorCodeInput) section2LabelColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
bind(section2ValueColorInput, 'input', e => { customization.section2ValueColor = e.target.value; if (section2ValueColorCodeInput) section2ValueColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
bind(section2BarColorInput, 'input', e => { customization.section2BarColor = e.target.value; if (section2BarColorCodeInput) section2BarColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
bind(section2DividerColorInput, 'input', e => { customization.section2DividerColor = e.target.value; if (section2DividerColorCodeInput) section2DividerColorCodeInput.value = e.target.value; renderItemsEditor(); renderPreview(); });
// 颜色代码输入联动（第三部分项目颜色）
bind(section2LabelColorCodeInput, 'input', e => {
  customization.section2LabelColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2LabelColorInput) section2LabelColorInput.value = v;
  renderItemsEditor(); renderPreview();
});
bind(section2ValueColorCodeInput, 'input', e => {
  customization.section2ValueColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2ValueColorInput) section2ValueColorInput.value = v;
  renderItemsEditor(); renderPreview();
});
bind(section2BarColorCodeInput, 'input', e => {
  customization.section2BarColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2BarColorInput) section2BarColorInput.value = v;
  renderItemsEditor(); renderPreview();
});
bind(section2DividerColorCodeInput, 'input', e => {
  customization.section2DividerColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && section2DividerColorInput) section2DividerColorInput.value = v;
  renderItemsEditor(); renderPreview();
});

// 新增：标签/值字体与样式联动（第三部分）- 优化：智能等待字体加载
bind(globalLabelFontSelect, 'change', e => { 
  customization.globalLabelFontFamily = e.target.value; 
  const fam = String(e.target.value).replace(/['"]/g, '').split(',')[0].trim();
  if (fam && document.fonts && document.fonts.load) {
    let rendered = false;
    const doRender = () => { if (!rendered) { rendered = true; renderPreview(); } };
    document.fonts.load(`16px "${fam}"`).then(doRender).catch(doRender);
    setTimeout(doRender, 500);
    if (document.fonts.check && document.fonts.check(`16px "${fam}"`)) doRender();
  } else {
    renderPreview();
  }
});
bind(globalValueFontSelect, 'change', e => { 
  customization.globalValueFontFamily = e.target.value; 
  const fam = String(e.target.value).replace(/['"]/g, '').split(',')[0].trim();
  if (fam && document.fonts && document.fonts.load) {
    let rendered = false;
    const doRender = () => { if (!rendered) { rendered = true; renderPreview(); } };
    document.fonts.load(`16px "${fam}"`).then(doRender).catch(doRender);
    setTimeout(doRender, 500);
    if (document.fonts.check && document.fonts.check(`16px "${fam}"`)) doRender();
  } else {
    renderPreview();
  }
});
bind(globalLabelWeightSelect, 'change', e => { customization.globalLabelWeight = parseInt(e.target.value || '500', 10); renderPreview(); });
bind(globalValueWeightSelect, 'change', e => { customization.globalValueWeight = parseInt(e.target.value || '600', 10); renderPreview(); });
bind(globalLabelItalicCheckbox, 'change', e => { customization.globalLabelItalic = !!e.target.checked; renderPreview(); });
bind(globalValueItalicCheckbox, 'change', e => { customization.globalValueItalic = !!e.target.checked; renderPreview(); });
bind(globalLabelUppercaseCheckbox, 'change', e => { customization.globalLabelUppercase = !!e.target.checked; renderPreview(); });
bind(globalValueUppercaseCheckbox, 'change', e => { customization.globalValueUppercase = !!e.target.checked; renderPreview(); });
bind(globalLabelReflectCheckbox, 'change', e => { customization.globalLabelReflect = !!e.target.checked; renderPreview(); });
bind(globalValueReflectCheckbox, 'change', e => { customization.globalValueReflect = !!e.target.checked; renderPreview(); });

/* 新增：动画叠加联动 */
bind(starEnabledCheckbox, 'change', e => { customization.starEnabled = !!e.target.checked; renderPreview(); });
bind(starFrequencyRange, 'input', e => { customization.starFrequency = parseFloat(e.target.value || '2'); if (starFrequencyValue) starFrequencyValue.textContent = customization.starFrequency.toFixed(1); renderPreview(); });
bind(starDensityRange, 'input', e => { customization.starDensity = parseInt(e.target.value || '50', 10); if (starDensityValue) starDensityValue.textContent = String(customization.starDensity); renderPreview(); });
bind(starColorInput, 'input', e => { customization.starColor = e.target.value; if (starColorCodeInput) starColorCodeInput.value = e.target.value; renderPreview(); });
bind(starColorCodeInput, 'input', e => {
  customization.starColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && starColorInput) starColorInput.value = v;
  renderPreview();
});

bind(sparkleEnabledCheckbox, 'change', e => { customization.sparkleEnabled = !!e.target.checked; renderPreview(); });
bind(sparkleDirectionSelect, 'change', e => { customization.sparkleDirection = e.target.value; renderPreview(); });
bind(sparkleFrequencyRange, 'input', e => { customization.sparkleFrequency = parseFloat(e.target.value || '2'); if (sparkleFrequencyValue) sparkleFrequencyValue.textContent = customization.sparkleFrequency.toFixed(1); renderPreview(); });
bind(sparkleDensityRange, 'input', e => { customization.sparkleDensity = parseInt(e.target.value || '20', 10); if (sparkleDensityValue) sparkleDensityValue.textContent = String(customization.sparkleDensity); renderPreview(); });
bind(sparkleColorInput, 'input', e => { customization.sparkleColor = e.target.value; if (sparkleColorCodeInput) sparkleColorCodeInput.value = e.target.value; renderPreview(); });
bind(sparkleColorCodeInput, 'input', e => {
  customization.sparkleColor = e.target.value;
  const v = e.target.value;
  if (/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test(v) && sparkleColorInput) sparkleColorInput.value = v;
  renderPreview();
});
bind(sparkleGlowCheckbox, 'change', e => { customization.sparkleGlow = !!e.target.checked; renderPreview(); });

bind(petalEnabledCheckbox, 'change', e => { customization.petalEnabled = !!e.target.checked; renderPreview(); });
bind(petalFrequencyRange, 'input', e => { customization.petalFrequency = parseFloat(e.target.value || '5'); if (petalFrequencyValue) petalFrequencyValue.textContent = customization.petalFrequency.toFixed(1); renderPreview(); });
bind(petalDensityRange, 'input', e => { customization.petalDensity = parseInt(e.target.value || '20', 10); if (petalDensityValue) petalDensityValue.textContent = String(customization.petalDensity); renderPreview(); });
bind(petalIconModeSelect, 'change', e => { customization.petalIconMode = e.target.value; renderPreview(); });
bind(petalIconBuiltinSelect, 'change', e => { customization.petalIconBuiltin = e.target.value; renderPreview(); });
bind(petalIconUrlInput, 'input', e => { customization.petalIconUrl = e.target.value; renderPreview(); });

// 图标事件联动
bind(iconModeSelect, 'change', e => {
  customization.iconMode = e.target.value;
  if (customization.iconMode !== 'none' && (customization.iconPosition === 'none' || !customization.iconPosition)) {
    customization.iconPosition = 'left';
    if (iconPositionSelect) iconPositionSelect.value = 'left';
  } else if (customization.iconMode === 'none') {
    customization.iconPosition = 'none';
    if (iconPositionSelect) iconPositionSelect.value = 'none';
  }
  updateIconFieldsVisibility();
  renderPreview();
});
bind(iconBuiltinSelect, 'change', e => { customization.iconBuiltin = e.target.value; renderPreview(); });
bind(iconUrlInput, 'input', e => { customization.iconUrl = e.target.value; renderPreview(); });
bind(iconSizeRange, 'input', e => {
  customization.iconSize = parseInt(e.target.value || '28', 10);
  if (iconSizeValue) iconSizeValue.textContent = String(customization.iconSize);
  renderPreview();
});
bind(iconPositionSelect, 'change', e => { customization.iconPosition = e.target.value; renderPreview(); });
 
// 首次刷新以应用默认值（移除一次，以避免覆盖主题默认值的首次渲染）
    
    // -----------------------
    // 初始化
    // -----------------------
    try {
      applyThemeDefaults(currentTheme);
      updateAddItemOptionVisibility();
      renderItemsEditor();
      setupCollapsibleSections();
      updateBgFieldsVisibility();
      updateIconFieldsVisibility();
      updateItemCardBgFieldsVisibility();

      // 初始化多图层/组件编辑 UI 与事件
      renderBgLayersEditor();
      renderBgComponentsEditor();
      setupBgEditorsEvents();

      renderPreview();
      console.groupCollapsed('[ui] section-2 grouping');
      try { document.querySelectorAll('#section-2 .form-group-box').forEach((box,i)=>console.log(i+1, box.getAttribute('data-title')||'(untitled)', box.querySelectorAll('.control-group').length)); } catch(_e) {}
      console.groupEnd();
      // 启动时先将“3. 输出代码”移入弹窗，左侧原始模块已隐藏
      // 移除右下角“导出最大宽度(px)”设置，导出宽度随 2 预览最大宽度
      try {
        const expMax = document.getElementById('export-max-width');
        if (expMax) {
          const grp = expMax.closest('.control-group');
          if (grp && grp.parentNode) grp.parentNode.removeChild(grp);
        }
      } catch (_e) {}
    } catch (e) {
      console.error('[init] error', e);
      if (previewContainer) {
        previewContainer.innerHTML = '<div style="color:#ff8080;padding:12px;border:1px solid #ff8080;border-radius:6px;background:rgba(255,0,0,.06);">初始化失败，已加载降级预览。请打开浏览器控制台查看错误详情。</div>';
      }
    }
    speedValue.textContent = animSpeed.toFixed(1);
    intensityValue.textContent = animIntensity.toFixed(2);
  // === 图片组件：裁剪与边缘特效 扩展 ===
try {
  // 计算附加样式（支持多特效叠加）
  function __nyCompExtraStyle(c){
    try{
      const crop = c && c.crop ? c.crop : {top:0,right:0,bottom:0,left:0};
      const t = Math.max(0, Math.min(50, Number(crop.top || 0)));
      const r = Math.max(0, Math.min(50, Number(crop.right || 0)));
      const b = Math.max(0, Math.min(50, Number(crop.bottom || 0)));
      const l = Math.max(0, Math.min(50, Number(crop.left || 0)));
      let css = '';
      
      // 裁剪
      if (t||r||b||l){
        css += `clip-path: inset(${t}% ${r}% ${b}% ${l}%);`;
      }
      
      // 多特效叠加支持
      const effs = (c && c.effects) || {};
      const col = customization.primaryColor || '#ffffff';
      const filters = [];
      
      // 圆角
      if (effs.rounded && isFinite(effs.roundedRadius)){
        css += `border-radius:${Math.max(0, Number(effs.roundedRadius))}px;`;
      }
      
      // 发光（filter）
      if (effs.glow && isFinite(effs.glowStrength)){
        const blur = (Math.max(0, Number(effs.glowStrength)) * 0.4 + 6).toFixed(1);
        filters.push(`drop-shadow(0 0 ${blur}px ${col})`);
      }
      
      // 阴影（filter）
      if (effs.shadow){
        filters.push(`drop-shadow(0 6px 16px rgba(0,0,0,.35))`);
      }
      
      // 组合 filter
      if (filters.length > 0){
        css += `filter: ${filters.join(' ')};`;
      }
      
      // 柔化边缘（mask，独立于 filter）
      if (effs.feather && isFinite(effs.featherStrength)){
        const s = Math.max(0, Math.min(50, Number(effs.featherStrength)));
        const inner = Math.max(60, 98 - s);
        const mask = `radial-gradient(circle at 50% 50%, #000 ${inner}%, transparent 100%)`;
        css += `-webkit-mask-image:${mask};mask-image:${mask};`;
      }
      
      return css;
    }catch(_e){ return ''; }
  }

  // 覆盖：组件 HTML 生成，注入裁剪/特效样式
  const __ny_old_buildBgComponentsHTML = buildBgComponentsHTML;
  buildBgComponentsHTML = function(components){
    try{
      const C = Array.isArray(components) ? components : [];
      if (!C.length) return '';
      const html = C.filter(c => c && c.visible !== false).map(c => {
        const id = esc(c.id || genId());
        const src = esc(c.src || '');
        const x = isFinite(c.x) ? Math.max(0, Math.min(100, Number(c.x))) : 50;
        const y = isFinite(c.y) ? Math.max(0, Math.min(100, Number(c.y))) : 50;
        const w = isFinite(c.w) ? Math.max(2, Math.min(100, Number(c.w))) : 20;
        const op = isFinite(c.opacity) ? Math.max(0, Math.min(1, Number(c.opacity))) : 1;
        const extra = __nyCompExtraStyle(c);
        return `<img class="bg-comp" data-id="${id}" src="${src}" alt="" style="left:${x}%;top:${y}%;width:${w}%;opacity:${op};${extra}">`;
      }).join('');
      return `<div class="bg-components-layer">${html}</div>`;
    }catch(e){
      try { return __ny_old_buildBgComponentsHTML(components); } catch(_e){ return ''; }
    }
  };

  // 增强：为每个组件条目附加"裁剪/边缘特效"控制面板
  function __ny_enhanceComponentsEditorUI(){
    try{
      const list = document.getElementById('bg-components-list');
      if (!list) return;
      const comps = customization.bgComponents || [];
      list.querySelectorAll('.item-controls').forEach(card => {
        if (!card.getAttribute('data-comp-id')) return;
        if (card.querySelector('.comp-adv-controls')) return;
        const id = card.getAttribute('data-comp-id');
        const c = comps.find(x => x.id === id);
        if (!c) return;
        c.crop = c.crop || {top:0,right:0,bottom:0,left:0};
        ['top','right','bottom','left'].forEach(k => { if(!isFinite(c.crop[k])) c.crop[k]=0; });
        
        // 多特效支持：改为对象存储
        c.effects = c.effects || {};
        if (!isFinite(c.effects.roundedRadius)) c.effects.roundedRadius = 0;
        if (!isFinite(c.effects.glowStrength)) c.effects.glowStrength = 0;
        if (!isFinite(c.effects.featherStrength)) c.effects.featherStrength = 0;
        c.effects.rounded = !!(c.effects.rounded);
        c.effects.glow = !!(c.effects.glow);
        c.effects.shadow = !!(c.effects.shadow);
        c.effects.feather = !!(c.effects.feather);

        const html = `
<div class="comp-adv-controls" style="margin-top:10px; border-top:1px dashed var(--border-color); padding-top:10px;">
  <div class="control-group">
    <label>裁剪(%)</label>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;">
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">上</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.top}" data-field="comp-crop-top" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">右</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.right}" data-field="comp-crop-right" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">下</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.bottom}" data-field="comp-crop-bottom" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
      <div style="display:flex;align-items:center;gap:4px;">
        <label style="color:var(--text-secondary);font-size:11px;min-width:16px;">左</label>
        <input type="number" min="0" max="50" step="1" value="${c.crop.left}" data-field="comp-crop-left" style="width:46px;padding:4px 6px;border:1px solid var(--border-color);border-radius:4px;background:var(--bg-control);color:var(--text-primary);font-size:12px;text-align:center;">
      </div>
    </div>
  </div>
  <div class="control-group">
    <label>边缘特效（可多选）</label>
    <div style="display:grid;gap:8px;margin-top:6px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-rounded" ${c.effects.rounded?'checked':''}>
        <span>圆角</span>
      </label>
      <div style="margin-left:24px;display:${c.effects.rounded?'block':'none'};" data-role="comp-effect-rounded-param">
        <div class="range-row" style="gap:6px;">
          <label style="color:var(--text-secondary);font-size:11px;min-width:48px;">半径</label>
          <input type="range" min="0" max="50" step="1" value="${c.effects.roundedRadius}" data-field="comp-effect-rounded-radius" style="flex:1;">
          <span class="value-pill" style="min-width:48px;"><span>${c.effects.roundedRadius}</span>px</span>
        </div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-glow" ${c.effects.glow?'checked':''}>
        <span>发光</span>
      </label>
      <div style="margin-left:24px;display:${c.effects.glow?'block':'none'};" data-role="comp-effect-glow-param">
        <div class="range-row" style="gap:6px;">
          <label style="color:var(--text-secondary);font-size:11px;min-width:48px;">强度</label>
          <input type="range" min="0" max="50" step="1" value="${c.effects.glowStrength}" data-field="comp-effect-glow-strength" style="flex:1;">
          <span class="value-pill" style="min-width:48px;"><span>${c.effects.glowStrength}</span></span>
        </div>
      </div>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-shadow" ${c.effects.shadow?'checked':''}>
        <span>阴影</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" data-field="comp-effect-feather" ${c.effects.feather?'checked':''}>
        <span>柔化边缘</span>
      </label>
      <div style="margin-left:24px;display:${c.effects.feather?'block':'none'};" data-role="comp-effect-feather-param">
        <div class="range-row" style="gap:6px;">
          <label style="color:var(--text-secondary);font-size:11px;min-width:48px;">强度</label>
          <input type="range" min="0" max="50" step="1" value="${c.effects.featherStrength}" data-field="comp-effect-feather-strength" style="flex:1;">
          <span class="value-pill" style="min-width:48px;"><span>${c.effects.featherStrength}</span></span>
        </div>
      </div>
    </div>
  </div>
</div>`;
        const wrap = document.createElement('div');
        wrap.innerHTML = html;
        card.appendChild(wrap);
      });
    }catch(_e){}
  }

  // 包装原有编辑器渲染函数
  if (typeof renderBgComponentsEditor === 'function'){
    const __ny_old_renderBgComponentsEditor = renderBgComponentsEditor;
    renderBgComponentsEditor = function(){
      __ny_old_renderBgComponentsEditor();
      __ny_enhanceComponentsEditorUI();
    };
    // 立即增强一次（当前界面）
    try { __ny_enhanceComponentsEditorUI(); } catch(_e){}
  }

  // 事件委托：裁剪/特效（支持多特效）
  if (bgComponentsList){
    bgComponentsList.addEventListener('input', (e) => {
      const root = e.target.closest('.item-controls'); if (!root) return;
      const id = root.getAttribute('data-comp-id');
      const c = (customization.bgComponents || []).find(x => x.id === id); if (!c) return;
      const field = e.target.dataset.field;
      if (!field) return;
      c.crop = c.crop || {top:0,right:0,bottom:0,left:0};
      c.effects = c.effects || {};
      function setPill(el, txt){ try{ el.closest('.range-row').querySelector('.value-pill span').textContent = txt; }catch(_e){} }
      
      // 裁剪
      if (field === 'comp-crop-top'){ c.crop.top = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      else if (field === 'comp-crop-right'){ c.crop.right = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      else if (field === 'comp-crop-bottom'){ c.crop.bottom = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      else if (field === 'comp-crop-left'){ c.crop.left = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); renderPreview(); }
      // 圆角参数
      else if (field === 'comp-effect-rounded-radius'){ c.effects.roundedRadius = clamp(parseInt(e.target.value||'0',10) || 0, 0, 200); setPill(e.target, c.effects.roundedRadius); renderPreview(); }
      // 发光参数
      else if (field === 'comp-effect-glow-strength'){ c.effects.glowStrength = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); setPill(e.target, c.effects.glowStrength); renderPreview(); }
      // 柔化边缘参数
      else if (field === 'comp-effect-feather-strength'){ c.effects.featherStrength = clamp(parseInt(e.target.value||'0',10) || 0, 0, 50); setPill(e.target, c.effects.featherStrength); renderPreview(); }
    });
    
    bgComponentsList.addEventListener('change', (e) => {
      const root = e.target.closest('.item-controls'); if (!root) return;
      const id = root.getAttribute('data-comp-id');
      const c = (customization.bgComponents || []).find(x => x.id === id); if (!c) return;
      const field = e.target.dataset.field;
      if (!field) return;
      c.effects = c.effects || {};
      
      // 多特效复选框
      if (field === 'comp-effect-rounded'){
        c.effects.rounded = !!e.target.checked;
        const paramDiv = root.querySelector('[data-role="comp-effect-rounded-param"]');
        if (paramDiv) paramDiv.style.display = c.effects.rounded ? 'block' : 'none';
        renderPreview();
      }
      else if (field === 'comp-effect-glow'){
        c.effects.glow = !!e.target.checked;
        const paramDiv = root.querySelector('[data-role="comp-effect-glow-param"]');
        if (paramDiv) paramDiv.style.display = c.effects.glow ? 'block' : 'none';
        renderPreview();
      }
      else if (field === 'comp-effect-shadow'){
        c.effects.shadow = !!e.target.checked;
        renderPreview();
      }
      else if (field === 'comp-effect-feather'){
        c.effects.feather = !!e.target.checked;
        const paramDiv = root.querySelector('[data-role="comp-effect-feather-param"]');
        if (paramDiv) paramDiv.style.display = c.effects.feather ? 'block' : 'none';
        renderPreview();
      }
    });
  }
}catch(_e){}

})();</script>

<!-- Ny.Adhere externalized to js/app.adhere.js; inline adherence block removed -->

<!-- 已迁移到 js/app.collapse.js，移除此内联初始化以避免重复绑定 -->
<!-- Mobile-friendly full color picker (modal) -->
<div id="color-picker-modal" class="cpk-modal" aria-hidden="true">
  <div class="cpk-backdrop"></div>
  <div class="cpk-dialog" role="dialog" aria-modal="true" aria-label="选择颜色">
    <div class="cpk-header">
      <span>选择颜色</span>
      <button type="button" class="cpk-close">关闭</button>
    </div>
    <div class="cpk-body">
      <div class="cpk-sv-wrap"><canvas id="cpk-sv"></canvas></div>
      <div>
        <div class="cpk-h-wrap"><canvas id="cpk-h"></canvas></div>
        <div class="cpk-preview">
          <div id="cpk-old" class="cpk-swatch" title="原色"></div>
          <div id="cpk-new" class="cpk-swatch" title="新色"></div>
        </div>
      </div>
      <div class="cpk-hex-row">
        <span>#</span>
        <input id="cpk-hex" type="text" inputmode="latin" placeholder="RRGGBB 或 #RRGGBB" autocomplete="off">
      </div>
    </div>
    <div class="cpk-actions">
      <button type="button" id="cpk-cancel" class="cpk-btn">取消</button>
      <button type="button" id="cpk-ok" class="cpk-btn primary">确定</button>
    </div>
  </div>
</div>
<script defer src="js/app.utils.js"></script>
<script defer src="js/app.render.js"></script>
<script defer src="js/app.merged.js"></script>
<script defer src="js/app.codegen.js"></script>
<script defer src="js/app.params.js"></script>
<script defer src="js/app.export.js"></script>
<script defer src="js/app.ui.js"></script>
<script>
  window.addEventListener('DOMContentLoaded', function() {
    try { if (window.Ny && Ny.Adhere && Ny.Adhere.init) Ny.Adhere.init(); } catch(_e){}
  });
</script>
<script defer src="js/app.colorpicker.mobile.js"></script>
<!-- 
  初始化逻辑已移至 app.render.js 的 window.load 事件监听器中
  避免重复初始化导致的状态覆盖问题
-->
</body>
</html>
